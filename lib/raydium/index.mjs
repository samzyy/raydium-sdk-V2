var zl=Object.defineProperty,jl=Object.defineProperties;var Hl=Object.getOwnPropertyDescriptors;var qo=Object.getOwnPropertySymbols;var ou=Object.prototype.hasOwnProperty,ru=Object.prototype.propertyIsEnumerable;var iu=(o,e,t)=>e in o?zl(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,v=(o,e)=>{for(var t in e||(e={}))ou.call(e,t)&&iu(o,t,e[t]);if(qo)for(var t of qo(e))ru.call(e,t)&&iu(o,t,e[t]);return o},U=(o,e)=>jl(o,Hl(e));var De=(o,e)=>{var t={};for(var n in o)ou.call(o,n)&&e.indexOf(n)<0&&(t[n]=o[n]);if(o!=null&&qo)for(var n of qo(o))e.indexOf(n)<0&&ru.call(o,n)&&(t[n]=o[n]);return t};import{merge as pb}from"lodash";import Qu from"axios";import{PublicKey as uu}from"@solana/web3.js";import{get as su,set as Yl}from"lodash";var ps=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},au={},Zl={};function fe(o){let e=su(au,o);if(!e){let t=su(Zl,o);e=new ps({name:o,logLevel:t}),Yl(au,o,e)}return e}import{MINT_SIZE as $l,TOKEN_PROGRAM_ID as Jl,getTransferFeeConfig as em,unpackMint as tm}from"@solana/spl-token";var fs=fe("Raydium_accountInfo_util");async function qt(o,e,t){let{batchRequest:n,commitment:i="confirmed",chunkCount:r=100}=v({batchRequest:!1},t),s=bs(e,r),a=new Array(s.length).fill([]);if(n){let c=s.map(m=>{let d=o._buildArgs([m.map(p=>p.toBase58())],i,"base64");return{methodName:"getMultipleAccounts",args:d}}),u=bs(c,10);a=(await(await Promise.all(u.map(async m=>await o._rpcBatchRequest(m)))).flat()).map(m=>(m.error&&fs.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${m.error.message}`),m.result.value.map(d=>{if(d){let{data:p,executable:b,lamports:f,owner:y,rentEpoch:g}=d;return p.length!==2&&p[1]!=="base64"&&fs.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:b,lamports:f,owner:new uu(y),rentEpoch:g}}return null})))}else try{a=await Promise.all(s.map(c=>o.getMultipleAccountsInfo(c,i)))}catch(c){c instanceof Error&&fs.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${c.message}`)}return a.flat()}async function Ne(o,e,t){let n=await qt(o,e.map(i=>i.pubkey),t);return e.map((i,r)=>U(v({},i),{accountInfo:n[r]}))}async function ui({connection:o,mints:e,config:t}){var r,s,a;if(e.length===0)return{};let n=await Ne(o,e.map(c=>({pubkey:mt(c)})),t),i={};for(let c of n){if(!c.accountInfo||c.accountInfo.data.length<$l){console.log("invalid mint account",c.pubkey.toBase58());continue}let u=tm(c.pubkey,c.accountInfo,(r=c.accountInfo)==null?void 0:r.owner);i[c.pubkey.toString()]=U(v({},u),{programId:((s=c.accountInfo)==null?void 0:s.owner)||Jl,feeConfig:(a=em(u))!=null?a:void 0})}return i[uu.default.toBase58()]=i[$.toBase58()],i}import un from"bn.js";var ci=9e15,Ln=1e9,ys="0123456789abcdef",Go="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",Xo="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",gs={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-ci,maxE:ci,crypto:!1},du,yn,le=!0,zo="[DecimalError] ",Cn=zo+"Invalid argument: ",pu=zo+"Precision limit exceeded",fu=zo+"crypto unavailable",bu="[object Decimal]",dt=Math.floor,Je=Math.pow,nm=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,im=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,om=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,yu=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,Gt=1e7,re=7,rm=9007199254740991,sm=Go.length-1,As=Xo.length-1,G={toStringTag:bu};G.absoluteValue=G.abs=function(){var o=new this.constructor(this);return o.s<0&&(o.s=1),ne(o)};G.ceil=function(){return ne(new this.constructor(this),this.e+1,2)};G.clampedTo=G.clamp=function(o,e){var t,n=this,i=n.constructor;if(o=new i(o),e=new i(e),!o.s||!e.s)return new i(NaN);if(o.gt(e))throw Error(Cn+e);return t=n.cmp(o),t<0?o:n.cmp(e)>0?e:new i(n)};G.comparedTo=G.cmp=function(o){var e,t,n,i,r=this,s=r.d,a=(o=new r.constructor(o)).d,c=r.s,u=o.s;if(!s||!a)return!c||!u?NaN:c!==u?c:s===a?0:!s^c<0?1:-1;if(!s[0]||!a[0])return s[0]?c:a[0]?-u:0;if(c!==u)return c;if(r.e!==o.e)return r.e>o.e^c<0?1:-1;for(n=s.length,i=a.length,e=0,t=n<i?n:i;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^c<0?1:-1;return n===i?0:n>i^c<0?1:-1};G.cosine=G.cos=function(){var o,e,t=this,n=t.constructor;return t.d?t.d[0]?(o=n.precision,e=n.rounding,n.precision=o+Math.max(t.e,t.sd())+re,n.rounding=1,t=am(n,ku(n,t)),n.precision=o,n.rounding=e,ne(yn==2||yn==3?t.neg():t,o,e,!0)):new n(1):new n(NaN)};G.cubeRoot=G.cbrt=function(){var o,e,t,n,i,r,s,a,c,u,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(le=!1,r=l.s*Je(l.s*l,1/3),!r||Math.abs(r)==1/0?(t=at(l.d),o=l.e,(r=(o-t.length+1)%3)&&(t+=r==1||r==-2?"0":"00"),r=Je(t,1/3),o=dt((o+1)/3)-(o%3==(o<0?-1:2)),r==1/0?t="5e"+o:(t=r.toExponential(),t=t.slice(0,t.indexOf("e")+1)+o),n=new m(t),n.s=l.s):n=new m(r.toString()),s=(o=m.precision)+3;;)if(a=n,c=a.times(a).times(a),u=c.plus(l),n=Le(u.plus(l).times(a),u.plus(c),s+2,1),at(a.d).slice(0,s)===(t=at(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!i&&t=="4999"){if(!i&&(ne(a,o+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,i=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(ne(n,o+1,1),e=!n.times(n).times(n).eq(l));break}return le=!0,ne(n,o,m.rounding,e)};G.decimalPlaces=G.dp=function(){var o,e=this.d,t=NaN;if(e){if(o=e.length-1,t=(o-dt(this.e/re))*re,o=e[o],o)for(;o%10==0;o/=10)t--;t<0&&(t=0)}return t};G.dividedBy=G.div=function(o){return Le(this,new this.constructor(o))};G.dividedToIntegerBy=G.divToInt=function(o){var e=this,t=e.constructor;return ne(Le(e,new t(o),0,1,1),t.precision,t.rounding)};G.equals=G.eq=function(o){return this.cmp(o)===0};G.floor=function(){return ne(new this.constructor(this),this.e+1,3)};G.greaterThan=G.gt=function(o){return this.cmp(o)>0};G.greaterThanOrEqualTo=G.gte=function(o){var e=this.cmp(o);return e==1||e===0};G.hyperbolicCosine=G.cosh=function(){var o,e,t,n,i,r=this,s=r.constructor,a=new s(1);if(!r.isFinite())return new s(r.s?1/0:NaN);if(r.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(r.e,r.sd())+4,s.rounding=1,i=r.d.length,i<32?(o=Math.ceil(i/3),e=(1/Ho(4,o)).toString()):(o=16,e="2.3283064365386962890625e-10"),r=li(s,1,r.times(e),new s(1),!0);for(var c,u=o,l=new s(8);u--;)c=r.times(r),r=a.minus(c.times(l.minus(c.times(l))));return ne(r,s.precision=t,s.rounding=n,!0)};G.hyperbolicSine=G.sinh=function(){var o,e,t,n,i=this,r=i.constructor;if(!i.isFinite()||i.isZero())return new r(i);if(e=r.precision,t=r.rounding,r.precision=e+Math.max(i.e,i.sd())+4,r.rounding=1,n=i.d.length,n<3)i=li(r,2,i,i,!0);else{o=1.4*Math.sqrt(n),o=o>16?16:o|0,i=i.times(1/Ho(5,o)),i=li(r,2,i,i,!0);for(var s,a=new r(5),c=new r(16),u=new r(20);o--;)s=i.times(i),i=i.times(a.plus(s.times(c.times(s).plus(u))))}return r.precision=e,r.rounding=t,ne(i,e,t,!0)};G.hyperbolicTangent=G.tanh=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+7,n.rounding=1,Le(t.sinh(),t.cosh(),n.precision=o,n.rounding=e)):new n(t.s)};G.inverseCosine=G.acos=function(){var o,e=this,t=e.constructor,n=e.abs().cmp(1),i=t.precision,r=t.rounding;return n!==-1?n===0?e.isNeg()?Ut(t,i,r):new t(0):new t(NaN):e.isZero()?Ut(t,i+4,r).times(.5):(t.precision=i+6,t.rounding=1,e=e.asin(),o=Ut(t,i+4,r).times(.5),t.precision=i,t.rounding=r,o.minus(e))};G.inverseHyperbolicCosine=G.acosh=function(){var o,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(o=n.precision,e=n.rounding,n.precision=o+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,le=!1,t=t.times(t).minus(1).sqrt().plus(t),le=!0,n.precision=o,n.rounding=e,t.ln()):new n(t)};G.inverseHyperbolicSine=G.asinh=function(){var o,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,le=!1,t=t.times(t).plus(1).sqrt().plus(t),le=!0,n.precision=o,n.rounding=e,t.ln())};G.inverseHyperbolicTangent=G.atanh=function(){var o,e,t,n,i=this,r=i.constructor;return i.isFinite()?i.e>=0?new r(i.abs().eq(1)?i.s/0:i.isZero()?i:NaN):(o=r.precision,e=r.rounding,n=i.sd(),Math.max(n,o)<2*-i.e-1?ne(new r(i),o,e,!0):(r.precision=t=n-i.e,i=Le(i.plus(1),new r(1).minus(i),t+o,1),r.precision=o+4,r.rounding=1,i=i.ln(),r.precision=o,r.rounding=e,i.times(.5))):new r(NaN)};G.inverseSine=G.asin=function(){var o,e,t,n,i=this,r=i.constructor;return i.isZero()?new r(i):(e=i.abs().cmp(1),t=r.precision,n=r.rounding,e!==-1?e===0?(o=Ut(r,t+4,n).times(.5),o.s=i.s,o):new r(NaN):(r.precision=t+6,r.rounding=1,i=i.div(new r(1).minus(i.times(i)).sqrt().plus(1)).atan(),r.precision=t,r.rounding=n,i.times(2)))};G.inverseTangent=G.atan=function(){var o,e,t,n,i,r,s,a,c,u=this,l=u.constructor,m=l.precision,d=l.rounding;if(u.isFinite()){if(u.isZero())return new l(u);if(u.abs().eq(1)&&m+4<=As)return s=Ut(l,m+4,d).times(.25),s.s=u.s,s}else{if(!u.s)return new l(NaN);if(m+4<=As)return s=Ut(l,m+4,d).times(.5),s.s=u.s,s}for(l.precision=a=m+10,l.rounding=1,t=Math.min(28,a/re+2|0),o=t;o;--o)u=u.div(u.times(u).plus(1).sqrt().plus(1));for(le=!1,e=Math.ceil(a/re),n=1,c=u.times(u),s=new l(u),i=u;o!==-1;)if(i=i.times(c),r=s.minus(i.div(n+=2)),i=i.times(c),s=r.plus(i.div(n+=2)),s.d[e]!==void 0)for(o=e;s.d[o]===r.d[o]&&o--;);return t&&(s=s.times(2<<t-1)),le=!0,ne(s,l.precision=m,l.rounding=d,!0)};G.isFinite=function(){return!!this.d};G.isInteger=G.isInt=function(){return!!this.d&&dt(this.e/re)>this.d.length-2};G.isNaN=function(){return!this.s};G.isNegative=G.isNeg=function(){return this.s<0};G.isPositive=G.isPos=function(){return this.s>0};G.isZero=function(){return!!this.d&&this.d[0]===0};G.lessThan=G.lt=function(o){return this.cmp(o)<0};G.lessThanOrEqualTo=G.lte=function(o){return this.cmp(o)<1};G.logarithm=G.log=function(o){var e,t,n,i,r,s,a,c,u=this,l=u.constructor,m=l.precision,d=l.rounding,p=5;if(o==null)o=new l(10),e=!0;else{if(o=new l(o),t=o.d,o.s<0||!t||!t[0]||o.eq(1))return new l(NaN);e=o.eq(10)}if(t=u.d,u.s<0||!t||!t[0]||u.eq(1))return new l(t&&!t[0]?-1/0:u.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)r=!0;else{for(i=t[0];i%10===0;)i/=10;r=i!==1}if(le=!1,a=m+p,s=Kn(u,a),n=e?Qo(l,a+10):Kn(o,a),c=Le(s,n,a,1),Mi(c.d,i=m,d))do if(a+=10,s=Kn(u,a),n=e?Qo(l,a+10):Kn(o,a),c=Le(s,n,a,1),!r){+at(c.d).slice(i+1,i+15)+1==1e14&&(c=ne(c,m+1,0));break}while(Mi(c.d,i+=10,d));return le=!0,ne(c,m,d)};G.minus=G.sub=function(o){var e,t,n,i,r,s,a,c,u,l,m,d,p=this,b=p.constructor;if(o=new b(o),!p.d||!o.d)return!p.s||!o.s?o=new b(NaN):p.d?o.s=-o.s:o=new b(o.d||p.s!==o.s?p:NaN),o;if(p.s!=o.s)return o.s=-o.s,p.plus(o);if(u=p.d,d=o.d,a=b.precision,c=b.rounding,!u[0]||!d[0]){if(d[0])o.s=-o.s;else if(u[0])o=new b(p);else return new b(c===3?-0:0);return le?ne(o,a,c):o}if(t=dt(o.e/re),l=dt(p.e/re),u=u.slice(),r=l-t,r){for(m=r<0,m?(e=u,r=-r,s=d.length):(e=d,t=l,s=u.length),n=Math.max(Math.ceil(a/re),s)+2,r>n&&(r=n,e.length=1),e.reverse(),n=r;n--;)e.push(0);e.reverse()}else{for(n=u.length,s=d.length,m=n<s,m&&(s=n),n=0;n<s;n++)if(u[n]!=d[n]){m=u[n]<d[n];break}r=0}for(m&&(e=u,u=d,d=e,o.s=-o.s),s=u.length,n=d.length-s;n>0;--n)u[s++]=0;for(n=d.length;n>r;){if(u[--n]<d[n]){for(i=n;i&&u[--i]===0;)u[i]=Gt-1;--u[i],u[n]+=Gt}u[n]-=d[n]}for(;u[--s]===0;)u.pop();for(;u[0]===0;u.shift())--t;return u[0]?(o.d=u,o.e=jo(u,t),le?ne(o,a,c):o):new b(c===3?-0:0)};G.modulo=G.mod=function(o){var e,t=this,n=t.constructor;return o=new n(o),!t.d||!o.s||o.d&&!o.d[0]?new n(NaN):!o.d||t.d&&!t.d[0]?ne(new n(t),n.precision,n.rounding):(le=!1,n.modulo==9?(e=Le(t,o.abs(),0,3,1),e.s*=o.s):e=Le(t,o,0,n.modulo,1),e=e.times(o),le=!0,t.minus(e))};G.naturalExponential=G.exp=function(){return Ps(this)};G.naturalLogarithm=G.ln=function(){return Kn(this)};G.negated=G.neg=function(){var o=new this.constructor(this);return o.s=-o.s,ne(o)};G.plus=G.add=function(o){var e,t,n,i,r,s,a,c,u,l,m=this,d=m.constructor;if(o=new d(o),!m.d||!o.d)return!m.s||!o.s?o=new d(NaN):m.d||(o=new d(o.d||m.s===o.s?m:NaN)),o;if(m.s!=o.s)return o.s=-o.s,m.minus(o);if(u=m.d,l=o.d,a=d.precision,c=d.rounding,!u[0]||!l[0])return l[0]||(o=new d(m)),le?ne(o,a,c):o;if(r=dt(m.e/re),n=dt(o.e/re),u=u.slice(),i=r-n,i){for(i<0?(t=u,i=-i,s=l.length):(t=l,n=r,s=u.length),r=Math.ceil(a/re),s=r>s?r+1:s+1,i>s&&(i=s,t.length=1),t.reverse();i--;)t.push(0);t.reverse()}for(s=u.length,i=l.length,s-i<0&&(i=s,t=l,l=u,u=t),e=0;i;)e=(u[--i]=u[i]+l[i]+e)/Gt|0,u[i]%=Gt;for(e&&(u.unshift(e),++n),s=u.length;u[--s]==0;)u.pop();return o.d=u,o.e=jo(u,n),le?ne(o,a,c):o};G.precision=G.sd=function(o){var e,t=this;if(o!==void 0&&o!==!!o&&o!==1&&o!==0)throw Error(Cn+o);return t.d?(e=gu(t.d),o&&t.e+1>e&&(e=t.e+1)):e=NaN,e};G.round=function(){var o=this,e=o.constructor;return ne(new e(o),o.e+1,e.rounding)};G.sine=G.sin=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+Math.max(t.e,t.sd())+re,n.rounding=1,t=cm(n,ku(n,t)),n.precision=o,n.rounding=e,ne(yn>2?t.neg():t,o,e,!0)):new n(NaN)};G.squareRoot=G.sqrt=function(){var o,e,t,n,i,r,s=this,a=s.d,c=s.e,u=s.s,l=s.constructor;if(u!==1||!a||!a[0])return new l(!u||u<0&&(!a||a[0])?NaN:a?s:1/0);for(le=!1,u=Math.sqrt(+s),u==0||u==1/0?(e=at(a),(e.length+c)%2==0&&(e+="0"),u=Math.sqrt(e),c=dt((c+1)/2)-(c<0||c%2),u==1/0?e="5e"+c:(e=u.toExponential(),e=e.slice(0,e.indexOf("e")+1)+c),n=new l(e)):n=new l(u.toString()),t=(c=l.precision)+3;;)if(r=n,n=r.plus(Le(s,r,t+2,1)).times(.5),at(r.d).slice(0,t)===(e=at(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!i&&e=="4999"){if(!i&&(ne(r,c+1,0),r.times(r).eq(s))){n=r;break}t+=4,i=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(ne(n,c+1,1),o=!n.times(n).eq(s));break}return le=!0,ne(n,c,l.rounding,o)};G.tangent=G.tan=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+10,n.rounding=1,t=t.sin(),t.s=1,t=Le(t,new n(1).minus(t.times(t)).sqrt(),o+10,0),n.precision=o,n.rounding=e,ne(yn==2||yn==4?t.neg():t,o,e,!0)):new n(NaN)};G.times=G.mul=function(o){var e,t,n,i,r,s,a,c,u,l=this,m=l.constructor,d=l.d,p=(o=new m(o)).d;if(o.s*=l.s,!d||!d[0]||!p||!p[0])return new m(!o.s||d&&!d[0]&&!p||p&&!p[0]&&!d?NaN:!d||!p?o.s/0:o.s*0);for(t=dt(l.e/re)+dt(o.e/re),c=d.length,u=p.length,c<u&&(r=d,d=p,p=r,s=c,c=u,u=s),r=[],s=c+u,n=s;n--;)r.push(0);for(n=u;--n>=0;){for(e=0,i=c+n;i>n;)a=r[i]+p[n]*d[i-n-1]+e,r[i--]=a%Gt|0,e=a/Gt|0;r[i]=(r[i]+e)%Gt|0}for(;!r[--s];)r.pop();return e?++t:r.shift(),o.d=r,o.e=jo(r,t),le?ne(o,m.precision,m.rounding):o};G.toBinary=function(o,e){return ks(this,2,o,e)};G.toDecimalPlaces=G.toDP=function(o,e){var t=this,n=t.constructor;return t=new n(t),o===void 0?t:(Tt(o,0,Ln),e===void 0?e=n.rounding:Tt(e,0,8),ne(t,o+t.e+1,e))};G.toExponential=function(o,e){var t,n=this,i=n.constructor;return o===void 0?t=rn(n,!0):(Tt(o,0,Ln),e===void 0?e=i.rounding:Tt(e,0,8),n=ne(new i(n),o+1,e),t=rn(n,!0,o+1)),n.isNeg()&&!n.isZero()?"-"+t:t};G.toFixed=function(o,e){var t,n,i=this,r=i.constructor;return o===void 0?t=rn(i):(Tt(o,0,Ln),e===void 0?e=r.rounding:Tt(e,0,8),n=ne(new r(i),o+i.e+1,e),t=rn(n,!1,o+n.e+1)),i.isNeg()&&!i.isZero()?"-"+t:t};G.toFraction=function(o){var e,t,n,i,r,s,a,c,u,l,m,d,p=this,b=p.d,f=p.constructor;if(!b)return new f(p);if(u=t=new f(1),n=c=new f(0),e=new f(n),r=e.e=gu(b)-p.e-1,s=r%re,e.d[0]=Je(10,s<0?re+s:s),o==null)o=r>0?e:u;else{if(a=new f(o),!a.isInt()||a.lt(u))throw Error(Cn+a);o=a.gt(e)?r>0?e:u:a}for(le=!1,a=new f(at(b)),l=f.precision,f.precision=r=b.length*re*2;m=Le(a,e,0,1,1),i=t.plus(m.times(n)),i.cmp(o)!=1;)t=n,n=i,i=u,u=c.plus(m.times(i)),c=i,i=e,e=a.minus(m.times(i)),a=i;return i=Le(o.minus(t),n,0,1,1),c=c.plus(i.times(u)),t=t.plus(i.times(n)),c.s=u.s=p.s,d=Le(u,n,r,1).minus(p).abs().cmp(Le(c,t,r,1).minus(p).abs())<1?[u,n]:[c,t],f.precision=l,le=!0,d};G.toHexadecimal=G.toHex=function(o,e){return ks(this,16,o,e)};G.toNearest=function(o,e){var t=this,n=t.constructor;if(t=new n(t),o==null){if(!t.d)return t;o=new n(1),e=n.rounding}else{if(o=new n(o),e===void 0?e=n.rounding:Tt(e,0,8),!t.d)return o.s?t:o;if(!o.d)return o.s&&(o.s=t.s),o}return o.d[0]?(le=!1,t=Le(t,o,0,e,1).times(o),le=!0,ne(t)):(o.s=t.s,t=o),t};G.toNumber=function(){return+this};G.toOctal=function(o,e){return ks(this,8,o,e)};G.toPower=G.pow=function(o){var e,t,n,i,r,s,a=this,c=a.constructor,u=+(o=new c(o));if(!a.d||!o.d||!a.d[0]||!o.d[0])return new c(Je(+a,u));if(a=new c(a),a.eq(1))return a;if(n=c.precision,r=c.rounding,o.eq(1))return ne(a,n,r);if(e=dt(o.e/re),e>=o.d.length-1&&(t=u<0?-u:u)<=rm)return i=Au(c,a,t,n),o.s<0?new c(1).div(i):ne(i,n,r);if(s=a.s,s<0){if(e<o.d.length-1)return new c(NaN);if((o.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=Je(+a,u),e=t==0||!isFinite(t)?dt(u*(Math.log("0."+at(a.d))/Math.LN10+a.e+1)):new c(t+"").e,e>c.maxE+1||e<c.minE-1?new c(e>0?s/0:0):(le=!1,c.rounding=a.s=1,t=Math.min(12,(e+"").length),i=Ps(o.times(Kn(a,n+t)),n),i.d&&(i=ne(i,n+5,1),Mi(i.d,n,r)&&(e=n+10,i=ne(Ps(o.times(Kn(a,e+t)),e),e+5,1),+at(i.d).slice(n+1,n+15)+1==1e14&&(i=ne(i,n+1,0)))),i.s=s,le=!0,c.rounding=r,ne(i,n,r))};G.toPrecision=function(o,e){var t,n=this,i=n.constructor;return o===void 0?t=rn(n,n.e<=i.toExpNeg||n.e>=i.toExpPos):(Tt(o,1,Ln),e===void 0?e=i.rounding:Tt(e,0,8),n=ne(new i(n),o,e),t=rn(n,o<=n.e||n.e<=i.toExpNeg,o)),n.isNeg()&&!n.isZero()?"-"+t:t};G.toSignificantDigits=G.toSD=function(o,e){var t=this,n=t.constructor;return o===void 0?(o=n.precision,e=n.rounding):(Tt(o,1,Ln),e===void 0?e=n.rounding:Tt(e,0,8)),ne(new n(t),o,e)};G.toString=function(){var o=this,e=o.constructor,t=rn(o,o.e<=e.toExpNeg||o.e>=e.toExpPos);return o.isNeg()&&!o.isZero()?"-"+t:t};G.truncated=G.trunc=function(){return ne(new this.constructor(this),this.e+1,1)};G.valueOf=G.toJSON=function(){var o=this,e=o.constructor,t=rn(o,o.e<=e.toExpNeg||o.e>=e.toExpPos);return o.isNeg()?"-"+t:t};function at(o){var e,t,n,i=o.length-1,r="",s=o[0];if(i>0){for(r+=s,e=1;e<i;e++)n=o[e]+"",t=re-n.length,t&&(r+=Sn(t)),r+=n;s=o[e],n=s+"",t=re-n.length,t&&(r+=Sn(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return r+s}function Tt(o,e,t){if(o!==~~o||o<e||o>t)throw Error(Cn+o)}function Mi(o,e,t,n){var i,r,s,a;for(r=o[0];r>=10;r/=10)--e;return--e<0?(e+=re,i=0):(i=Math.ceil((e+1)/re),e%=re),r=Je(10,re-e),a=o[i]%r|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==r||t>3&&a+1==r/2)&&(o[i+1]/r/100|0)==Je(10,e-2)-1||(a==r/2||a==0)&&(o[i+1]/r/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==r||!n&&t>3&&a+1==r/2)&&(o[i+1]/r/1e3|0)==Je(10,e-3)-1,s}function Uo(o,e,t){for(var n,i=[0],r,s=0,a=o.length;s<a;){for(r=i.length;r--;)i[r]*=e;for(i[0]+=ys.indexOf(o.charAt(s++)),n=0;n<i.length;n++)i[n]>t-1&&(i[n+1]===void 0&&(i[n+1]=0),i[n+1]+=i[n]/t|0,i[n]%=t)}return i.reverse()}function am(o,e){var t,n,i;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),i=(1/Ho(4,t)).toString()):(t=16,i="2.3283064365386962890625e-10"),o.precision+=t,e=li(o,1,e.times(i),new o(1));for(var r=t;r--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return o.precision-=t,e}var Le=function(){function o(n,i,r){var s,a=0,c=n.length;for(n=n.slice();c--;)s=n[c]*i+a,n[c]=s%r|0,a=s/r|0;return a&&n.unshift(a),n}function e(n,i,r,s){var a,c;if(r!=s)c=r>s?1:-1;else for(a=c=0;a<r;a++)if(n[a]!=i[a]){c=n[a]>i[a]?1:-1;break}return c}function t(n,i,r,s){for(var a=0;r--;)n[r]-=a,a=n[r]<i[r]?1:0,n[r]=a*s+n[r]-i[r];for(;!n[0]&&n.length>1;)n.shift()}return function(n,i,r,s,a,c){var u,l,m,d,p,b,f,y,g,P,k,T,I,h,S,x,K,B,C,L,R=n.constructor,D=n.s==i.s?1:-1,_=n.d,W=i.d;if(!_||!_[0]||!W||!W[0])return new R(!n.s||!i.s||(_?W&&_[0]==W[0]:!W)?NaN:_&&_[0]==0||!W?D*0:D/0);for(c?(p=1,l=n.e-i.e):(c=Gt,p=re,l=dt(n.e/p)-dt(i.e/p)),C=W.length,K=_.length,g=new R(D),P=g.d=[],m=0;W[m]==(_[m]||0);m++);if(W[m]>(_[m]||0)&&l--,r==null?(h=r=R.precision,s=R.rounding):a?h=r+(n.e-i.e)+1:h=r,h<0)P.push(1),b=!0;else{if(h=h/p+2|0,m=0,C==1){for(d=0,W=W[0],h++;(m<K||d)&&h--;m++)S=d*c+(_[m]||0),P[m]=S/W|0,d=S%W|0;b=d||m<K}else{for(d=c/(W[0]+1)|0,d>1&&(W=o(W,d,c),_=o(_,d,c),C=W.length,K=_.length),x=C,k=_.slice(0,C),T=k.length;T<C;)k[T++]=0;L=W.slice(),L.unshift(0),B=W[0],W[1]>=c/2&&++B;do d=0,u=e(W,k,C,T),u<0?(I=k[0],C!=T&&(I=I*c+(k[1]||0)),d=I/B|0,d>1?(d>=c&&(d=c-1),f=o(W,d,c),y=f.length,T=k.length,u=e(f,k,y,T),u==1&&(d--,t(f,C<y?L:W,y,c))):(d==0&&(u=d=1),f=W.slice()),y=f.length,y<T&&f.unshift(0),t(k,f,T,c),u==-1&&(T=k.length,u=e(W,k,C,T),u<1&&(d++,t(k,C<T?L:W,T,c))),T=k.length):u===0&&(d++,k=[0]),P[m++]=d,u&&k[0]?k[T++]=_[x]||0:(k=[_[x]],T=1);while((x++<K||k[0]!==void 0)&&h--);b=k[0]!==void 0}P[0]||P.shift()}if(p==1)g.e=l,du=b;else{for(m=1,d=P[0];d>=10;d/=10)m++;g.e=m+l*p-1,ne(g,a?r+g.e+1:r,s,b)}return g}}();function ne(o,e,t,n){var i,r,s,a,c,u,l,m,d,p=o.constructor;e:if(e!=null){if(m=o.d,!m)return o;for(i=1,a=m[0];a>=10;a/=10)i++;if(r=e-i,r<0)r+=re,s=e,l=m[d=0],c=l/Je(10,i-s-1)%10|0;else if(d=Math.ceil((r+1)/re),a=m.length,d>=a)if(n){for(;a++<=d;)m.push(0);l=c=0,i=1,r%=re,s=r-re+1}else break e;else{for(l=a=m[d],i=1;a>=10;a/=10)i++;r%=re,s=r-re+i,c=s<0?0:l/Je(10,i-s-1)%10|0}if(n=n||e<0||m[d+1]!==void 0||(s<0?l:l%Je(10,i-s-1)),u=t<4?(c||n)&&(t==0||t==(o.s<0?3:2)):c>5||c==5&&(t==4||n||t==6&&(r>0?s>0?l/Je(10,i-s):0:m[d-1])%10&1||t==(o.s<0?8:7)),e<1||!m[0])return m.length=0,u?(e-=o.e+1,m[0]=Je(10,(re-e%re)%re),o.e=-e||0):m[0]=o.e=0,o;if(r==0?(m.length=d,a=1,d--):(m.length=d+1,a=Je(10,re-r),m[d]=s>0?(l/Je(10,i-s)%Je(10,s)|0)*a:0),u)for(;;)if(d==0){for(r=1,s=m[0];s>=10;s/=10)r++;for(s=m[0]+=a,a=1;s>=10;s/=10)a++;r!=a&&(o.e++,m[0]==Gt&&(m[0]=1));break}else{if(m[d]+=a,m[d]!=Gt)break;m[d--]=0,a=1}for(r=m.length;m[--r]===0;)m.pop()}return le&&(o.e>p.maxE?(o.d=null,o.e=NaN):o.e<p.minE&&(o.e=0,o.d=[0])),o}function rn(o,e,t){if(!o.isFinite())return wu(o);var n,i=o.e,r=at(o.d),s=r.length;return e?(t&&(n=t-s)>0?r=r.charAt(0)+"."+r.slice(1)+Sn(n):s>1&&(r=r.charAt(0)+"."+r.slice(1)),r=r+(o.e<0?"e":"e+")+o.e):i<0?(r="0."+Sn(-i-1)+r,t&&(n=t-s)>0&&(r+=Sn(n))):i>=s?(r+=Sn(i+1-s),t&&(n=t-i-1)>0&&(r=r+"."+Sn(n))):((n=i+1)<s&&(r=r.slice(0,n)+"."+r.slice(n)),t&&(n=t-s)>0&&(i+1===s&&(r+="."),r+=Sn(n))),r}function jo(o,e){var t=o[0];for(e*=re;t>=10;t/=10)e++;return e}function Qo(o,e,t){if(e>sm)throw le=!0,t&&(o.precision=t),Error(pu);return ne(new o(Go),e,1,!0)}function Ut(o,e,t){if(e>As)throw Error(pu);return ne(new o(Xo),e,t,!0)}function gu(o){var e=o.length-1,t=e*re+1;if(e=o[e],e){for(;e%10==0;e/=10)t--;for(e=o[0];e>=10;e/=10)t++}return t}function Sn(o){for(var e="";o--;)e+="0";return e}function Au(o,e,t,n){var i,r=new o(1),s=Math.ceil(n/re+4);for(le=!1;;){if(t%2&&(r=r.times(e),lu(r.d,s)&&(i=!0)),t=dt(t/2),t===0){t=r.d.length-1,i&&r.d[t]===0&&++r.d[t];break}e=e.times(e),lu(e.d,s)}return le=!0,r}function cu(o){return o.d[o.d.length-1]&1}function Pu(o,e,t){for(var n,i=new o(e[0]),r=0;++r<e.length;)if(n=new o(e[r]),n.s)i[t](n)&&(i=n);else{i=n;break}return i}function Ps(o,e){var t,n,i,r,s,a,c,u=0,l=0,m=0,d=o.constructor,p=d.rounding,b=d.precision;if(!o.d||!o.d[0]||o.e>17)return new d(o.d?o.d[0]?o.s<0?0:1/0:1:o.s?o.s<0?0:o:0/0);for(e==null?(le=!1,c=b):c=e,a=new d(.03125);o.e>-2;)o=o.times(a),m+=5;for(n=Math.log(Je(2,m))/Math.LN10*2+5|0,c+=n,t=r=s=new d(1),d.precision=c;;){if(r=ne(r.times(o),c,1),t=t.times(++l),a=s.plus(Le(r,t,c,1)),at(a.d).slice(0,c)===at(s.d).slice(0,c)){for(i=m;i--;)s=ne(s.times(s),c,1);if(e==null)if(u<3&&Mi(s.d,c-n,p,u))d.precision=c+=10,t=r=a=new d(1),l=0,u++;else return ne(s,d.precision=b,p,le=!0);else return d.precision=b,s}s=a}}function Kn(o,e){var t,n,i,r,s,a,c,u,l,m,d,p=1,b=10,f=o,y=f.d,g=f.constructor,P=g.rounding,k=g.precision;if(f.s<0||!y||!y[0]||!f.e&&y[0]==1&&y.length==1)return new g(y&&!y[0]?-1/0:f.s!=1?NaN:y?0:f);if(e==null?(le=!1,l=k):l=e,g.precision=l+=b,t=at(y),n=t.charAt(0),Math.abs(r=f.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)f=f.times(o),t=at(f.d),n=t.charAt(0),p++;r=f.e,n>1?(f=new g("0."+t),r++):f=new g(n+"."+t.slice(1))}else return u=Qo(g,l+2,k).times(r+""),f=Kn(new g(n+"."+t.slice(1)),l-b).plus(u),g.precision=k,e==null?ne(f,k,P,le=!0):f;for(m=f,c=s=f=Le(f.minus(1),f.plus(1),l,1),d=ne(f.times(f),l,1),i=3;;){if(s=ne(s.times(d),l,1),u=c.plus(Le(s,new g(i),l,1)),at(u.d).slice(0,l)===at(c.d).slice(0,l))if(c=c.times(2),r!==0&&(c=c.plus(Qo(g,l+2,k).times(r+""))),c=Le(c,new g(p),l,1),e==null)if(Mi(c.d,l-b,P,a))g.precision=l+=b,u=s=f=Le(m.minus(1),m.plus(1),l,1),d=ne(f.times(f),l,1),i=a=1;else return ne(c,g.precision=k,P,le=!0);else return g.precision=k,c;c=u,i+=2}}function wu(o){return String(o.s*o.s/0)}function ws(o,e){var t,n,i;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(i=e.length;e.charCodeAt(i-1)===48;--i);if(e=e.slice(n,i),e){if(i-=n,o.e=t=t-n-1,o.d=[],n=(t+1)%re,t<0&&(n+=re),n<i){for(n&&o.d.push(+e.slice(0,n)),i-=re;n<i;)o.d.push(+e.slice(n,n+=re));e=e.slice(n),n=re-e.length}else n-=i;for(;n--;)e+="0";o.d.push(+e),le&&(o.e>o.constructor.maxE?(o.d=null,o.e=NaN):o.e<o.constructor.minE&&(o.e=0,o.d=[0]))}else o.e=0,o.d=[0];return o}function um(o,e){var t,n,i,r,s,a,c,u,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),yu.test(e))return ws(o,e)}else if(e==="Infinity"||e==="NaN")return+e||(o.s=NaN),o.e=NaN,o.d=null,o;if(im.test(e))t=16,e=e.toLowerCase();else if(nm.test(e))t=2;else if(om.test(e))t=8;else throw Error(Cn+e);for(r=e.search(/p/i),r>0?(c=+e.slice(r+1),e=e.substring(2,r)):e=e.slice(2),r=e.indexOf("."),s=r>=0,n=o.constructor,s&&(e=e.replace(".",""),a=e.length,r=a-r,i=Au(n,new n(t),r,r*2)),u=Uo(e,t,Gt),l=u.length-1,r=l;u[r]===0;--r)u.pop();return r<0?new n(o.s*0):(o.e=jo(u,l),o.d=u,le=!1,s&&(o=Le(o,i,a*4)),c&&(o=o.times(Math.abs(c)<54?Je(2,c):vi.pow(2,c))),le=!0,o)}function cm(o,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:li(o,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/Ho(5,t)),e=li(o,2,e,e);for(var i,r=new o(5),s=new o(16),a=new o(20);t--;)i=e.times(e),e=e.times(r.plus(i.times(s.times(i).minus(a))));return e}function li(o,e,t,n,i){var r,s,a,c,u=1,l=o.precision,m=Math.ceil(l/re);for(le=!1,c=t.times(t),a=new o(n);;){if(s=Le(a.times(c),new o(e++*e++),l,1),a=i?n.plus(s):n.minus(s),n=Le(s.times(c),new o(e++*e++),l,1),s=a.plus(n),s.d[m]!==void 0){for(r=m;s.d[r]===a.d[r]&&r--;);if(r==-1)break}r=a,a=n,n=s,s=r,u++}return le=!0,s.d.length=m+1,s}function Ho(o,e){for(var t=o;--e;)t*=o;return t}function ku(o,e){var t,n=e.s<0,i=Ut(o,o.precision,1),r=i.times(.5);if(e=e.abs(),e.lte(r))return yn=n?4:1,e;if(t=e.divToInt(i),t.isZero())yn=n?3:2;else{if(e=e.minus(t.times(i)),e.lte(r))return yn=cu(t)?n?2:3:n?4:1,e;yn=cu(t)?n?1:4:n?3:2}return e.minus(i).abs()}function ks(o,e,t,n){var i,r,s,a,c,u,l,m,d,p=o.constructor,b=t!==void 0;if(b?(Tt(t,1,Ln),n===void 0?n=p.rounding:Tt(n,0,8)):(t=p.precision,n=p.rounding),!o.isFinite())l=wu(o);else{for(l=rn(o),s=l.indexOf("."),b?(i=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):i=e,s>=0&&(l=l.replace(".",""),d=new p(1),d.e=l.length-s,d.d=Uo(rn(d),10,i),d.e=d.d.length),m=Uo(l,10,i),r=c=m.length;m[--c]==0;)m.pop();if(!m[0])l=b?"0p+0":"0";else{if(s<0?r--:(o=new p(o),o.d=m,o.e=r,o=Le(o,d,t,n,0,i),m=o.d,r=o.e,u=du),s=m[t],a=i/2,u=u||m[t+1]!==void 0,u=n<4?(s!==void 0||u)&&(n===0||n===(o.s<0?3:2)):s>a||s===a&&(n===4||u||n===6&&m[t-1]&1||n===(o.s<0?8:7)),m.length=t,u)for(;++m[--t]>i-1;)m[t]=0,t||(++r,m.unshift(1));for(c=m.length;!m[c-1];--c);for(s=0,l="";s<c;s++)l+=ys.charAt(m[s]);if(b){if(c>1)if(e==16||e==8){for(s=e==16?4:3,--c;c%s;c++)l+="0";for(m=Uo(l,i,e),c=m.length;!m[c-1];--c);for(s=1,l="1.";s<c;s++)l+=ys.charAt(m[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(r<0?"p":"p+")+r}else if(r<0){for(;++r;)l="0"+l;l="0."+l}else if(++r>c)for(r-=c;r--;)l+="0";else r<c&&(l=l.slice(0,r)+"."+l.slice(r))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return o.s<0?"-"+l:l}function lu(o,e){if(o.length>e)return o.length=e,!0}function lm(o){return new this(o).abs()}function mm(o){return new this(o).acos()}function dm(o){return new this(o).acosh()}function pm(o,e){return new this(o).plus(e)}function fm(o){return new this(o).asin()}function bm(o){return new this(o).asinh()}function ym(o){return new this(o).atan()}function gm(o){return new this(o).atanh()}function Am(o,e){o=new this(o),e=new this(e);var t,n=this.precision,i=this.rounding,r=n+4;return!o.s||!e.s?t=new this(NaN):!o.d&&!e.d?(t=Ut(this,r,1).times(e.s>0?.25:.75),t.s=o.s):!e.d||o.isZero()?(t=e.s<0?Ut(this,n,i):new this(0),t.s=o.s):!o.d||e.isZero()?(t=Ut(this,r,1).times(.5),t.s=o.s):e.s<0?(this.precision=r,this.rounding=1,t=this.atan(Le(o,e,r,1)),e=Ut(this,r,1),this.precision=n,this.rounding=i,t=o.s<0?t.minus(e):t.plus(e)):t=this.atan(Le(o,e,r,1)),t}function Pm(o){return new this(o).cbrt()}function wm(o){return ne(o=new this(o),o.e+1,2)}function km(o,e,t){return new this(o).clamp(e,t)}function hm(o){if(!o||typeof o!="object")throw Error(zo+"Object expected");var e,t,n,i=o.defaults===!0,r=["precision",1,Ln,"rounding",0,8,"toExpNeg",-ci,0,"toExpPos",0,ci,"maxE",0,ci,"minE",-ci,0,"modulo",0,9];for(e=0;e<r.length;e+=3)if(t=r[e],i&&(this[t]=gs[t]),(n=o[t])!==void 0)if(dt(n)===n&&n>=r[e+1]&&n<=r[e+2])this[t]=n;else throw Error(Cn+t+": "+n);if(t="crypto",i&&(this[t]=gs[t]),(n=o[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(fu);else this[t]=!1;else throw Error(Cn+t+": "+n);return this}function Tm(o){return new this(o).cos()}function Im(o){return new this(o).cosh()}function hu(o){var e,t,n;function i(r){var s,a,c,u=this;if(!(u instanceof i))return new i(r);if(u.constructor=i,mu(r)){u.s=r.s,le?!r.d||r.e>i.maxE?(u.e=NaN,u.d=null):r.e<i.minE?(u.e=0,u.d=[0]):(u.e=r.e,u.d=r.d.slice()):(u.e=r.e,u.d=r.d?r.d.slice():r.d);return}if(c=typeof r,c==="number"){if(r===0){u.s=1/r<0?-1:1,u.e=0,u.d=[0];return}if(r<0?(r=-r,u.s=-1):u.s=1,r===~~r&&r<1e7){for(s=0,a=r;a>=10;a/=10)s++;le?s>i.maxE?(u.e=NaN,u.d=null):s<i.minE?(u.e=0,u.d=[0]):(u.e=s,u.d=[r]):(u.e=s,u.d=[r]);return}else if(r*0!==0){r||(u.s=NaN),u.e=NaN,u.d=null;return}return ws(u,r.toString())}else if(c!=="string")throw Error(Cn+r);return(a=r.charCodeAt(0))===45?(r=r.slice(1),u.s=-1):(a===43&&(r=r.slice(1)),u.s=1),yu.test(r)?ws(u,r):um(u,r)}if(i.prototype=G,i.ROUND_UP=0,i.ROUND_DOWN=1,i.ROUND_CEIL=2,i.ROUND_FLOOR=3,i.ROUND_HALF_UP=4,i.ROUND_HALF_DOWN=5,i.ROUND_HALF_EVEN=6,i.ROUND_HALF_CEIL=7,i.ROUND_HALF_FLOOR=8,i.EUCLID=9,i.config=i.set=hm,i.clone=hu,i.isDecimal=mu,i.abs=lm,i.acos=mm,i.acosh=dm,i.add=pm,i.asin=fm,i.asinh=bm,i.atan=ym,i.atanh=gm,i.atan2=Am,i.cbrt=Pm,i.ceil=wm,i.clamp=km,i.cos=Tm,i.cosh=Im,i.div=Bm,i.exp=xm,i.floor=Sm,i.hypot=Km,i.ln=Cm,i.log=Lm,i.log10=Nm,i.log2=Rm,i.max=Om,i.min=Mm,i.mod=vm,i.mul=Em,i.pow=_m,i.random=Vm,i.round=Fm,i.sign=Dm,i.sin=Wm,i.sinh=qm,i.sqrt=Um,i.sub=Gm,i.sum=Xm,i.tan=Qm,i.tanh=zm,i.trunc=jm,o===void 0&&(o={}),o&&o.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)o.hasOwnProperty(t=n[e++])||(o[t]=this[t]);return i.config(o),i}function Bm(o,e){return new this(o).div(e)}function xm(o){return new this(o).exp()}function Sm(o){return ne(o=new this(o),o.e+1,3)}function Km(){var o,e,t=new this(0);for(le=!1,o=0;o<arguments.length;)if(e=new this(arguments[o++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return le=!0,new this(1/0);t=e}return le=!0,t.sqrt()}function mu(o){return o instanceof vi||o&&o.toStringTag===bu||!1}function Cm(o){return new this(o).ln()}function Lm(o,e){return new this(o).log(e)}function Rm(o){return new this(o).log(2)}function Nm(o){return new this(o).log(10)}function Om(){return Pu(this,arguments,"lt")}function Mm(){return Pu(this,arguments,"gt")}function vm(o,e){return new this(o).mod(e)}function Em(o,e){return new this(o).mul(e)}function _m(o,e){return new this(o).pow(e)}function Vm(o){var e,t,n,i,r=0,s=new this(1),a=[];if(o===void 0?o=this.precision:Tt(o,1,Ln),n=Math.ceil(o/re),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));r<n;)i=e[r],i>=429e7?e[r]=crypto.getRandomValues(new Uint32Array(1))[0]:a[r++]=i%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);r<n;)i=e[r]+(e[r+1]<<8)+(e[r+2]<<16)+((e[r+3]&127)<<24),i>=214e7?crypto.randomBytes(4).copy(e,r):(a.push(i%1e7),r+=4);r=n/4}else throw Error(fu);else for(;r<n;)a[r++]=Math.random()*1e7|0;for(n=a[--r],o%=re,n&&o&&(i=Je(10,re-o),a[r]=(n/i|0)*i);a[r]===0;r--)a.pop();if(r<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=re)a.shift();for(n=1,i=a[0];i>=10;i/=10)n++;n<re&&(t-=re-n)}return s.e=t,s.d=a,s}function Fm(o){return ne(o=new this(o),o.e+1,this.rounding)}function Dm(o){return o=new this(o),o.d?o.d[0]?o.s:0*o.s:o.s||NaN}function Wm(o){return new this(o).sin()}function qm(o){return new this(o).sinh()}function Um(o){return new this(o).sqrt()}function Gm(o,e){return new this(o).sub(e)}function Xm(){var o=0,e=arguments,t=new this(e[o]);for(le=!1;t.s&&++o<e.length;)t=t.plus(e[o]);return le=!0,ne(t,this.precision,this.rounding)}function Qm(o){return new this(o).tan()}function zm(o){return new this(o).tanh()}function jm(o){return ne(o=new this(o),o.e+1,1)}G[Symbol.for("nodejs.util.inspect.custom")]=G.toString;G[Symbol.toStringTag]="Decimal";var vi=G.constructor=hu(gs);Go=new vi(Go);Xo=new vi(Xo);var O=vi;import nd from"big.js";import $o from"bn.js";import Hm from"toformat";var Ym=Hm,Ei=Ym;import Zo from"big.js";import $m from"bn.js";import Jm from"decimal.js-light";import _i from"bn.js";var Tu=9007199254740991;function ee(o){let e=fe("Raydium_parseBigNumberish");if(o instanceof _i)return o;if(typeof o=="string"){if(o.match(/^-?[0-9]+$/))return new _i(o);e.logWithError(`invalid BigNumberish string: ${o}`)}return typeof o=="number"?(o%1&&e.logWithError(`BigNumberish number underflow: ${o}`),(o>=Tu||o<=-Tu)&&e.logWithError(`BigNumberish number overflow: ${o}`),new _i(String(o))):typeof o=="bigint"?new _i(o.toString()):(e.error(`invalid BigNumberish value: ${o}`),new _i(0))}var Yo=fe("module/fraction"),hs=Ei(Zo),Vi=Ei(Jm),ed={[0]:Vi.ROUND_DOWN,[1]:Vi.ROUND_HALF_UP,[2]:Vi.ROUND_UP},td={[0]:Zo.roundDown,[1]:Zo.roundHalfUp,[2]:Zo.roundUp},ke=class{constructor(e,t=new $m(1)){this.numerator=ee(e),this.denominator=ee(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new ke(this.denominator,this.numerator)}add(e){let t=e instanceof ke?e:new ke(ee(e));return this.denominator.eq(t.denominator)?new ke(this.numerator.add(t.numerator),this.denominator):new ke(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof ke?e:new ke(ee(e));return this.denominator.eq(t.denominator)?new ke(this.numerator.sub(t.numerator),this.denominator):new ke(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof ke?e:new ke(ee(e));return new ke(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof ke?e:new ke(ee(e));return new ke(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||Yo.logWithError(`${e} is not an integer.`),e<=0&&Yo.logWithError(`${e} is not positive.`),Vi.set({precision:e+1,rounding:ed[n]});let i=new Vi(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return i.toFormat(i.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||Yo.logWithError(`${e} is not an integer.`),e<0&&Yo.logWithError(`${e} is negative.`),hs.DP=e,hs.RM=td[n]||1,new hs(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var id=fe("Raydium_amount"),Iu=Ei(nd);function od(o,e){let t="0",n="0";if(o.includes(".")){let i=o.split(".");i.length===2?([t,n]=i,n=n.padEnd(e,"0")):id.logWithError(`invalid number string, num: ${o}`)}else t=o;return[t,n.slice(0,e)||n]}var Ie=class extends ke{constructor(t,n,i=!0,r){let s=new $o(0),a=Ts.pow(new $o(t.decimals));if(i)s=ee(n);else{let c=new $o(0),u=new $o(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=od(n.toString(),t.decimals);c=ee(l),u=ee(m)}c=c.mul(a),s=c.add(u)}super(s,a);this.logger=fe(r||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new Ie(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new Ie(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,i=0){return super.toSignificant(t,n,i)}toFixed(t=this.token.decimals,n,i=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,i)}toExact(t={groupSeparator:""}){return Iu.DP=this.token.decimals,new Iu(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as rd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Bu}from"@solana/spl-token";var sn={chainId:101,address:rd.default.toBase58(),programId:Bu.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},nt={chainId:101,address:"So11111111111111111111111111111111111111112",programId:Bu.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as Ks}from"@solana/web3.js";import{PublicKey as _e,SystemProgram as xu,SYSVAR_RENT_PUBKEY as sd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ad}from"@solana/spl-token";function A({pubkey:o,isSigner:e=!1,isWritable:t=!0}){return{pubkey:o,isWritable:t,isSigner:e}}var Is=[A({pubkey:ad,isWritable:!1}),A({pubkey:xu.programId,isWritable:!1}),A({pubkey:sd,isWritable:!1})];function Bs({publicKey:o,transformSol:e}){let t=xs(o.toString());if(t instanceof _e)return e&&t.equals(it)?$:t;if(e&&t.toString()===it.toBase58())return $;if(typeof t=="string"){if(t===_e.default.toBase58())return _e.default;try{return new _e(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function xs(o){try{return new _e(o)}catch{return o}}var Jo=new _e("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),an=new _e("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),He=new _e("SysvarRent111111111111111111111111111111111"),Ss=new _e("SysvarC1ock11111111111111111111111111111111"),Xt=new _e("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),er=new _e("Sysvar1nstructions1111111111111111111111111"),tr=xu.programId,ny=new _e("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),iy=new _e("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),oy=new _e("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),ry=new _e("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),sy=new _e("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),ay=new _e("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),uy=new _e("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),cy=new _e("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),ly=new _e("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),my=new _e("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),dy=new _e("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),$=new _e("So11111111111111111111111111111111111111112"),it=_e.default;function mt(o){return Bs({publicKey:o,transformSol:!0})}var Cs=class{constructor({mint:e,decimals:t,symbol:n,name:i,skipMint:r=!1,isToken2022:s=!1}){if(e===it.toBase58()||e instanceof Ks&&it.equals(e)){this.decimals=nt.decimals,this.symbol=nt.symbol,this.name=nt.name,this.mint=new Ks(nt.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=i||e.toString().substring(0,6),this.mint=r?Ks.default:Bs({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Ve=Cs;Ve.WSOL=new Cs(U(v({},nt),{mint:nt.address}));var Ls=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},nr=Ls;nr.SOL=new Ls(sn);import ud from"bn.js";var Su=new ke(new ud(100)),ot=class extends ke{toSignificant(e=5,t,n){return this.mul(Su).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Su).toFixed(e,t,n)}};var cd=fe("Raydium_price"),It=class extends ke{constructor(t){let{baseToken:n,quoteToken:i,numerator:r,denominator:s}=t;super(r,s);this.baseToken=n,this.quoteToken=i,this.scalar=new ke(Rs(n.decimals),Rs(i.decimals))}get raw(){return new ke(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new It({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&cd.logWithError("mul token not equals");let n=super.mul(t);return new It({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,i){return this.adjusted.toSignificant(t,n,i)}toFixed(t=this.quoteToken.decimals,n,i){return this.adjusted.toFixed(t,n,i)}};import{PublicKey as ld}from"@solana/web3.js";import md from"bn.js";function Ku(o){return typeof o=="object"&&o!==null&&![Ve,Ie,ld,ke,md,It,ot].some(e=>typeof e=="object"&&o instanceof e)}function Oe(o){return typeof o=="string"?xs(o):Array.isArray(o)?o.map(e=>Oe(e)):Ku(o)?Object.fromEntries(Object.entries(o).map(([e,t])=>[e,Oe(t)])):o}var Bt=new un(0),Cu=new un(1),ag=new un(2),ug=new un(3),cg=new un(5),Ts=new un(10),lg=new un(100),mg=new un(1e3),dg=new un(1e4);function Rs(o){return Ts.pow(ee(o))}function ir(o,e){let t=o.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}function or(o,e,t){return o.mul(e).add(t).sub(new un(1)).div(t)}function Ns(o,e,t){return o.mul(e).div(t)}var Lu=o=>typeof o=="number";function Ru(o,e,t){let n=Lu(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(o).getTime()<=n}function Nu(o,e,t){let n=Lu(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(o).getTime()>n}function bs(o,e=1,t=[]){let n=[...o];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}var Qt=class{constructor(e){this._owner=e}get publicKey(){return Qt.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return Qt.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return Qt.isKeyPair(this._owner)}get isPublicKey(){return Qt.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!Qt.isKeyPair(e)}};import{PublicKey as gd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ad}from"@solana/spl-token";import{ComputeBudgetProgram as Ou,Keypair as Mu,PublicKey as vu,Transaction as rr,TransactionMessage as dd,VersionedTransaction as Eu}from"@solana/web3.js";var X={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV4Withdraw:"FarmV4Withdraw",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut",CpmmLockLp:"CpmmLockLp",CpmmCollectLockFee:"CpmmCollectLockFee",TransferTip:"TransferTip"};import{TOKEN_PROGRAM_ID as pd}from"@solana/spl-token";var gn=fe("Raydium_txUtil"),_u=1644;function sr(o){let e=[],t=[];return o.microLamports&&(e.push(Ou.setComputeUnitPrice({microLamports:o.microLamports})),t.push(X.SetComputeUnitPrice)),o.units&&(e.push(Ou.setComputeUnitLimit({units:o.units})),t.push(X.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function mi(o,e){var n,i;let t=e!=null?e:"confirmed";return(i=await((n=o.getLatestBlockhash)==null?void 0:n.call(o,{commitment:t})))==null?void 0:i.blockhash}async function Os(o,e){return o.getSignatureStatuses([e]),new Promise((t,n)=>{let i=setTimeout(n,6e4);o.onSignature(e,r=>{if(clearTimeout(i),!r.err){t("");return}n(Object.assign(r.err,{txId:e}))},"confirmed")})}function ar(o,e){o.length<1&&gn.logWithError(`no instructions provided: ${o.toString()}`),e.length<1&&gn.logWithError(`no signers provided:, ${e.toString()}`);let t=new rr;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...o);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<_u}catch{return!1}}async function Vu(o,e,t,n=!0){let i=new vu("RaydiumSimuLateTransaction11111111111111111"),r=[],s=new rr;s.feePayer=i;for(let u of e)ar([...s.instructions,u],[i])||(r.push(s),s=new rr,s.feePayer=i),s.add(u);s.instructions.length>0&&r.push(s);let a=[];try{if(a=await fd(o,r,n),a.find(u=>u.err!==null))throw Error("rpc simulateTransaction error")}catch(u){u instanceof Error&&gn.logWithError("failed to simulate for instructions","RPC_ERROR",{message:u.message})}let c=[];for(let u of a)if(gn.debug("simulate result:",u),u.logs){let l=u.logs.filter(m=>m&&m.includes(t));gn.debug("filteredLog:",c),l.length||gn.logWithError("simulate log not match keyword","keyword",t),c.push(...l)}return c}function Fu(o,e){let t=o.match(/{["\w:,]+}/g);return!t||t.length!==1?gn.logWithError(`simulate log fail to match json, keyword: ${e}`):t[0]}function An(o,e){let n=new RegExp(`"${e}":(\\d+)`,"g").exec(o);return!n||n.length!==2?gn.logWithError(`simulate log fail to match key", key: ${e}`):n[1]}function ie(o,e){let[t,n]=vu.findProgramAddressSync(o,e);return{publicKey:t,nonce:n}}async function fd(o,e,t){let n=[];if(t){let i=await o.getLatestBlockhash(),r=[];for(let u of e){u.recentBlockhash=i.blockhash,u.lastValidBlockHeight=i.lastValidBlockHeight;let m=u._compile().serialize(),p=u._serialize(m).toString("base64");r.push(p)}let s=r.map(u=>{let l=o._buildArgs([u],void 0,"base64");return{methodName:"simulateTransaction",args:l}}),a=[],c=20;for(let u=0;u<Math.ceil(s.length/c);u++)a.push(s.slice(u*c,(u+1)*c));n=await(await Promise.all(a.map(async u=>(await o._rpcBatchRequest(u)).map(l=>l.result.value)))).flat()}else try{n=await Promise.all(e.map(async i=>await(await o.simulateTransaction(i)).value))}catch(i){i instanceof Error&&gn.logWithError("failed to get info for multiple accounts","RPC_ERROR",{message:i.message})}return n}function Fi({instructions:o,payer:e,signers:t}){return ar(o,[e,...t])}function ur({instructions:o,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=Mu.generate().publicKey.toString()}){let r=new dd({payerKey:e,recentBlockhash:n,instructions:o}).compileToV0Message(Object.values(t!=null?t:{}));try{return Buffer.from(new Eu(r).serialize()).toString("base64").length<_u}catch{return!1}}var bd=o=>Buffer.isBuffer(o)?o:o instanceof Uint8Array?Buffer.from(o.buffer,o.byteOffset,o.byteLength):Buffer.from(o),yd=o=>{let e=o.serialize({requireAllSignatures:!1,verifySignatures:!1});o instanceof Eu&&(e=bd(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function di(o){let e=[];return o.forEach(t=>{t instanceof rr&&(t.recentBlockhash||(t.recentBlockhash=pd.toBase58()),t.feePayer||(t.feePayer=Mu.generate().publicKey)),e.push(yd(t))}),console.log("simulate tx string:",e),e}function J(o,e,t){return ie([o.toBuffer(),(t!=null?t:Ad).toBuffer(),e.toBuffer()],new gd("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as me}from"@solana/web3.js";var Ms=new me("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),Du=new me("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),vs=new me("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),pi=new me("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),Pd=new me("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),Es=new me("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),cr=new me("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),Di=new me("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),wd=new me("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),lr=new me("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Rn=new me("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),fi=new me("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Wi=new me("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),kd=new me("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),_s=new me("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),hd=new me("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),Td=new me("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),Id=new me("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),Bd=new me("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),qi=new me("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),Vs=new me("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),xd=new me("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),Sd=new me("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),Kd=new me("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),Cd=new me("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),Ui=new me("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Ld=new me("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),Gi=new me("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),Rd=new me("7AFUeLVRjBfzqK3tTGw8hN48KLQWSk6DTE8xprWdPqix"),zt=new me("LanMV9sAd7wArD4vJFi2qDdfnVhFxYSUg6eADduJ3uj"),Nd=new me("WLHv2UAZm6z4KyaaELi5pjdbJh6RESMva1Rnn8pJVVh"),Od=new me("LanD8FpTBBvzZFXjTxsAoipkFsxPUCDB4qAqKxYDiNP"),Md=new me("HYNHiyKJ3gGVFvyxJAurK7qr7P2o5J9THmvCGMdULtpW"),Xi={IDO_PROGRAM_ID_V1:hd,IDO_PROGRAM_ID_V2:Td,IDO_PROGRAM_ID_V3:Id,IDO_PROGRAM_ID_V4:Bd},At={AMM_V4:Di,AMM_STABLE:wd,CLMM_PROGRAM_ID:Rn,CLMM_LOCK_PROGRAM_ID:fi,CLMM_LOCK_AUTH_ID:Wi,FARM_PROGRAM_ID_V3:Ms,FARM_PROGRAM_ID_V5:vs,FARM_PROGRAM_ID_V6:pi,OPEN_BOOK_PROGRAM:Es,SERUM_PROGRAM_ID_V3:cr,UTIL1216:Pd,Router:kd,CREATE_CPMM_POOL_PROGRAM:qi,CREATE_CPMM_POOL_AUTH:Vs,CREATE_CPMM_POOL_FEE_ACC:xd,LOCK_CPMM_PROGRAM:Ui,LOCK_CPMM_AUTH:Gi,LAUNCHPAD_PROGRAM:zt,LAUNCHPAD_AUTH:Nd,FEE_DESTINATION_ID:_s},Og={AMM_V4:new me("HWy1jotHpo6UqeQxx49dpYYdQB8wj9Qk9MdxwjLvDHB8"),AMM_STABLE:new me("DDg4VmQaJV9ogWce7LpcjBA9bv22wRp5uaTPa5pGjijF"),CLMM_PROGRAM_ID:new me("devi51mZmdwUJGU9hjN27vEz64Gps7uUefqxg27EAtH"),CLMM_LOCK_PROGRAM_ID:new me("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),CLMM_LOCK_AUTH_ID:new me("8qmHNvu2Kr2C7U8mJL4Vz1vTDxMhVuXKREwU7TNoaVEo"),FARM_PROGRAM_ID_V3:new me("85BFyr98MbCUU9MVTEgzx1nbhWACbJqLzho6zd6DZcWL"),FARM_PROGRAM_ID_V5:new me("EcLzTrNg9V7qhcdyXDe2qjtPkiGzDM2UbdRaeaadU5r2"),FARM_PROGRAM_ID_V6:new me("Farm2hJLcqPtPg8M4rR6DMrsRNc5TPm5Cs4bVQrMe2T7"),OPEN_BOOK_PROGRAM:new me("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),SERUM_PROGRAM_ID_V3:me.default,UTIL1216:me.default,Router:new me("BVChZ3XFEwTMUk1o9i3HAf91H6mFxSwa5X2wFAWhYPhU"),CREATE_CPMM_POOL_PROGRAM:Sd,CREATE_CPMM_POOL_AUTH:Kd,CREATE_CPMM_POOL_FEE_ACC:Cd,LOCK_CPMM_PROGRAM:Ld,LOCK_CPMM_AUTH:Rd,LAUNCHPAD_PROGRAM:Od,LAUNCHPAD_AUTH:Md,FEE_DESTINATION_ID:new me("3XMrhbv989VxAMi3DErLV9eJht1pHppW5LbKxe9fkEFR")};import Pt from"bn.js";var Qi=1e4;function he(o,e,t,n){if(e===void 0)return{amount:o,fee:void 0,expirationTime:void 0};let i=U(v({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),r=t.epoch<i.newerTransferFee.epoch?i.olderTransferFee:i.newerTransferFee,s=new Pt(r.maximumFee.toString()),a=t.epoch<i.newerTransferFee.epoch?(Number(i.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(r.transferFeeBasisPoints===Qi){let c=new Pt(r.maximumFee.toString());return{amount:o.add(c),fee:c,expirationTime:a}}else{let c=Nn(o.mul(new Pt(Qi)),new Pt(Qi-r.transferFeeBasisPoints)),u=new Pt(r.maximumFee.toString()),l=c.sub(o).gt(u)?o.add(u):c,m=Nn(l.mul(new Pt(r.transferFeeBasisPoints)),new Pt(Qi)),d=m.gt(s)?s:m;return{amount:l,fee:d,expirationTime:a}}else{let c=Nn(o.mul(new Pt(r.transferFeeBasisPoints)),new Pt(Qi)),u=c.gt(s)?s:c;return{amount:o,fee:u,expirationTime:a}}}function jt(o,e){return o===void 0?e:e===void 0?o:Math.min(o,e)}function Nn(o,e){let{div:t,mod:n}=o.divmod(e);return n.gt(new Pt(0))?t.add(new Pt(1)):t}function mr(o,e){if(o.isZero())return new Pt(0);let t=o.div(e);return t.isZero()?new Pt(1):o.mod(e).gt(new Pt(0))?t.add(new Pt(1)):t}import{PublicKey as Wu,AddressLookupTableAccount as dr}from"@solana/web3.js";async function Fs({connection:o,address:e}){let t=await qt(o,[...new Set(e.map(i=>i.toString()))].map(i=>new Wu(i))),n={};for(let i=0;i<e.length;i++){let r=t[i],s=e[i];if(!r)continue;let a=new dr({key:s,state:dr.deserialize(r.data)});n[s.toString()]=a,pr[s.toString()]=a}return n}var pr={AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU:new dr({key:new Wu("AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU"),state:dr.deserialize(Buffer.from("AQAAAP//////////I1rcEwAAAAAvAQYwun9CU6c5Ikm2pAj+D9IEnCOR45nK+SFTGSdpd6J6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbd9uHXZaGT2cvhRs7reawctIXtX1s3kTqM9YV+/wCpBt324e51j94YQl285GzN2rYa/E2DuQ0n/r35KNihi/wFSlNQ+F3IgtYUpVZyeIopbd8eq6vQpgZ4iEky9O72oAVKU1qZKSEGTSTocWDaOHx8NbXdvJK7geQfqEBBBUSNBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvBkX2T9y7AHdNGviJAqQNtlDUDCnauQRWybsLji6nPM8Qkw5asQRvCdB3MbX6IEBwytOrpM32l4jQygKG9TKgR0vZScQ2AsM/IHeQ7RajUkyhuZdc8SGiqQz/7H34torNR/Wir3sl0ruUrVxJWEZfUg+QLNAxxODdBi53/OP7Ioil1cqeBM9dtZC3FLov4yyxWRM/wcGStyJX/QfTnLBAHqkqWotPKVlShCVQqpP9W5W1rOao65IMk5QuQ2kMIOxzDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu/YsA/yfEEFGcr8Z57VKDw8uQzpiru7g4lvjnfapW62W030syevD8k07SGoxUHiuT/ai7gAHWWhDsVmg/C63ajgpkH7Sn3GdutArDTfyqOkdqv4/IPC/EFFy7mGkfDd2C57N5a/4jC+BbmJy7wQaSEZr0CQU88lPtUxIVvzGjC95b8Ooss2TqmkrayGKofkPMGQn7Ux+9lfwBSNfxwH8NgbpqC/7LNlV4I7nCvsXf3p+ohQk9NrAJb2KAFpUqEIJ9ZBV7BYDzHF/ORKYlgtvPnXjudZQ6CEo5OzUDaNIomTCCsvhD16TxJjsbgne1kGnQPCFSoaxUbq2V1bPMFQ3VYP6wDZ9bKStCFKx9A3tNbwZFC5ZGAN83MFK7XoTy+OmmcFEr6rLOjfSuTfPvHJkSVxW6Qllwkl67XcBi5v00u2gQsbu+38sp+rd5pA/LvyWj4P94ZGZwc1tE2P88xekCLcAwZGb+UhFzL/7K26csOb57yM5bvF9xJrLEObOkAAAAAn+HWRkdcPKyFFMnVwEoD7vnD0jCKFIU1sImubYCxNTSVzsKpaQX+fzNxrLAI3L14JQnJx/D6Uk2LADIHGqnGELzjEbkBDAlaM77NkXMPfqXNLSveCkWI7UEgNs31WEWB6XHSYI/v5DklHOb4QTtDOR804PVbi3fjloZeLR2F8d4FuZmMMO7ck3Fnkn2zEMG5gOmqsygb6PjTitArVl52NhcSznTxVnguaIJxiZkAnurDmn3MWR0PC2GLghp2KJqHCc6QQ85odeIjFHKOlRlJyeSXVJmL8vb1UgOzsbJPVP8p6zM4M3C1Sd7uWIHP33G42AP2Zg8ucn/n6meQjjD266JgCWdxZD6PXs9CsnIeL7SSG0/6lGb9xfP0ZcWkCXB/3hjxHYVXjra/GPOeXGk0fLLKjCbk+mgs2w6d2oCwimBipTzuoZ30GiI8ij8VRzD5CzMWtu2m21eDBIfjGAEo4pQeNNonKcqzV/cleX8ySZLOHsz8PtBCrLqF+VkLm9hOzIT+6i/nIf6keR4GWKMOD4AvqfpjHoD4DuhBpz8P28+DxkGrDXXr/nr20x291VPvcTU/b+b+o2kC9G0kcXeTlLjU6a2TQXWlZ4gBUdBl1jgT7mObSTpLblNiXZsLkbmVXZwvFKXua5cUKlWed/w30skmEUraTuQqtqr5fHZPW9n57EmeTif6LjHL2YJFZkQU+TrJmFzqzmF4/b8OwrPQAprl8mX3q4LUIdAS/a+11B6DWD1Xk2++Sn94dLC4xjkO4Wtlw8c4XuzciVbepHOmnoWzVu/0y3KCrLCSfQxQ3br8DJCoVzhgtPsS2nZZjsBGIZgnU0QpMv+2MnRsnKwdp1VsrCX84j/qvaZn4WhKunippgTbN2EUs0tPTP55Qfgj+nKmjtWW5IYs72FrEwJKYoNfsmqaF4o5pf4v9zgPwVwY/5I4XJKUL2L25m9kAQcW/K+H1RTFEUoj8Z4ajpOmAB/dG0COmCphVMW2CCMvnxhcGiSgPnpDuWu6qiJ7NG7ye5kvHgefgqPLeicspNJ5EpL3XiRNLM2tmJLI1awAwOyd6iHv0dCkMYRKaa6rcaZeYwmKCkckm0kM2JNmnmmAaBQQ7mwmIM0IMxX4f5W6j9PqZWcJxF7r17T/lQBAmcjoupRiJifbnXCNUv9GhpRF19WcBdeKbivRJVlGop6I2RS6lGImJ9udcI1S/0aGlEXX1ZwF14puK9ElWUainojZFYVHLHD6dIP2ESjqBzg3ol1/wB7+/ylGwd9LS7wSZ2A630CJSVKwH47K9P4bB8PEQP8BwjMFa7xQHOqZFP1XqaQ==","base64"))})};import{PublicKey as Gn,sendAndConfirmTransaction as Ds,SystemProgram as qu,Transaction as zi,TransactionMessage as fr,VersionedTransaction as br}from"@solana/web3.js";import vd from"axios";import{LAMPORTS_PER_SOL as Gu}from"@solana/web3.js";var Ed="http://sg-sender.helius-rpc.com/fast",Jg=.001*Gu,Uu=["4ACfpUFoaSD9bfPdeu6DBt89gB6ENTeHBXCAi87NhDEE","D2L6yPZ2FmmmTKPgzaMKdhu6EWZcTpLy1Vhx8uvZe7NZ","9bnz4RShgq1hAnLnZbP8kbgBg1kEmcJBYQq3gQbmnSta","5VY91ws6B2hMmBFRsXkoAAdsPHBJwRfBht4DXox3xkwn","2nyhqdwKcJZR2vcqCyrYsaPVdAnFoJjiksCXJ7hfEYgD","2q5pghRs6arqVjRvT5gfgWfWcHWmw1ZuCzphgd5KfWGJ","wyvPkWjVZz1M8fHQnMMCDTQDbkManefNNhweYk5WkcF","3KCKozbAaF75qEU33jtzozcJ29yJuaLJTy2jFdzUY8bT","4vieeGHPYPG2MmyPRcYjdiDmmhN3ww7hsFNap8pVN3Ey","4TQLFNWK8AovT1gFvda5jfw2oJeRMKEmw7aH6MGBJ3or"].map(o=>new Gn(o)),yr=2e3;async function _d(o){let e=Buffer.from(o.serialize()).toString("base64"),n=await(await fetch(Ed,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:Date.now().toString(),method:"sendTransaction",params:[e,{encoding:"base64",skipPreflight:!0,maxRetries:0}]})})).json();if(console.log("Helius response:",JSON.stringify(n,null,2)),n.error)throw new Error(n.error.message);let i=n.result;return console.log("Transaction sent:",i),i}var gr=class{constructor(e){this.instructions=[];this.endInstructions=[];this.lookupTableAddress=[];this.signers=[];this.instructionTypes=[];this.endInstructionTypes=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.loopMultiTxStatus=!!e.loopMultiTxStatus}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){var n;let e=(await vd.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=(n=e==null?void 0:e[15])!=null?n:{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=sr(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}addTipInstruction(e){var t;return e?(this.endInstructions.push(qu.transfer({fromPubkey:(t=e.feePayer)!=null?t:this.feePayer,toPubkey:new Gn(e.address),lamports:BigInt(e.amount.toString())})),this.endInstructionTypes.push(X.TransferTip),!0):!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:i=[],endInstructionTypes:r=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...i),this.endInstructionTypes.push(...r),this.lookupTableAddress.push(...s.filter(a=>a!==Gn.default.toString())),this}async versionBuild({txVersion:e,extInfo:t}){return e===0?await this.buildV0(v({},t||{})):this.build(t)}build(e){var n;let t=new zi;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,((n=this.owner)==null?void 0:n.signer)&&!this.signers.some(i=>i.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:t,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async i=>{var l;let{recentBlockHash:r,skipPreflight:s=!0,sendAndConfirm:a,notSendToRpc:c}=i||{},u=r!=null?r:await mi(this.connection,this.blockhashCommitment);if(t.recentBlockhash=u,this.signers.length&&t.sign(...this.signers),di([t]),console.log("SEND 1"),(l=this.owner)!=null&&l.isKeyPair)return{txId:a?await Ds(this.connection,t,this.signers.find(d=>d.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:s}):await this.connection.sendRawTransaction(t.serialize(),{skipPreflight:s}),signedTx:t};if(this.signAllTransactions){let m=await this.signAllTransactions([t]);if(this.signers.length)for(let d of m)try{d.sign(...this.signers)}catch{}return{txId:c?"":await this.connection.sendRawTransaction(m[0].serialize(),{skipPreflight:s}),signedTx:m[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){var u;let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:i}=this.build(n),r=t.filter(l=>l.transaction.instructions.length>0),s=[i,...r.map(l=>l.transaction)],a=[this.signers,...r.map(l=>l.signers)],c=[...this.instructionTypes,...r.map(l=>l.instructionTypes).flat()];return(u=this.owner)!=null&&u.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:c,execute:async l=>{var g;let{sequentially:m,onTxUpdate:d,skipTxCount:p=0,recentBlockHash:b,skipPreflight:f=!0}=l||{},y=b!=null?b:await mi(this.connection,this.blockhashCommitment);if((g=this.owner)!=null&&g.isKeyPair){if(m){let P=[],k=0;for(let T of s){if(++k,k<=p)continue;let I=await Ds(this.connection,T,this.signers.find(h=>h.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:f});P.push(I)}return{txIds:P,signedTxs:s}}return{txIds:await await Promise.all(s.map(async P=>(P.recentBlockhash=y,await this.connection.sendRawTransaction(P.serialize(),{skipPreflight:f})))),signedTxs:s}}if(this.signAllTransactions){let P=s.map((T,I)=>(T.recentBlockhash=y,a[I].length&&T.sign(...a[I]),T));di(P),console.log("SEND 2");let k=await this.signAllTransactions(P);if(m){let T=0,I=[],h=async()=>{if(!k[T])return;let S=await this.connection.sendRawTransaction(k[T].serialize(),{skipPreflight:f});I.push({txId:S,status:"sent",signedTx:k[T]}),d==null||d([...I]),T++;let x=!1,K=null,B=null,C=L=>{K!==null&&clearInterval(K),B!==null&&this.connection.removeSignatureListener(B);let R=I.findIndex(D=>D.txId===S);if(R>-1){if(I[R].status==="error"||I[R].status==="success")return;I[R].status=L.err?"error":"success"}d==null||d([...I]),L.err||h()};this.loopMultiTxStatus&&(K=setInterval(async()=>{var L;if(x){clearInterval(K);return}try{let R=await this.connection.getTransaction(S,{commitment:"confirmed",maxSupportedTransactionVersion:0});R&&(x=!0,clearInterval(K),C({err:((L=R.meta)==null?void 0:L.err)||null}),console.log("tx status from getTransaction:",S))}catch(R){x=!0,clearInterval(K),console.error("getTransaction timeout:",R,S)}},yr)),B=this.connection.onSignature(S,L=>{if(x){this.connection.removeSignatureListener(B);return}x=!0,C(L)},"confirmed"),this.connection.getSignatureStatus(S)};return await h(),{txIds:I.map(S=>S.txId),signedTxs:k}}else{let T=[];for(let I=0;I<k.length;I+=1){let h=await this.connection.sendRawTransaction(k[I].serialize(),{skipPreflight:f});T.push(h)}return{txIds:T,signedTxs:k}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e){var f;let b=e||{},{lookupTableCache:t={},lookupTableAddress:n=[],forerunCreate:i,recentBlockhash:r}=b,s=De(b,["lookupTableCache","lookupTableAddress","forerunCreate","recentBlockhash"]),a=v(v({},this.cluster==="devnet"?{}:pr),t),c=Array.from(new Set([...n,...this.lookupTableAddress])),u=[];for(let y of c)a[y]===void 0&&u.push(new Gn(y));let l=await Fs({connection:this.connection,address:u});for(let[y,g]of Object.entries(l))a[y]=g;let m=i?Gn.default.toBase58():r!=null?r:await mi(this.connection,this.blockhashCommitment),d=new fr({payerKey:this.feePayer,recentBlockhash:m,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(a));((f=this.owner)==null?void 0:f.signer)&&!this.signers.some(y=>y.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let p=new br(d);return p.sign(this.signers),{builder:this,transaction:p,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async y=>{var T;let{skipPreflight:g=!0,sendAndConfirm:P,notSendToRpc:k}=y||{};if(di([p]),console.log("SEND 3"),(T=this.owner)!=null&&T.isKeyPair){let I=await this.connection.sendTransaction(p,{skipPreflight:g});return P&&await Os(this.connection,I),{txId:I,signedTx:p}}if(this.signAllTransactions){let I=await this.signAllTransactions([p]);if(this.signers.length)for(let h of I)try{h.sign(this.signers)}catch{}return{txId:k?"":await this.connection.sendTransaction(I[0],{skipPreflight:g}),signedTx:I[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}async buildV0MultiTx(e){var u;let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:i}=await this.buildV0(n),r=t.filter(l=>l.builder.instructions.length>0),s=[i,...r.map(l=>l.transaction)],a=[this.signers,...r.map(l=>l.signers)],c=[...this.instructionTypes,...r.map(l=>l.instructionTypes).flat()];return(u=this.owner)!=null&&u.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),s.forEach(async(l,m)=>{l.sign(a[m])}),{builder:this,transactions:s,signers:a,instructionTypes:c,buildProps:n,execute:async l=>{var f;let{sequentially:m,onTxUpdate:d,recentBlockHash:p,skipPreflight:b=!0}=l||{};if(p&&s.forEach(y=>y.message.recentBlockhash=p),di(s),console.log("SEND 4"),(f=this.owner)!=null&&f.isKeyPair){if(m){let y=[];for(let g of s){let P=await this.connection.sendTransaction(g,{skipPreflight:b});await Os(this.connection,P),y.push(P)}return{txIds:y,signedTxs:s}}return{txIds:await Promise.all(s.map(async y=>await this.connection.sendTransaction(y,{skipPreflight:b}))),signedTxs:s}}if(this.signAllTransactions){let y=await this.signAllTransactions(s);if(m){let g=0,P=[],k=async()=>{if(!y[g])return;let T=await this.connection.sendTransaction(y[g],{skipPreflight:b});P.push({txId:T,status:"sent",signedTx:y[g]}),d==null||d([...P]),g++;let I=!1,h=null,S=null,x=K=>{h!==null&&clearInterval(h),S!==null&&this.connection.removeSignatureListener(S);let B=P.findIndex(C=>C.txId===T);if(B>-1){if(P[B].status==="error"||P[B].status==="success")return;P[B].status=K.err?"error":"success"}d==null||d([...P]),K.err||k()};this.loopMultiTxStatus&&(h=setInterval(async()=>{var K;if(I){clearInterval(h);return}try{let B=await this.connection.getTransaction(T,{commitment:"confirmed",maxSupportedTransactionVersion:0});B&&(I=!0,clearInterval(h),x({err:((K=B.meta)==null?void 0:K.err)||null}),console.log("tx status from getTransaction:",T))}catch(B){I=!0,clearInterval(h),console.error("getTransaction timeout:",B,T)}},yr)),S=this.connection.onSignature(T,K=>{if(I){this.connection.removeSignatureListener(S);return}I=!0,x(K)},"confirmed"),this.connection.getSignatureStatus(T)};return k(),{txIds:[],signedTxs:y}}else{let g=[];for(let P=0;P<y.length;P+=1){let k=await this.connection.sendTransaction(y[P],{skipPreflight:b});g.push(k)}return{txIds:g,signedTxs:y}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){var d;let m=e||{},{splitIns:t=[],computeBudgetConfig:n}=m,i=De(m,["splitIns","computeBudgetConfig"]),r=n?sr(n):{instructions:[],instructionTypes:[]},s=this.signers.reduce((p,b)=>U(v({},p),{[b.publicKey.toBase58()]:b}),{}),a=[],c=[],u=[],l=0;if(this.allInstructions.forEach(p=>{let b=[...u,p],f=n?[...r.instructions,...b]:b,g=[...new Set(b.map(P=>P.keys.filter(k=>k.isSigner).map(k=>k.pubkey.toString())).flat()).values()].map(P=>new Gn(P));if(p!==t[l]&&u.length<12&&(Fi({instructions:f,payer:this.feePayer,signers:g})||Fi({instructions:b,payer:this.feePayer,signers:g})))u.push(p);else{if(u.length===0)throw Error("item ins too big");l+=p===t[l]?1:0,Fi({instructions:n?[...r.instructions,...u]:[...u],payer:this.feePayer,signers:g})?a.push(new zi().add(...r.instructions,...u)):a.push(new zi().add(...u)),c.push(Array.from(new Set(u.map(P=>P.keys.filter(k=>k.isSigner).map(k=>k.pubkey.toString())).flat())).map(P=>s[P]).filter(P=>P!==void 0)),u=[p]}}),u.length>0){let b=[...new Set(u.map(f=>f.keys.filter(y=>y.isSigner).map(y=>y.pubkey.toString())).flat()).values()].map(f=>s[f]).filter(f=>f!==void 0);Fi({instructions:n?[...r.instructions,...u]:[...u],payer:this.feePayer,signers:b.map(f=>f.publicKey)})?a.push(new zi().add(...r.instructions,...u)):a.push(new zi().add(...u)),c.push(b)}return a.forEach(p=>p.feePayer=this.feePayer),(d=this.owner)!=null&&d.signer&&c.forEach(p=>{p.some(b=>b.publicKey.equals(this.owner.publicKey))||p.push(this.owner.signer)}),{builder:this,transactions:a,signers:c,instructionTypes:this.instructionTypes,execute:async p=>{var T;let{sequentially:b,onTxUpdate:f,skipTxCount:y=0,recentBlockHash:g,skipPreflight:P=!0}=p||{},k=g!=null?g:await mi(this.connection,this.blockhashCommitment);if(a.forEach(async(I,h)=>{I.recentBlockhash=k,c[h].length&&I.sign(...c[h])}),di(a),console.log("SEND 5"),console.log("sizeCheckBuild"),(T=this.owner)!=null&&T.isKeyPair){if(b){let I=0,h=[];for(let S of a){if(++I,I<=y){h.push("tx skipped");continue}let x=await Ds(this.connection,S,this.signers.find(K=>K.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:P});h.push(x)}return{txIds:h,signedTxs:a}}return{txIds:await Promise.all(a.map(async I=>await this.connection.sendRawTransaction(I.serialize(),{skipPreflight:P}))),signedTxs:a}}if(this.signAllTransactions){let I=await this.signAllTransactions(a.slice(y,a.length)),h=[...a.slice(0,y),...I];if(b){let S=0,x=[],K=async()=>{if(!h[S])return;S<y&&(x.push({txId:"",status:"success",signedTx:h[S]}),f==null||f([...x]),S++,K());let B=await this.connection.sendRawTransaction(h[S].serialize(),{skipPreflight:P});x.push({txId:B,status:"sent",signedTx:h[S]}),f==null||f([...x]),S++;let C=!1,L=null,R=null,D=_=>{L!==null&&clearInterval(L),R!==null&&this.connection.removeSignatureListener(R);let W=x.findIndex(Y=>Y.txId===B);if(W>-1){if(x[W].status==="error"||x[W].status==="success")return;x[W].status=_.err?"error":"success"}f==null||f([...x]),_.err||K()};this.loopMultiTxStatus&&(L=setInterval(async()=>{var _;if(C){clearInterval(L);return}try{let W=await this.connection.getTransaction(B,{commitment:"confirmed",maxSupportedTransactionVersion:0});W&&(C=!0,clearInterval(L),D({err:((_=W.meta)==null?void 0:_.err)||null}),console.log("tx status from getTransaction:",B))}catch(W){C=!0,clearInterval(L),console.error("getTransaction timeout:",W,B)}},yr)),R=this.connection.onSignature(B,_=>{if(C){this.connection.removeSignatureListener(R);return}C=!0,D(_)},"confirmed"),this.connection.getSignatureStatus(B)};return await K(),{txIds:x.map(B=>B.txId),signedTxs:h}}else{let S=[];for(let x=0;x<h.length;x+=1){let K=await this.connection.sendRawTransaction(h[x].serialize(),{skipPreflight:P});S.push(K)}return{txIds:S,signedTxs:h}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:i||{}}}async sizeCheckBuildV0(e){var k;let P=e||{},{computeBudgetConfig:t,splitIns:n=[],lookupTableCache:i={},lookupTableAddress:r=[]}=P,s=De(P,["computeBudgetConfig","splitIns","lookupTableCache","lookupTableAddress"]),a=v(v({},this.cluster==="devnet"?{}:pr),i),c=Array.from(new Set([...this.lookupTableAddress,...r])),u=[];for(let T of c)a[T]===void 0&&u.push(new Gn(T));let l=await Fs({connection:this.connection,address:u});for(let[T,I]of Object.entries(l))a[T]=I;let m=t?sr(t):{instructions:[],instructionTypes:[]},d=await mi(this.connection,this.blockhashCommitment),p=this.signers.reduce((T,I)=>U(v({},T),{[I.publicKey.toBase58()]:I}),{}),b=[],f=[],y=[],g=0;if(this.allInstructions.forEach(T=>{let I=[...y,T],h=t?[...m.instructions,...I]:I;if(T!==n[g]&&y.length<12&&(ur({instructions:h,payer:this.feePayer,lookupTableAddressAccount:a})||ur({instructions:I,payer:this.feePayer,lookupTableAddressAccount:a})))y.push(T);else{if(y.length===0)throw Error("item ins too big");g+=T===n[g]?1:0;let S={};for(let x of[...new Set(c)])a[x]!==void 0&&(S[x]=a[x]);if(t&&ur({instructions:[...m.instructions,...y],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:d})){let x=new fr({payerKey:this.feePayer,recentBlockhash:d,instructions:[...m.instructions,...y]}).compileToV0Message(Object.values(a));b.push(new br(x))}else{let x=new fr({payerKey:this.feePayer,recentBlockhash:d,instructions:[...y]}).compileToV0Message(Object.values(a));b.push(new br(x))}f.push(Array.from(new Set(y.map(x=>x.keys.filter(K=>K.isSigner).map(K=>K.pubkey.toString())).flat())).map(x=>p[x]).filter(x=>x!==void 0)),y=[T]}}),y.length>0){let I=[...new Set(y.map(K=>K.keys.filter(B=>B.isSigner).map(B=>B.pubkey.toString())).flat()).values()].map(K=>p[K]).filter(K=>K!==void 0),h=Uu[Math.floor(Math.random()*Uu.length)],S=qu.transfer({fromPubkey:this.feePayer,toPubkey:h,lamports:Math.floor(.001*Gu)}),x=new fr({payerKey:this.feePayer,recentBlockhash:d,instructions:[S,...y]}).compileToV0Message(Object.values(a));b.push(new br(x)),f.push(I)}return(k=this.owner)!=null&&k.signer&&f.forEach(T=>{T.some(I=>I.publicKey.equals(this.owner.publicKey))||T.push(this.owner.signer)}),b.forEach((T,I)=>{T.sign(f[I]),console.log(`Tx #${I+1} size (bytes):`,T.serialize().length)}),{builder:this,transactions:b,buildProps:e,signers:f,instructionTypes:this.instructionTypes,execute:async T=>{var B;let{sequentially:I,onTxUpdate:h,skipTxCount:S=0,recentBlockHash:x,skipPreflight:K=!0}=T||{};if(b.map(async(C,L)=>{f[L].length&&C.sign(f[L]),x&&(C.message.recentBlockhash=x)}),(B=this.owner)!=null&&B.isKeyPair){console.log("Sending transaction using Helius Sender");for(let C of b){let L=await _d(C)}return{txIds:[],signedTxs:[]}}if(this.signAllTransactions){let C=await this.signAllTransactions(b.slice(S,b.length)),L=[...b.slice(0,S),...C];if(I){let R=0,D=[],_=async()=>{if(!L[R])return;if(R<S){D.push({txId:"",status:"success",signedTx:L[R]}),h==null||h([...D]),R++,_();return}let W=await this.connection.sendTransaction(L[R],{skipPreflight:K});D.push({txId:W,status:"sent",signedTx:L[R]}),h==null||h([...D]),R++;let Y=!1,se=null,Pe=null,ce=de=>{se!==null&&clearInterval(se),Pe!==null&&this.connection.removeSignatureListener(Pe);let Ke=D.findIndex(Ze=>Ze.txId===W);if(Ke>-1){if(D[Ke].status==="error"||D[Ke].status==="success")return;D[Ke].status=de.err?"error":"success"}h==null||h([...D]),de.err||_()};this.loopMultiTxStatus&&(se=setInterval(async()=>{var de;if(Y){clearInterval(se);return}try{let Ke=await this.connection.getTransaction(W,{commitment:"confirmed",maxSupportedTransactionVersion:0});Ke&&(Y=!0,clearInterval(se),ce({err:((de=Ke.meta)==null?void 0:de.err)||null}),console.log("tx status from getTransaction:",W))}catch(Ke){Y=!0,clearInterval(se),console.error("getTransaction timeout:",Ke,W)}},yr)),Pe=this.connection.onSignature(W,de=>{if(Y){this.connection.removeSignatureListener(Pe);return}Y=!0,ce(de)},"confirmed"),this.connection.getSignatureStatus(W)};return _(),{txIds:[],signedTxs:L}}else{let R=[];for(let D=0;D<L.length;D+=1){let _=await this.connection.sendTransaction(L[D],{skipPreflight:K});R.push(_)}return{txIds:R,signedTxs:L}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}};import Vd from"bn.js";var Ht=new Vd(1e6);var rt={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",MONITOR_BASE_HOST:"https://monitor.raydium.io",SERVICE_1_BASE_HOST:"https://service-v1.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",CPMM_CONFIG:"/main/cpmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://lite-api.jup.ag/tokens/v1/tagged/verified",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",OWNER_LOCK_POSITION:"/position/clmm-lock/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee",CPMM_LOCK:"https://dynamic-ipfs.raydium.io/lock/cpmm/position"},TA=v({},rt);var Xu="ray_tab_hash",Ws="ray_req_hash",Fd=()=>{if(typeof window===void 0)return"";let o=sessionStorage.getItem(Xu);return o||(o=`ray-${Date.now()}`,sessionStorage.setItem(Xu,o)),o},Ar=async n=>{var i=n,{logCount:o=1e3,removeLastLog:e}=i,t=De(i,["logCount","removeLastLog"]);if(typeof window===void 0)return new Promise(s=>s());let r=JSON.parse(localStorage.getItem(Ws)||"[]").slice(0,o-1);e&&r.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),r.unshift(U(v({},t),{time:Date.now(),session:Fd()}));try{localStorage.setItem(Ws,JSON.stringify(r))}catch{if(e){let s=!1,a=JSON.stringify(t.data).substring(0,100);for(r[0].data=a+(a.length>100?"...":"");!s;){r.pop();let c=JSON.stringify(t.data).substring(0,100);r[0].data=c+(c.length>100?"...":"");try{localStorage.setItem(Ws,JSON.stringify(r)),s=!0}catch{s=!1}}return new Promise(c=>c())}return Ar(U(v({},t),{logCount:o,removeLastLog:!0}))}};import{TOKEN_2022_PROGRAM_ID as Dd,TOKEN_PROGRAM_ID as Wd}from"@solana/spl-token";var Pr=fe("Raydium_Api"),qs=new Map;var wr=class{constructor({cluster:e,timeout:t,logRequests:n,logCount:i,urlConfigs:r}){this.cluster=e,this.urlConfigs=r||{},this.logCount=i||1e3,this.api=Qu.create({baseURL:this.urlConfigs.BASE_HOST||rt.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:c,url:u}=s;return Pr.debug(`${a==null?void 0:a.toUpperCase()} ${c}${u}`),s},s=>(Pr.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:c,status:u}=s,{method:l,baseURL:m,url:d}=a;return n&&Ar({status:u,url:`${m}${d}`,params:a.params,data:c,logCount:this.logCount}),Pr.debug(`${l==null?void 0:l.toUpperCase()} ${m}${d}  ${u}`),c},s=>{let{config:a,response:c={}}=s,{status:u}=c,{method:l,baseURL:m,url:d}=a;return n&&Ar({status:u,url:`${m}${d}`,params:a.params,data:s.message,logCount:this.logCount}),Pr.error(`${l.toUpperCase()} ${m}${d} ${u||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||rt.CLMM_CONFIG)).data}async getCpmmConfigs(){return(await this.api.get(this.urlConfigs.CPMM_CONFIG||rt.CPMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||rt.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await Qu.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(i=>i.numSlots);return n.reduce((i,r)=>i+r,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||rt.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||rt.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||rt.TOKEN_LIST)).data}async getJupTokenList(){return(await this.api.get("",{baseURL:this.urlConfigs.JUP_TOKEN_LIST||rt.JUP_TOKEN_LIST})).map(t=>U(v({},t),{chainId:101,programId:t.tags.includes("token-2022")?Dd.toBase58():Wd.toBase58()}))}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||rt.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:i="desc",page:r=0,pageSize:s=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||rt.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${i}&page=${r}&pageSize=${s}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||rt.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],i=t.filter(s=>qs.has(s)?(n.push(qs.get(s)),!1):!0),r=[];return i.length&&(r=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||rt.POOL_KEY_BY_ID)+`?ids=${i.join(",")}`)).data.filter(Boolean),r.forEach(a=>{qs.set(a.id,a)})),n.concat(r)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:i="all",sort:r="default",order:s="desc",page:a=1}=e,[c,u]=[t&&mt(t).toBase58(),n&&n!=="undefined"?mt(n).toBase58():""],[l,m]=u&&c>u?[u,c]:[c,u];return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||rt.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${m}&poolType=${i}&poolSortField=${r}&sortType=${s}&pageSize=100&page=${a}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||rt.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||rt.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||rt.CHECK_AVAILABILITY)).data}};var kr="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",zu="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{PublicKey as Kr,SystemProgram as Ap}from"@solana/web3.js";import{AccountLayout as Pi,createAssociatedTokenAccountIdempotentInstruction as $s,TOKEN_PROGRAM_ID as En,TOKEN_2022_PROGRAM_ID as Pp}from"@solana/spl-token";var Us=(...o)=>o.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Me=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=fe(t)}createTxBuilder(e){return this.scope.checkOwner(),new gr({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,loopMultiTxStatus:this.scope.loopMultiTxStatus,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Us(e))}logInfo(...e){this.logger.info(Us(e))}logAndCreateError(...e){let t=Us(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as dp,SystemProgram as pp}from"@solana/web3.js";import fp from"bn.js";import{createCloseAccountInstruction as bp,createInitializeAccountInstruction as yp,createTransferInstruction as gp,TOKEN_PROGRAM_ID as Ai}from"@solana/spl-token";import{Keypair as up,PublicKey as uc}from"@solana/web3.js";import cp from"bn.js";import{TOKEN_PROGRAM_ID as lp}from"@solana/spl-token";function qd(o){return o instanceof Uint8Array||o!=null&&typeof o=="object"&&o.constructor.name==="Uint8Array"}function Gs(o,...e){if(!qd(o))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(o.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${o.length}`)}function Xs(o,e=!0){if(o.destroyed)throw new Error("Hash instance has been destroyed");if(e&&o.finished)throw new Error("Hash#digest() has already been called")}function ju(o,e){Gs(o);let t=e.outputLen;if(o.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var Tr=o=>new DataView(o.buffer,o.byteOffset,o.byteLength),Yt=(o,e)=>o<<32-e|o>>>e;var uP=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Ud(o){if(typeof o!="string")throw new Error(`utf8ToBytes expected string, got ${typeof o}`);return new Uint8Array(new TextEncoder().encode(o))}function Qs(o){return typeof o=="string"&&(o=Ud(o)),Gs(o),o}var hr=class{clone(){return this._cloneInto()}},cP={}.toString;function Hu(o){let e=n=>o().update(Qs(n)).digest(),t=o();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>o(),e}function Gd(o,e,t,n){if(typeof o.setBigUint64=="function")return o.setBigUint64(e,t,n);let i=BigInt(32),r=BigInt(4294967295),s=Number(t>>i&r),a=Number(t&r),c=n?4:0,u=n?0:4;o.setUint32(e+c,s,n),o.setUint32(e+u,a,n)}var Yu=(o,e,t)=>o&e^~o&t,Zu=(o,e,t)=>o&e^o&t^e&t,Ir=class extends hr{constructor(e,t,n,i){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Tr(this.buffer)}update(e){Xs(this);let{view:t,buffer:n,blockLen:i}=this;e=Qs(e);let r=e.length;for(let s=0;s<r;){let a=Math.min(i-this.pos,r-s);if(a===i){let c=Tr(e);for(;i<=r-s;s+=i)this.process(c,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Xs(this),ju(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:i,isLE:r}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>i-s&&(this.process(n,0),s=0);for(let m=s;m<i;m++)t[m]=0;Gd(n,i-8,BigInt(this.length*8),r),this.process(n,0);let a=Tr(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<u;m++)a.setUint32(4*m,l[m],r)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:i,finished:r,destroyed:s,pos:a}=this;return e.length=i,e.pos=a,e.finished=r,e.destroyed=s,i%t&&e.buffer.set(n),e}};var Xd=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),On=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Mn=new Uint32Array(64),zs=class extends Ir{constructor(){super(64,32,8,!1),this.A=On[0]|0,this.B=On[1]|0,this.C=On[2]|0,this.D=On[3]|0,this.E=On[4]|0,this.F=On[5]|0,this.G=On[6]|0,this.H=On[7]|0}get(){let{A:e,B:t,C:n,D:i,E:r,F:s,G:a,H:c}=this;return[e,t,n,i,r,s,a,c]}set(e,t,n,i,r,s,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=r|0,this.F=s|0,this.G=a|0,this.H=c|0}process(e,t){for(let m=0;m<16;m++,t+=4)Mn[m]=e.getUint32(t,!1);for(let m=16;m<64;m++){let d=Mn[m-15],p=Mn[m-2],b=Yt(d,7)^Yt(d,18)^d>>>3,f=Yt(p,17)^Yt(p,19)^p>>>10;Mn[m]=f+Mn[m-7]+b+Mn[m-16]|0}let{A:n,B:i,C:r,D:s,E:a,F:c,G:u,H:l}=this;for(let m=0;m<64;m++){let d=Yt(a,6)^Yt(a,11)^Yt(a,25),p=l+d+Yu(a,c,u)+Xd[m]+Mn[m]|0,f=(Yt(n,2)^Yt(n,13)^Yt(n,22))+Zu(n,i,r)|0;l=u,u=c,c=a,a=s+p|0,s=r,r=i,i=n,n=p+f|0}n=n+this.A|0,i=i+this.B|0,r=r+this.C|0,s=s+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,i,r,s,a,c,u,l)}roundClean(){Mn.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var $u=Hu(()=>new zs);import{PublicKey as op}from"@solana/web3.js";import oc,{isBN as rc}from"bn.js";import{bits as Qd,BitStructure as AP,blob as zd,Blob as PP,cstr as wP,f32 as kP,f32be as hP,f64 as TP,f64be as IP,greedy as BP,Layout as jd,ns64 as xP,ns64be as SP,nu64 as Hd,nu64be as KP,offset as Yd,s16 as CP,s16be as LP,s24 as RP,s24be as NP,s32 as Zd,s32be as OP,s40 as MP,s40be as vP,s48 as EP,s48be as _P,s8 as VP,seq as $d,struct as FP,Structure as Jd,u16 as ep,u16be as DP,u24 as WP,u24be as qP,u32 as tp,u32be as UP,u40 as GP,u40be as XP,u48 as QP,u48be as zP,u8 as np,UInt as ip,union as jP,Union as HP,unionLayoutDiscriminator as YP,utf8 as ZP}from"@solana/buffer-layout";var Br=jd,Ju=Jd;var js=ip;var ec=np,Zt=ep;var xr=tp;var tc=Hd;var ve=Zd;var nc=$d;var Te=zd;var Hs=Qd,ic=Yd;var Xn=class extends Br{constructor(t,n,i){super(t,i);this.blob=Te(t),this.signed=n}decode(t,n=0){let i=new oc(this.blob.decode(t,n),10,"le");return this.signed?i.fromTwos(this.span*8).clone():i}encode(t,n,i=0){return typeof t=="number"&&(t=new oc(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,i)}},Sr=class extends Br{constructor(t){super(8,t);this._lower=Hs(xr(),!1),this._upper=Hs(xr(),!1)}addBoolean(t){this._lower.fields.length<32?this._lower.addBoolean(t):this._upper.addBoolean(t)}decode(t,n=0){let i=this._lower.decode(t,n),r=this._upper.decode(t,n+this._lower.span);return v(v({},i),r)}encode(t,n,i=0){return this._lower.encode(t,n,i)+this._upper.encode(t,n,i+this._lower.span)}};function q(o){return new js(1,o)}function ut(o){return new js(4,o)}function w(o){return new Xn(8,!1,o)}function te(o){return new Xn(16,!1,o)}function sc(o){return new Xn(1,!0,o)}function gi(o){return new Xn(8,!0,o)}function ac(o){return new Xn(16,!0,o)}var yi=class extends Br{constructor(t,n,i,r){super(t.span,r);this.layout=t,this.decoder=n,this.encoder=i}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,i){return this.layout.encode(this.encoder(t),n,i)}getSpan(t,n){return this.layout.getSpan(t,n)}};function N(o){return new yi(Te(32),e=>new op(e),e=>e.toBuffer(),o)}function Fe(o){return new yi(ec(),rp,sp,o)}function rp(o){if(o===0)return!1;if(o===1)return!0;throw new Error("Invalid bool: "+o)}function sp(o){return o?1:0}function ap(o){let e=xr("length"),t=E([e,Te(ic(e,-e.span),"data")]);return new yi(t,({data:n})=>n,n=>({data:n}),o)}function $t(o){return new yi(ap(),e=>e.toString("utf-8"),e=>Buffer.from(e,"utf-8"),o)}var Ys=class extends Ju{decode(e,t){return super.decode(e,t)}};function E(o,e,t){return new Ys(o,e,t)}function z(o,e,t){let n,i=typeof e=="number"?e:rc(e)?e.toNumber():new Proxy(e,{get(r,s){if(!n){let a=Reflect.get(r,"count");n=rc(a)?a.toNumber():a,Reflect.set(r,"count",n)}return Reflect.get(r,s)},set(r,s,a){return s==="count"&&(n=a),Reflect.set(r,s,a)}});return nc(o,i,t)}var Jt=E([N("mint"),N("owner"),w("amount"),ut("delegateOption"),N("delegate"),q("state"),ut("isNativeOption"),w("isNative"),w("delegatedAmount"),ut("closeAuthorityOption"),N("closeAuthority")]);var Aw=fe("Raydium_Util");function cc({owner:o,solAccountResp:e,tokenAccountResp:t}){let n=[],i=[];for(let{pubkey:r,account:s}of t.value){let a=Jt.decode(s.data),{mint:c,amount:u}=a;n.push({publicKey:r,mint:c,amount:u,isAssociated:J(o,c,s.owner).publicKey.equals(r),isNative:!1,programId:s.owner}),i.push({pubkey:r,accountInfo:a,programId:s.owner})}return e&&n.push({mint:uc.default,amount:new cp(String(e.lamports)),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:i}}function Ge({fromPublicKey:o,programId:e=lp,assignSeed:t}){let n=t?btoa(t).slice(0,32):up.generate().publicKey.toBase58().slice(0,32);return{publicKey:mp(o,n,e),seed:n}}function mp(o,e,t){let n=Buffer.concat([o.toBuffer(),Buffer.from(e),t.toBuffer()]),i=$u(n);return new uc(i)}function Zs(o){let{mint:e,tokenAccount:t,owner:n,programId:i=Ai}=o;return yp(t,e,n,i)}function Pn(o){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:i,programId:r=Ai}=o;return bp(e,t,i,n,r)}async function vn(o){let{connection:e,amount:t,commitment:n,payer:i,owner:r,skipCloseAccount:s}=o,a=await e.getMinimumBalanceForRentExemption(Jt.span,n),c=ee(t).add(new fp(a)),u=Ge({fromPublicKey:i,programId:Ai});return{addresses:{newAccount:u.publicKey},signers:[],instructions:[pp.createAccountWithSeed({fromPubkey:i,basePubkey:i,seed:u.seed,newAccountPubkey:u.publicKey,lamports:c.toNumber(),space:Jt.span,programId:Ai}),Zs({mint:new dp(nt.address),tokenAccount:u.publicKey,owner:r,programId:Ai})],instructionTypes:[X.CreateAccount,X.InitAccount],endInstructionTypes:s?[]:[X.CloseAccount],endInstructions:s?[]:[Pn({tokenAccount:u.publicKey,payer:i,owner:r})]}}function lc({source:o,destination:e,owner:t,amount:n,multiSigners:i=[],tokenProgram:r=Ai}){return gp(o,e,t,BigInt(String(n)),i,r)}var ji=class extends Me{constructor(t){super(t);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._accountListener=[];this._clientOwnedToken=!1;this._notSubscribeAccountChange=!1;this._accountFetchTime=0;let{tokenAccounts:n,tokenAccountRawInfos:i,notSubscribeAccountChange:r}=t;this._tokenAccounts=n||[],this._tokenAccountRawInfos=i||[],this._notSubscribeAccountChange=r!=null?r:!0,this._clientOwnedToken=!!(n||i)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}set notSubscribeAccountChange(t){this._notSubscribeAccountChange=t}updateTokenAccount({tokenAccounts:t,tokenAccountRawInfos:n}){return t&&(this._tokenAccounts=t),n&&(this._tokenAccountRawInfos=n),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(t){return this._accountListener.push(t),this}removeAccountChangeListener(t){return this._accountListener=this._accountListener.filter(n=>n!==t),this}getAssociatedTokenAccount(t,n){return J(this.scope.ownerPubKey,t,n).publicKey}resetTokenAccounts(){this._clientOwnedToken||(this._tokenAccounts=[],this._tokenAccountRawInfos=[])}async fetchWalletTokenAccounts(t){if(this._clientOwnedToken||!(t!=null&&t.forceUpdate)&&this._tokenAccounts.length&&Date.now()-this._accountFetchTime<(this._notSubscribeAccountChange?1e3*5:1e3*60*3))return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let i=v(v({},{}),t),[r,s,a]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,i.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:En},i.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Pp},i.commitment)]),{tokenAccounts:c,tokenAccountRawInfos:u}=cc({owner:this.scope.ownerPubKey,solAccountResp:r,tokenAccountResp:{context:s.context,value:[...s.value,...a.value]}});return this._tokenAccounts=c,this._tokenAccountRawInfos=u,this._accountFetchTime=Date.now(),this._notSubscribeAccountChange||(this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>{this.fetchWalletTokenAccounts({forceUpdate:!0}),this._accountListener.forEach(l=>l({tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos}))},{commitment:t==null?void 0:t.commitment})),{tokenAccounts:c,tokenAccountRawInfos:u}}clearAccountChangeCkb(){this._accountChangeListenerId!==void 0&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId)}async getCreatedTokenAccount({mint:t,programId:n=En,associatedOnly:i=!0}){await this.fetchWalletTokenAccounts();let r=this._tokenAccounts.filter(({mint:a})=>a==null?void 0:a.equals(t)).sort((a,c)=>a.amount.lt(c.amount)?1:-1),s=this.getAssociatedTokenAccount(t,n);for(let a of r){let{publicKey:c}=a;if(c&&(!i||i&&s.equals(c)))return c}}async getOrCreateTokenAccount(t){var f,y,g,P;await this.fetchWalletTokenAccounts();let{mint:n,createInfo:i,associatedOnly:r,owner:s,notUseTokenAccount:a=!1,skipCloseAccount:c=!1,checkCreateATAOwner:u=!1,assignSeed:l}=t,m=new Kr(t.tokenProgram||En),d=this.getAssociatedTokenAccount(n,new Kr(m)),p=(a?[]:this.tokenAccountRawInfos).filter(k=>k.accountInfo.mint.equals(n)&&(!r||k.pubkey.equals(d))).sort((k,T)=>k.accountInfo.amount.lt(T.accountInfo.amount)?1:-1);if(i===void 0||p.length>0)return p.length>0?{account:p[0].pubkey}:{};let b={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(r){let k=$s(s,d,s,n,m),T=this.tokenAccountRawInfos.find(I=>I.pubkey.equals(d));if(u){let I=await this.scope.connection.getAccountInfo(d);if(I===null)(f=b.instructions)==null||f.push(k),b.instructionTypes.push(X.CreateATA);else if(!(I.owner.equals(m)&&Pi.decode(I.data).mint.equals(n)&&Pi.decode(I.data).owner.equals(s)))throw Error(`create ata check error -> mint: ${n.toString()}, ata: ${d.toString()}`)}else T===void 0&&(b.instructions.push(k),b.instructionTypes.push(X.CreateATA));if(n.equals($)&&i.amount){let I=await vn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:i.payer||this.scope.ownerPubKey,amount:(y=i.amount)!=null?y:0,skipCloseAccount:c});b.instructions.push(...I.instructions||[]),b.endInstructions.push(...I.endInstructions||[]),b.instructionTypes.push(...I.instructionTypes||[]),b.endInstructionTypes.push(...I.endInstructionTypes||[]),i.amount&&(b.instructions.push(lc({source:I.addresses.newAccount,destination:d,owner:this.scope.ownerPubKey,amount:i.amount,tokenProgram:En})),b.instructionTypes.push(X.TransferAmount))}return!c&&T===void 0&&(b.endInstructions.push(Pn({owner:s,payer:i.payer||s,tokenAccount:d,programId:m})),b.endInstructionTypes.push(X.CloseAccount)),{account:d,instructionParams:b}}else{let k=Ge({fromPublicKey:s,programId:m,assignSeed:l}),T=await this.scope.connection.getMinimumBalanceForRentExemption(Pi.span),I=Ap.createAccountWithSeed({fromPubkey:s,basePubkey:s,seed:k.seed,newAccountPubkey:k.publicKey,lamports:T+Number((P=(g=i.amount)==null?void 0:g.toString())!=null?P:0),space:Pi.span,programId:m});return b.instructions.push(I,Zs({mint:n,tokenAccount:k.publicKey,owner:this.scope.ownerPubKey,programId:m})),b.instructionTypes.push(X.CreateAccount),b.instructionTypes.push(X.InitAccount),c||(b.endInstructions.push(Pn({owner:s,payer:i.payer||s,tokenAccount:k.publicKey,programId:m})),b.endInstructionTypes.push(X.CloseAccount)),{account:k.publicKey,instructionParams:b}}}async checkOrCreateAta({mint:t,programId:n=En,autoUnwrapWSOLToSOL:i}){var c;await this.fetchWalletTokenAccounts();let r=(c=this.scope.account.tokenAccounts.find(({mint:u})=>(u==null?void 0:u.toBase58())===t.toBase58()))==null?void 0:c.publicKey,s=this.scope.ownerPubKey,a={};if(!r){let u=this.getAssociatedTokenAccount(t,n),l=await $s(s,u,s,t,n);a.instructions=[l],a.instructionTypes=[X.CreateATA],r=u}return i&&$.toBase58()===t.toBase58()&&(a.endInstructions=[Pn({owner:s,payer:s,tokenAccount:r,programId:n})],a.endInstructionTypes=[X.CloseAccount]),{pubKey:r,newInstructions:a}}async handleTokenAccount(t){let{side:n,amount:i,mint:r,programId:s=En,tokenAccount:a,payer:c=this.scope.ownerPubKey,bypassAssociatedCheck:u,skipCloseAccount:l,checkCreateATAOwner:m}=t,d=this.getAssociatedTokenAccount(r,s);if(new Kr($).equals(r)){let p=await vn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:c,amount:i,skipCloseAccount:l});return v({tokenAccount:p.addresses.newAccount},p)}else if(!a||n==="out"&&!d.equals(a)&&!u){let p=[],b=$s(this.scope.ownerPubKey,d,this.scope.ownerPubKey,r,s);if(m){let f=await this.scope.connection.getAccountInfo(d);if(f===null)p.push(b);else if(!(f.owner.equals(En)&&Pi.decode(f.data).mint.equals(r)&&Pi.decode(f.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${r.toString()}, ata: ${d.toString()}`)}else p.push(b);return{tokenAccount:d,instructions:p,instructionTypes:[X.CreateATA]}}return{tokenAccount:a}}async processTokenAccount(t){let{mint:n,programId:i=En,amount:r,useSOLBalance:s,handleTokenAccount:a,feePayer:c}=t,u,l=this.createTxBuilder(c);if(n.equals(new Kr($))&&s){let m=await this.handleTokenAccount({side:"in",amount:r||0,mint:n,bypassAssociatedCheck:!0,programId:i}),{tokenAccount:p}=m,b=De(m,["tokenAccount"]);u=p,l.addInstruction(b)}else if(u=await this.getCreatedTokenAccount({mint:n,associatedOnly:!1,programId:i}),!u&&a){let d=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:n,bypassAssociatedCheck:!0,programId:i}),{tokenAccount:p}=d,b=De(d,["tokenAccount"]);u=p,l.addInstruction(b)}return v({tokenAccount:u},l.AllTxData)}};import{PublicKey as Be,SystemProgram as Dp}from"@solana/web3.js";import{createAssociatedTokenAccountIdempotentInstruction as Wp}from"@solana/spl-token";import{PublicKey as gc}from"@solana/web3.js";var Js=E([q("instruction")]),ea=E([q("instruction")]),wp=E([w("rewardState"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardLastUpdateTime"),w("totalReward"),w("totalRewardEmissioned"),w("rewardClaimed"),w("rewardPerSecond"),te("accRewardPerShare"),N("rewardVault"),N("rewardMint"),N("rewardSender"),w("rewardType"),z(w(),15,"padding")]),kp=E([w("state"),w("nonce"),N("lpVault"),N("rewardVault"),N(),N(),w(),w(),w("totalReward"),te("perShareReward"),w("lastSlot"),w("perSlotReward")]),hp=E([w("state"),w("nonce"),N("lpVault"),N("rewardVaultA"),w("totalRewardA"),te("perShareRewardA"),w("perSlotRewardA"),q("option"),N("rewardVaultB"),Te(7),w("totalRewardB"),te("perShareRewardB"),w("perSlotRewardB"),w("lastSlot"),N()]),Tp=E([w(),w("state"),w("nonce"),w("validRewardTokenNum"),te("rewardMultiplier"),w("rewardPeriodMax"),w("rewardPeriodMin"),w("rewardPeriodExtend"),N("lpMint"),N("lpVault"),z(wp,5,"rewardInfos"),N("creator"),N(),z(w(),32,"padding")]),mc=new Proxy(kp,{get(o,e,t){return e==="decode"?(...n)=>{let i=o.decode(...n);return U(v({},i),{version:3,rewardInfos:[{rewardVault:i.rewardVault,totalReward:i.totalReward,perSlotReward:i.perSlotReward,perShareReward:i.perShareReward}]})}:Reflect.get(o,e,t)}}),dc=new Proxy(hp,{get(o,e,t){return e==="decode"?(...n)=>{let i=o.decode(...n);return U(v({},i),{version:5,rewardInfos:[{rewardVault:i.rewardVaultA,totalReward:i.totalRewardA,perSlotReward:i.perSlotRewardA,perShareReward:i.perShareRewardA},{rewardVault:i.rewardVaultB,totalReward:i.totalRewardB,perSlotReward:i.perSlotRewardB,perShareReward:i.perShareRewardB}]})}:Reflect.get(o,e,t)}}),Hi=new Proxy(Tp,{get(o,e,t){return e==="decode"?(...n)=>{let i=o.decode(...n);return U(v({},i),{version:6,rewardInfos:i.rewardInfos.map(r=>{var s;return U(v({},r),{rewardType:((s=Object.entries(_n).find(a=>String(a[1])===r.rewardType.toString()))!=null?s:["Standard SPL"])[0]})})})}:Reflect.get(o,e,t)}}),Ip=E([w("isSet"),w("rewardPerSecond"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardType")]),ta=E([q("instruction"),w("nonce"),z(Ip,5,"rewardTimeInfo")]),na=E([q("instruction"),w("rewardReopenTime"),w("rewardEndTime"),w("rewardPerSecond")]),ia=E([q("instruction"),w("isSet"),w("rewardPerSecond"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardType")]),Yw=E([w("state"),N("id"),N("owner"),w("deposited"),z(w(),1,"rewardDebts")]),Yi=E([w("state"),N("id"),N("owner"),w("deposited"),z(te(),1,"rewardDebts"),w(""),w("voteLockedBalance"),z(w(),15)]),Zw=E([w("state"),N("id"),N("owner"),w("deposited"),z(w(),2,"rewardDebts")]),pc=E([w("state"),N("id"),N("owner"),w("deposited"),z(te(),2,"rewardDebts"),z(w(),17)]),fc=E([w(),w("state"),N("id"),N("owner"),w("deposited"),z(te(),5,"rewardDebts"),z(w(),16)]),wt=E([q("instruction"),w("amount")]),Bp=E([N("mint"),N("grantAuthority"),w("baselineVoteWeightScaledFactor"),w("maxExtraLockupVoteWeightScaledFactor"),w("lockupSaturationSecs"),sc("digitShift"),z(q(),7,"reserved1"),z(w(),7,"reserved2")]),bc=E([Te(8),N("governanceProgramId"),N("realm"),N("realmGoverningTokenMint"),N("realmAuthority"),z(q(),32,"reserved1"),z(Bp,4,"votingMints"),gi("timeOffset"),q("bump"),z(q(),7,"reserved2"),z(w(),11,"reserved3")]),xp=E([gi("startTime"),gi("endTime"),q("kind"),z(q(),15,"reserved")]),Sp=E([z(xp,1,"lockup"),w("amountDeposited_native"),w("amountInitiallyLockedNative"),Fe("isUsed"),Fe("allowClawback"),q("votingMintConfigIdx"),z(q(),29,"reserved")]),yc=E([Te(8),N("voterAuthority"),N("registrar"),z(Sp,32,"deposits"),q("voterBump"),q("voterWweightRecordBump"),z(q(),94,"reserved")]);var rk=fe("Raydium_farm_config"),Ac=new gc("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Pc=new gc("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),wc={3:mc,5:dc,6:Hi},kc={3:Yi,5:pc,6:fc},oa=o=>[3,4,5,6].indexOf(o)!==-1,ra=o=>{var s;let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=o,i=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`,r={3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${i}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${i}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${i}`}};return(s=r[e])==null?void 0:s.call(r)},_n={"Standard SPL":0,"Option tokens":1},vt={[Ms.toString()]:3,[Du.toString()]:4,[vs.toString()]:5,[pi.toString()]:6};import{PublicKey as ae,SystemProgram as Qn,SYSVAR_CLOCK_PUBKEY as ki,SYSVAR_RENT_PUBKEY as Lp,TransactionInstruction as et}from"@solana/web3.js";import Cr from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Rp,createAssociatedTokenAccountIdempotentInstruction as Np,TOKEN_PROGRAM_ID as St}from"@solana/spl-token";function sa(o,e,t){return ie([e.toBuffer(),Buffer.from("registrar","utf8"),t.toBuffer()],o)}function aa(o,e){return ie([e.toBuffer(),Buffer.from("voting_mint_seed","utf8")],o)}function ua(o,e){return ie([e.toBuffer()],o)}function ca(o,e,t){return ie([e.toBuffer(),Buffer.from("voter","utf8"),t.toBuffer()],o)}function la(o,e,t){return ie([e.toBuffer(),Buffer.from("voter-weight-record","utf8"),t.toBuffer()],o)}function ma(o,e,t,n){return ie([Buffer.from("governance","utf8"),e.toBuffer(),t.toBuffer(),n.toBuffer()],o)}import xt from"bn.js";var Zi=fe("Raydium.farm.util");function $i({programId:o,poolId:e,mint:t,type:n}){let{publicKey:i}=ie([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],o);return i}function pt({programId:o,poolId:e,owner:t,version:n}){let{publicKey:i}=ie([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],o);return i}var hc=({programId:o,poolId:e})=>ie([e.toBuffer()],o);function Tc(o){return{isSet:new xt(1),rewardPerSecond:ee(o.perSecond),rewardOpenTime:ee(o.openTime),rewardEndTime:ee(o.endTime),rewardType:ee(_n[o.rewardType])}}function da(o){return ee(o.endTime).sub(ee(o.openTime)).mul(ee(o.perSecond))}function wi(o){let e=kc[o];return e||Zi.logWithError("invalid version",o),e}function Kp(o){let e=wc[o];return e||Zi.logWithError("invalid version",o),e}function Cp(o,e,t,n){if(o.version===3||o.version===5){if(o.lastSlot.gte(new xt(t)))return o;let i=new xt(t).sub(o.lastSlot);o.lastSlot=new xt(t);for(let r of o.rewardInfos){if(e.amount.eq(new xt(0)))continue;let s=r.perSlotReward.mul(i);r.perShareReward=r.perShareReward.add(s.mul(new xt(10).pow(new xt(o.version===3?9:15))).div(e.amount)),r.totalReward=r.totalReward.add(s)}}else if(o.version===6)for(let i of o.rewardInfos){if(i.rewardState.eq(new xt(0)))continue;let r=xt.min(new xt(n),i.rewardEndTime);if(i.rewardOpenTime.gte(r))continue;let a=r.sub(i.rewardLastUpdateTime).mul(i.rewardPerSecond),c=i.totalReward.sub(i.totalRewardEmissioned);c.lt(a)?(a=c,i.rewardLastUpdateTime=i.rewardLastUpdateTime.add(c.div(i.rewardPerSecond))):i.rewardLastUpdateTime=r,!e.amount.eq(new xt(0))&&(i.accRewardPerShare=i.accRewardPerShare.add(a.mul(o.rewardMultiplier).div(e.amount)),i.totalRewardEmissioned=i.totalRewardEmissioned.add(a))}return o}async function hk({connection:o,farmPools:e,owner:t,config:n,chainTime:i}){let r=!1,s=!1,a=new xt(10),c=[];for(let d of e){let p=Oe(d);p.version===6?s=!0:r=!0,c.push({pubkey:p.id,version:p.version,key:"state",poolId:p.id},{pubkey:p.lpVault,version:p.version,key:"lpVault",poolId:p.id}),t&&c.push({pubkey:pt({programId:p.programId,poolId:p.id,owner:t,version:d.version}),version:p.version,key:"ledger",poolId:p.id})}let u={},l=await Ne(o,c,n);for(let{pubkey:d,version:p,key:b,poolId:f,accountInfo:y}of l){let g=f.toBase58();if(u[g]=v({},u[g]),b==="state"){let P=Kp(p);(!y||!y.data||y.data.length!==P.span)&&Zi.logWithError(`invalid farm state account info, pools.id, ${d}`),u[g].state=P.decode(y.data)}else if(b==="lpVault")(!y||!y.data||y.data.length!==Jt.span)&&Zi.logWithError(`invalid farm lp vault account info, pools.lpVault, ${d}`),u[g].lpVault=Jt.decode(y.data);else if(b==="ledger"){let P=wi(p);y&&y.data&&(y.data.length!==P.span&&Zi.logWithError(`invalid farm ledger account info, ledger, ${d}`),u[g].ledger=P.decode(y.data))}}let m=s||r?await o.getSlot():0;for(let d of Object.keys(u))u[d]!==void 0&&(u[d].state=Cp(u[d].state,u[d].lpVault,m,i));for(let[d,{state:p,ledger:b}]of Object.entries(u))if(b){let f=p.version===6?p.rewardMultiplier:p.rewardInfos.length===1?a.pow(new xt(9)):a.pow(new xt(15)),y=p.rewardInfos.map((g,P)=>{let k=b.rewardDebts[P];return b.deposited.mul(p.version===6?g.accRewardPerShare:g.perShareReward).div(f).sub(k)});u[d].wrapped=U(v({},u[d].wrapped),{pendingRewards:y})}return u}function Tk(o,e=Date.now()){if(o.version===6){let t=o.state.rewardInfos;if(t.every(({rewardOpenTime:n})=>Ru(e,n.toNumber(),{unit:"s"})))return"upcoming pool";if(t.every(({rewardEndTime:n})=>Nu(e,n.toNumber(),{unit:"s"})))return"closed pool"}else{let t=o.state.rewardInfos.map(({perSlotReward:n})=>n);if(t.length===2){if(String(t[0])==="0"&&String(t[1])!=="0")return"normal fusion pool";if(String(t[0])!=="0"&&String(t[1])!=="0")return"dual fusion pool";if(String(t[0])==="0"&&String(t[1])==="0")return"closed pool"}else if(t.length===1&&String(t[0])==="0")return"closed pool"}}async function pa(o,e,t,n){let i=await o.getAccountInfo(e);if(i===null)throw Error("registrar info check error");let s=bc.decode(i.data).votingMints.findIndex(l=>l.mint.equals(n));if(s===-1)throw Error("find voter mint error");let a=await o.getAccountInfo(t);if(a===null)return{index:s,isInit:!1};let u=yc.decode(a.data).deposits.findIndex(l=>l.isUsed&&l.votingMintConfigIdx===s);return u===-1?{index:s,isInit:!1}:{index:u,isInit:!0}}var Op=fe("Raydium_farm_instruction"),Ji={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function eo(o){let{version:e,id:t,ledger:n,programId:i,owner:r}=o,s={3:9,5:10}[e];s||Op.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(Js.span);Js.encode({instruction:s},a);let c=[A({pubkey:t}),A({pubkey:n}),A({pubkey:r,isWritable:!1}),A({pubkey:Qn.programId,isWritable:!1}),A({pubkey:Lp,isWritable:!1})];return{instruction:new et({programId:i,keys:c,data:a}),instructionType:X.FarmV3CreateLedger}}function Ic(o){var n;let e=Buffer.alloc(ta.span);ta.encode({instruction:0,nonce:new Cr(o.nonce),rewardTimeInfo:o.rewardInfoConfig},e);let t=[...Is,A({pubkey:o.farmId}),A({pubkey:o.farmAuthority,isWritable:!1}),A({pubkey:o.lpVault}),A({pubkey:o.lpMint,isWritable:!1}),A({pubkey:o.lockVault}),A({pubkey:o.lockMint,isWritable:!1}),A({pubkey:(n=o.lockUserAccount)!=null?n:it}),A({pubkey:o.owner,isWritable:!1,isSigner:!0})];for(let i of o.rewardInfo)t.push(A({pubkey:i.rewardMint,isWritable:!1}),A({pubkey:i.rewardVault}),A({pubkey:i.userRewardToken}));return{instruction:new et({programId:o.programId,keys:t,data:e}),instructionType:X.FarmV6Create}}function Bc(o){let e=Buffer.alloc(ea.span);ea.encode({instruction:5},e);let t=[A({pubkey:St,isWritable:!1}),A({pubkey:o.id}),A({pubkey:o.authority,isWritable:!1}),A({pubkey:o.lpVault,isWritable:!1}),A({pubkey:o.rewardVault}),A({pubkey:o.userRewardToken}),A({pubkey:o.owner,isWritable:!1,isSigner:!0})];return{instruction:new et({programId:o.programId,keys:t,data:e}),instructionType:X.FarmV6CreatorWithdraw}}function Mp(o,e,t,n,i,r,s,a,c,u,l,m,d){let p=E([q("depositEntryIndex"),w("amount")]),b=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:St,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:er,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({depositEntryIndex:m,amount:d},f);let y=Buffer.from([...Ji.voterStakeRegistryDeposit,...f]);return new et({keys:b,programId:o,data:y})}function vp(o,e,t,n){let i=E([]),r=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:Qn.programId,isSigner:!1,isWritable:!1}],s=Buffer.alloc(i.span);i.encode({},s);let a=Buffer.from([...Ji.voterStakeRegistryUpdateVoterWeightRecord,...s]);return new et({keys:r,programId:o,data:a})}function Ep(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b){let f=E([q("depositEntryIndex"),w("amount")]),y=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:St,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:er,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);f.encode({depositEntryIndex:p,amount:b},g);let P=Buffer.from([...Ji.voterStakeRegistryWithdraw,...g]);return new et({keys:y,programId:o,data:P})}function _p(o,e,t,n,i,r){let s=E([q("ins")]),a=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:Qn.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({ins:23},c),new et({keys:a,programId:o,data:c})}function Vp(o,e,t,n,i,r,s,a){let c=E([q("voterBump"),q("voterWeightRecordBump")]),u=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:Qn.programId,isSigner:!1,isWritable:!1},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:er,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({voterBump:s,voterWeightRecordBump:a},l);let m=Buffer.from([...Ji.voterStakeRegistryCreateVoter,...l]);return new et({keys:u,programId:o,data:m})}function Fp(o,e,t,n,i,r,s,a,c,u,l,m){let d=E([q("depositEntryIndex"),q("kind"),q("option"),w("startTs"),ut("periods"),Fe("allowClawback")]),p=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Qn.programId,isSigner:!1,isWritable:!1},{pubkey:St,isSigner:!1,isWritable:!1},{pubkey:Rp,isSigner:!1,isWritable:!1},{pubkey:He,isSigner:!1,isWritable:!1}],b=Buffer.alloc(d.span);d.encode({depositEntryIndex:a,kind:c,option:u===void 0?0:1,startTs:u,periods:l,allowClawback:m},b);let f=Buffer.from([...Ji.voterStakeRegistryCreateDepositEntry,...b]);return new et({keys:p,programId:o,data:f})}async function Fk({connection:o,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:i,communityTokenMint:r,owner:s,poolId:a,tokenProgram:c}){let u=sa(n,i,r).publicKey,l=pt({programId:e,poolId:a,owner:s,version:3}),m=await o.getAccountInfo(l);if(m===null)throw Error("user is not staker");let d=Yi.decode(m.data),p=d.deposited.sub(d.voteLockedBalance);if(console.log("amount",p.toString()),p.eq(new Cr(0)))throw Error("user do not has new stake amount");let b=aa(e,a).publicKey,f=ua(e,a).publicKey,{publicKey:y,nonce:g}=ca(n,u,s),P=J(y,b,c).publicKey,{publicKey:k,nonce:T}=la(n,u,s),I=ma(t,i,r,s).publicKey,h=[],S=J(s,b,c).publicKey;if(await o.getAccountInfo(S)===null&&h.push(Np(s,S,s,b)),await o.getAccountInfo(y)===null){let L=_p(t,i,s,r,s,I);h.push(L,Vp(n,u,y,k,s,s,g,T))}let{index:B,isInit:C}=await pa(o,u,y,b);return C||h.push(Fp(n,u,y,P,s,s,b,B,0,void 0,0,!1)),h.push(Mp(n,u,y,P,S,s,l,a,b,f,e,B,p),vp(n,u,y,k)),h}async function Dk({connection:o,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:i,communityTokenMint:r,owner:s,poolId:a,tokenProgram:c}){let u=sa(n,i,r).publicKey,l=pt({programId:e,poolId:a,owner:s,version:3}),m=await o.getAccountInfo(l);if(m===null)throw Error("user is not staker");let d=Yi.decode(m.data);if(d.voteLockedBalance.eq(new Cr(0)))throw Error("user has vote locked balance = 0");let p=aa(e,a).publicKey,b=ua(e,a).publicKey,{publicKey:f}=ca(n,u,s),y=J(f,p,c).publicKey,{publicKey:g}=la(n,u,s),P=ma(t,i,r,s).publicKey,k=[],{index:T,isInit:I}=await pa(o,u,f,p);if(!I)throw Error("deposit entry index check error");return k.push(Ep(n,u,f,s,P,g,y,J(s,p,c).publicKey,l,a,p,b,e,T,d.voteLockedBalance)),k}function fa({payer:o,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:i}){let r=Buffer.alloc(na.span);na.encode({instruction:3,rewardReopenTime:ee(i.openTime),rewardEndTime:ee(i.endTime),rewardPerSecond:ee(i.perSecond)},r);let s=[A({pubkey:St,isWritable:!1}),A({pubkey:n.id}),A({pubkey:n.lpVault,isWritable:!1}),A({pubkey:e}),A({pubkey:t}),A({pubkey:o,isWritable:!1,isSigner:!0})];return new et({programId:n.programId,keys:s,data:r})}function ba({payer:o,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:i}){let r=Buffer.alloc(ia.span);ia.encode({instruction:4,isSet:new Cr(1),rewardPerSecond:ee(i.perSecond),rewardOpenTime:ee(i.openTime),rewardEndTime:ee(i.endTime),rewardType:ee(_n[i.rewardType])},r);let s=[...Is,A({pubkey:t.id}),A({pubkey:t.authority,isWritable:!1}),A({pubkey:i.mint,isWritable:!1}),A({pubkey:n}),A({pubkey:e}),A({pubkey:o,isWritable:!1,isSigner:!0})];return new et({programId:t.programId,keys:s,data:r})}function Wk(o){let{farmInfo:e,farmKeys:t,version:n,lpAccount:i,rewardAccounts:r,owner:s,instruction:a,amount:c,deposit:u}=o,[l,m]=[new ae(e.programId),new ae(e.id)],d=pt({programId:l,poolId:m,owner:s,version:n}),p=Buffer.alloc(wt.span);wt.encode({instruction:a,amount:c},p);let b=n===6?[A({pubkey:St,isWritable:!1}),...u?[A({pubkey:Qn.programId,isWritable:!1})]:[],A({pubkey:m}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:new ae(t.lpVault)}),A({pubkey:d}),A({pubkey:s,isWritable:!1,isSigner:!0}),A({pubkey:i})]:[A({pubkey:m}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:d}),A({pubkey:s,isWritable:!1,isSigner:!0}),A({pubkey:i}),A({pubkey:new ae(t.lpVault)}),A({pubkey:r[0]}),A({pubkey:new ae(t.rewardInfos[0].vault)}),A({pubkey:ki,isWritable:!1}),A({pubkey:St,isWritable:!1})];if(n===5)for(let f=1;f<t.rewardInfos.length;f++)b.push(A({pubkey:r[f]})),b.push(A({pubkey:new ae(t.rewardInfos[f].vault)}));if(n===6)for(let f=0;f<t.rewardInfos.length;f++)b.push(A({pubkey:new ae(t.rewardInfos[f].vault)})),b.push(A({pubkey:r[f]}));return new et({programId:l,keys:b,data:p})}function to(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s}=o,[a,c]=[new ae(e.programId),new ae(e.id)],u=pt({programId:a,poolId:c,owner:r,version:6}),l=Buffer.alloc(wt.span);wt.encode({instruction:2,amount:ee(s)},l);let m=[A({pubkey:St,isWritable:!1}),A({pubkey:c}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:new ae(t.lpVault)}),A({pubkey:u}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(A({pubkey:new ae(t.rewardInfos[d].vault)})),m.push(A({pubkey:i[d]}));return new et({programId:a,keys:m,data:l})}function no(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[c,u]=[new ae(e.programId),new ae(e.id)],l=pt({programId:c,poolId:u,owner:r,version:5}),m=Buffer.alloc(wt.span);wt.encode({instruction:12,amount:ee(s)},m);let d=[A({pubkey:u}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:l}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n}),A({pubkey:new ae(t.lpVault)}),A({pubkey:i[0]}),A({pubkey:new ae(t.rewardInfos[0].vault)}),A({pubkey:ki,isWritable:!1}),A({pubkey:St,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(A({pubkey:i[p]})),d.push(A({pubkey:new ae(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(A({pubkey:p}));return new et({programId:c,keys:d,data:m})}function xc(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[c,u]=[new ae(e.programId),new ae(e.id)],l=E([q("instruction"),w("amount")]),m=[A({pubkey:u}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:a[0]}),A({pubkey:r,isSigner:!0,isWritable:!1}),A({pubkey:n}),A({pubkey:new ae(t.lpVault)}),A({pubkey:i[0]}),A({pubkey:new ae(t.rewardInfos[0].vault)}),A({pubkey:ki,isWritable:!1}),A({pubkey:St,isWritable:!1}),A({pubkey:i[1]}),A({pubkey:new ae(t.rewardInfos[1].vault)})],d=Buffer.alloc(l.span);return l.encode({instruction:2,amount:s},d),new et({keys:m,programId:c,data:d})}function io(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[c,u]=[new ae(e.programId),new ae(e.id)],l=pt({programId:c,poolId:u,owner:r,version:3}),m=Buffer.alloc(wt.span);wt.encode({instruction:11,amount:ee(s)},m);let d=[A({pubkey:u}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:l}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n}),A({pubkey:new ae(t.lpVault)}),A({pubkey:i[0]}),A({pubkey:new ae(t.rewardInfos[0].vault)}),A({pubkey:ki,isWritable:!1}),A({pubkey:St,isWritable:!1})];if(a)for(let p of a)d.push(A({pubkey:p}));return new et({programId:c,keys:d,data:m})}function Sc(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[c,u]=[new ae(e.programId),new ae(e.id)],l=pt({programId:c,poolId:u,owner:r,version:3}),m=Buffer.alloc(wt.span);wt.encode({instruction:10,amount:ee(s)},m);let d=[A({pubkey:u}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:l}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n}),A({pubkey:new ae(t.lpVault)}),A({pubkey:i[0]}),A({pubkey:new ae(t.rewardInfos[0].vault)}),A({pubkey:ki,isWritable:!1}),A({pubkey:St,isWritable:!1})];if(a)for(let p of a)d.push(A({pubkey:p}));return new et({programId:c,keys:d,data:m})}function Kc(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[c,u]=[new ae(e.programId),new ae(e.id)],l=pt({programId:c,poolId:u,owner:r,version:5}),m=Buffer.alloc(wt.span);wt.encode({instruction:11,amount:ee(s)},m);let d=[A({pubkey:u}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:l}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n}),A({pubkey:new ae(t.lpVault)}),A({pubkey:i[0]}),A({pubkey:new ae(t.rewardInfos[0].vault)}),A({pubkey:ki,isWritable:!1}),A({pubkey:St,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(A({pubkey:i[p]})),d.push(A({pubkey:new ae(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(A({pubkey:p}));return new et({programId:c,keys:d,data:m})}function Cc(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s}=o,[a,c]=[new ae(e.programId),new ae(e.id)],u=pt({programId:a,poolId:c,owner:r,version:6}),l=Buffer.alloc(wt.span);wt.encode({instruction:1,amount:ee(s)},l);let m=[A({pubkey:St,isWritable:!1}),A({pubkey:Qn.programId,isWritable:!1}),A({pubkey:c}),A({pubkey:new ae(t.authority),isWritable:!1}),A({pubkey:new ae(t.lpVault)}),A({pubkey:u}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(A({pubkey:new ae(t.rewardInfos[d].vault)})),m.push(A({pubkey:i[d]}));return new et({programId:a,keys:m,data:l})}var oo=class extends Me{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals(it)){let n=await vn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:da(U(v({},t),{openTime:t.openTime.toString(),endTime:t.endTime.toString()}))});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:i=pi,txVersion:r,feePayer:s}){this.checkDisabled(),this.scope.checkOwner();let c={lpMint:new Be(e.lpMint.address),lockInfo:{lockMint:Ac,lockVault:Pc},version:6,rewardInfos:t,programId:i},u=this.createTxBuilder(s),l=n!=null?n:this.scope.ownerPubKey,m=Ge({fromPublicKey:l,programId:c.programId}),d=await this.scope.connection.getMinimumBalanceForRentExemption(Hi.span);u.addInstruction({instructions:[Dp.createAccountWithSeed({fromPubkey:l,basePubkey:l,seed:m.seed,newAccountPubkey:m.publicKey,lamports:d,space:Hi.span,programId:c.programId})]});let{publicKey:p,nonce:b}=hc({programId:new Be(c.programId),poolId:m.publicKey}),f=$i({programId:c.programId,poolId:m.publicKey,mint:c.lpMint,type:"lpVault"}),y=[],g=[];for(let h of c.rewardInfos){h.openTime>=h.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",h.openTime.toString()),isNaN(_n[h.rewardType])&&this.logAndCreateError("rewardType error",h.rewardType),Number(h.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",h.perSecond),y.push(Tc(h));let{rewardPubKey:S,newInstruction:x}=await this._getUserRewardInfo({rewardInfo:h,payer:l});x&&u.addInstruction(x),S||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let K=h.mint.equals(it)?new Be(nt.address):h.mint;g.push({rewardMint:K,rewardVault:$i({programId:c.programId,poolId:m.publicKey,mint:K,type:"rewardVault"}),userRewardToken:S})}let{account:P,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({mint:new Be(c.lockInfo.lockMint),owner:this.scope.ownerPubKey,skipCloseAccount:!1,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:!1});k&&u.addInstruction(k),P||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:T,instructionType:I}=Ic({farmId:m.publicKey,owner:this.scope.ownerPubKey,farmAuthority:p,lpVault:f,lpMint:c.lpMint,lockVault:c.lockInfo.lockVault,lockMint:c.lockInfo.lockMint,lockUserAccount:P,programId:c.programId,rewardInfo:g,rewardInfoConfig:y,nonce:b});return u.addInstruction({instructions:[T],instructionTypes:[I]}).versionBuild({txVersion:r,extInfo:{farmId:m.publicKey,farmAuthority:p,lpVault:f,lockUserAccount:P,nonce:b}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:i,feePayer:r}){var g;let s=vt[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Oe((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,l=n.mint.equals(it)?new Be(nt.address):n.mint,m=c.rewardInfos.findIndex(P=>new Be(P.mint.address).equals(l)),d=a.rewardInfos[m];d||this.logAndCreateError("configuration does not exist","rewardMint",l);let p=(g=d.vault)!=null?g:it,b=this.createTxBuilder(r),{rewardPubKey:f,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return y&&b.addInstruction(y),f||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),b.addInstruction({instructions:[fa({payer:this.scope.ownerPubKey,rewardVault:p,userRewardTokenPub:f,farmKeys:c,rewardInfo:n})],instructionTypes:[X.FarmV6Restart]}).versionBuild({txVersion:i})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:i,feePayer:r}){var m;let s=vt[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Oe((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.forEach(d=>{d.openTime>=d.endTime&&this.logAndCreateError("start time error","newRewardInfo",d)});let u=t||this.scope.ownerPubKey,l=this.createTxBuilder(r);for(let d of n){let p=d.mint.equals(it)?new Be(nt.address):d.mint,b=c.rewardInfos.findIndex(T=>new Be(T.mint.address).equals(p)),f=a.rewardInfos[b];f||this.logAndCreateError("configuration does not exist","rewardMint",p);let y=(m=f.vault)!=null?m:it,{rewardPubKey:g,newInstruction:P}=await this._getUserRewardInfo({rewardInfo:d,payer:u});P&&l.addInstruction(P),g||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let k=fa({payer:this.scope.ownerPubKey,rewardVault:y,userRewardTokenPub:g,farmKeys:c,rewardInfo:d});l.addInstruction({instructions:[k],instructionTypes:[X.FarmV6Restart]})}return l.versionBuild({txVersion:i})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:i,payer:r,feePayer:s}=e,a=vt[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=Oe((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=r!=null?r:this.scope.ownerPubKey,l=this.createTxBuilder(s),m=i.mint.equals(it)?new Be(nt.address):i.mint,d=$i({programId:new Be(n.programId),poolId:new Be(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:p,newInstruction:b}=await this._getUserRewardInfo({rewardInfo:i,payer:u});return b&&l.addInstruction(b),p||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),i.mint=m,l.addInstruction({instructions:[ba({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:c,rewardVault:d,rewardInfo:i})],instructionTypes:[X.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:i,payer:r,feePayer:s}=e,a=vt[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=Oe((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=r!=null?r:this.scope.ownerPubKey,l=this.createTxBuilder(s);for(let m of i){let d=m.mint.equals(it)?new Be(nt.address):m.mint,p=$i({programId:new Be(n.programId),poolId:new Be(n.id),mint:d,type:"rewardVault"}),{rewardPubKey:b,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:m,payer:u});f&&l.addInstruction(f),b||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let y=ba({payer:this.scope.ownerPubKey,userRewardTokenPub:b,farmKeys:c,rewardVault:p,rewardInfo:U(v({},m),{mint:d})});l.addInstruction({instructions:[y],instructionTypes:[X.FarmV6CreatorAddReward]})}return l.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:i,feePayer:r,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:u,computeBudgetConfig:l,txTipConfig:m}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:d,programId:p}=n,b=vt[p];b===4&&this.logAndCreateError("V4 has suspended deposits:",n.programId),oa(b)||this.logAndCreateError("invalid farm program:",n.programId);let[f,y]=[new Be(n.programId),new Be(n.id)],g=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],P=pt({programId:f,poolId:y,owner:this.scope.ownerPubKey,version:b}),k=this.createTxBuilder(r);k.addCustomComputeBudget(l),k.addTipInstruction(m);let T={};for(let D of this.scope.account.tokenAccounts)if(a){let _=J(this.scope.ownerPubKey,D.mint,D.programId).publicKey;D.publicKey&&_.equals(D.publicKey)&&(T[D.mint.toString()]=D.publicKey)}else T[D.mint.toString()]=D.publicKey;let I=g.lpMint,h=T[I.address];h||this.logAndCreateError("you don't have any lp","lp zero",T);let S=[];for(let D of d){let _=s&&D.mint.address===$.toString(),W=T[D.mint.address];if(!W){let{account:Y,instructionParams:se}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:D.mint.programId,mint:new Be(D.mint.address),notUseTokenAccount:_,createInfo:{payer:r||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!_,associatedOnly:_?!1:a,checkCreateATAOwner:c});W=Y,se&&k.addInstruction(se)}T[D.mint.address]=W,S.push(W)}let x,K=await this.scope.connection.getAccountInfo(P);if(K&&(x=wi(b).decode(K.data)),n.programId!==pi.toString()&&!x){let{instruction:D,instructionType:_}=eo({id:y,programId:f,version:b,ledger:P,owner:this.scope.ownerPubKey});k.addInstruction({instructions:[D],instructionTypes:[_]})}let B=ra({version:b,rewardInfos:d,rewardTokenAccountsPublicKeys:S});B&&this.logAndCreateError(B);let C={amount:ee(i),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:g,lpAccount:h,rewardAccounts:S,userAuxiliaryLedgers:u==null?void 0:u.map(D=>new Be(D))},L=b===6?Cc(C):b===5?Kc(C):Sc(C),R={3:X.FarmV3Deposit,5:X.FarmV5Deposit,6:X.FarmV6Deposit};return k.addInstruction({instructions:[L],instructionTypes:[R[b]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:i,deposited:r,useSOLBalance:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:l,computeBudgetConfig:m,txTipConfig:d}=e,{rewardInfos:p}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let b=vt[n.programId];oa(b)||this.logAndCreateError("invalid farm program:",n.programId);let f=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],y=this.createTxBuilder(a);y.addCustomComputeBudget(m),y.addTipInstruction(d);let g={};for(let B of this.scope.account.tokenAccounts)if(c){let C=J(this.scope.ownerPubKey,B.mint).publicKey;B.publicKey&&C.equals(B.publicKey)&&(g[B.mint.toString()]=B.publicKey)}else g[B.mint.toString()]=B.publicKey;if(b!==4){let B=pt({programId:new Be(n.programId),poolId:new Be(n.id),owner:this.scope.ownerPubKey,version:b}),C=await this.scope.connection.getAccountInfo(B);if(C)wi(b).decode(C.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else if(b!==6){let{instruction:L,instructionType:R}=eo({id:new Be(f.id),programId:new Be(f.programId),version:b,ledger:B,owner:this.scope.ownerPubKey});y.addInstruction({instructions:[L],instructionTypes:[R]})}}r&&r.isZero()&&!(l||[]).length&&this.logAndCreateError("no deposited lp",{farmId:n.id});let P=f.lpMint.address,k=s&&P===$.toString(),T=g[P.toString()];if(!T){let{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.lpMint.programId,mint:new Be(P),notUseTokenAccount:k,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:k?!1:c,checkCreateATAOwner:u});T=B,C&&y.addInstruction(C)}g[P.toString()]=T;let I=[];for(let B of p){let C=s&&B.mint.address===$.toString(),L=g[B.mint.address];if(!L){let{account:R,instructionParams:D}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:B.mint.programId,mint:new Be(B.mint.address),notUseTokenAccount:C,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!C,associatedOnly:C?!1:c,checkCreateATAOwner:u});L=R,D&&y.addInstruction(D)}g[B.mint.address]=L,I.push(L)}let h=ra({version:b,rewardInfos:p,rewardTokenAccountsPublicKeys:I});h&&this.logAndCreateError(h);let S={amount:ee(i),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:f,lpAccount:T,rewardAccounts:I,userAuxiliaryLedgers:l==null?void 0:l.map(B=>new Be(B))},x=b===6?to(S):b===5?no(S):b===4?xc(S):io(S),K={3:X.FarmV3Withdraw,4:X.FarmV4Withdraw,5:X.FarmV5Withdraw,6:X.FarmV6Withdraw};return y.addInstruction({instructions:[x],instructionTypes:[K[b]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n,computeBudgetConfig:i,txTipConfig:r,feePayer:s}){var f;this.scope.checkOwner();let a=Oe((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c=vt[e.programId];c!==6&&this.logAndCreateError("invalid farm version",c);let u=a.rewardInfos.find(y=>mt(y.mint.address).equals(mt(t)));u||this.logAndCreateError("withdraw mint error","rewardInfos",e);let l=(f=u==null?void 0:u.vault)!=null?f:it,m=this.createTxBuilder(s),d;if(t.equals(it)||t.equals(Be.default)){let y=await vn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:da(U(v({},u),{openTime:u.openTime,endTime:u.endTime,perSecond:new O(u.perSecond).mul(10**u.mint.decimals).toString()}))});d=y.addresses.newAccount,m.addInstruction(y)}else{let y=await this.scope.account.getCreatedTokenAccount({mint:t});y===null?(d=await this.scope.account.getAssociatedTokenAccount(t),m.addInstruction({instructions:[Wp(this.scope.ownerPubKey,d,this.scope.ownerPubKey,t)],instructionTypes:[X.CreateATA]})):d=y}let{instruction:p,instructionType:b}=Bc({programId:a.programId,id:a.id,authority:a.authority,lpVault:a.lpVault,rewardVault:l,userRewardToken:d,owner:this.scope.ownerPubKey});return m.addCustomComputeBudget(i),m.addTipInstruction(r),m.addInstruction({instructions:[p],instructionTypes:[b]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:c,computeBudgetConfig:u}=e,l=this.createTxBuilder(i),m={};for(let b of this.scope.account.tokenAccounts)if(r){let f=J(this.scope.ownerPubKey,b.mint).publicKey;b.publicKey&&f.equals(b.publicKey)&&(m[b.mint.toString()]=b.publicKey)}else m[b.mint.toString()]=b.publicKey;let p=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(b=>b.id).join(",")})).reduce((b,f)=>U(v({},b),{[f.id]:f}),{});for(let b of Object.values(t)){let{programId:f,lpMint:y,rewardInfos:g,id:P}=b,k=vt[f],T=y.address,I=n&&T===$.toString(),h=m[T];if(!h){let{account:L,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.programId,mint:new Be(T),notUseTokenAccount:I,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:I?!1:r,checkCreateATAOwner:s});h=L,R&&l.addInstruction(R)}m[T.toString()]=h;let S=[];for(let L of g){let R=n&&L.mint.address===$.toString(),D=m[L.mint.address];if(!D){let{account:_,instructionParams:W}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:L.mint.programId,mint:new Be(L.mint.address),notUseTokenAccount:R,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!R,associatedOnly:R?!1:r,checkCreateATAOwner:s});D=_,W&&l.addInstruction(W)}m[L.mint.address]=D,S.push(D)}let x=p[P],K={amount:Bt,owner:this.scope.ownerPubKey,farmInfo:b,farmKeys:x,lpAccount:h,rewardAccounts:S,userAuxiliaryLedgers:a==null?void 0:a.map(L=>new Be(L))},B=k===6?to(K):k===5?no(K):io(K),C={3:X.FarmV3Withdraw,5:X.FarmV5Withdraw,6:X.FarmV6Withdraw};l.addInstruction({instructions:[B],instructionTypes:[C[k]]})}return c===1?l.sizeCheckBuild({computeBudgetConfig:u}):l.sizeCheckBuildV0({computeBudgetConfig:u})}};import{PublicKey as je}from"@solana/web3.js";import{AccountLayout as Mf,NATIVE_MINT as Ur,TOKEN_PROGRAM_ID as Fn}from"@solana/spl-token";import{Keypair as Er,PublicKey as Q,SystemProgram as Tn,TransactionInstruction as ct}from"@solana/web3.js";import Ia from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as bo,TOKEN_2022_PROGRAM_ID as We,TOKEN_PROGRAM_ID as xe}from"@solana/spl-token";import ef from"bn.js";import Et from"bn.js";var ye=new Et(0),Nt=new Et(1),wn=new Et(-1),Ye=new Et(1).shln(64),Lr=new Et(1).shln(128),ro=Ye.sub(Nt),so=64,Lc=Lr.subn(1),ft=-443636,kt=-ft,_t=new Et("4295048016"),Vt=new Et("79226673521066979257578248091"),Rr=new Et("4295048017"),Nr=new Et("79226673521066979257578248090"),Rc=16,Nc="59543866431248",Oc="184467440737095516",Mc="15793534762490258745",Or=new Et(10).pow(new Et(6)),qp=(n=>(n[n.rate_500=500]="rate_500",n[n.rate_3000=3e3]="rate_3000",n[n.rate_10000=1e4]="rate_10000",n))(qp||{}),Ah={[500]:10,[3e3]:60,[1e4]:200},Ph={version:6,liquidity:ye,tickCurrent:0,feeGrowthGlobalX64A:ye,feeGrowthGlobalX64B:ye,protocolFeesTokenA:ye,protocolFeesTokenB:ye,swapInAmountTokenA:ye,swapOutAmountTokenB:ye,swapInAmountTokenB:ye,swapOutAmountTokenA:ye,tickArrayBitmap:[],rewardInfos:[],day:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},week:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},month:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},tvl:0},vc={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},wh=new Et("18446744073700000000");import pe from"bn.js";function Mr(o){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,o,!1),new Uint8Array(e)}function hh(o){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,o,!1),new Uint8Array(e)}function Th(o){let e=new ArrayBuffer(4);return new DataView(e).setUint32(0,o,!1),new Uint8Array(e)}function vr(o){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,o,!1),new Uint8Array(e)}function ya(o,e){let t=0;for(let n=o-1;n>=0&&!e.testn(n);n--)t++;return t}function ga(o,e){let t=0;for(let n=0;n<o&&!e.testn(n);n++)t++;return t}function ao(o,e){for(let t=0;t<o;t++)if(e.testn(t))return!1;return!0}function Ec(o,e){return ao(o,e)?null:ya(o,e)}function _c(o,e){return ao(o,e)?null:ga(o,e)}var Up=Buffer.from("amm_config","utf8"),Gp=Buffer.from("pool","utf8"),Xp=Buffer.from("pool_vault","utf8"),Qp=Buffer.from("pool_reward_vault","utf8"),Vc=Buffer.from("position","utf8"),zp=Buffer.from("tick_array","utf8"),jp=Buffer.from("operation","utf8"),Hp=Buffer.from("pool_tick_array_bitmap_extension","utf8"),Yp=Buffer.from("observation","utf8");function Sh(o,e){return ie([Up,Mr(e)],o)}function Fc(o,e,t,n){return ie([Gp,e.toBuffer(),t.toBuffer(),n.toBuffer()],o)}function Aa(o,e,t){return ie([Xp,e.toBuffer(),t.toBuffer()],o)}function Dc(o,e,t){return ie([Qp,e.toBuffer(),t.toBuffer()],o)}function ge(o,e,t){return ie([zp,e.toBuffer(),vr(t)],o)}function en(o,e,t,n){return ie([Vc,e.toBuffer(),vr(t),vr(n)],o)}function ht(o,e){return ie([Vc,e.toBuffer()],o)}function kn(o){return ie([Buffer.from("metadata","utf8"),Xt.toBuffer(),o.toBuffer()],Xt)}function uo(o){return ie([jp],o)}function Xe(o,e){return ie([Hp,e.toBuffer()],o)}function Wc(o,e){return ie([Yp,e.toBuffer()],o)}var qc=Buffer.from("locked_position","utf8");function Pa(o,e){return ie([qc,e.toBuffer()],o)}function co(o,e){return ie([qc,e.toBuffer()],o)}var Zp=Buffer.from("support_mint","utf8");function wa(o,e){return ie([Zp,e.toBuffer()],o)}import{PublicKey as Ot}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as Uc}from"@solana/spl-token";import Ee from"bn.js";import cn from"bn.js";var lo=class{static getfeeGrowthInside(e,t,n){let i=new cn(0),r=new cn(0);e.tickCurrent>=t.tick?(i=t.feeGrowthOutsideX64A,r=t.feeGrowthOutsideX64B):(i=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),r=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new cn(0),a=new cn(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let c=ue.wrappingSubU128(ue.wrappingSubU128(e.feeGrowthGlobalX64A,i),s),u=ue.wrappingSubU128(ue.wrappingSubU128(e.feeGrowthGlobalX64B,r),a);return{feeGrowthInsideX64A:c,feeGrowthInsideBX64:u}}static GetPositionFees(e,t,n,i){let{feeGrowthInsideX64A:r,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=ue.mulDivFloor(ue.wrappingSubU128(r,t.feeGrowthInsideLastX64A),t.liquidity,Ye),c=t.tokenFeesOwedA.add(a),u=ue.mulDivFloor(ue.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,Ye),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,i){let{feeGrowthInsideX64A:r,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=ue.mulDivFloor(ue.wrappingSubU128(r,t.feeGrowthInsideLastX64A),t.liquidity,Ye),c=t.tokenFeesOwedA.add(a),u=ue.mulDivFloor(ue.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,Ye),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,i){let r=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=ue.wrappingSubU128(c,u.growthInsideLastX64),m=ue.mulDivFloor(l,t.liquidity,Ye),d=u.rewardAmountOwed.add(m);r.push(d)}return r}static GetPositionRewards(e,t,n,i){let r=[],s=this.getRewardGrowthInside(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=ue.wrappingSubU128(c,u.growthInsideLastX64),m=ue.mulDivFloor(l,t.liquidity,Ye),d=u.rewardAmountOwed.add(m);r.push(d)}return r}static getRewardGrowthInside(e,t,n,i){let r=[];for(let s=0;s<i.length;s++){let a=new cn(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new cn(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),r.push(ue.wrappingSubU128(ue.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),c))}return r}static getRewardGrowthInsideV2(e,t,n,i){let r=[];for(let s=0;s<i.length;s++){let a=new cn(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new cn(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),r.push(ue.wrappingSubU128(ue.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),c))}return r}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:i,add:r,epochInfo:s}){var y,g,P,k;let a=oe.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),c=oe.getSqrtPriceX64FromTick(t.tickLower),u=oe.getSqrtPriceX64FromTick(t.tickUpper),l=r?1+i:1-i,m=Ae.getAmountsFromLiquidity(a,c,u,n,r),[d,p]=[he(m.amountA,(y=e.mintA.extensions)==null?void 0:y.feeConfig,s,!0),he(m.amountB,(g=e.mintB.extensions)==null?void 0:g.feeConfig,s,!0)],[b,f]=[he(new cn(new O(m.amountA.toString()).mul(l).toFixed(0)),(P=e.mintA.extensions)==null?void 0:P.feeConfig,s,!0),he(new cn(new O(m.amountB.toString()).mul(l).toFixed(0)),(k=e.mintB.extensions)==null?void 0:k.feeConfig,s,!0)];return{liquidity:n,amountA:d,amountB:p,amountSlippageA:b,amountSlippageB:f,expirationTime:jt(d.expirationTime,p.expirationTime)}}};var $p=15,we=class{static async getTickArrays(e,t,n,i,r,s,a){let c=[],u=Z.getTickArrayStartIndexByTick(i,r),l=Z.getInitializedTickArrayInRange(s,a,r,u,Math.floor($p/2));for(let p=0;p<l.length;p++){let{publicKey:b}=ge(t,n,l[p]);c.push(b)}let m=(await qt(e,c)).map(p=>p!==null?mo.decode(p.data):null),d={};for(let p=0;p<c.length;p++){let b=m[p];b!==null&&(d[b.startTickIndex]=U(v({},b),{address:c[p]}))}return d}static nextInitializedTick(e,t,n,i,r,s){let{initializedTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}=this.nextInitializedTickInOneArray(e,t,n,i,r,s);for(;a==null||a.liquidityGross.lten(0);){if(u=Z.getNextTickArrayStartIndex(u,r,s),this.checkIsValidStartIndex(u,r))throw new Error("No enough initialized tickArray");let l=n[u];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:d,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,s);[a,c,u]=[m,d,p]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}}static nextInitializedTickArray(e,t,n,i,r){let s=Math.floor(e/we.tickCount(t)),a=n?Z.searchLowBitFromStart(i,r,s-1,1,t):Z.searchHightBitFromStart(i,r,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,i){let r;if(i){let a=tt-1;for(;a>=0;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){r=c;break}a=a-1}}else{let a=0;for(;a<tt;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){r=c;break}a=a+1}}let{publicKey:s}=ge(e,t,n.startTickIndex);return{nextTick:r,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,i,r,s){let a=Z.getTickArrayStartIndexByTick(i,r),c=Math.floor((i-a)/r),u=n[a];if(u==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;c>=0;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c-1}else for(c=c+1;c<tt;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c+1}let{publicKey:m}=ge(e,t,a);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:u.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(Z.checkIsOutOfBoundary(e)){if(e>kt)return!1;let n=Z.getTickArrayStartIndexByTick(ft,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return tt*e}};var ka=14,hn=class{static maxTickInTickarrayBitmap(e){return e*tt*zn}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(i+=1);let r=n*i;return e<0?{minValue:-r,maxValue:-r+n}:{minValue:r,maxValue:r+n}}static nextInitializedTickArrayStartIndex(e,t,n,i){if(!we.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let r=this.maxTickInTickarrayBitmap(n),s=i?t-we.tickCount(n):t+we.tickCount(n);if(s<-r||s>=r)return{isInit:!1,tickIndex:t};let a=n*tt,c=s/a+512;s<0&&s%a!=0&&c--;let u=Math.abs(c);if(i){let l=e.shln(1024-u-1),m=Ec(1024,l);if(m!==null){let d=(u-m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:-r}}else{let l=e.shrn(u),m=_c(1024,l);if(m!==null){let d=(u+m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:r-we.tickCount(n)}}}},po=class{static getBitmapOffset(e,t){if(!we.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=hn.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&i--,i}static getBitmap(e,t,n){let i=this.getBitmapOffset(e,t);return e<0?{offset:i,tickarrayBitmap:n.negativeTickArrayBitmap[i]}:{offset:i,tickarrayBitmap:n.positiveTickArrayBitmap[i]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:i}=this.extensionTickBoundary(t);if(e>=i&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=hn.maxTickInTickarrayBitmap(e),n=-t;if(kt<=t)throw Error(`extensionTickBoundary check error: ${kt}, ${t}`);if(n<=ft)throw Error(`extensionTickBoundary check error: ${n}, ${ft}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:i}=this.getBitmap(e,t,n),r=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:Z.mergeTickArrayBitmap(i).testn(r),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,i){let r=we.tickCount(t),s=n?e-r:e+r,{tickarrayBitmap:a}=this.getBitmap(s,t,i);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,i){let{minValue:r,maxValue:s}=hn.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(i){let c=Z.mergeTickArrayBitmap(e).shln(zn-1-a),u=ao(512,c)?null:ya(512,c);if(u!==null){let l=t-u*we.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:r}}else{let c=Z.mergeTickArrayBitmap(e).shrn(a),u=ao(512,c)?null:ga(512,c);if(u!==null){let l=t+u*we.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-we.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%hn.maxTickInTickarrayBitmap(t),i=Math.floor(n/we.tickCount(t));return e<0&&n!=0&&(i=zn-i),i}};var Re=class{static getOutputAmountAndRemainAccounts(e,t,n,i,r,s=!1){let a=n.toBase58()===e.mintA.address,c=[],{isExist:u,startIndex:l,nextAccountMeta:m}=this.getFirstInitializedTickArray(e,a);if(!u||l===void 0||!m)throw new Error("Invalid tick array");c.push(m);let{allTrade:d,amountCalculated:p,accounts:b,sqrtPriceX64:f,feeAmount:y}=jn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,a,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i,l,r,s);return c.push(...b),{allTrade:d,expectedAmountOut:p.mul(wn),remainingAccounts:c,executionPrice:f,feeAmount:y}}static getInputAmountAndRemainAccounts(e,t,n,i,r){let s=n.toBase58()===e.mintB.address,a=[],{isExist:c,startIndex:u,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!c||u===void 0||!l)throw new Error("Invalid tick array");try{let f=this.preInitializedTickArrayStartIndex(e,s);if(f.isExist){let{publicKey:y}=ge(e.programId,e.id,f.nextStartIndex);a.push(y)}}catch{}a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:p,feeAmount:b}=jn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i.mul(wn),u,r);return a.push(...d),{expectedAmountIn:m,remainingAccounts:a,executionPrice:p,feeAmount:b}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:i}=Re.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?po.checkTickArrayIsInit(we.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):Z.checkTickArrayIsInitialized(Z.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=ge(e.programId,e.id,i);return{isExist:!0,startIndex:i,nextAccountMeta:a}}let{isExist:r,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,we.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(r){let{publicKey:a}=ge(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/we.tickCount(e.tickSpacing)),i=t?Z.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):Z.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return i.length>0?{isExist:!0,nextStartIndex:i[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=we.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:i,tickIndex:r}=hn.nextInitializedTickArrayStartIndex(Z.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(i)return{isExist:!0,nextStartIndex:r};t=r;let{isInit:s,tickIndex:a}=po.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<ft||t>kt)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:i,rewardInfos:r}){var a,c,u;let s=[];for(let l=0;l<r.length;l++){let m=r[l],d=(u=(a=t.rewardDefaultInfos[l])==null?void 0:a.mint.programId)!=null?u:(c=await e.getAccountInfo(m.tokenMint))==null?void 0:c.owner;if(d===void 0)throw Error("get new reward mint info error");let p=U(v({},m),{perSecond:ue.x64ToDecimal(m.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Ot(d)});if(p.tokenMint.equals(Ot.default))continue;if(n<=p.openTime.toNumber()||i.eq(ye)){s.push(p);continue}let b=new Ee(Math.min(p.endTime.toNumber(),n)),f=b.sub(p.lastUpdateTime),y=ue.mulDivFloor(f,p.emissionsPerSecondX64,i),g=p.rewardGrowthGlobalX64.add(y),P=ue.mulDivFloor(f,p.emissionsPerSecondX64,Ye),k=p.rewardTotalEmissioned.add(P);s.push(U(v({},p),{rewardGrowthGlobalX64:g,rewardTotalEmissioned:k,lastUpdateTime:b}))}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:i}=this.tickRange(e);for(let r of t){let s=Z.getTickArrayStartIndexByTick(r,e);if(s>=n||s<i)return!0}return!1}static tickRange(e){let t=hn.maxTickInTickarrayBitmap(e),n=-t;return t>kt&&(t=we.getArrayStartIndex(kt,e)+we.tickCount(e)),n<ft&&(n=we.getArrayStartIndex(ft,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!we.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/we.tickCount(t)*zn}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let i=await Ne(e,t.map(s=>({pubkey:s})),{batchRequest:n}),r={};for(let s of i)s.accountInfo!==null&&(r[s.pubkey.toString()]=Xc.decode(s.accountInfo.data));return r}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let i={},r=[];for(let c of t){let u=Z.getTickArrayStartIndexByTick(c.tickCurrent,c.tickSpacing),l=Z.getInitializedTickArrayInRange(c.tickArrayBitmap,c.exBitmapInfo,c.tickSpacing,u,7);for(let m of l){let{publicKey:d}=ge(c.programId,c.id,m);r.push({pubkey:d}),i[d.toString()]=c.id}}let s=await Ne(e,r,{batchRequest:n}),a={};for(let c of s){if(!c.accountInfo)continue;let u=i[c.pubkey.toString()];if(!u)continue;a[u.toString()]===void 0&&(a[u.toString()]={});let l=mo.decode(c.accountInfo.data);a[u.toString()][l.startTickIndex]=U(v({},l),{address:c.pubkey})}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:i=!1,updateOwnerRewardAndFee:r=!0}){var a;let s=[];for(let c=0;c<e.length;c++){let u=e[c];u!==null&&(s.find(l=>l.equals(u.state.programId))||s.push(u.state.programId))}if(n){let c=n.tokenAccounts.map(d=>d.accountInfo.mint),u=[];for(let d of c)for(let p of s)u.push(ht(p,d).publicKey);let l=await qt(t,u,{batchRequest:i}),m={};for(let d of l){if(d===null)continue;let p=fo.decode(d.data),b=p.poolId.toString(),f=e.find(x=>x.state.id.toBase58()===b);if(f===void 0)continue;let y=f.state,g=Z._getTickPriceLegacy({poolInfo:y,tick:p.tickLower,baseIn:!0}),P=Z._getTickPriceLegacy({poolInfo:y,tick:p.tickUpper,baseIn:!0}),{amountA:k,amountB:T}=Ae.getAmountsFromLiquidity(y.sqrtPriceX64,g.tickSqrtPriceX64,P.tickSqrtPriceX64,p.liquidity,!1),I=1/(1-Math.sqrt(Math.sqrt(g.price.div(P.price).toNumber())));f.positionAccount=[...(a=f.positionAccount)!=null?a:[],{poolId:p.poolId,nftMint:p.nftMint,priceLower:g.price,priceUpper:P.price,amountA:k,amountB:T,tickLower:p.tickLower,tickUpper:p.tickUpper,liquidity:p.liquidity,feeGrowthInsideLastX64A:p.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:p.feeGrowthInsideLastX64B,tokenFeesOwedA:p.tokenFeesOwedA,tokenFeesOwedB:p.tokenFeesOwedB,rewardInfos:p.rewardInfos.map(x=>U(v({},x),{pendingReward:new Ee(0)})),leverage:I,tokenFeeAmountA:new Ee(0),tokenFeeAmountB:new Ee(0)}];let h=await Z.getTickArrayAddressByTick(f.state.programId,p.poolId,p.tickLower,f.state.tickSpacing),S=await Z.getTickArrayAddressByTick(f.state.programId,p.poolId,p.tickUpper,f.state.tickSpacing);m[`${f.state.programId.toString()}-${p.poolId.toString()}-${p.tickLower}`]=h,m[`${f.state.programId.toString()}-${p.poolId.toString()}-${p.tickUpper}`]=S}if(r){let d=Object.values(m),p=await qt(t,d,{batchRequest:i}),b={};for(let f=0;f<d.length;f++){let y=p[f];if(y===null)continue;let g=d[f].toString();b[g]=mo.decode(y.data)}for(let{state:f,positionAccount:y}of e)if(!!y)for(let g of y){let P=`${f.programId.toString()}-${f.id.toString()}-${g.tickLower}`,k=`${f.programId.toString()}-${f.id.toString()}-${g.tickUpper}`,T=b[m[P].toString()],I=b[m[k].toString()],h=T.ticks[Z.getTickOffsetInArray(g.tickLower,f.tickSpacing)],S=I.ticks[Z.getTickOffsetInArray(g.tickUpper,f.tickSpacing)],{tokenFeeAmountA:x,tokenFeeAmountB:K}=await lo.GetPositionFees(f,g,h,S),B=await lo.GetPositionRewards(f,g,h,S);g.tokenFeeAmountA=x.gte(new Ee(0))?x:new Ee(0),g.tokenFeeAmountB=K.gte(new Ee(0))?K:new Ee(0);for(let C=0;C<B.length;C++)g.rewardInfos[C].pendingReward=B[C].gte(new Ee(0))?B[C]:new Ee(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountIn:r,slippage:s,priceLimit:a=new O(0),catchLiquidityInsufficient:c=!1}){var L;let u,l=n.toBase58()===e.mintA.address,[m,d]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new O(0))?u=l?_t.add(new Ee(1)):Vt.sub(new Ee(1)):u=oe.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let p=he(r,m,i,!1),{allTrade:b,expectedAmountOut:f,remainingAccounts:y,executionPrice:g,feeAmount:P}=Re.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub((L=p.fee)!=null?L:ye),u,c),k=he(f,d,i,!1),T=oe.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),I=l?T:new O(1).div(T),h=f.mul(new Ee(Math.floor((1-s)*1e10))).div(new Ee(1e10)),S=he(h,d,i,!1),x=l?e.currentPrice:new O(1).div(e.currentPrice),K=new O(I).sub(x).abs(),B=x,C=new ot(new O(K).mul(10**15).toFixed(0),new O(B).mul(10**15).toFixed(0));return{allTrade:b,realAmountIn:p,amountOut:k,minAmountOut:S,expirationTime:jt(p.expirationTime,k.expirationTime),currentPrice:e.currentPrice,executionPrice:I,priceImpact:C,fee:P,remainingAccounts:y,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:i,slippage:r,epochInfo:s,catchLiquidityInsufficient:a=!1}){let c=i.address===e.mintB.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA],[m,d]=[new Ve(U(v({},u),{mint:u.address,isToken2022:u.programId===Uc.toBase58()})),new Ve(U(v({},l),{mint:l.address,isToken2022:l.programId===Uc.toBase58()}))],{allTrade:p,realAmountIn:b,amountOut:f,minAmountOut:y,expirationTime:g,currentPrice:P,executionPrice:k,priceImpact:T,fee:I,remainingAccounts:h,executionPriceX64:S}=Re.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Ot(u.address),amountIn:n,slippage:r,epochInfo:s,catchLiquidityInsufficient:a}),x=U(v({},b),{amount:new Ie(m,b.amount),fee:b.fee===void 0?void 0:new Ie(m,b.fee)}),K=U(v({},f),{amount:new Ie(d,f.amount),fee:f.fee===void 0?void 0:new Ie(d,f.fee)}),B=U(v({},y),{amount:new Ie(d,y.amount),fee:y.fee===void 0?void 0:new Ie(d,y.fee)}),C=new It({baseToken:m,denominator:new Ee(10).pow(new Ee(20+m.decimals)),quoteToken:d,numerator:P.mul(new O(10**(20+d.decimals))).toFixed(0)}),L=new It({baseToken:m,denominator:new Ee(10).pow(new Ee(20+m.decimals)),quoteToken:d,numerator:k.mul(new O(10**(20+d.decimals))).toFixed(0)}),R=new Ie(m,I);return{allTrade:p,realAmountIn:x,amountOut:K,minAmountOut:B,expirationTime:g,currentPrice:C,executionPrice:L,priceImpact:T,fee:R,remainingAccounts:h,executionPriceX64:S}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountOut:r,slippage:s,priceLimit:a=new O(0)}){var B;let c=n.toBase58()===e.mintA.address,u={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;a.equals(new O(0))?l=c?Vt.sub(new Ee(1)):_t.add(new Ee(1)):l=oe.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let m=he(r,u[n.toString()],i,!0),{expectedAmountIn:d,remainingAccounts:p,executionPrice:b,feeAmount:f}=Re.getInputAmountAndRemainAccounts(e,t,n,m.amount.sub((B=m.fee)!=null?B:ye),l),y=c?e.mintB.address:e.mintA.address,g=he(d,u[y],i,!1),P=oe.sqrtPriceX64ToPrice(b,e.mintA.decimals,e.mintB.decimals),k=c?P:new O(1).div(P),T=d.mul(new Ee(Math.floor((1+s)*1e10))).div(new Ee(1e10)),I=he(T,u[y],i,!0),h=c?e.currentPrice:new O(1).div(e.currentPrice),S=new O(k).sub(h).abs(),x=h,K=new ot(new O(S).mul(10**15).toFixed(0),new O(x).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:I,realAmountOut:m,expirationTime:jt(g.expirationTime,m.expirationTime),currentPrice:e.currentPrice,executionPrice:k,priceImpact:K,fee:f,remainingAccounts:p}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:i}){var b,f,y;let r=e[t],s=Z.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=Z.getTickPrice({poolInfo:e,tick:i,baseIn:!0}).price.toNumber(),c=Math.max(s,r.priceMin),l=Math.min(a,r.priceMax)-c,m=a-s,d=r.priceMax-r.priceMin,p;return l<=0?p=0:m===l?p=d/l:d===l?p=l/m:p=l/d*(l/m),{feeApr:r.feeApr*p,rewardsApr:[((b=r.rewardApr[0])!=null?b:0)*p,((f=r.rewardApr[1])!=null?f:0)*p,((y=r.rewardApr[2])!=null?y:0)*p],apr:r.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:i,liquidity:r,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:c}){let u=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=i[mt(e.mintA.address).toString()],d=i[mt(e.mintB.address).toString()],p=e.mintA.decimals,b=e.mintB.decimals;if(!l||!m||!d)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let f=oe.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),y=oe.getSqrtPriceX64FromTick(s),g=oe.getSqrtPriceX64FromTick(a),{amountSlippageA:P,amountSlippageB:k}=Ae.getAmountsFromLiquidityWithSlippage(f,y,g,t,!1,!1,0),{amountSlippageA:T,amountSlippageB:I}=Ae.getAmountsFromLiquidityWithSlippage(f,y,g,r,!1,!1,0),h=new O(P.toString()).div(new O(10).pow(p)).mul(m.value).add(new O(k.toString()).div(new O(10).pow(b)).mul(d.value)),S=new O(T.toString()).div(new O(10).pow(p)).mul(m.value).add(new O(I.toString()).div(new O(10).pow(b)).mul(d.value)),x=new O(1).div(h.add(S)),B=new O(l.volumeFee).mul(365).div(u).mul(x).mul(100).toNumber(),C=3600*24*365,L=e.rewardDefaultInfos.map(R=>{var W,Y;let D=R.mint.decimals,_=i[R.mint.address];return c<((W=R.startTime)!=null?W:0)||c>((Y=R.endTime)!=null?Y:0)||!R.perSecond||!_||D===void 0?0:new O(_.value).mul(new O(R.perSecond).mul(C)).div(new O(10).pow(D)).mul(x).mul(100).toNumber()});return{feeApr:B,rewardsApr:L,apr:B+L.reduce((R,D)=>R+D,0)}}static async getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:i,amount:r,slippage:s,add:a,epochInfo:c,amountHasFee:u}){var g,P;let l=oe.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),m=oe.getSqrtPriceX64FromTick(n),d=oe.getSqrtPriceX64FromTick(i),p=he(r,(g=e[t?"mintA":"mintB"].extensions)==null?void 0:g.feeConfig,c,!u),b=new Ee(new O(p.amount.sub((P=p.fee)!=null?P:ye).toString()).toFixed(0)),f;if(l.lte(m))f=t?Ae.getLiquidityFromTokenAmountA(m,d,b,!a):new Ee(0);else if(l.lte(d)){let k=Ae.getLiquidityFromTokenAmountA(l,d,b,!a),T=Ae.getLiquidityFromTokenAmountB(m,l,b);f=t?k:T}else f=t?new Ee(0):Ae.getLiquidityFromTokenAmountB(m,d,b);let y=await Re.getAmountsFromLiquidity({epochInfo:c,poolInfo:e,tickLower:n,tickUpper:i,liquidity:f,slippage:s,add:a});return{liquidity:f,amountA:t?p:y.amountA,amountB:t?y.amountB:p,amountSlippageA:t?p:y.amountSlippageA,amountSlippageB:t?y.amountSlippageB:p,expirationTime:y.expirationTime}}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:i,liquidity:r,slippage:s,add:a}){var y,g,P,k;let c=oe.getSqrtPriceX64FromTick(n),u=oe.getSqrtPriceX64FromTick(i),l=a?1+s:1-s,m=Ae.getAmountsFromLiquidity(oe.priceToSqrtPriceX64(new O(t.price),t.mintA.decimals,t.mintB.decimals),c,u,r,a),[d,p]=[he(m.amountA,(y=t.mintA.extensions)==null?void 0:y.feeConfig,e,!0),he(m.amountB,(g=t.mintB.extensions)==null?void 0:g.feeConfig,e,!0)],[b,f]=[he(m.amountA.muln(l),(P=t.mintA.extensions)==null?void 0:P.feeConfig,e,!0),he(m.amountB.muln(l),(k=t.mintB.extensions)==null?void 0:k.feeConfig,e,!0)];return{liquidity:r,amountA:d,amountB:p,amountSlippageA:b,amountSlippageB:f,expirationTime:jt(d.expirationTime,p.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let i=t.filter(c=>!n[c.id]).map(c=>new Ot(c.id));(await qt(e,i)).forEach((c,u)=>{!c||(n[i[u].toBase58()]=Hn.decode(c.data))});let s=t.map(c=>Xe(new Ot(c.programId),new Ot(c.id)).publicKey),a=await Re.fetchExBitmaps({connection:e,exBitmapAddress:s,batchRequest:!1});return t.reduce((c,u)=>U(v({},c),{[u.id]:U(v({},n[u.id]),{id:new Ot(u.id),version:6,programId:new Ot(u.programId),mintA:u.mintA,mintB:u.mintB,ammConfig:U(v({},u.config),{id:new Ot(u.config.id),fundOwner:""}),currentPrice:new O(u.price),exBitmapAccount:Xe(new Ot(u.programId),new Ot(u.id)).publicKey,exBitmapInfo:a[Xe(new Ot(u.programId),new Ot(u.id)).publicKey.toBase58()],startTime:n[u.id].startTime.toNumber(),rewardInfos:n[u.id].rewardInfos})}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};function dT({poolInfo:o,tickLower:e,tickUpper:t,amountA:n,amountB:i,slippage:r,add:s,epochInfo:a,amountHasFee:c}){var k,T,I,h;let[u,l,m,d]=e<t?[e,t,n,i]:[t,e,i,n],p=oe.priceToSqrtPriceX64(new O(o.price),o.mintA.decimals,o.mintB.decimals),b=oe.getSqrtPriceX64FromTick(u),f=oe.getSqrtPriceX64FromTick(l),[y,g]=[he(m,(k=o.mintA.extensions)==null?void 0:k.feeConfig,a,!c),he(d,(T=o.mintB.extensions)==null?void 0:T.feeConfig,a,!c)],P=Ae.getLiquidityFromTokenAmounts(p,b,f,y.amount.sub((I=y.fee)!=null?I:ye),g.amount.sub((h=g.fee)!=null?h:ye));return Ae.getAmountsOutFromLiquidity({poolInfo:o,tickLower:e,tickUpper:t,liquidity:P,slippage:r,add:s,epochInfo:a,amountAddFee:!c})}var ha={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function Gc(o){return U(v({},o),{type:"Concentrated",programId:o.programId.toString(),id:o.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:o.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:o.ammConfig.tradeFeeRate,openTime:o.startTime.toString(),tvl:0,day:ha,week:ha,month:ha,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,burnPercent:0,config:U(v({},o.ammConfig),{id:o.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]})})}var ue=class{static mulDivRoundingUp(e,t,n){let i=e.mul(t),r=i.div(n);return i.mod(n).eq(ye)||(r=r.add(Nt)),r}static mulDivFloor(e,t,n){if(n.eq(ye))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(ye))throw new Error("division by 0");return e.mul(t).add(n.sub(Nt)).div(n)}static x64ToDecimal(e,t){return new O(e.toString()).div(O.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new pe(e.mul(O.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(Lr).sub(t).mod(Lr)}};function st(o,e){return Ta(o.mul(e),64,256)}function Jp(o,e,t){let n=o.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function Ta(o,e,t){let n=o.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var oe=class{static sqrtPriceX64ToPrice(e,t,n){return ue.x64ToDecimal(e).pow(2).mul(O.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return ue.decimalToX64(e.mul(O.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,i){if(!e.gt(ye))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(ye))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,i){if(!e.gt(ye))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(ye))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,i){if(n.eq(ye))return e;let r=t.shln(so);if(i){let s=r,a=r.add(n.mul(e));return a.gte(s)?ue.mulDivCeil(s,e,a):ue.mulDivRoundingUp(s,Nt,s.div(e).add(n))}else{let s=n.mul(e);if(!r.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=r.sub(s);return ue.mulDivCeil(r,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,i){let r=n.shln(so);if(i)return e.add(r.div(t));{let s=ue.mulDivRoundingUp(r,Nt,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<ft||e>kt)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new pe("18445821805675395072"):new pe("18446744073709551616");return(t&2)!=0&&(n=st(n,new pe("18444899583751176192"))),(t&4)!=0&&(n=st(n,new pe("18443055278223355904"))),(t&8)!=0&&(n=st(n,new pe("18439367220385607680"))),(t&16)!=0&&(n=st(n,new pe("18431993317065453568"))),(t&32)!=0&&(n=st(n,new pe("18417254355718170624"))),(t&64)!=0&&(n=st(n,new pe("18387811781193609216"))),(t&128)!=0&&(n=st(n,new pe("18329067761203558400"))),(t&256)!=0&&(n=st(n,new pe("18212142134806163456"))),(t&512)!=0&&(n=st(n,new pe("17980523815641700352"))),(t&1024)!=0&&(n=st(n,new pe("17526086738831433728"))),(t&2048)!=0&&(n=st(n,new pe("16651378430235570176"))),(t&4096)!=0&&(n=st(n,new pe("15030750278694412288"))),(t&8192)!=0&&(n=st(n,new pe("12247334978884435968"))),(t&16384)!=0&&(n=st(n,new pe("8131365268886854656"))),(t&32768)!=0&&(n=st(n,new pe("3584323654725218816"))),(t&65536)!=0&&(n=st(n,new pe("696457651848324352"))),(t&131072)!=0&&(n=st(n,new pe("26294789957507116"))),(t&262144)!=0&&(n=st(n,new pe("37481735321082"))),e>0&&(n=Lc.div(n)),n}static getTickFromPrice(e,t,n){return oe.getTickFromSqrtPriceX64(oe.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(Vt)||e.lt(_t))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new pe(t-64),i=Jp(n,32,128),r=new pe("8000000000000000","hex"),s=0,a=new pe(0),c=t>=64?e.shrn(t-63):e.shln(63-t);for(;r.gt(new pe(0))&&s<Rc;){c=c.mul(c);let b=c.shrn(127);c=c.shrn(63+b.toNumber()),a=a.add(r.mul(b)),r=r.shrn(1),s+=1}let u=a.shrn(32),m=i.add(u).mul(new pe(Nc)),d=Ta(m.sub(new pe(Oc)),64,128).toNumber(),p=Ta(m.add(new pe(Mc)),64,128).toNumber();return d==p?d:oe.getSqrtPriceX64FromTick(p).lte(e)?p:d}},Yn=class{static getTickWithPriceAndTickspacing(e,t,n,i){let s=oe.getTickFromSqrtPriceX64(oe.priceToSqrtPriceX64(e,n,i))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,i){let r=Yn.getTickWithPriceAndTickspacing(e,t,n,i),s=oe.getSqrtPriceX64FromTick(r);return oe.sqrtPriceX64ToPrice(s,n,i)}},Ae=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(ye))throw new Error("sqrtPriceX64A must greater than 0");let r=n.ushln(so),s=t.sub(e);return i?ue.mulDivRoundingUp(ue.mulDivCeil(r,s,t),Nt,e):ue.mulDivFloor(r,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(ye))throw new Error("sqrtPriceX64A must greater than 0");return i?ue.mulDivCeil(n,t.sub(e),Ye):ue.mulDivFloor(n,t.sub(e),Ye)}static getLiquidityFromTokenAmountA(e,t,n,i){e.gt(t)&&([e,t]=[t,e]);let r=n.mul(e).mul(t),s=t.sub(e),a=r.div(s);return i?ue.mulDivRoundingUp(a,Nt,ro):a.shrn(so)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),ue.mulDivFloor(n,ro,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,i,r){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return Ae.getLiquidityFromTokenAmountA(t,n,i,!1);if(e.lt(n)){let s=Ae.getLiquidityFromTokenAmountA(e,n,i,!1),a=Ae.getLiquidityFromTokenAmountB(t,e,r);return s.lt(a)?s:a}else return Ae.getLiquidityFromTokenAmountB(t,n,r)}static getAmountsFromLiquidity(e,t,n,i,r){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:Ae.getTokenAmountAFromLiquidity(t,n,i,r),amountB:new pe(0)};if(e.lt(n)){let s=Ae.getTokenAmountAFromLiquidity(e,n,i,r),a=Ae.getTokenAmountBFromLiquidity(t,e,i,r);return{amountA:s,amountB:a}}else return{amountA:new pe(0),amountB:Ae.getTokenAmountBFromLiquidity(t,n,i,r)}}static getAmountsFromLiquidityWithSlippage(e,t,n,i,r,s,a){let{amountA:c,amountB:u}=Ae.getAmountsFromLiquidity(e,t,n,i,s),l=r?1+a:1-a,m=new pe(new O(c.toString()).mul(l).toFixed(0)),d=new pe(new O(u.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:d}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:i,slippage:r,add:s,epochInfo:a,amountAddFee:c}){var P,k,T,I;let u=oe.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),l=oe.getSqrtPriceX64FromTick(t),m=oe.getSqrtPriceX64FromTick(n),d=s?1+r:1-r,p=Ae.getAmountsFromLiquidity(u,l,m,i,s),[b,f]=[he(p.amountA,(P=e.mintA.extensions)==null?void 0:P.feeConfig,a,c),he(p.amountB,(k=e.mintB.extensions)==null?void 0:k.feeConfig,a,c)],[y,g]=[he(new pe(new O(p.amountA.toString()).mul(d).toFixed(0)),(T=e.mintA.extensions)==null?void 0:T.feeConfig,a,c),he(new pe(new O(p.amountB.toString()).mul(d).toFixed(0)),(I=e.mintB.extensions)==null?void 0:I.feeConfig,a,c)];return{liquidity:i,amountA:b,amountB:f,amountSlippageA:y,amountSlippageB:g,expirationTime:jt(b.expirationTime,f.expirationTime)}}},jn=class{static swapCompute(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f=!1){if(d.eq(ye))throw new Error("amountSpecified must not be 0");if(b||(b=s?_t.add(Nt):Vt.sub(Nt)),s){if(b.lt(_t))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(b.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(b.gt(Vt))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(b.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let y=d.gt(ye),g={amountSpecifiedRemaining:d,amountCalculated:ye,sqrtPriceX64:m,tick:u>p?Math.min(p+we.tickCount(l)-1,u):p,accounts:[],liquidity:c,feeAmount:new pe(0)},P=p,k=n[p],T=0,I=!s&&k.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(ye)&&!g.sqrtPriceX64.eq(b);){T>10;let h={};h.sqrtPriceStartX64=g.sqrtPriceX64;let S=Z.nextInitTick(k,g.tick,l,s,I),x=S||null,K=null;if(!(x!=null&&x.liquidityGross.gtn(0))){let C=Re.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:l,tickArrayBitmap:i,exBitmapInfo:r},P,s);if(!C.isExist){if(f)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}P=C.nextStartIndex;let{publicKey:L}=ge(e,t,P);K=L,k=n[P];try{x=Z.firstInitializedTick(k,s)}catch{throw Error("not found next tick info")}}h.tickNext=x.tick,h.initialized=x.liquidityGross.gtn(0),p!==P&&K&&(g.accounts.push(K),p=P),h.tickNext<ft?h.tickNext=ft:h.tickNext>kt&&(h.tickNext=kt),h.sqrtPriceNextX64=oe.getSqrtPriceX64FromTick(h.tickNext);let B;if(s&&h.sqrtPriceNextX64.lt(b)||!s&&h.sqrtPriceNextX64.gt(b)?B=b:B=h.sqrtPriceNextX64,[g.sqrtPriceX64,h.amountIn,h.amountOut,h.feeAmount]=jn.swapStepCompute(g.sqrtPriceX64,B,g.liquidity,g.amountSpecifiedRemaining,a,s),g.feeAmount=g.feeAmount.add(h.feeAmount),y?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(h.amountIn.add(h.feeAmount)),g.amountCalculated=g.amountCalculated.sub(h.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(h.amountOut),g.amountCalculated=g.amountCalculated.add(h.amountIn.add(h.feeAmount))),g.sqrtPriceX64.eq(h.sqrtPriceNextX64)){if(h.initialized){let C=x.liquidityNet;s&&(C=C.mul(wn)),g.liquidity=Ae.addDelta(g.liquidity,C)}I=h.tickNext!=g.tick&&!s&&k.startTickIndex===h.tickNext,g.tick=s?h.tickNext-1:h.tickNext}else if(g.sqrtPriceX64!=h.sqrtPriceStartX64){let C=oe.getTickFromSqrtPriceX64(g.sqrtPriceX64);I=C!=g.tick&&!s&&k.startTickIndex===C,g.tick=C}++T}try{let{nextStartIndex:h,isExist:S}=we.nextInitializedTickArray(g.tick,l,s,i,r);S&&p!==h&&(g.accounts.push(ge(e,t,h).publicKey),p=h)}catch{}return{allTrade:!0,amountSpecifiedRemaining:ye,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,i,r,s){let a={sqrtPriceX64Next:new pe(0),amountIn:new pe(0),amountOut:new pe(0),feeAmount:new pe(0)},c=i.gte(ye);if(c){let l=ue.mulDivFloor(i,Or.sub(new pe(r.toString())),Or);a.amountIn=s?Ae.getTokenAmountAFromLiquidity(t,e,n,!0):Ae.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(a.amountIn)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=oe.getNextSqrtPriceX64FromInput(e,n,l,s)}else a.amountOut=s?Ae.getTokenAmountBFromLiquidity(t,e,n,!1):Ae.getTokenAmountAFromLiquidity(e,t,n,!1),i.mul(wn).gte(a.amountOut)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=oe.getNextSqrtPriceX64FromOutput(e,n,i.mul(wn),s);let u=t.eq(a.sqrtPriceX64Next);return s?(u&&c||(a.amountIn=Ae.getTokenAmountAFromLiquidity(a.sqrtPriceX64Next,e,n,!0)),u&&!c||(a.amountOut=Ae.getTokenAmountBFromLiquidity(a.sqrtPriceX64Next,e,n,!1))):(a.amountIn=u&&c?a.amountIn:Ae.getTokenAmountBFromLiquidity(e,a.sqrtPriceX64Next,n,!0),a.amountOut=u&&!c?a.amountOut:Ae.getTokenAmountAFromLiquidity(e,a.sqrtPriceX64Next,n,!1)),!c&&a.amountOut.gt(i.mul(wn))&&(a.amountOut=i.mul(wn)),c&&!a.sqrtPriceX64Next.eq(t)?a.feeAmount=i.sub(a.amountIn):a.feeAmount=ue.mulDivCeil(a.amountIn,new pe(r),Or.sub(new pe(r))),[a.sqrtPriceX64Next,a.amountIn,a.amountOut,a.feeAmount]}};var tt=60,zn=512,Z=class{static getTickArrayAddressByTick(e,t,n,i){let r=Z.getTickArrayStartIndexByTick(n,i),{publicKey:s}=ge(e,t,r);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=Z.getTickArrayStartIndexByTick(e,t),i=Math.floor((e-n)/t);if(i<0||i>=tt)throw new Error("tick offset in array overflow");return i}static getTickArrayBitIndex(e,t){let n=we.tickCount(t),i=e/n;return e<0&&e%n!=0?i=Math.ceil(i)-1:i=Math.floor(i),i}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*we.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*tt,i=Math.floor(e/n)+512;return Math.abs(i)}static checkTickArrayIsInitialized(e,t,n){let i=n*tt,r=Math.floor(t/i)+512,s=Math.abs(r);return{isInitialized:e.testn(s),startIndex:(s-512)*i}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*tt:e+t*tt}static mergeTickArrayBitmap(e){let t=new ef(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,i,r){let s=Math.floor(i/(n*tt));return[...Z.searchLowBitFromStart(e,t,s-1,r,n),...Z.searchHightBitFromStart(e,t,s,r,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return Z.searchHightBitFromStart(e,t,-7680,zn,n)}static getAllInitializedTickArrayInfo(e,t,n,i,r){let s=[],a=Z.getAllInitializedTickArrayStartIndex(n,i,r);for(let c of a){let{publicKey:u}=ge(e,t,c);s.push({tickArrayStartIndex:c,tickArrayAddress:u})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,i,r){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>Z.mergeTickArrayBitmap(u)),a=[];for(;n>=-7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n--,a.length===i)break}let c=we.tickCount(r);return a.map(u=>u*c)}static searchHightBitFromStart(e,t,n,i,r){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>Z.mergeTickArrayBitmap(u)),a=[];for(;n<7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n++,a.length===i)break}let c=we.tickCount(r);return a.map(u=>u*c)}static checkIsOutOfBoundary(e){return e<ft||e>kt}static nextInitTick(e,t,n,i,r){if(we.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(i)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(r||(a=a+1);a<tt;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=tt-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<tt;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let i=oe.getSqrtPriceX64FromTick(t),r=oe.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:r,tickSqrtPriceX64:i}:{tick:t,price:new O(1).div(r),tickSqrtPriceX64:i}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let i=n?t:new O(1).div(t),r=Yn.getTickWithPriceAndTickspacing(i,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=oe.getSqrtPriceX64FromTick(r),a=oe.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:r,price:a}:{tick:r,price:new O(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let i=oe.getSqrtPriceX64FromTick(t),r=oe.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:r,tickSqrtPriceX64:i}:{tick:t,price:new O(1).div(r),tickSqrtPriceX64:i}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let i=n?t:new O(1).div(t),r=Yn.getTickWithPriceAndTickspacing(i,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=oe.getSqrtPriceX64FromTick(r),a=oe.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:r,price:a}:{tick:r,price:new O(1).div(a)}}};var Qc=E([Te(8),q("bump"),Zt("index"),N(""),ut("protocolFeeRate"),ut("tradeFeeRate"),Zt("tickSpacing"),z(w(),8,"")]),tf=E([ut("blockTimestamp"),gi("tickCumulative"),z(w(),4)]),zc=E([Te(8),Fe("initialized"),w("recentEpoch"),Zt("observationIndex"),N("poolId"),z(tf,100,"observations"),z(w(),4)]),nf=E([q("rewardState"),w("openTime"),w("endTime"),w("lastUpdateTime"),te("emissionsPerSecondX64"),w("rewardTotalEmissioned"),w("rewardClaimed"),N("tokenMint"),N("tokenVault"),N("creator"),te("rewardGrowthGlobalX64")]),Hn=E([Te(8),q("bump"),N("ammConfig"),N("creator"),N("mintA"),N("mintB"),N("vaultA"),N("vaultB"),N("observationId"),q("mintDecimalsA"),q("mintDecimalsB"),Zt("tickSpacing"),te("liquidity"),te("sqrtPriceX64"),ve("tickCurrent"),ut(),te("feeGrowthGlobalX64A"),te("feeGrowthGlobalX64B"),w("protocolFeesTokenA"),w("protocolFeesTokenB"),te("swapInAmountTokenA"),te("swapOutAmountTokenB"),te("swapInAmountTokenB"),te("swapOutAmountTokenA"),q("status"),z(q(),7,""),z(nf,3,"rewardInfos"),z(w(),16,"tickArrayBitmap"),w("totalFeesTokenA"),w("totalFeesClaimedTokenA"),w("totalFeesTokenB"),w("totalFeesClaimedTokenB"),w("fundFeesTokenA"),w("fundFeesTokenB"),w("startTime"),z(w(),15*4-3,"padding")]),of=E([te("growthInsideLastX64"),w("rewardAmountOwed")]),fo=E([Te(8),q("bump"),N("nftMint"),N("poolId"),ve("tickLower"),ve("tickUpper"),te("liquidity"),te("feeGrowthInsideLastX64A"),te("feeGrowthInsideLastX64B"),w("tokenFeesOwedA"),w("tokenFeesOwedB"),z(of,3,"rewardInfos"),z(w(),8,"")]),ET=E([Te(8),q("bump"),N("poolId"),ve("tickLowerIndex"),ve("tickUpperIndex"),te("liquidity"),te("feeGrowthInsideLastX64A"),te("feeGrowthInsideLastX64B"),w("tokenFeesOwedA"),w("tokenFeesOwedB"),z(te(),3,"rewardGrowthInside"),z(w(),8,"")]),rf=E([ve("tick"),ac("liquidityNet"),te("liquidityGross"),te("feeGrowthOutsideX64A"),te("feeGrowthOutsideX64B"),z(te(),3,"rewardGrowthsOutsideX64"),z(ut(),13,"")]),mo=E([Te(8),N("poolId"),ve("startTickIndex"),z(rf,tt,"ticks"),q("initializedTickCount"),z(q(),115,"")]),jc=E([Te(329),z(N(),100,"whitelistMints")]),Xc=E([Te(8),N("poolId"),z(z(w(),8),ka,"positiveTickArrayBitmap"),z(z(w(),8),ka,"negativeTickArrayBitmap")]),_T=E([w(),q("bump"),N("owner"),N("poolId"),N("positionId"),N("nftAccount"),z(w(),8)]),VT=E([Te(8),q("bump"),N("lockOwner"),N("poolId"),N("positionId"),N("nftAccount"),N("lockNftMint"),w("recentEpoch"),z(w(),8)]);zc.span;var Hc=fe("Raydium_Clmm"),Mt={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],openPositionWithTokenEx:[77,255,174,82,125,29,201,46],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},Yc=[188,37,179,131,82,150,84,73],Zc=[16,72,250,198,14,162,212,19],Se=class{static createPoolInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,b){let f=E([te("sqrtPriceX64"),w("zero")]),y=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:He,isSigner:!1,isWritable:!1},...(b==null?void 0:b.map(k=>({pubkey:k,isSigner:!1,isWritable:!1})))||[]],g=Buffer.alloc(f.span);f.encode({sqrtPriceX64:p,zero:ye},g);let P=Buffer.from([...Mt.createPool,...g]);return new ct({keys:y,programId:e,data:P})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:i,mintB:r,ammConfigId:s,initialPriceX64:a,extendMintAccount:c}=e,[u,l]=[new Q(i.address),new Q(r.address)],{publicKey:m}=Fc(t,s,u,l),{publicKey:d}=Wc(t,m),{publicKey:p}=Aa(t,m,u),{publicKey:b}=Aa(t,m,l),f=Xe(t,m).publicKey,y=[this.createPoolInstruction(t,m,n,s,d,u,p,new Q(i.programId||xe),l,b,new Q(r.programId||xe),f,a,c)];return{signers:[],instructions:y,instructionTypes:[X.CreateAccount,X.ClmmCreatePool],address:{poolId:m,observationId:d,exBitmapAccount:f,mintAVault:p,mintBVault:b},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P,k,T,I,h,S,x,K,B){let C=E([ve("tickLowerIndex"),ve("tickUpperIndex"),ve("tickArrayLowerStartIndex"),ve("tickArrayUpperStartIndex"),te("liquidity"),w("amountMaxA"),w("amountMaxB"),Fe("withMetadata"),q("optionBaseFlag"),Fe("baseFlag")]),L=[...B?[{pubkey:B,isSigner:!1,isWritable:!0}]:[]],R=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:bo,isSigner:!1,isWritable:!1},{pubkey:Xt,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...L],D=Buffer.alloc(C.span);C.encode({tickLowerIndex:P,tickUpperIndex:k,tickArrayLowerStartIndex:T,tickArrayUpperStartIndex:I,liquidity:h,amountMaxA:S,amountMaxB:x,withMetadata:K==="create",baseFlag:!1,optionBaseFlag:0},D);let _=Buffer.from([...Mt.openPosition,...D]);return new ct({keys:R,programId:e,data:_})}static openPositionFromLiquidityInstruction22(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P,k,T,I,h,S,x,K){let B=E([ve("tickLowerIndex"),ve("tickUpperIndex"),ve("tickArrayLowerStartIndex"),ve("tickArrayUpperStartIndex"),te("liquidity"),w("amountMaxA"),w("amountMaxB"),Fe("withMetadata"),q("optionBaseFlag"),Fe("baseFlag")]),C=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],L=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:bo,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...C],R=Buffer.alloc(B.span);B.encode({tickLowerIndex:g,tickUpperIndex:P,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:T,liquidity:I,amountMaxA:h,amountMaxB:S,withMetadata:x==="create",baseFlag:!1,optionBaseFlag:0},R);let D=Buffer.from([...Mt.openPositionWithTokenEx,...R]);return new ct({keys:L,programId:e,data:D})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d=[],[p,b]=[new Q(e.programId),new Q(e.id)],f;if(l)f=new Q((await l(1))[0]);else{let K=Er.generate();d.push(K),f=K.publicKey}let y=Z.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=Z.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:P}=ge(p,b,y),{publicKey:k}=ge(p,b,g),{publicKey:T}=m?J(n.wallet,f,We):J(n.wallet,f,xe),{publicKey:I}=kn(f),{publicKey:h}=ht(p,f),{publicKey:S}=en(p,b,i,r),x=m?this.openPositionFromLiquidityInstruction22(p,n.feePayer,b,n.wallet,f,T,S,P,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),i,r,y,g,s,a,c,u,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?Xe(p,b).publicKey:void 0):this.openPositionFromLiquidityInstruction(p,n.feePayer,b,n.wallet,f,T,I,S,P,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),i,r,y,g,s,a,c,u,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?Xe(p,b).publicKey:void 0);return{signers:d,instructions:[x],instructionTypes:[X.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:f,tickArrayLower:P,tickArrayUpper:k,positionNftAccount:T,metadataAccount:I,personalPosition:h,protocolPosition:S}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,base:s,baseAmount:a,otherAmountMax:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d=[],[p,b]=[new Q(e.programId),new Q(e.id)],f;if(l)f=new Q((await l(1))[0]);else{let K=Er.generate();d.push(K),f=K.publicKey}let y=Z.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=Z.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:P}=ge(p,b,y),{publicKey:k}=ge(p,b,g),{publicKey:T}=m?J(n.wallet,f,We):J(n.wallet,f,xe),{publicKey:I}=kn(f),{publicKey:h}=ht(p,f),{publicKey:S}=en(p,b,i,r),x=m?this.openPositionFromBaseInstruction22(p,n.feePayer,b,n.wallet,f,T,S,P,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),i,r,y,g,u,s,a,c,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?Xe(p,b).publicKey:void 0):this.openPositionFromBaseInstruction(p,n.feePayer,b,n.wallet,f,T,I,S,P,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),i,r,y,g,u,s,a,c,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?Xe(p,b).publicKey:void 0);return{address:{nftMint:f,tickArrayLower:P,tickArrayUpper:k,positionNftAccount:T,metadataAccount:I,personalPosition:h,protocolPosition:S},instructions:[x],signers:d,instructionTypes:[X.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P,k,T,I,h,S,x,K,B){let C=E([ve("tickLowerIndex"),ve("tickUpperIndex"),ve("tickArrayLowerStartIndex"),ve("tickArrayUpperStartIndex"),te("liquidity"),w("amountMaxA"),w("amountMaxB"),Fe("withMetadata"),q("optionBaseFlag"),Fe("baseFlag")]),L=[...B?[{pubkey:B,isSigner:!1,isWritable:!0}]:[]],R=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:bo,isSigner:!1,isWritable:!1},{pubkey:Xt,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...L],D=Buffer.alloc(C.span);C.encode({tickLowerIndex:P,tickUpperIndex:k,tickArrayLowerStartIndex:T,tickArrayUpperStartIndex:I,liquidity:new Ia(0),amountMaxA:S==="MintA"?x:K,amountMaxB:S==="MintA"?K:x,withMetadata:h==="create",baseFlag:S==="MintA",optionBaseFlag:1},D);let _=Buffer.from([...Mt.openPosition,...D]);return new ct({keys:R,programId:e,data:_})}static openPositionFromBaseInstruction22(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P,k,T,I,h,S,x,K){let B=E([ve("tickLowerIndex"),ve("tickUpperIndex"),ve("tickArrayLowerStartIndex"),ve("tickArrayUpperStartIndex"),te("liquidity"),w("amountMaxA"),w("amountMaxB"),Fe("withMetadata"),q("optionBaseFlag"),Fe("baseFlag")]),C=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],L=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:bo,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...C],R=Buffer.alloc(B.span);B.encode({tickLowerIndex:g,tickUpperIndex:P,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:T,liquidity:new Ia(0),amountMaxA:h==="MintA"?S:x,amountMaxB:h==="MintA"?x:S,withMetadata:I==="create",baseFlag:h==="MintA",optionBaseFlag:1},R);let D=Buffer.from([...Mt.openPositionWithTokenEx,...R]);return new ct({keys:L,programId:e,data:D})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d,p=[];if(l)d=new Q((await l(1))[0]);else{let K=Er.generate();p.push(K),d=K.publicKey}let[b,f]=[new Q(e.programId),new Q(e.id)],y=Z.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=Z.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:P}=ge(b,f,y),{publicKey:k}=ge(b,f,g),{publicKey:T}=m?J(n.wallet,d,We):J(n.wallet,d,xe),{publicKey:I}=kn(d),{publicKey:h}=ht(b,d),{publicKey:S}=en(b,f,i,r),x=m?this.openPositionFromLiquidityInstruction22(b,n.wallet,f,n.wallet,d,T,S,P,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(t.mintA.address),new Q(t.mintB.address),i,r,y,g,s,a,c,u,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?Xe(b,f).publicKey:void 0):this.openPositionFromLiquidityInstruction(b,n.wallet,f,n.wallet,d,T,I,S,P,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(t.mintA.address),new Q(t.mintB.address),i,r,y,g,s,a,c,u,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[y,g])?Xe(b,f).publicKey:void 0);return{address:{nftMint:d,tickArrayLower:P,tickArrayUpper:k,positionNftAccount:T,metadataAccount:I,personalPosition:h,protocolPosition:S},instructions:[x],signers:p,instructionTypes:[X.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,i,r,s){let a=E([]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:s?We:xe,isSigner:!1,isWritable:!1}],u=Buffer.alloc(a.span);a.encode({},u);let l=Buffer.from([...Mt.closePosition,...u]);return new ct({keys:c,programId:e,data:l})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:i,nft2022:r}){let s=new Q(e.programId),a=r?J(n.wallet,i.nftMint,We).publicKey:J(n.wallet,i.nftMint,xe).publicKey,{publicKey:c}=ht(s,i.nftMint),u=[];return u.push(this.closePositionInstruction(s,n.wallet,i.nftMint,a,c,r)),{address:{positionNftAccount:a,personalPosition:c},signers:[],instructions:u,instructionTypes:[X.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P){let k=E([te("liquidity"),w("amountMaxA"),w("amountMaxB"),q("optionBaseFlag"),Fe("baseFlag")]),T=[...P?[{pubkey:P,isSigner:!1,isWritable:!0}]:[]],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...T],h=Buffer.alloc(k.span);k.encode({liquidity:f,amountMaxA:y,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},h);let S=Buffer.from([...Mt.increaseLiquidity,...h]);return new ct({keys:I,programId:e,data:S})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:r,amountMaxA:s,amountMaxB:a,nft2022:c}){let[u,l]=[new Q(e.programId),new Q(e.id)],m=Z.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=Z.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=ge(u,l,m),{publicKey:b}=ge(u,l,d),{publicKey:f}=c?J(i.wallet,n.nftMint,We):J(i.wallet,n.nftMint,xe),{publicKey:y}=ht(u,n.nftMint),{publicKey:g}=en(u,l,n.tickLower,n.tickUpper),P=this.increasePositionFromLiquidityInstruction(u,i.wallet,f,y,l,g,p,b,i.tokenAccountA,i.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),r,s,a,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?Xe(u,l).publicKey:void 0);return{address:{tickArrayLower:p,tickArrayUpper:b,positionNftAccount:f,personalPosition:y,protocolPosition:g},signers:[],instructions:[P],instructionTypes:[X.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,base:r,baseAmount:s,otherAmountMax:a,nft2022:c}){let[u,l]=[new Q(e.programId),new Q(e.id)],m=Z.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=Z.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=ge(u,l,m),{publicKey:b}=ge(u,l,d),{publicKey:f}=c?J(i.wallet,n.nftMint,We):J(i.wallet,n.nftMint,xe),{publicKey:y}=ht(u,n.nftMint),{publicKey:g}=en(u,l,n.tickLower,n.tickUpper);return{address:{tickArrayLower:p,tickArrayUpper:b,positionNftAccount:f,personalPosition:y,protocolPosition:g},instructions:[this.increasePositionFromBaseInstruction(u,i.wallet,f,y,l,g,p,b,i.tokenAccountA,i.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),r,s,a,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?Xe(u,l).publicKey:void 0)],signers:[],instructionTypes:[X.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P){let k=E([te("liquidity"),w("amountMaxA"),w("amountMaxB"),q("optionBaseFlag"),Fe("baseFlag")]),T=[...P?[{pubkey:P,isSigner:!1,isWritable:!0}]:[]],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...T],h=Buffer.alloc(k.span);k.encode({liquidity:new Ia(0),amountMaxA:f==="MintA"?y:g,amountMaxB:f==="MintA"?g:y,baseFlag:f==="MintA",optionBaseFlag:1},h);let S=Buffer.from([...Mt.increaseLiquidity,...h]);return new ct({keys:I,programId:e,data:S})}static decreaseLiquidityInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P,k){let T=E([te("liquidity"),w("amountMinA"),w("amountMinB")]),I=[...k?[{pubkey:k,isSigner:!1,isWritable:!0}]:[],...f.map(K=>[{pubkey:K.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:K.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:K.rewardMint,isSigner:!1,isWritable:!1}]).flat()],h=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:Jo,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...I],S=Buffer.alloc(T.span);T.encode({liquidity:y,amountMinA:g,amountMinB:P},S);let x=Buffer.from([...Mt.decreaseLiquidity,...S]);return new ct({keys:h,programId:e,data:x})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:r,amountMinA:s,amountMinB:a,programId:c,nft2022:u}){let[l,m]=[new Q(e.programId),new Q(e.id)],d=Z.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),p=Z.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:b}=ge(l,m,d),{publicKey:f}=ge(l,m,p),{publicKey:y}=u?J(i.wallet,n.nftMint,We):J(i.wallet,n.nftMint,c),{publicKey:g}=ht(l,n.nftMint),{publicKey:P}=en(l,m,n.tickLower,n.tickUpper),k=[];for(let h=0;h<e.rewardDefaultInfos.length;h++)k.push({poolRewardVault:new Q(t.rewardInfos[h].vault),ownerRewardVault:i.rewardAccounts[h],rewardMint:new Q(e.rewardDefaultInfos[h].mint.address)});let T=[],I=this.decreaseLiquidityInstruction(l,i.wallet,y,g,m,P,b,f,i.tokenAccountA,i.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),k,r,s,a,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[d,p])?Xe(l,m).publicKey:void 0);return T.push(I),{address:{tickArrayLower:b,tickArrayUpper:f,positionNftAccount:y,personalPosition:g,protocolPosition:P},signers:[],instructions:T,instructionTypes:[X.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g){let P=E([w("amount"),w("otherAmountThreshold"),te("sqrtPriceLimitX64"),Fe("isBaseInput")]),k=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...m.map(S=>({pubkey:S,isSigner:!1,isWritable:!0}))],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:Jo,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...k],I=Buffer.alloc(P.span);P.encode({amount:p,otherAmountThreshold:b,sqrtPriceLimitX64:f,isBaseInput:y},I);let h=Buffer.from([...Mt.swap,...I]);return new ct({keys:T,programId:e,data:h})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,inputMint:r,amountIn:s,amountOutMin:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new Q(e.programId),new Q(e.id)],[d,p]=[new Q(t.vault.A),new Q(t.vault.B)],[b,f]=[new Q(e.mintA.address),new Q(e.mintB.address)],y=e.mintA.address===r.toString(),g=[this.swapInstruction(l,i.wallet,m,new Q(e.config.id),y?i.tokenAccountA:i.tokenAccountB,y?i.tokenAccountB:i.tokenAccountA,y?d:p,y?p:d,y?b:f,y?f:b,u,n,s,a,c,!0,Xe(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[X.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,outputMint:r,amountOut:s,amountInMax:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new Q(e.programId),new Q(e.id)],[d,p]=[new Q(t.vault.A),new Q(t.vault.B)],[b,f]=[new Q(e.mintA.address),new Q(e.mintB.address)],y=e.mintA.address===r.toBase58(),g=[this.swapInstruction(l,i.wallet,m,new Q(e.config.id),y?i.tokenAccountB:i.tokenAccountA,y?i.tokenAccountA:i.tokenAccountB,y?p:d,y?d:p,y?f:b,y?b:f,u,n,s,a,c,!1,Xe(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[X.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,i,r,s,a,c,u,l,m,d){let p=E([w("openTime"),w("endTime"),te("emissionsPerSecondX64")]),b=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:He,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({openTime:ee(l),endTime:ee(m),emissionsPerSecondX64:d},f);let y=Buffer.from([...Mt.initReward,...f]);return new ct({keys:b,programId:e,data:y})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[r,s]=[new Q(e.programId),new Q(e.id)],a=Dc(r,s,i.mint).publicKey,c=uo(r).publicKey,u=[this.initRewardInstruction(r,n.wallet,s,c,new Q(e.config.id),n.tokenAccount,i.programId,i.mint,a,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:c},signers:[],instructions:u,instructionTypes:[X.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,i,r,s,a,c,u,l,m,d){let p=E([q("rewardIndex"),te("emissionsPerSecondX64"),w("openTime"),w("endTime")]),b=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0}],f=Buffer.alloc(p.span);p.encode({rewardIndex:u,emissionsPerSecondX64:d,openTime:ee(l),endTime:ee(m)},f);let y=Buffer.from([...Mt.setRewardEmissions,...f]);return new ct({keys:b,programId:e,data:y})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[r,s]=[new Q(e.programId),new Q(e.id)],a,c,u;for(let d=0;d<e.rewardDefaultInfos.length;d++)e.rewardDefaultInfos[d].mint.address===i.mint.toString()&&(a=d,c=new Q(t.rewardInfos[d].vault),u=new Q(t.rewardInfos[d].mint.address));(a===void 0||c===void 0)&&Hc.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=uo(r).publicKey,m=[this.setRewardInstruction(r,n.wallet,s,l,new Q(e.config.id),n.tokenAccount,c,u,a,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{rewardVault:c,operationId:l},signers:[],instructions:m,instructionTypes:[X.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,i,r,s,a){let c=E([q("rewardIndex")]),u=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:Jo,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({rewardIndex:a},l);let m=Buffer.from([...Mt.collectReward,...l]);return new ct({keys:u,programId:e,data:m})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:i}){let[r,s]=[new Q(e.programId),new Q(e.id)],a,c;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===i.toString()&&(a=l,c=new Q(t.rewardInfos[l].vault));(a===void 0||c===void 0)&&Hc.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let u=[this.collectRewardInstruction(r,n.wallet,s,n.tokenAccount,c,i,a)];return{address:{rewardVault:c},signers:[],instructions:u,instructionTypes:[X.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static async makeLockPositions({programId:e,authProgramId:t,poolProgramId:n,payer:i,wallet:r,nftMint:s,nft2022:a,getEphemeralSigners:c}){let u=[],l;if(c)l=new Q((await c(1))[0]);else{let g=Er.generate();u.push(g),l=g.publicKey}let m=a?J(r,s,We).publicKey:J(r,s,xe).publicKey,{publicKey:d}=ht(n,s),p=co(e,l).publicKey,b=J(r,l,xe).publicKey,f=kn(l).publicKey,y=Se.lockPositionInstructionV2({programId:e,auth:t,payer:i,positionOwner:r,lockOwner:r,positionNftAccount:m,positionId:d,lockPositionId:p,lockNftMint:l,lockNftAccount:b,metadataAccount:f,withMetadata:!0,nft2022:a,positionNftMint:s,authPositionNftAccount:J(t,s,a?We:xe).publicKey,positionNftProgram:a?We:xe});return{address:{positionId:d,lockPositionId:p,lockNftAccount:b,lockNftMint:l,positionNftAccount:m,metadataAccount:f},instructions:[y],signers:u,instructionTypes:[X.ClmmLockPosition],lookupTableAddress:[]}}static lockPositionInstructionV2({programId:e,auth:t,payer:n,positionOwner:i,lockOwner:r,positionNftAccount:s,positionId:a,positionNftMint:c,authPositionNftAccount:u,positionNftProgram:l,lockPositionId:m,lockNftMint:d,lockNftAccount:p,metadataAccount:b,withMetadata:f}){let y=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!0,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:Xt,isSigner:!1,isWritable:!1},{pubkey:bo,isSigner:!1,isWritable:!1},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1}],g=E([Fe("withMetadata")]),P=Buffer.alloc(g.span);g.encode({withMetadata:f},P);let k=Buffer.from([...Yc,...P]);return new ct({keys:y,programId:e,data:k})}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:i,positionNft:r}){let{publicKey:s}=J(i,r,xe),{publicKey:a}=ht(n,r),c=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:Pa(e,a).publicKey,isSigner:!1,isWritable:!0},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1}];return new ct({keys:c,programId:e,data:Buffer.from(Yc)})}static harvestLockPositionInstruction(e){let[t,n]=[new Q(e.poolKeys.programId),new Q(e.poolKeys.id)],i=Z.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),r=Z.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:s}=ge(t,n,i),{publicKey:a}=ge(t,n,r),{publicKey:c}=J(e.owner,e.ownerPosition.nftMint,xe),{publicKey:u}=ht(t,e.ownerPosition.nftMint),{publicKey:l}=en(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),m=[];for(let b=0;b<e.poolKeys.rewardInfos.length;b++)m.push({poolRewardVault:new Q(e.poolKeys.rewardInfos[b].vault),ownerRewardVault:e.ownerRewardAccounts[b],rewardMint:new Q(e.poolKeys.rewardInfos[b].mint.address)});let d=[...m.map(b=>[{pubkey:b.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:b.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:b.rewardMint,isSigner:!1,isWritable:!1}]).flat()],p=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:Pa(e.programId,u).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:new Q(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new Q(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:an,isSigner:!1,isWritable:!1},{pubkey:new Q(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new Q(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...d];return new ct({keys:p,programId:e.programId,data:Buffer.from(Zc)})}static harvestLockPositionInstructionV2({programId:e,auth:t,lockPositionId:n,clmmProgram:i,lockOwner:r,lockNftMint:s,lockNftAccount:a,positionNftAccount:c,positionId:u,poolId:l,protocolPosition:m,vaultA:d,vaultB:p,tickArrayLower:b,tickArrayUpper:f,userVaultA:y,userVaultB:g,mintA:P,mintB:k,rewardAccounts:T,exTickArrayBitmap:I}){let h=[...I?[{pubkey:I,isSigner:!1,isWritable:!0}]:[],...T.map(x=>[{pubkey:x.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:x.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:x.rewardMint,isSigner:!1,isWritable:!1}]).flat()],S=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:an,isSigner:!1,isWritable:!1},{pubkey:P,isSigner:!1,isWritable:!1},{pubkey:k,isSigner:!1,isWritable:!1},...h];return new ct({keys:S,programId:e,data:Buffer.from(Zc)})}};var $c=E([ut("mintAuthorityOption"),N("mintAuthority"),w("supply"),q("decimals"),q("isInitialized"),ut("freezeAuthorityOption"),N("freezeAuthority")]);import{PublicKey as sf}from"@solana/web3.js";import{MintLayout as Jc,TOKEN_PROGRAM_ID as af}from"@solana/spl-token";var mI=async({connection:o,mint:e})=>{let t=await o.getAccountInfo(new sf(e));return!t||t.data.length!==Jc.span?void 0:Jc.decode(t.data)},dI=({mint:o,decimals:e,programId:t=af,logoURI:n="",priority:i=3})=>{let r=o.toBase58().substring(0,6);return{address:o.toBase58(),decimals:e,symbol:r,logoURI:n,extensions:{},chainId:101,programId:t.toString(),name:r,tags:[],priority:i}},_r=o=>new Ve({mint:o.address,decimals:o.decimals,symbol:o.symbol,name:o.name}),yo=i=>{var r=i,{amount:o,isRaw:e,name:t}=r,n=De(r,["amount","isRaw","name"]);return new Ie(new Ve({mint:mt(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),o,e,t)};function pI(o){return o.address===sn.address?nt:o}function fI(o){return o.address===nt.address?sn:o}var bt=i=>{var r=i,{address:o,programId:e,decimals:t}=r,n=De(r,["address","programId","decimals"]);return v({chainId:101,address:mt(o).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{}},n)},Vn=o=>o?U(v({},o),{transferFeeConfigAuthority:o.transferFeeConfigAuthority.toBase58(),withdrawWithheldAuthority:o.withdrawWithheldAuthority.toBase58(),withheldAmount:o.withheldAmount.toString(),olderTransferFee:U(v({},o.olderTransferFee),{epoch:o.olderTransferFee.epoch.toString(),maximumFee:o.olderTransferFee.maximumFee.toString()}),newerTransferFee:U(v({},o.newerTransferFee),{epoch:o.newerTransferFee.epoch.toString(),maximumFee:o.newerTransferFee.maximumFee.toString()})}):void 0;import el from"bn.js";var Ba=new el(25),Vr=new el(1e4),uf={4:3,5:3};import{PublicKey as Ce,SystemProgram as ul,SYSVAR_RENT_PUBKEY as hf,TransactionInstruction as In}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Tf,TOKEN_PROGRAM_ID as Ii}from"@solana/spl-token";var xa=E([q("instruction"),w("amountIn"),w("minAmountOut")]),Sa=E([q("instruction"),w("maxAmountIn"),w("amountOut")]),BI=E([q("instruction"),q("nonce")]),Ka=E([q("instruction"),q("nonce"),w("startTime")]),Zn=E([w("status"),w("nonce"),w("maxOrder"),w("depth"),w("baseDecimal"),w("quoteDecimal"),w("state"),w("resetFlag"),w("minSize"),w("volMaxCutRatio"),w("amountWaveRatio"),w("baseLotSize"),w("quoteLotSize"),w("minPriceMultiplier"),w("maxPriceMultiplier"),w("systemDecimalValue"),w("minSeparateNumerator"),w("minSeparateDenominator"),w("tradeFeeNumerator"),w("tradeFeeDenominator"),w("pnlNumerator"),w("pnlDenominator"),w("swapFeeNumerator"),w("swapFeeDenominator"),w("baseNeedTakePnl"),w("quoteNeedTakePnl"),w("quoteTotalPnl"),w("baseTotalPnl"),w("poolOpenTime"),w("punishPcAmount"),w("punishCoinAmount"),w("orderbookToInitTime"),te("swapBaseInAmount"),te("swapQuoteOutAmount"),w("swapBase2QuoteFee"),te("swapQuoteInAmount"),te("swapBaseOutAmount"),w("swapQuote2BaseFee"),N("baseVault"),N("quoteVault"),N("baseMint"),N("quoteMint"),N("lpMint"),N("openOrders"),N("marketId"),N("marketProgramId"),N("targetOrders"),N("withdrawQueue"),N("lpVault"),N("owner"),w("lpReserve"),z(w(),3,"padding")]),cf=E([w("accountType"),w("status"),w("nonce"),w("maxOrder"),w("depth"),w("baseDecimal"),w("quoteDecimal"),w("state"),w("resetFlag"),w("minSize"),w("volMaxCutRatio"),w("amountWaveRatio"),w("baseLotSize"),w("quoteLotSize"),w("minPriceMultiplier"),w("maxPriceMultiplier"),w("systemDecimalsValue"),w("abortTradeFactor"),w("priceTickMultiplier"),w("priceTick"),w("minSeparateNumerator"),w("minSeparateDenominator"),w("tradeFeeNumerator"),w("tradeFeeDenominator"),w("pnlNumerator"),w("pnlDenominator"),w("swapFeeNumerator"),w("swapFeeDenominator"),w("baseNeedTakePnl"),w("quoteNeedTakePnl"),w("quoteTotalPnl"),w("baseTotalPnl"),w("poolOpenTime"),w("punishPcAmount"),w("punishCoinAmount"),w("orderbookToInitTime"),te("swapBaseInAmount"),te("swapQuoteOutAmount"),te("swapQuoteInAmount"),te("swapBaseOutAmount"),w("swapQuote2BaseFee"),w("swapBase2QuoteFee"),N("baseVault"),N("quoteVault"),N("baseMint"),N("quoteMint"),N("lpMint"),N("modelDataAccount"),N("openOrders"),N("marketId"),N("marketProgramId"),N("targetOrders"),N("owner"),z(w(),64,"padding")]),Ca=E([q("instruction"),w("baseAmountIn"),w("quoteAmountIn"),w("fixedSide"),w("otherAmountMin")]),La=E([q("instruction"),w("lpAmount"),w("baseAmountMin"),w("quoteAmountMin")]),xI={4:Zn,5:cf},tl=E([w("fee")]);import{PublicKey as lf}from"@solana/web3.js";var Ti=new lf("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Jn=5e4,mf=E([w("x"),w("y"),w("price")]),df=E([w("accountType"),w("status"),w("multiplier"),w("validDataCount"),z(mf,Jn,"DataElement")]);function pf(o,e){return[0,Jn-2]}function ff(o){return[0,Jn-2]}function bf(o){return[0,Jn-2]}function yf(o,e,t){let[n,i]=pf(e,t),r=n,s=i,a=0,c=e*o.multiplier/t;for(;r<=s;){if(a=Math.floor((s+r)/2),a===0||a>=Jn-2)return[a,a,!1];let u=o.DataElement[a].x*o.multiplier/o.DataElement[a].y,l=o.DataElement[a-1].x*o.multiplier/o.DataElement[a-1].y,m=o.DataElement[a+1].x*o.multiplier/o.DataElement[a+1].y;if(c===u)return[a,a,!0];if(c===l)return[a-1,a-1,!0];if(c===m)return[a+1,a+1,!0];if(c<l)s=a-1;else{if(c>l&&c<u)return[a-1,a,!0];if(c>u&&c<m)return[a,a+1,!0];r=a+1}}return[a,a,!1]}function Ra(o,e,t){let[n,i,r]=yf(o,e,t);if(!r)return 0;if(n===i){let s=o.DataElement[n].x;return e*o.multiplier/s}else{let s=o.DataElement[n].x,a=o.DataElement[n].y,c=o.DataElement[i].x,u=o.DataElement[i].y,l=t*(c*a-s*u),m=s*l,d=(c-s)*(e*a-s*t)*u,p=m+d;return e*o.multiplier*l/p}}function $n(o,e,t){return e*o.multiplier/t}function nl(o,e,t){return e*t/o.multiplier}function gf(o,e){let[t,n]=ff(e),i=t,r=n,s=0,a=e;for(;i<r;){if(s=Math.floor((r+i)/2),s<=0||s>Jn-2)return[s,s,!1];let c=o.DataElement[s].x,u=o.DataElement[s-1].x,l=o.DataElement[s+1].x;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<u)r=s-1;else{if(a>u&&a<c)return[s-1,s,!0];if(a>c&&a<l)return[s,s+1,!0];i=s+1}}return[s,s,!1]}function Af(o,e){let[t,n]=bf(e),i=t,r=n,s=0,a=e;for(;i<=r;){if(s=Math.floor((r+i)/2),s<=0||s>=Jn-2)return[s,s,!1];let c=o.DataElement[s].y,u=o.DataElement[s-1].y,l=o.DataElement[s+1].y;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)i=s+1;else{if(a<u&&a>c)return[s-1,s,!0];if(a<c&&a>l)return[s,s+1,!0];r=s-1}}return[s,s,!1]}function il(o,e,t,n){let i=n?e+t:e-t,[r,s,a]=gf(o,i);if(!a)return[0,0,!1,a];if(r===s)return[o.DataElement[s].price,o.DataElement[s].y,!1,a];{let c=o.DataElement[r].x,u=o.DataElement[s].x,l=o.DataElement[r].price,m=o.DataElement[s].price,d=o.DataElement[r].y,p=o.DataElement[s].y;if(e>=c&&e<=u)return n?[m,p,!0,a]:[l,d,!0,a];{let b,f;return n?(b=l+(m-l)*(e-c)/(u-c),f=d-(i-c)*o.multiplier/m):(b=l+(m-l)*(e-c)/(u-c),f=p+(u-i)*o.multiplier/l),[b,f,!1,a]}}}function Pf(o,e,t,n){let i=n?e-t:e+t,[r,s,a]=Af(o,i);if(!a)return[0,0,!1,a];if(r===s)return[o.DataElement[s].price,o.DataElement[s].x,!1,a];{let c=o.DataElement[r].x,u=o.DataElement[s].x,l=o.DataElement[r].price,m=o.DataElement[s].price,d=o.DataElement[r].y,p=o.DataElement[s].y;if(e>=p&&e<=d)return n?[m,u,!0,a]:[l,c,!0,a];{let b,f;return n?(b=l+(m-l)*(d-e)/(d-p),f=c+m*(d-i)/o.multiplier):(b=l+(m-l)*(d-e)/(d-p),f=u-l*(i-p)/o.multiplier),[b,f,!1,a]}}}function wf(o,e){let t=il(o,e,0,!1);return t[3]?t[0]:0}function ol(o,e,t,n){let i=Ra(o,e,t),r=$n(o,e,i),s=$n(o,t,i),a=$n(o,n,i),c=!0,[u,l,m,d]=il(o,r,a,c);if(!d)return 0;if(m)return n*o.multiplier/u;{let p=s-l;return nl(o,p,i)}}function rl(o,e,t,n){let i=Ra(o,e,t),r=$n(o,e,i),s=$n(o,t,i),a=$n(o,n,i),c=!1,[u,l,m,d]=Pf(o,s,a,c);if(!d)return 0;if(m)return n*u/o.multiplier;{let p=r-l;return nl(o,p,i)}}function kf(o){let e=df.decode(o);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function sl(o,e,t,n){let i=wf(o,$n(o,e,Ra(o,e,t)))/o.multiplier;return n?i:1/i}var hi=class{constructor({connection:e}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(Ti);e&&(this._layoutData=kf(e==null?void 0:e.data))}}};var al=fe("Raydium_liquidity_instruction");function cl(o){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:i,quoteAmountIn:r,fixedSide:s,otherAmountMin:a}=o,c=Buffer.alloc(Ca.span);Ca.encode({instruction:3,baseAmountIn:ee(i),quoteAmountIn:ee(r),otherAmountMin:ee(a),fixedSide:s==="base"?Bt:Cu},c);let u=[A({pubkey:Ii,isWritable:!1}),A({pubkey:new Ce(e.id)}),A({pubkey:new Ce(t.authority),isWritable:!1}),A({pubkey:new Ce(t.openOrders),isWritable:!1}),A({pubkey:new Ce(t.targetOrders)}),A({pubkey:new Ce(e.lpMint.address)}),A({pubkey:new Ce(t.vault.A)}),A({pubkey:new Ce(t.vault.B)})];return e.pooltype.includes("StablePool")&&u.push(A({pubkey:Ti})),u.push(A({pubkey:new Ce(e.marketId),isWritable:!1}),A({pubkey:n.baseTokenAccount}),A({pubkey:n.quoteTokenAccount}),A({pubkey:n.lpTokenAccount}),A({pubkey:n.owner,isWritable:!1,isSigner:!0}),A({pubkey:new Ce(t.marketEventQueue),isWritable:!1})),new In({programId:new Ce(e.programId),keys:u,data:c})}function Na(o){let{poolInfo:e,poolKeys:t,userKeys:n,lpAmount:i,baseAmountMin:r,quoteAmountMin:s}=o,a=Oe(t),c=4;if(e.pooltype.includes("StablePool")&&(c=5),c===4||c===5){let u=Buffer.alloc(La.span);La.encode({instruction:4,lpAmount:ee(i),baseAmountMin:ee(r),quoteAmountMin:ee(s)},u);let l=[A({pubkey:Ii,isWritable:!1}),A({pubkey:a.id}),A({pubkey:a.authority,isWritable:!1}),A({pubkey:a.openOrders}),A({pubkey:a.targetOrders}),A({pubkey:a.mintLp.address}),A({pubkey:a.vault.A}),A({pubkey:a.vault.B})];return c===5?l.push(A({pubkey:Ti})):(l.push(A({pubkey:a.id})),l.push(A({pubkey:a.id}))),l.push(A({pubkey:a.marketProgramId,isWritable:!1}),A({pubkey:a.marketId}),A({pubkey:a.marketBaseVault}),A({pubkey:a.marketQuoteVault}),A({pubkey:a.marketAuthority,isWritable:!1}),A({pubkey:n.lpTokenAccount}),A({pubkey:n.baseTokenAccount}),A({pubkey:n.quoteTokenAccount}),A({pubkey:n.owner,isWritable:!1,isSigner:!0}),A({pubkey:a.marketEventQueue}),A({pubkey:a.marketBids}),A({pubkey:a.marketAsks})),new In({programId:a.programId,keys:l,data:u})}return new In({programId:a.programId,keys:[]})}function Oa({programId:o,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:i,coinMint:r,pcMint:s,coinVault:a,pcVault:c,withdrawQueue:u,ammTargetOrders:l,poolTempLp:m,marketProgramId:d,marketId:p,userWallet:b,userCoinVault:f,userPcVault:y,userLpVault:g,nonce:P,openTime:k,coinAmount:T,pcAmount:I,ammConfigId:h,feeDestinationId:S}){let x=E([q("instruction"),q("nonce"),w("openTime"),w("pcAmount"),w("coinAmount")]),K=[{pubkey:Ii,isSigner:!1,isWritable:!1},{pubkey:Tf,isSigner:!1,isWritable:!1},{pubkey:ul.programId,isSigner:!1,isWritable:!1},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:h,isSigner:!1,isWritable:!1},{pubkey:S,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!0,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],B=Buffer.alloc(x.span);return x.encode({instruction:1,nonce:P,openTime:k,coinAmount:T,pcAmount:I},B),{instruction:new In({keys:K,programId:o,data:B}),instructionType:X.AmmV4CreatePool}}function qI(o){let e=E([q("instruction"),q("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[A({pubkey:new Ce(o.id),isWritable:!1}),A({pubkey:new Ce(o.authority),isWritable:!1}),A({pubkey:new Ce(o.openOrders),isWritable:!1}),A({pubkey:new Ce(o.vault.A),isWritable:!1}),A({pubkey:new Ce(o.vault.B),isWritable:!1}),A({pubkey:new Ce(o.mintLp.address),isWritable:!1}),A({pubkey:new Ce(o.marketId),isWritable:!1}),A({pubkey:new Ce(o.marketEventQueue),isWritable:!1})];return new In({programId:new Ce(o.programId),keys:n,data:t})}function If({poolKeys:o,userKeys:e,amountIn:t,minAmountOut:n},i){let r=Oe(o),s=Buffer.alloc(xa.span);xa.encode({instruction:9,amountIn:ee(t),minAmountOut:ee(n)},s);let a=[A({pubkey:Ii,isWritable:!1}),A({pubkey:r.id}),A({pubkey:r.authority,isWritable:!1}),A({pubkey:r.openOrders})];return i===4&&a.push(A({pubkey:r.targetOrders})),a.push(A({pubkey:r.vault.A}),A({pubkey:r.vault.B})),i===5&&a.push(A({pubkey:Ti})),a.push(A({pubkey:r.marketProgramId,isWritable:!1}),A({pubkey:r.marketId}),A({pubkey:r.marketBids}),A({pubkey:r.marketAsks}),A({pubkey:r.marketEventQueue}),A({pubkey:r.marketBaseVault}),A({pubkey:r.marketQuoteVault}),A({pubkey:r.marketAuthority,isWritable:!1}),A({pubkey:e.tokenAccountIn}),A({pubkey:e.tokenAccountOut}),A({pubkey:e.owner,isWritable:!1,isSigner:!0})),new In({programId:r.programId,keys:a,data:s})}function Bf({poolKeys:o,userKeys:e,maxAmountIn:t,amountOut:n},i){let r=Oe(o),s=Buffer.alloc(Sa.span);Sa.encode({instruction:11,maxAmountIn:ee(t),amountOut:ee(n)},s);let a=[A({pubkey:Ii,isWritable:!1}),A({pubkey:r.id}),A({pubkey:r.authority,isWritable:!1}),A({pubkey:r.openOrders}),A({pubkey:r.targetOrders}),A({pubkey:r.vault.A}),A({pubkey:r.vault.B})];return i===5&&a.push(A({pubkey:Ti})),a.push(A({pubkey:r.marketProgramId,isWritable:!1}),A({pubkey:r.marketId}),A({pubkey:r.marketBids}),A({pubkey:r.marketAsks}),A({pubkey:r.marketEventQueue}),A({pubkey:r.marketBaseVault}),A({pubkey:r.marketQuoteVault}),A({pubkey:r.marketAuthority,isWritable:!1}),A({pubkey:e.tokenAccountIn}),A({pubkey:e.tokenAccountOut}),A({pubkey:e.owner,isWritable:!1,isSigner:!0})),new In({programId:r.programId,keys:a,data:s})}function Fr(o){let{poolKeys:e,version:t,userKeys:n,amountIn:i,amountOut:r,fixedSide:s}=o;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return If(U(v({},a),{amountIn:i,minAmountOut:r}),t);if(s==="out")return Bf(U(v({},a),{maxAmountIn:i,amountOut:r}),t);al.logWithError("invalid params","params",o)}throw al.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}function UI({poolKeys:o,userKeys:e,startTime:t}){let n=Buffer.alloc(Ka.span);Ka.encode({instruction:0,nonce:5,startTime:ee(t)},n);let i=Oe(o),r=[A({pubkey:Ii,isWritable:!1}),A({pubkey:ul.programId,isWritable:!1}),A({pubkey:hf,isWritable:!1}),A({pubkey:i.id}),A({pubkey:i.authority,isWritable:!1}),A({pubkey:i.openOrders}),A({pubkey:i.mintLp.address}),A({pubkey:i.mintA.address,isWritable:!1}),A({pubkey:i.mintB.address,isWritable:!1}),A({pubkey:i.vault.A,isWritable:!1}),A({pubkey:i.vault.B,isWritable:!1}),A({pubkey:i.id}),A({pubkey:i.targetOrders}),A({pubkey:e.lpTokenAccount}),A({pubkey:i.id,isWritable:!1}),A({pubkey:i.marketProgramId,isWritable:!1}),A({pubkey:i.marketId,isWritable:!1}),A({pubkey:e.payer,isSigner:!0})];return new In({programId:i.programId,keys:r,data:n})}function ll({poolKeys:o}){let e=E([q("instruction"),q("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[A({pubkey:new Ce(o.id),isWritable:!1}),A({pubkey:new Ce(o.authority),isWritable:!1}),A({pubkey:new Ce(o.openOrders),isWritable:!1}),A({pubkey:new Ce(o.vault.A),isWritable:!1}),A({pubkey:new Ce(o.vault.B),isWritable:!1}),A({pubkey:new Ce(o.mintLp.address),isWritable:!1}),A({pubkey:new Ce(o.marketId),isWritable:!1}),A({pubkey:new Ce(o.marketEventQueue),isWritable:!1})];return{instruction:new In({programId:new Ce(o.programId),keys:n,data:t})}}import{PublicKey as Ao}from"@solana/web3.js";import go from"bn.js";import{TOKEN_PROGRAM_ID as Kf}from"@solana/spl-token";import{PublicKey as xf}from"@solana/web3.js";var Sf=fe("Raydium_liquidity_serum");function ml({programId:o,marketId:e}){let t=[e.toBuffer()],n=0,i;for(;n<100;){try{let r=t.concat(Buffer.from([n]),Buffer.alloc(7));i=xf.createProgramAddressSync(r,o)}catch(r){if(r instanceof TypeError)throw r;n++;continue}return{publicKey:i,nonce:n}}throw Sf.logWithError("unable to find a viable program address nonce","params",{programId:o,marketId:e}),new Error("unable to find a viable program address nonce")}function Dr({programId:o}){let{publicKey:e}=ie([Buffer.from("amm_config_account_seed","utf-8")],o);return e}function ei({name:o,programId:e,marketId:t}){let{publicKey:n}=ie([e.toBuffer(),t.toBuffer(),Buffer.from(o,"utf-8")],e);return n}function Cf({programId:o,marketId:e}){let{publicKey:t}=ie([o.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],o);return t}function Ea({programId:o}){return ie([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],o)}function _a({version:o,marketVersion:e,marketId:t,baseMint:n,quoteMint:i,baseDecimals:r,quoteDecimals:s,programId:a,marketProgramId:c}){let u=ei({name:"amm_associated_seed",programId:a,marketId:t}),l=ei({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:m,nonce:d}=Ea({programId:a}),p=ei({name:"coin_vault_associated_seed",programId:a,marketId:t}),b=ei({name:"pc_vault_associated_seed",programId:a,marketId:t}),f=ei({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),y=Cf({programId:a,marketId:t}),g=ei({name:"target_associated_seed",programId:a,marketId:t}),P=ei({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:k}=ml({programId:c,marketId:t});return{id:u,baseMint:n,quoteMint:i,lpMint:l,baseDecimals:r,quoteDecimals:s,lpDecimals:r,version:o,programId:a,authority:m,nonce:d,baseVault:p,quoteVault:b,lpVault:f,openOrders:y,targetOrders:g,withdrawQueue:P,marketVersion:e,marketProgramId:c,marketId:t,marketAuthority:k,lookupTableAccount:Ao.default,configId:Dr({programId:a})}}var Ma;async function pB({connection:o,poolKeysList:e,config:t}){return e.find(i=>i.modelDataAccount)&&(Ma||(Ma=new hi({connection:o}),await Ma.initStableModelLayout())),await Promise.all(e.map(async i=>{if(i.modelDataAccount){let r=ll({poolKeys:i});return(await Vu(o,[r.instruction],"GetPoolData")).map(c=>{let u=Fu(c,"GetPoolData"),l=new go(An(u,"status")),m=Number(An(u,"coin_decimals")),d=Number(An(u,"pc_decimals")),p=Number(An(u,"lp_decimals")),b=new go(An(u,"pool_coin_amount")),f=new go(An(u,"pool_pc_amount")),y=new go(An(u,"pool_lp_supply")),g="0";try{g=An(u,"pool_open_time")}catch{}return{status:l,baseDecimals:m,quoteDecimals:d,lpDecimals:p,baseReserve:b,quoteReserve:f,lpSupply:y,startTime:new go(g)}})[0]}else{let[r,s,a,c]=await o.getMultipleAccountsInfo([new Ao(i.id),new Ao(i.vault.A),new Ao(i.vault.B),new Ao(i.mintLp.address)]);if(r===null)throw Error("fetch pool error");if(s===null)throw Error("fetch vaultAccA error");if(a===null)throw Error("fetch vaultAccB error");if(c===null)throw Error("fetch mintAccLp error");let u=Zn.decode(r.data),l=Jt.decode(s.data),m=Jt.decode(a.data),d=$c.decode(c.data);return{status:u.status,baseDecimals:u.baseDecimal.toNumber(),quoteDecimals:u.quoteDecimal.toNumber(),lpDecimals:d.decimals,baseReserve:l.amount.sub(u.baseNeedTakePnl),quoteReserve:m.amount.sub(u.quoteNeedTakePnl),lpSupply:u.lpReserve,startTime:u.poolOpenTime}}}))}var va={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},Wr=o=>{let e={},t=Kf.toBase58();return Object.keys(o).map(n=>{let i=o[n],[r,s]=[i.baseMint.toBase58(),i.quoteMint.toBase58()];e[n]={id:n,version:4,status:i.status.toNumber(),programId:i.programId.toBase58(),mintA:bt({address:r,programId:t,decimals:i.baseDecimal.toNumber()}),mintB:bt({address:s,programId:t,decimals:i.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:i.poolPrice.toNumber(),mintAmountA:new O(i.mintAAmount.toString()).div(10**i.baseDecimal.toNumber()).toNumber(),mintAmountB:new O(i.mintBAmount.toString()).div(10**i.quoteDecimal.toNumber()).toNumber(),baseReserve:i.baseReserve,quoteReserve:i.quoteReserve,feeRate:new O(i.tradeFeeNumerator.toString()).div(i.tradeFeeDenominator.toString()).toNumber(),openTime:i.poolOpenTime.toString(),tvl:0,day:va,week:va,month:va,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:i.marketId.toBase58(),configId:Dr({programId:i.programId}).toBase58(),lpPrice:0,lpAmount:new O(i.lpReserve.toString()).div(10**Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())).toNumber(),lpMint:bt({address:i.lpMint.toBase58(),programId:t,decimals:Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())}),burnPercent:0}}),e};import qe from"bn.js";import{PublicKey as Po}from"@solana/web3.js";import wo from"bn.js";import{TOKEN_PROGRAM_ID as bl}from"@solana/spl-token";import{SystemProgram as ti,SYSVAR_RENT_PUBKEY as Rf,Transaction as dl,TransactionInstruction as Nf}from"@solana/web3.js";import{createInitializeAccountInstruction as pl,TOKEN_PROGRAM_ID as fl}from"@solana/spl-token";function Lf(o="accountFlags"){let e=new Sr(o);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var Va=E([Te(5),Lf("accountFlags"),N("ownAddress"),w("vaultSignerNonce"),N("baseMint"),N("quoteMint"),N("baseVault"),w("baseDepositsTotal"),w("baseFeesAccrued"),N("quoteVault"),w("quoteDepositsTotal"),w("quoteFeesAccrued"),w("quoteDustThreshold"),N("requestQueue"),N("eventQueue"),N("bids"),N("asks"),w("baseLotSize"),w("quoteLotSize"),w("feeRateBps"),w("referrerRebatesAccrued"),Te(7)]);function Of({programId:o,marketInfo:e}){let t=E([q("version"),ut("instruction"),w("baseLotSize"),w("quoteLotSize"),Zt("feeRateBps"),w("vaultSignerNonce"),w("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:Rf,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),i=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},i),new Nf({keys:n,programId:o,data:i})}async function qr({connection:o,wallet:e,marketInfo:t}){var s,a,c,u,l,m,d,p;let n=new dl,i=await o.getMinimumBalanceForRentExemption(165);n.add(ti.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:i,space:165,programId:fl}),ti.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:i,space:165,programId:fl}),pl(t.baseVault.publicKey,t.baseMint,t.vaultOwner),pl(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner),ti.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await o.getMinimumBalanceForRentExemption(Va.span),space:Va.span,programId:t.programId}));let r=new dl;return r.add(ti.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:t.lowestFeeMarket?6208320:await o.getMinimumBalanceForRentExemption((s=t.requestQueueSpace)!=null?s:5120+12),space:t.lowestFeeMarket?764:(a=t.requestQueueSpace)!=null?a:5120+12,programId:t.programId}),ti.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:t.lowestFeeMarket?79594560:await o.getMinimumBalanceForRentExemption((c=t.eventQueueSpace)!=null?c:262144+12),space:t.lowestFeeMarket?11308:(u=t.eventQueueSpace)!=null?u:262144+12,programId:t.programId}),ti.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:t.lowestFeeMarket?101977920:await o.getMinimumBalanceForRentExemption((l=t.orderbookQueueSpace)!=null?l:65536+12),space:t.lowestFeeMarket?14524:(m=t.orderbookQueueSpace)!=null?m:65536+12,programId:t.programId}),ti.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:t.lowestFeeMarket?101977920:await o.getMinimumBalanceForRentExemption((d=t.orderbookQueueSpace)!=null?d:65536+12),space:t.lowestFeeMarket?14524:(p=t.orderbookQueueSpace)!=null?p:65536+12,programId:t.programId}),Of({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[X.CreateAccount,X.CreateAccount,X.InitAccount,X.InitAccount]},{transaction:r,signer:[],instructionTypes:[X.CreateAccount,X.CreateAccount,X.CreateAccount,X.CreateAccount,X.CreateAccount,X.InitMarket]}]}var Bi=class extends Me{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:i,dexProgramId:r,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u,assignSeed:l,txVersion:m,computeBudgetConfig:d,txTipConfig:p,feePayer:b}){let f=this.scope.ownerPubKey,y=l?`${e.mint.toBase58().slice(0,10)}-${t.mint.toBase58().slice(0,10)}-${l}`:void 0,g=Ge({fromPublicKey:f,programId:r,assignSeed:y&&`${y}-market`}),P=Ge({fromPublicKey:f,programId:r,assignSeed:y&&`${y}-request`}),k=Ge({fromPublicKey:f,programId:r,assignSeed:y&&`${y}-event`}),T=Ge({fromPublicKey:f,programId:r,assignSeed:y&&`${y}-bids`}),I=Ge({fromPublicKey:f,programId:r,assignSeed:y&&`${y}-asks`}),h=Ge({fromPublicKey:f,programId:bl,assignSeed:y&&`${y}-baseVault`}),S=Ge({fromPublicKey:f,programId:bl,assignSeed:y&&`${y}-quoteVault`}),x=0,K=new wo(100);function B(){let Y=new wo(0);for(;;)try{return{vaultOwner:Po.createProgramAddressSync([g.publicKey.toBuffer(),Y.toArrayLike(Buffer,"le",8)],r),vaultSignerNonce:Y}}catch{if(Y.iaddn(1),Y.gt(new wo(25555)))throw Error("find vault owner error")}}let{vaultOwner:C,vaultSignerNonce:L}=B(),R=new wo(Math.round(10**e.decimals*n)),D=new wo(Math.round(n*10**t.decimals*i));if(R.eq(Bt))throw Error("lot size is too small");if(D.eq(Bt))throw Error("tick size or lot size is too small");let _=await qr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:r,id:g,baseMint:e.mint,quoteMint:t.mint,baseVault:h,quoteVault:S,vaultOwner:C,requestQueue:P,eventQueue:k,bids:T,asks:I,feeRateBps:x,quoteDustThreshold:K,vaultSignerNonce:L,baseLotSize:R,quoteLotSize:D,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u}}),W=this.createTxBuilder(b);W.addInstruction({instructions:_[0].transaction.instructions,signers:_[0].signer});for await(let Y of _.slice(1,_.length))W.addInstruction({instructions:Y.transaction.instructions,signers:Y.signer,instructionTypes:Y.instructionTypes});return m===0?W.sizeCheckBuildV0({computeBudgetConfig:d,address:{marketId:g.publicKey,requestQueue:P.publicKey,eventQueue:k.publicKey,bids:T.publicKey,asks:I.publicKey,baseVault:h.publicKey,quoteVault:S.publicKey,baseMint:new Po(e.mint),quoteMint:new Po(t.mint)}}):W.sizeCheckBuild({computeBudgetConfig:d,address:{marketId:g.publicKey,requestQueue:P.publicKey,eventQueue:k.publicKey,bids:T.publicKey,asks:I.publicKey,baseVault:h.publicKey,quoteVault:S.publicKey,baseMint:new Po(e.mint),quoteMint:new Po(t.mint)}})}};var ko=class extends Me{constructor(t){super(t);this.stableLayout=new hi({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:t,amount:n,slippage:i,baseIn:r}){let s=new qe(new O(n).mul(10**t[r?"mintA":"mintB"].decimals).toFixed(0)),a=_r(t[r?"mintB":"mintA"]),[c,u]=[new qe(new O(t.mintAmountA).mul(10**t.mintA.decimals).toString()),new qe(new O(t.mintAmountB).mul(10**t.mintB.decimals).toString())],l=new qe(new O(t.lpAmount).mul(10**t.lpMint.decimals).toFixed(0,O.ROUND_DOWN));this.logDebug("baseReserve:",c.toString(),"quoteReserve:",u.toString()),this.logDebug("tokenIn:",r?t.mintA.symbol:t.mintB.symbol,"amountIn:",s.toString(),"anotherToken:",r?t.mintB.symbol:t.mintA.symbol,"slippage:",`${i.toSignificant()}%`,"baseReserve",c.toString(),"quoteReserve",u.toString());let m=r?"base":"quote";this.logDebug("input side:",m);let d=Bt;s.isZero()||(d=m==="base"?ir(s.mul(u),c):ir(s.mul(c),u)),this.logDebug("amountRaw:",d.toString(),"lpAmount:",l.toString());let p=ir(s.mul(l),m==="base"?c:u);this.logDebug("liquidity:",p.toString());let b=new ot(new qe(1)).add(i),f=new ot(new qe(1)).sub(i),y=b.mul(d).quotient,g=f.mul(d).quotient,P=new Ie(a,d),k=new Ie(a,y),T=new Ie(a,g);return this.logDebug("anotherAmount:",P.toFixed(),"maxAnotherAmount:",k.toFixed()),{anotherAmount:P,maxAnotherAmount:k,minAnotherAmount:T,liquidity:p}}async getAmmPoolKeys(t){return(await this.scope.api.fetchPoolKeysById({idList:[t]}))[0]}async addLiquidity(t){let{poolInfo:n,poolKeys:i,amountInA:r,amountInB:s,otherAmountMin:a,fixedSide:c,config:u,txVersion:l,computeBudgetConfig:m,txTipConfig:d,feePayer:p}=t;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",r,"amountInB:",s),(r.isZero()||s.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:r.toFixed(),amountInB:s.toFixed()});let{account:b}=this.scope,{bypassAssociatedCheck:f,checkCreateATAOwner:y}=v({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},u),[g,P]=[r.token,s.token],k=await b.getCreatedTokenAccount({mint:g.mint,associatedOnly:!1}),T=await b.getCreatedTokenAccount({mint:P.mint,associatedOnly:!1});!k&&!T&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",b.tokenAccounts);let I=await b.getCreatedTokenAccount({mint:new je(n.lpMint.address)}),h=[g,P],S=[k,T],x=[r.raw,s.raw],K=r.token.mint.toBase58()===n.mintA.address?"base":"quote",B="base";["quote","base"].includes(K)||this.logAndCreateError("invalid fixedSide","fixedSide",c),K==="quote"?(h.reverse(),S.reverse(),x.reverse(),B=c==="a"?"quote":"base"):K==="base"&&(B=c==="a"?"base":"quote");let[C,L]=h,[R,D]=S,[_,W]=x,Y=i!=null?i:await this.getAmmPoolKeys(n.id),se=this.createTxBuilder(p),gt=await b.handleTokenAccount({side:"in",amount:_,mint:C.mint,tokenAccount:R,bypassAssociatedCheck:f,checkCreateATAOwner:y}),{tokenAccount:Pe}=gt,ce=De(gt,["tokenAccount"]);se.addInstruction(ce);let Ue=await b.handleTokenAccount({side:"in",amount:W,mint:L.mint,tokenAccount:D,bypassAssociatedCheck:f,checkCreateATAOwner:y}),{tokenAccount:de}=Ue,Ke=De(Ue,["tokenAccount"]);se.addInstruction(Ke);let lt=await b.handleTokenAccount({side:"out",amount:0,mint:new je(n.lpMint.address),tokenAccount:I,bypassAssociatedCheck:f,checkCreateATAOwner:y}),{tokenAccount:Ze}=lt,Dt=De(lt,["tokenAccount"]);return se.addInstruction(Dt),se.addInstruction({instructions:[cl({poolInfo:n,poolKeys:Y,userKeys:{baseTokenAccount:Pe,quoteTokenAccount:de,lpTokenAccount:Ze,owner:this.scope.ownerPubKey},baseAmountIn:_,quoteAmountIn:W,otherAmountMin:a.raw,fixedSide:B})],instructionTypes:[n.pooltype.includes("StablePool")?X.AmmV5AddLiquidity:X.AmmV4AddLiquidity],lookupTableAddress:Y.lookupTableAccount?[Y.lookupTableAccount]:[]}),se.addCustomComputeBudget(m),se.addTipInstruction(d),l===0?await se.buildV0():se.build()}async removeLiquidity(t){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:n,poolKeys:i,lpAmount:r,baseAmountMin:s,quoteAmountMin:a,config:c,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}=t,p=i!=null?i:await this.getAmmPoolKeys(n.id),[b,f,y]=[new je(n.mintA.address),new je(n.mintB.address),new je(n.lpMint.address)];this.logDebug("lpAmount:",r),this.logDebug("baseAmountMin:",s),this.logDebug("quoteAmountMin:",a),r.isZero()&&this.logAndCreateError("amount must greater than zero","lpAmount",r.toString());let{account:g}=this.scope,P=await g.getCreatedTokenAccount({mint:y,associatedOnly:!1});P||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",g.tokenAccounts);let k=await g.getCreatedTokenAccount({mint:b}),T=await g.getCreatedTokenAccount({mint:f}),I=this.createTxBuilder(d),{bypassAssociatedCheck:h,checkCreateATAOwner:S}=v({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},c),L=await g.handleTokenAccount({side:"out",amount:0,mint:b,tokenAccount:k,bypassAssociatedCheck:h,checkCreateATAOwner:S}),{tokenAccount:x}=L,K=De(L,["tokenAccount"]);I.addInstruction(K);let R=await g.handleTokenAccount({side:"out",amount:0,mint:f,tokenAccount:T,bypassAssociatedCheck:h,checkCreateATAOwner:S}),{tokenAccount:B}=R,C=De(R,["tokenAccount"]);return I.addInstruction(C),I.addInstruction({instructions:[Na({poolInfo:n,poolKeys:p,userKeys:{lpTokenAccount:P,baseTokenAccount:x,quoteTokenAccount:B,owner:this.scope.ownerPubKey},lpAmount:r,baseAmountMin:s,quoteAmountMin:a})],lookupTableAddress:p.lookupTableAccount?[p.lookupTableAccount]:[],instructionTypes:[n.pooltype.includes("StablePool")?X.AmmV5RemoveLiquidity:X.AmmV4RemoveLiquidity]}),I.addCustomComputeBudget(l),I.addTipInstruction(m),u===0?await I.buildV0():I.build()}async removeAllLpAndCreateClmmPosition({poolInfo:t,clmmPoolInfo:n,removeLpAmount:i,createPositionInfo:r,farmInfo:s,userFarmLpAmount:a,base:c,computeBudgetConfig:u,payer:l,userAuxiliaryLedgers:m,tokenProgram:d=Fn,checkCreateATAOwner:p=!0,getEphemeralSigners:b,txVersion:f,feePayer:y}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(t.mintA.address===n.mintA.address||t.mintA.address===n.mintB.address)||!(t.mintB.address===n.mintA.address||t.mintB.address===n.mintB.address))throw Error("mint check error");let g=this.createTxBuilder(y),P={};for(let Y of this.scope.account.tokenAccountRawInfos)(P[Y.accountInfo.mint.toString()]===void 0||J(this.scope.ownerPubKey,Y.accountInfo.mint,Fn).publicKey.equals(Y.pubkey))&&(P[Y.accountInfo.mint.toString()]=Y.pubkey);let k=P[t.lpMint.address];if(k===void 0)throw Error("find lp account error in trade accounts");let T=i.add(a!=null?a:new qe(0)),I=t.mintA.address===Ve.WSOL.mint.toString(),h=t.mintB.address===Ve.WSOL.mint.toString(),{account:S,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Fn,mint:new je(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:I?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:!0,checkCreateATAOwner:p});if(g.addInstruction(x||{}),S===void 0)throw new Error("base token account not found");let{account:K,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Fn,mint:new je(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:h?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!0,checkCreateATAOwner:p});if(g.addInstruction(B||{}),K===void 0)throw new Error("quote token account not found");if(P[t.mintA.address]=S,P[t.mintB.address]=K,s!==void 0&&!(a!=null&&a.isZero())){let Y=vt[s.programId],se=pt({programId:new je(s.programId),poolId:new je(s.id),owner:this.scope.ownerPubKey,version:Y}),Pe,ce=await this.scope.connection.getAccountInfo(se);if(ce&&(Pe=wi(Y).decode(ce.data)),Y!==6&&!Pe){let{instruction:lt,instructionType:nn}=eo({id:new je(s.id),programId:new je(s.programId),version:Y,ledger:se,owner:this.scope.ownerPubKey});g.addInstruction({instructions:[lt],instructionTypes:[nn]})}let de=[];for(let lt of s.rewardInfos){let nn=lt.mint.address===Ve.WSOL.mint.toString();if(P[lt.mint.address])de.push(P[lt.mint.address]);else{let{account:bn,instructionParams:Wt}=await this.scope.account.getOrCreateTokenAccount({mint:new je(lt.mint.address),tokenProgram:d,owner:this.scope.ownerPubKey,skipCloseAccount:!nn,createInfo:{payer:l||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:p});bn||this.logAndCreateError("farm reward account not found:",lt.mint.address),Wt&&g.addInstruction(Wt),de.push(bn)}}let Ke=(await this.scope.api.fetchFarmKeysById({ids:s.id}))[0],Ze={userAuxiliaryLedgers:m,amount:a,owner:this.scope.ownerPubKey,farmInfo:s,farmKeys:Ke,lpAccount:k,rewardAccounts:de},Dt=vt[s.programId],gt=Dt===6?to(Ze):Dt===5?no(Ze):io(Ze),Ue={3:X.FarmV3Withdraw,5:X.FarmV5Withdraw,6:X.FarmV6Withdraw};g.addInstruction({instructions:[gt],instructionTypes:[Ue[Dt]]})}let C=await this.getAmmPoolKeys(t.id),L=Na({poolInfo:t,poolKeys:C,userKeys:{lpTokenAccount:k,baseTokenAccount:S,quoteTokenAccount:K,owner:this.scope.ownerPubKey},lpAmount:T,baseAmountMin:0,quoteAmountMin:0});g.addInstruction({instructions:[L],instructionTypes:[t.pooltype.includes("StablePool")?X.AmmV5RemoveLiquidity:X.AmmV4RemoveLiquidity],lookupTableAddress:C.lookupTableAccount?[C.lookupTableAccount]:[]});let[R,D]=t.mintA.address===n.mintA.address?[S,K]:[K,S],_=await this.scope.clmm.getClmmPoolKeys(n.id),W=await Se.openPositionFromBaseInstructions(U(v({poolInfo:n,poolKeys:_,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:R,tokenAccountB:D},withMetadata:"create"},r),{base:c,getEphemeralSigners:b}));return g.addInstruction({instructions:[...W.instructions],signers:W.signers,instructionTypes:[...W.instructionTypes],lookupTableAddress:_.lookupTableAccount?[_.lookupTableAccount]:[]}),f===0?g.sizeCheckBuildV0({computeBudgetConfig:u}):g.sizeCheckBuild({computeBudgetConfig:u})}async createPoolV4({programId:t,marketInfo:n,baseMintInfo:i,quoteMintInfo:r,baseAmount:s,quoteAmount:a,startTime:c,ownerInfo:u,associatedOnly:l=!1,checkCreateATAOwner:m=!1,tokenProgram:d,txVersion:p,feeDestinationId:b,computeBudgetConfig:f,txTipConfig:y,feePayer:g}){var D;let P=u.feePayer||((D=this.scope.owner)==null?void 0:D.publicKey),k=u.useSOLBalance&&i.mint.equals(Ur),T=u.useSOLBalance&&r.mint.equals(Ur),I=this.createTxBuilder(g),{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:i.mint,owner:this.scope.ownerPubKey,createInfo:k?{payer:P,amount:s}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:l,checkCreateATAOwner:m});I.addInstruction(S||{});let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:r.mint,owner:this.scope.ownerPubKey,createInfo:T?{payer:P,amount:a}:void 0,notUseTokenAccount:T,skipCloseAccount:!T,associatedOnly:T?!1:l,checkCreateATAOwner:m});if(I.addInstruction(K||{}),h===void 0||x===void 0)throw Error("you don't has some token account");let B=_a({version:4,marketVersion:3,marketId:n.marketId,baseMint:i.mint,quoteMint:r.mint,baseDecimals:i.decimals,quoteDecimals:r.decimals,programId:t,marketProgramId:n.programId}),C={programId:t,ammId:B.id,ammAuthority:B.authority,ammOpenOrders:B.openOrders,lpMint:B.lpMint,coinMint:B.baseMint,pcMint:B.quoteMint,coinVault:B.baseVault,pcVault:B.quoteVault,withdrawQueue:B.withdrawQueue,ammTargetOrders:B.targetOrders,poolTempLp:B.lpVault,marketProgramId:B.marketProgramId,marketId:B.marketId,ammConfigId:B.configId,feeDestinationId:b},{instruction:L,instructionType:R}=Oa(U(v({},C),{userWallet:this.scope.ownerPubKey,userCoinVault:h,userPcVault:x,userLpVault:J(this.scope.ownerPubKey,B.lpMint,d).publicKey,nonce:B.nonce,openTime:c,coinAmount:s,pcAmount:a}));return I.addInstruction({instructions:[L],instructionTypes:[R]}),I.addCustomComputeBudget(f),I.addTipInstruction(y),I.versionBuild({txVersion:p,extInfo:{address:C}})}async createMarketAndPoolV4({programId:t=Di,marketProgram:n=Es,feeDestinationId:i=_s,tokenProgram:r,baseMintInfo:s,quoteMintInfo:a,baseAmount:c,quoteAmount:u,startTime:l,ownerInfo:m,lowestFeeMarket:d,assignSeed:p,associatedOnly:b=!1,checkCreateATAOwner:f=!1,lotSize:y=1,tickSize:g=.01,txVersion:P,computeBudgetConfig:k,txTipConfig:T,feePayer:I}){var Oi,Rt,Wo;let h=this.scope.ownerPubKey,S=m.feePayer||((Oi=this.scope.owner)==null?void 0:Oi.publicKey),x=m.useSOLBalance&&s.mint.equals(Ur),K=m.useSOLBalance&&a.mint.equals(Ur),B=p?`${s.mint.toBase58().slice(0,7)}-${a.mint.toBase58().slice(0,7)}-${p}`:void 0,C=Ge({fromPublicKey:h,programId:n,assignSeed:B&&`${B}-market`}),L=Ge({fromPublicKey:h,programId:n,assignSeed:B&&`${B}-request`}),R=Ge({fromPublicKey:h,programId:n,assignSeed:B&&`${B}-event`}),D=Ge({fromPublicKey:h,programId:n,assignSeed:B&&`${B}-bids`}),_=Ge({fromPublicKey:h,programId:n,assignSeed:B&&`${B}-asks`}),W=Ge({fromPublicKey:h,programId:Fn,assignSeed:B&&`${B}-baseVault`}),Y=Ge({fromPublicKey:h,programId:Fn,assignSeed:B&&`${B}-quoteVault`}),se=0,Pe=new qe(100);function ce(){let on=new qe(0);for(;;)try{return{vaultOwner:je.createProgramAddressSync([C.publicKey.toBuffer(),on.toArrayLike(Buffer,"le",8)],n),vaultSignerNonce:on}}catch{if(on.iaddn(1),on.gt(new qe(25555)))throw Error("find vault owner error")}}let{vaultOwner:de,vaultSignerNonce:Ke}=ce(),Ze=new qe(Math.round(10**s.decimals*y)),Dt=new qe(Math.round(y*10**a.decimals*g));if(Ze.eq(Bt))throw Error("lot size is too small");if(Dt.eq(Bt))throw Error("tick size or lot size is too small");let gt=await qr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:n,vaultOwner:de,baseMint:s.mint,quoteMint:a.mint,id:C,baseVault:W,quoteVault:Y,requestQueue:L,eventQueue:R,bids:D,asks:_,feeRateBps:se,quoteDustThreshold:Pe,vaultSignerNonce:Ke,baseLotSize:Ze,quoteLotSize:Dt,lowestFeeMarket:d}}),Ue=this.createTxBuilder(I);Ue.addInstruction({instructions:gt[0].transaction.instructions,signers:gt[0].signer});for await(let on of gt.slice(1,gt.length))Ue.addInstruction({instructions:on.transaction.instructions,signers:on.signer,instructionTypes:on.instructionTypes});let{account:lt,instructionParams:nn}=await this.scope.account.getOrCreateTokenAccount({mint:s.mint,owner:this.scope.ownerPubKey,createInfo:x?{payer:S,amount:c}:void 0,notUseTokenAccount:x,skipCloseAccount:!x,associatedOnly:x?!1:b,checkCreateATAOwner:f,assignSeed:x&&B?`${B}-wsol`:void 0});Ue.addInstruction(nn||{});let{account:bn,instructionParams:Wt}=await this.scope.account.getOrCreateTokenAccount({mint:a.mint,owner:this.scope.ownerPubKey,createInfo:K?{payer:S,amount:u}:void 0,notUseTokenAccount:K,skipCloseAccount:!K,associatedOnly:K?!1:b,checkCreateATAOwner:f,assignSeed:K&&B?`${B}-wsol`:void 0});if(Ue.addInstruction(Wt||{}),lt===void 0)throw Error("you don't has base token account");if(bn===void 0)throw Error("you don't has quote token account");let $e=_a({version:4,marketVersion:3,marketId:C.publicKey,baseMint:s.mint,quoteMint:a.mint,baseDecimals:s.decimals,quoteDecimals:a.decimals,programId:t,marketProgramId:n}),ai={programId:t,ammId:$e.id,ammAuthority:$e.authority,ammOpenOrders:$e.openOrders,lpMint:$e.lpMint,coinMint:$e.baseMint,pcMint:$e.quoteMint,coinVault:$e.baseVault,pcVault:$e.quoteVault,withdrawQueue:$e.withdrawQueue,ammTargetOrders:$e.targetOrders,poolTempLp:$e.lpVault,marketProgramId:$e.marketProgramId,marketId:$e.marketId,ammConfigId:$e.configId,feeDestinationId:i},{instruction:Fo,instructionType:Do}=Oa(U(v({},ai),{userWallet:this.scope.ownerPubKey,userCoinVault:lt,userPcVault:bn,userLpVault:J(this.scope.ownerPubKey,$e.lpMint,r).publicKey,nonce:$e.nonce,openTime:l,coinAmount:c,pcAmount:u}));Ue.addInstruction({instructions:[Fo],instructionTypes:[Do]});let Ni=x||K?[((Rt=nn==null?void 0:nn.instructions)==null?void 0:Rt[0])||((Wo=Wt==null?void 0:Wt.instructions)==null?void 0:Wo[0])].filter(on=>!!on):void 0;return P===0?Ue.sizeCheckBuildV0({computeBudgetConfig:k,splitIns:Ni,address:v({requestQueue:L.publicKey,eventQueue:R.publicKey,bids:D.publicKey,asks:_.publicKey,baseVault:W.publicKey,quoteVault:Y.publicKey,baseMint:new je(s.mint),quoteMint:new je(a.mint)},ai)}):Ue.sizeCheckBuild({computeBudgetConfig:k,splitIns:Ni,address:v({requestQueue:L.publicKey,eventQueue:R.publicKey,bids:D.publicKey,asks:_.publicKey,baseVault:W.publicKey,quoteVault:Y.publicKey,baseMint:new je(s.mint),quoteMint:new je(a.mint)},ai)})}async getCreatePoolFee({programId:t}){let n=Dr({programId:t}),i=await this.scope.connection.getAccountInfo(n,{dataSlice:{offset:536,length:8}});if(i===null)throw Error("get config account error");return tl.decode(i.data).fee}computeAmountOut({poolInfo:t,amountIn:n,mintIn:i,mintOut:r,slippage:s}){let[a,c]=[i.toString(),r.toString()];if(a!==t.mintA.address&&a!==t.mintB.address)throw new Error("toke not match");if(c!==t.mintA.address&&c!==t.mintB.address)throw new Error("toke not match");let{baseReserve:u,quoteReserve:l}=t,m=[u,l],d=[t.mintA.decimals,t.mintB.decimals],p=a==t.mintA.address?"base":"quote";p==="quote"&&(m.reverse(),d.reverse());let[b,f]=m,[y,g]=d,P=t.version===4,k;if(P)k=new O(f.toString()).div(10**g).div(new O(b.toString()).div(10**y));else{let R=sl(this.stableLayout.stableModelData,u.toNumber(),l.toNumber(),!1);p==="quote"?k=new O(1e6).div(R*1e6):k=new O(R*1e6).div(1e6)}let T=n,I=new qe(0),h=new qe(0);if(!T.isZero())if(P){h=Nn(T.mul(Ba),Vr);let R=T.sub(h),D=b.add(R);I=f.mul(R).div(D)}else{h=T.mul(new qe(2)).div(new qe(1e4));let R=T.sub(h);p==="quote"?I=new qe(ol(this.stableLayout.stableModelData,l.toNumber(),u.toNumber(),R.toNumber())):I=new qe(rl(this.stableLayout.stableModelData,l.toNumber(),u.toNumber(),R.toNumber()))}let S=new qe(new O(I.toString()).mul(1-s).toFixed(0)),x=I,K=S,B=new O(I.toString()).div(new O(T.sub(h).toString()).toFixed(0));!T.isZero()&&!I.isZero()&&(B=new O(I.toString()).div(10**g).div(new O(T.sub(h).toString()).div(10**y)));let C=k.sub(B).div(k).mul(100);return{amountOut:x,minAmountOut:K,currentPrice:k,executionPrice:B,priceImpact:C,fee:h}}computeAmountIn({poolInfo:t,amountOut:n,mintIn:i,mintOut:r,slippage:s}){let{baseReserve:a,quoteReserve:c}=t;i.toString()!==t.mintA.address&&i.toString()!==t.mintB.address&&this.logAndCreateError("mintIn does not match pool"),r.toString()!==t.mintA.address&&r.toString()!==t.mintB.address&&this.logAndCreateError("mintOut does not match pool"),this.logDebug("baseReserve:",a.toString()),this.logDebug("quoteReserve:",c.toString());let u=i.toString()===t.mintA.address,[l,m]=u?[t.mintA,t.mintB]:[t.mintB,t.mintA];this.logDebug("currencyOut:",m.symbol||m.address),this.logDebug("amountOut:",new O(n.toString()).div(10**m.decimals).toDecimalPlaces(m.decimals).toString(),l.symbol||l.address),this.logDebug("slippage:",`${s*100}%`);let d=[a,c],p=u?"quote":"base";p==="base"&&d.reverse(),this.logDebug("output side:",p);let[b,f]=d,y=new O(f.toString()).div(10**t[u?"mintB":"mintA"].decimals).div(new O(b.toString()).div(10**t[u?"mintA":"mintB"].decimals));this.logDebug("currentPrice:",`1 ${l.symbol||l.address} \u2248 ${y.toString()} ${m.symbol||m.address}`),this.logDebug("currentPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new O(1).div(y).toString()} ${l.symbol||l.address}`);let g=new qe(0),P=n;if(!P.isZero()){P.gt(f)&&(P=f.sub(new qe(1)));let K=f.sub(P);g=b.mul(P).div(K).mul(Vr).div(Vr.sub(Ba))}let k=new qe(new O(g.toString()).mul(1+s).toFixed(0)),T=g,I=k;this.logDebug("amountIn:",new O(T.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString()),this.logDebug("maxAmountIn:",new O(I.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString());let h=null;!g.isZero()&&!P.isZero()&&(h=new O(P.toString()).div(10**m.decimals).div(new O(g.toString()).div(10**l.decimals)),this.logDebug("executionPrice:",`1 ${m.symbol||m.address} \u2248 ${h.toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`),this.logDebug("executionPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new O(1).div(h).toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`));let S=y.mul(T.toString()),x=S.sub(n.toString()).abs().div(S);return this.logDebug("priceImpact:",`${x.toString()}%`),{amountIn:T,maxAmountIn:I,currentPrice:y,executionPrice:h,priceImpact:x}}async swap({poolInfo:t,poolKeys:n,amountIn:i,amountOut:r,inputMint:s,fixedSide:a,txVersion:c,config:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}){let p=this.createTxBuilder(d),{associatedOnly:b=!0,inputUseSolBalance:f=!0,outputUseSolBalance:y=!0}=u||{},[g,P]=s===t.mintA.address?[t.mintA,t.mintB]:[t.mintB,t.mintA],k=f&&g.address===$.toBase58(),T=y&&P.address===$.toBase58(),{account:I,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Fn,mint:new je(g.address),owner:this.scope.ownerPubKey,createInfo:k?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:b});p.addInstruction(h||{}),I||this.logAndCreateError("input token account not found",{token:g.symbol||g.address,tokenAccountIn:I,inputTokenUseSolBalance:k,associatedOnly:b});let{account:S,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Fn,mint:new je(P.address),owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:T?!1:b});p.addInstruction(x||{}),S===void 0&&this.logAndCreateError("output token account not found",{token:P.symbol||P.address,tokenAccountOut:S,outputTokenUseSolBalance:T,associatedOnly:b});let K=n||await this.getAmmPoolKeys(t.id),B=4;return t.pooltype.includes("StablePool")&&(B=5),p.addInstruction({instructions:[Fr({version:B,poolKeys:K,userKeys:{tokenAccountIn:I,tokenAccountOut:S,owner:this.scope.ownerPubKey},amountIn:i,amountOut:r,fixedSide:a})],instructionTypes:[B===4?X.AmmV4SwapBaseIn:X.AmmV5SwapBaseIn]}),p.addCustomComputeBudget(l),p.addTipInstruction(m),p.versionBuild({txVersion:c})}async getRpcPoolInfo(t){return(await this.getRpcPoolInfos([t]))[t]}async getRpcPoolInfos(t,n){let i=await Ne(this.scope.connection,t.map(l=>({pubkey:new je(l)})),n),r={},s=[];for(let l=0;l<t.length;l++){let m=i[l];if(m===null||!m.accountInfo)throw Error("fetch pool info error: "+String(t[l]));let d=Zn.decode(m.accountInfo.data);r[String(t[l])]=U(v({},d),{programId:m.accountInfo.owner}),s.push(d.baseVault,d.quoteVault)}let a={},c=await Ne(this.scope.connection,s.map(l=>({pubkey:new je(l)})),n);for(let l=0;l<s.length;l++){let m=c[l].accountInfo;if(m===null)throw Error("fetch vault info error: "+s[l]);a[String(s[l])]=new qe(Mf.decode(m.data).amount.toString())}let u={};for(let[l,m]of Object.entries(r)){let d=a[m.baseVault.toString()].sub(m.baseNeedTakePnl),p=a[m.quoteVault.toString()].sub(m.quoteNeedTakePnl);u[l]=U(v({},m),{baseReserve:d,mintAAmount:a[m.baseVault.toString()],mintBAmount:a[m.quoteVault.toString()],quoteReserve:p,poolPrice:new O(p.toString()).div(new O(10).pow(m.quoteDecimal.toString())).div(new O(d.toString()).div(new O(10).pow(m.baseDecimal.toString())))})}return u}async getPoolInfoFromRpc({poolId:t}){let n=await this.getRpcPoolInfo(t),i=Wr({[t]:n}),r=i[t],s=await this.scope.tradeV2.computePoolToPoolKeys({pools:[i[t]],ammRpcData:{[t]:n}});return{poolRpcData:n,poolInfo:r,poolKeys:s[0]}}};import{PublicKey as H}from"@solana/web3.js";import Kt from"bn.js";import{AccountLayout as yl,TOKEN_2022_PROGRAM_ID as Dn,TOKEN_PROGRAM_ID as ho}from"@solana/spl-token";var To=class extends Me{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){var S;let{programId:t,owner:n=((S=this.scope.owner)==null?void 0:S.publicKey)||H.default,mint1:i,mint2:r,ammConfig:s,initialPrice:a,computeBudgetConfig:c,forerunCreate:u,getObserveState:l,txVersion:m,txTipConfig:d,feePayer:p}=e,b=this.createTxBuilder(p),[f,y,g]=new Kt(new H(i.address).toBuffer()).gt(new Kt(new H(r.address).toBuffer()))?[r,i,new O(1).div(a)]:[i,r,a],P=oe.priceToSqrtPriceX64(g,f.decimals,y.decimals),k=[],T=[];f.programId===Dn.toBase58()&&T.push(wa(t,new H(f.address)).publicKey),y.programId===Dn.toBase58()&&T.push(wa(t,new H(y.address)).publicKey),(await this.scope.connection.getMultipleAccountsInfo(T)).forEach((x,K)=>{x&&k.push(T[K])});let h=await Se.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:f,mintB:y,ammConfigId:s.id,initialPriceX64:P,forerunCreate:!l&&u,extendMintAccount:k});return b.addInstruction(h),b.addCustomComputeBudget(c),b.addTipInstruction(d),b.versionBuild({txVersion:m,extInfo:{address:U(v({},h.address),{observationId:h.address.observationId.toBase58(),exBitmapAccount:h.address.exBitmapAccount.toBase58(),programId:t.toString(),id:h.address.poolId.toString(),mintA:f,mintB:y,openTime:"0",vault:{A:h.address.mintAVault.toString(),B:h.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}}),mockPoolInfo:v({type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:h.address.poolId.toString(),mintA:f,mintB:y,feeRate:s.tradeFeeRate,openTime:"0",programId:t.toString(),price:g.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]},burnPercent:0},vc),forerunCreate:u}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,base:s,baseAmount:a,otherAmountMax:c,nft2022:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,withMetadata:d="create",getEphemeralSigners:p,computeBudgetConfig:b,txTipConfig:f,txVersion:y,feePayer:g}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let P=this.createTxBuilder(g),k=null,T=null,I=n.useSOLBalance&&e.mintA.address===$.toString(),h=n.useSOLBalance&&e.mintB.address===$.toString(),[S,x]=s==="MintA"?[a,c]:[c,a],{account:K,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new H(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:I||S.isZero()?{payer:this.scope.ownerPubKey,amount:S}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:I?!1:l,checkCreateATAOwner:m});K&&(k=K),P.addInstruction(B||{});let{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new H(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||x.isZero()?{payer:this.scope.ownerPubKey,amount:x}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:h?!1:l,checkCreateATAOwner:m});C&&(T=C),P.addInstruction(L||{}),(!k||!T)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",{ownerTokenAccountA:k==null?void 0:k.toBase58(),ownerTokenAccountB:T==null?void 0:T.toBase58()});let R=t||await this.getClmmPoolKeys(e.id),D=await Se.openPositionFromBaseInstructions({poolInfo:e,poolKeys:R,ownerInfo:U(v({},n),{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:T}),tickLower:i,tickUpper:r,base:s,baseAmount:a,otherAmountMax:c,withMetadata:d,getEphemeralSigners:p,nft2022:u});return P.addInstruction(D),P.addCustomComputeBudget(b),P.addTipInstruction(f),P.versionBuild({txVersion:y,extInfo:v({},D.address)})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:i,amountMaxB:r,tickLower:s,tickUpper:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",txVersion:d,computeBudgetConfig:p,txTipConfig:b,getEphemeralSigners:f,nft2022:y,feePayer:g}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let P=this.createTxBuilder(g),k=null,T=null,I=n.useSOLBalance&&e.mintA.address===$.toBase58(),h=n.useSOLBalance&&e.mintB.address===$.toBase58(),{account:S,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new H(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:I||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:I?!1:u,checkCreateATAOwner:l});S&&(k=S),P.addInstruction(x||{});let{account:K,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new H(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||r.isZero()?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:h?!1:u,checkCreateATAOwner:l});K&&(T=K),P.addInstruction(B||{}),(k===void 0||T===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let C=t||await this.getClmmPoolKeys(e.id),L=await Se.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:C,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:T},tickLower:s,tickUpper:a,liquidity:c,amountMaxA:i,amountMaxB:r,withMetadata:m,getEphemeralSigners:f,nft2022:y});return P.addInstruction(L),P.addCustomComputeBudget(p),P.addTipInstruction(b),P.versionBuild({txVersion:d,extInfo:{address:L.address}})}async increasePositionFromLiquidity(e){var B;let{poolInfo:t,poolKeys:n,ownerPosition:i,amountMaxA:r,amountMaxB:s,liquidity:a,ownerInfo:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txTipConfig:d,txVersion:p,feePayer:b}=e,f=this.createTxBuilder(b),y,g,P=c.useSOLBalance&&t.mintA.address===$.toString(),k=c.useSOLBalance&&t.mintB.address===$.toString(),{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new H(t.mintA.address),notUseTokenAccount:P,owner:this.scope.ownerPubKey,createInfo:P||r.isZero()?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!P,associatedOnly:P?!1:u,checkCreateATAOwner:l});T&&(y=T),f.addInstruction(I||{});let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new H(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:u,checkCreateATAOwner:l});h&&(g=h),f.addInstruction(S||{}),!y&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let x=n!=null?n:await this.getClmmPoolKeys(t.id),K=Se.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:x,ownerPosition:i,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:y,tokenAccountB:g},liquidity:a,amountMaxA:r,amountMaxB:s,nft2022:(B=await this.scope.connection.getAccountInfo(i.nftMint))==null?void 0:B.owner.equals(Dn)});return f.addInstruction(K),f.addCustomComputeBudget(m),f.addTipInstruction(d),f.versionBuild({txVersion:p,extInfo:{address:K.address}})}async increasePositionFromBase(e){var K;let{poolInfo:t,ownerPosition:n,base:i,baseAmount:r,otherAmountMax:s,ownerInfo:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,b=this.createTxBuilder(p),f,y,g=a.useSOLBalance&&t.mintA.address===$.toString(),P=a.useSOLBalance&&t.mintB.address===$.toString(),{account:k,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new H(t.mintA.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:g||(i==="MintA"?r:s).isZero()?{payer:this.scope.ownerPubKey,amount:i==="MintA"?r:s}:void 0,skipCloseAccount:!g,associatedOnly:g?!1:c,checkCreateATAOwner:u});k&&(f=k),b.addInstruction(T||{});let{account:I,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new H(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:P||(i==="MintA"?s:r).isZero()?{payer:this.scope.ownerPubKey,amount:i==="MintA"?s:r}:void 0,notUseTokenAccount:P,skipCloseAccount:!P,associatedOnly:P?!1:c,checkCreateATAOwner:u});I&&(y=I),b.addInstruction(h||{}),!f&&!y&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let S=await this.getClmmPoolKeys(t.id),x=Se.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:S,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:y},base:i,baseAmount:r,otherAmountMax:s,nft2022:(K=await this.scope.connection.getAccountInfo(n.nftMint))==null?void 0:K.owner.equals(Dn)});return b.addInstruction(x),b.addCustomComputeBudget(l),b.addTipInstruction(m),b.versionBuild({txVersion:d,extInfo:{address:x.address}})}async decreaseLiquidity(e){var R;let{poolInfo:t,poolKeys:n,ownerPosition:i,ownerInfo:r,amountMinA:s,amountMinB:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txTipConfig:d,txVersion:p,feePayer:b}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let f=this.createTxBuilder(b),y=r.useSOLBalance&&t.mintA.address===$.toString(),g=r.useSOLBalance&&t.mintB.address===$.toString(),P,k,{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new H(t.mintA.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,associatedOnly:y?!1:u,checkCreateATAOwner:l});P=T,I&&f.addInstruction(I);let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new H(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!g,associatedOnly:g?!1:u,checkCreateATAOwner:l});k=h,S&&f.addInstruction(S);let x=[];for(let D of t.rewardDefaultInfos){let _=r.useSOLBalance&&D.mint.address===$.toString(),W;if(D.mint.address===t.mintA.address)W=P;else if(D.mint.address===t.mintB.address)W=k;else{let{account:Y,instructionParams:se}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new H(D.mint.programId),mint:new H(D.mint.address),notUseTokenAccount:_,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!_,associatedOnly:_?!1:u,checkCreateATAOwner:l});W=Y,se&&f.addInstruction(se)}x.push(W)}!P&&!k&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let K=n!=null?n:await this.getClmmPoolKeys(t.id),B=(R=await this.scope.connection.getAccountInfo(i.nftMint))==null?void 0:R.owner.equals(Dn),C=await Se.decreaseLiquidityInstructions({poolInfo:t,poolKeys:K,ownerPosition:i,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:P,tokenAccountB:k,rewardAccounts:x},liquidity:c,amountMinA:s,amountMinB:a,nft2022:B});f.addInstruction({instructions:C.instructions,instructionTypes:[X.ClmmDecreasePosition]});let L=v({},C.address);if(r.closePosition){let D=await Se.closePositionInstructions({poolInfo:t,poolKeys:K,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:i,nft2022:B});f.addInstruction({endInstructions:D.instructions,endInstructionTypes:D.instructionTypes}),L=v(v({},L),D.address)}return f.addCustomComputeBudget(m),f.addTipInstruction(d),f.versionBuild({txVersion:p,extInfo:{address:L}})}async lockPosition(e){var b;let{programId:t=fi,authProgramId:n=Wi,poolProgramId:i=Rn,ownerPosition:r,payer:s,computeBudgetConfig:a,txTipConfig:c,txVersion:u,getEphemeralSigners:l,feePayer:m}=e,d=this.createTxBuilder(m),p=await Se.makeLockPositions({programId:t,authProgramId:n,poolProgramId:i,wallet:this.scope.ownerPubKey,payer:s!=null?s:this.scope.ownerPubKey,nftMint:r.nftMint,getEphemeralSigners:l,nft2022:(b=await this.scope.connection.getAccountInfo(r.nftMint))==null?void 0:b.owner.equals(Dn)});return d.addInstruction(p),d.addCustomComputeBudget(a),d.addTipInstruction(c),d.versionBuild({txVersion:u,extInfo:p.address})}async harvestLockPosition(e){let{programId:t=fi,authProgramId:n=Wi,clmmProgram:i=Rn,poolKeys:r,lockData:s,ownerInfo:a={useSOLBalance:!0},associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,b=r||await this.getClmmPoolKeys(s.poolId.toString()),f=this.createTxBuilder(p),y=await this.scope.connection.getAccountInfo(s.positionId);y||this.logger.logWithError("position not found",s.positionId);let g=fo.decode(y.data),P=a.useSOLBalance&&b.mintA.address===$.toString(),k=a.useSOLBalance&&b.mintB.address===$.toString(),T,I,{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.mintA.programId,mint:new H(b.mintA.address),notUseTokenAccount:P,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!P,associatedOnly:P?!1:c,checkCreateATAOwner:u});T=h,S&&f.addInstruction(S);let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.mintB.programId,mint:new H(b.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!k,associatedOnly:k?!1:c,checkCreateATAOwner:u});I=x,K&&f.addInstruction(K);let B={},C=[];for(let de of b.rewardInfos){let Ke=a.useSOLBalance&&de.mint.address===$.toString(),Ze=B[de.mint.address];if(!Ze){let{account:Dt,instructionParams:gt}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new H(de.mint.programId),mint:new H(de.mint.address),notUseTokenAccount:Ke,owner:this.scope.ownerPubKey,skipCloseAccount:!Ke,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:Ke?!1:c});Ze=Dt,gt&&f.addInstruction(gt)}B[de.mint.address]=Ze,C.push(Ze)}let L=co(t,s.lockNftMint).publicKey,R=J(this.scope.ownerPubKey,s.lockNftMint,ho).publicKey,D=Z.getTickArrayStartIndexByTick(g.tickLower,b.config.tickSpacing),_=Z.getTickArrayStartIndexByTick(g.tickUpper,b.config.tickSpacing),{publicKey:W}=ge(new H(b.programId),s.poolId,D),{publicKey:Y}=ge(new H(b.programId),s.poolId,_),{publicKey:se}=en(new H(b.programId),s.poolId,g.tickLower,g.tickUpper),Pe=[];for(let de=0;de<b.rewardInfos.length;de++)Pe.push({poolRewardVault:new H(b.rewardInfos[de].vault),ownerRewardVault:C[de],rewardMint:new H(b.rewardInfos[de].mint.address)});let ce=await Se.harvestLockPositionInstructionV2({programId:t,auth:n,lockPositionId:L,clmmProgram:i,lockOwner:this.scope.ownerPubKey,lockNftMint:s.lockNftMint,lockNftAccount:R,positionNftAccount:s.nftAccount,positionId:s.positionId,poolId:s.poolId,protocolPosition:se,vaultA:new H(b.vault.A),vaultB:new H(b.vault.B),tickArrayLower:W,tickArrayUpper:Y,userVaultA:T,userVaultB:I,mintA:new H(b.mintA.address),mintB:new H(b.mintB.address),rewardAccounts:Pe,exTickArrayBitmap:Xe(i,s.poolId).publicKey});return f.addInstruction({instructions:[ce],instructionTypes:[X.ClmmHarvestLockPosition]}),f.addCustomComputeBudget(l),f.addTipInstruction(m),f.versionBuild({txVersion:d})}async closePosition({poolInfo:e,poolKeys:t,ownerPosition:n,txVersion:i,computeBudgetConfig:r,txTipConfig:s,feePayer:a}){var m;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let c=this.createTxBuilder(a),u=t!=null?t:await this.getClmmPoolKeys(e.id),l=Se.closePositionInstructions({poolInfo:e,poolKeys:u,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n,nft2022:(m=await this.scope.connection.getAccountInfo(n.nftMint))==null?void 0:m.owner.equals(Dn)});return c.addCustomComputeBudget(r),c.addTipInstruction(s),c.addInstruction(l).versionBuild({txVersion:i,extInfo:{address:l.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txVersion:a,feePayer:c}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(c),l=t.useSOLBalance&&n.mint.address.toString()===$.toString(),m=n.perSecond.mul(n.endTime-n.openTime),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new H(n.mint.address),mint:new H(n.mint.address),notUseTokenAccount:!!l,skipCloseAccount:!l,owner:this.scope.ownerPubKey,createInfo:l?{payer:t.feePayer||this.scope.ownerPubKey,amount:new Kt(new O(m.toFixed(0)).gte(m)?m.toFixed(0):m.add(1).toFixed(0))}:void 0,associatedOnly:l?!1:i,checkCreateATAOwner:r});p&&u.addInstruction(p),d||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let b=await this.getClmmPoolKeys(e.id),f=Se.initRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:d},rewardInfo:{programId:new H(n.mint.programId),mint:new H(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ue.decimalToX64(n.perSecond)}});return u.addInstruction(f),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:f.address}})}async initRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){for(let p of i)p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let m=this.createTxBuilder(l),d={};for(let p of i){let b=n.useSOLBalance&&p.mint.address===$.toString(),f=p.perSecond.mul(p.endTime-p.openTime),{account:y,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new H(p.mint.programId),mint:new H(p.mint.address),notUseTokenAccount:!!b,skipCloseAccount:!b,owner:this.scope.ownerPubKey,createInfo:b?{payer:n.feePayer||this.scope.ownerPubKey,amount:new Kt(new O(f.toFixed(0)).gte(f)?f.toFixed(0):f.add(1).toFixed(0))}:void 0,associatedOnly:b?!1:r,checkCreateATAOwner:s});g&&m.addInstruction(g),y||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let P=t!=null?t:await this.getClmmPoolKeys(e.id),k=Se.initRewardInstructions({poolInfo:e,poolKeys:P,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:y},rewardInfo:{programId:new H(p.mint.programId),mint:new H(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:ue.decimalToX64(p.perSecond)}});d=v(v({},d),k.address),m.addInstruction(k)}return m.addCustomComputeBudget(a),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:{address:d}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let l=this.createTxBuilder(u),m=t.useSOLBalance&&n.mint.equals($),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:m,owner:this.scope.ownerPubKey,createInfo:m?{payer:t.feePayer||this.scope.ownerPubKey,amount:new Kt(new O(n.perSecond.mul(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.mul(n.endTime-n.openTime))?n.perSecond.mul(n.endTime-n.openTime).toFixed(0):n.perSecond.mul(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:m?!1:i,checkCreateATAOwner:r});p&&l.addInstruction(p),d||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let b=await this.getClmmPoolKeys(e.id),f=Se.setRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:d},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ue.decimalToX64(n.perSecond)}});return l.addInstruction(f),l.addCustomComputeBudget(s),l.addTipInstruction(a),l.versionBuild({txVersion:c,extInfo:{address:f.address}})}async setRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){let m=this.createTxBuilder(l),d={};for(let p of i){p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let b=n.useSOLBalance&&p.mint.address===$.toString(),{account:f,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new H(p.mint.programId),mint:new H(p.mint.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:b?{payer:n.feePayer||this.scope.ownerPubKey,amount:new Kt(new O(p.perSecond.mul(p.endTime-p.openTime).toFixed(0)).gte(p.perSecond.mul(p.endTime-p.openTime))?p.perSecond.mul(p.endTime-p.openTime).toFixed(0):p.perSecond.mul(p.endTime-p.openTime).add(1).toFixed(0))}:void 0,associatedOnly:b?!1:r,checkCreateATAOwner:s});y&&m.addInstruction(y),f||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let g=t!=null?t:await this.getClmmPoolKeys(e.id),P=Se.setRewardInstructions({poolInfo:e,poolKeys:g,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:f},rewardInfo:{mint:new H(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:ue.decimalToX64(p.perSecond)}});m.addInstruction(P),d=v(v({},d),P.address)}return m.addCustomComputeBudget(a),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:{address:d}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){let l=e.rewardDefaultInfos.find(g=>g.mint.address===n.toString());l||this.logAndCreateError("reward mint error","not found reward mint",n);let m=this.createTxBuilder(u),d=t.useSOLBalance&&n.equals($),{account:p,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new H(l.mint.programId),mint:n,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!d,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:i,checkCreateATAOwner:r});b&&m.addInstruction(b),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),y=Se.collectRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardMint:n});return m.addInstruction(y),m.addCustomComputeBudget(s),m.addTipInstruction(a),m.versionBuild({txVersion:c,extInfo:{address:y.address}})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l={};for(let m of n){let d=e.rewardDefaultInfos.find(P=>P.mint.address===m.toString());if(!d){this.logAndCreateError("reward mint error","not found reward mint",m);continue}let p=t.useSOLBalance&&m.equals($),{account:b,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new H(d.mint.programId),mint:m,notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:i,checkCreateATAOwner:r});b||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),f&&u.addInstruction(f);let y=await this.getClmmPoolKeys(e.id),g=Se.collectRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:b},rewardMint:m});u.addInstruction(g),l=v(v({},l),g.address)}return u.addCustomComputeBudget(s),u.addTipInstruction(a),u.build({address:l})}async swap({poolInfo:e,poolKeys:t,inputMint:n,amountIn:i,amountOutMin:r,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p,txTipConfig:b,feePayer:f}){let y=this.createTxBuilder(f),g=n.toString()===e.mintA.address,P=c.useSOLBalance&&e.mintA.address===$.toBase58(),k=c.useSOLBalance&&e.mintB.address===$.toBase58(),T;!s||s.equals(new O(0))?T=g?_t.add(new Kt(1)):Vt.sub(new Kt(1)):T=oe.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let I;if(!I){let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new H(e.mintA.address),notUseTokenAccount:P,owner:this.scope.ownerPubKey,skipCloseAccount:!P,createInfo:P||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?i:0}:void 0,associatedOnly:P?!1:l,checkCreateATAOwner:m});I=x,K&&y.addInstruction(K)}let h;if(!h){let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new H(e.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:k||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:i}:void 0,associatedOnly:k?!1:l,checkCreateATAOwner:m});h=x,K&&y.addInstruction(K)}(!I||!h)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:I,ownerTokenAccountB:h,mintAUseSOLBalance:P,mintBUseSOLBalance:k,associatedOnly:l});let S=t!=null?t:await this.getClmmPoolKeys(e.id);return y.addInstruction(Se.makeSwapBaseInInstructions({poolInfo:e,poolKeys:S,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:I,tokenAccountB:h},inputMint:new H(n),amountIn:i,amountOutMin:r,sqrtPriceLimitX64:T,remainingAccounts:u})),y.addCustomComputeBudget(p),y.addTipInstruction(b),y.versionBuild({txVersion:d})}async swapBaseOut({poolInfo:e,poolKeys:t,outputMint:n,amountOut:i,amountInMax:r,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p,txTipConfig:b,feePayer:f}){let y=this.createTxBuilder(f),g=n.toString()===e.mintB.address,P=c.useSOLBalance&&e.mintA.address===$.toBase58(),k=c.useSOLBalance&&e.mintB.address===$.toBase58(),T;!s||s.equals(new O(0))?T=n.toString()===e.mintB.address?_t.add(new Kt(1)):Vt.sub(new Kt(1)):T=oe.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let I;if(!I){let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new H(e.mintA.address),notUseTokenAccount:P,owner:this.scope.ownerPubKey,skipCloseAccount:!P,createInfo:P||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?r:0}:void 0,associatedOnly:P?!1:l,checkCreateATAOwner:m});I=x,K&&y.addInstruction(K)}let h;if(!h){let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new H(e.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:k||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:r}:void 0,associatedOnly:k?!1:l,checkCreateATAOwner:m});h=x,K&&y.addInstruction(K)}(!I||!h)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:I,ownerTokenAccountB:h,mintAUseSOLBalance:P,mintBUseSOLBalance:k,associatedOnly:l});let S=t!=null?t:await this.getClmmPoolKeys(e.id);return y.addInstruction(Se.makeSwapBaseOutInstructions({poolInfo:e,poolKeys:S,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:I,tokenAccountB:h},outputMint:new H(n),amountOut:i,amountInMax:r,sqrtPriceLimitX64:T,remainingAccounts:u})),y.addCustomComputeBudget(p),y.addTipInstruction(b),y.versionBuild({txVersion:d})}async harvestAllRewards({allPoolInfo:e,allPositions:t,lockInfo:n,ownerInfo:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,programId:a,txVersion:c,computeBudgetConfig:u,feePayer:l}){var y,g;let m={};for(let P of this.scope.account.tokenAccountRawInfos)r?J(this.scope.ownerPubKey,P.accountInfo.mint,a).publicKey.equals(P.pubkey)&&(m[P.accountInfo.mint.toString()]=P.pubkey):m[P.accountInfo.mint.toString()]=P.pubkey;let d=Object.values(t).flat().map(P=>P.nftMint),p=await Ne(this.scope.connection,d.map(P=>({pubkey:P}))),b={};p.forEach(P=>{var k,T;b[P.pubkey.toBase58()]=(T=(k=P==null?void 0:P.accountInfo)==null?void 0:k.owner)!=null?T:null});let f=this.createTxBuilder(l);for(let P of Object.values(e)){if(t[P.id]===void 0||!t[P.id].find(C=>!C.liquidity.isZero()||C.rewardInfos.find(L=>!L.rewardAmountOwed.isZero())))continue;let k=P,T=i.useSOLBalance&&k.mintA.address===$.toString(),I=i.useSOLBalance&&k.mintB.address===$.toString(),h=m[k.mintA.address];if(!h){let{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:k.mintA.programId,mint:new H(k.mintA.address),notUseTokenAccount:T,owner:this.scope.ownerPubKey,skipCloseAccount:!T,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:T?!1:r,checkCreateATAOwner:s});h=C,L&&f.addInstruction(L)}let S=m[k.mintB.address];if(!S){let{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:k.mintB.programId,mint:new H(k.mintB.address),notUseTokenAccount:I,owner:this.scope.ownerPubKey,skipCloseAccount:!I,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:I?!1:r,checkCreateATAOwner:s});S=C,L&&f.addInstruction(L)}m[k.mintA.address]=h,m[k.mintB.address]=S;let x=[];for(let C of k.rewardDefaultInfos){let L=i.useSOLBalance&&C.mint.address===$.toString(),R=m[C.mint.address];if(!R){let{account:D,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new H(C.mint.programId),mint:new H(C.mint.address),notUseTokenAccount:L,owner:this.scope.ownerPubKey,skipCloseAccount:!L,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:L?!1:r});R=D,_&&f.addInstruction(_)}m[C.mint.address]=R,x.push(R)}let K=await this.getClmmPoolKeys(k.id),B=[];for(let C=0;C<K.rewardInfos.length;C++)B.push({poolRewardVault:new H(K.rewardInfos[C].vault),ownerRewardVault:x[C],rewardMint:new H(K.rewardInfos[C].mint.address)});for(let C of t[P.id]){let L=(y=n==null?void 0:n[P.id])==null?void 0:y[C.nftMint.toBase58()];if(L){let R=J(this.scope.ownerPubKey,L.lockNftMint,ho).publicKey,D=Z.getTickArrayStartIndexByTick(C.tickLower,K.config.tickSpacing),_=Z.getTickArrayStartIndexByTick(C.tickUpper,K.config.tickSpacing),{publicKey:W}=ge(new H(K.programId),L.poolId,D),{publicKey:Y}=ge(new H(K.programId),L.poolId,_),{publicKey:se}=en(new H(K.programId),L.poolId,C.tickLower,C.tickUpper),Pe=co(fi,L.lockNftMint).publicKey,ce=Se.harvestLockPositionInstructionV2({programId:fi,auth:Wi,lockPositionId:Pe,clmmProgram:Rn,lockOwner:this.scope.ownerPubKey,lockNftMint:L.lockNftMint,lockNftAccount:R,positionNftAccount:L.nftAccount,positionId:L.positionId,poolId:L.poolId,protocolPosition:se,vaultA:new H(K.vault.A),vaultB:new H(K.vault.B),tickArrayLower:W,tickArrayUpper:Y,userVaultA:h,userVaultB:S,mintA:new H(K.mintA.address),mintB:new H(K.mintB.address),rewardAccounts:B,exTickArrayBitmap:Xe(Rn,L.poolId).publicKey});f.addInstruction({instructions:[ce],instructionTypes:[X.ClmmHarvestLockPosition],lookupTableAddress:K.lookupTableAccount?[K.lookupTableAccount]:[]})}else{let R=Se.decreaseLiquidityInstructions({poolInfo:k,poolKeys:K,ownerPosition:C,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:h,tokenAccountB:S,rewardAccounts:x},liquidity:new Kt(0),amountMinA:new Kt(0),amountMinB:new Kt(0),nft2022:(g=b[C.nftMint.toBase58()])==null?void 0:g.equals(Dn)});f.addInstruction(R)}}}return c===0?f.sizeCheckBuildV0({computeBudgetConfig:u}):f.sizeCheckBuild({computeBudgetConfig:u})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(uo(e).publicKey);return t?jc.decode(t.data).whitelistMints.filter(i=>!i.equals(H.default)):[]}async getOwnerPositionInfo({programId:e}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new Kt(1))).map(s=>ht(new H(e),s.accountInfo.mint).publicKey),i=await this.scope.connection.getMultipleAccountsInfo(n),r=[];return i.forEach(s=>{if(!s)return;let a=fo.decode(s.data);r.push(a)}),r}async getRpcClmmPoolInfo({poolId:e}){return(await this.getRpcClmmPoolInfos({poolIds:[e]}))[String(e)]}async getRpcClmmPoolInfos({poolIds:e,config:t}){let n=await Ne(this.scope.connection,e.map(r=>({pubkey:new H(r)})),t),i={};for(let r=0;r<e.length;r++){let s=n[r];if(s===null||!s.accountInfo)throw Error("fetch pool info error: "+String(e[r]));let a=Hn.decode(s.accountInfo.data),c=oe.sqrtPriceX64ToPrice(a.sqrtPriceX64,a.mintDecimalsA,a.mintDecimalsB).toNumber();i[String(e[r])]=U(v({},a),{currentPrice:c,programId:s.accountInfo.owner})}return i}async getComputeClmmPoolInfos({clmmPoolsRpcInfo:e,mintInfos:t}){let n=new Set(Object.keys(e).map(c=>e[c].ammConfig.toBase58())),i=await Ne(this.scope.connection,Array.from(n).map(c=>({pubkey:new H(c)}))),r={};i.forEach(c=>{!c.accountInfo||(r[c.pubkey.toBase58()]=Qc.decode(c.accountInfo.data))});let s=await Re.fetchComputeMultipleClmmInfo({connection:this.scope.connection,rpcDataMap:e,poolList:Object.keys(e).map(c=>{var m,d,p,b;let[u,l]=[e[c].mintA.toBase58(),e[c].mintB.toBase58()];return{id:c,programId:e[c].programId.toBase58(),mintA:bt({address:u,decimals:e[c].mintDecimalsA,programId:t[u].programId.toBase58()||ho.toBase58(),extensions:{feeConfig:(m=t[u])!=null&&m.feeConfig?Vn((d=t[u])==null?void 0:d.feeConfig):void 0}}),mintB:bt({address:l,decimals:e[c].mintDecimalsB,programId:t[l].programId.toBase58()||ho.toBase58(),extensions:{feeConfig:(p=t[l])!=null&&p.feeConfig?Vn((b=t[l])==null?void 0:b.feeConfig):void 0}}),price:e[c].currentPrice,config:U(v({},r[e[c].ammConfig.toBase58()]),{id:e[c].ammConfig.toBase58(),fundFeeRate:0,description:"",defaultRange:0,defaultRangePoint:[]})}})}),a=await Re.fetchMultiplePoolTickArrays({connection:this.scope.connection,poolKeys:Object.values(s)});return{computeClmmPoolInfo:s,computePoolTickData:a}}async getPoolInfoFromRpc(e){var l;let t=await this.getRpcClmmPoolInfo({poolId:e}),n=new Set([t.mintA.toBase58(),t.mintB.toBase58()]),i=await ui({connection:this.scope.connection,mints:Array.from(n).map(m=>new H(m))}),{computeClmmPoolInfo:r,computePoolTickData:s}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:{[e]:t},mintInfos:i}),a=await Ne(this.scope.connection,[{pubkey:t.vaultA},{pubkey:t.vaultB}]),c=Gc(r[e]);if(!a[0].accountInfo||!a[1].accountInfo)throw new Error("pool vault data not found");c.mintAmountA=Number(yl.decode(a[0].accountInfo.data).amount.toString()),c.mintAmountB=Number(yl.decode((l=a[1].accountInfo)==null?void 0:l.data).amount.toString());let u=U(v({},r[e]),{exBitmapAccount:r[e].exBitmapAccount.toBase58(),observationId:r[e].observationId.toBase58(),id:e,programId:t.programId.toBase58(),openTime:t.startTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},config:c.config,rewardInfos:r[e].rewardInfos.filter(m=>!m.tokenVault.equals(H.default)).map(m=>({mint:bt({address:m.tokenMint.toBase58(),programId:ho.toBase58(),decimals:10}),vault:m.tokenVault.toBase58()}))});return{poolInfo:c,poolKeys:u,computePoolInfo:r[e],tickData:s}}};import{PublicKey as j}from"@solana/web3.js";import{AccountLayout as Hf,NATIVE_MINT as $r,TOKEN_PROGRAM_ID as tn}from"@solana/spl-token";import Fa from"bn.js";import zr from"decimal.js-light";import Io from"bn.js";function Gr(o,e){if(e.isZero())throw Error("divisor is zero");return o.mod(e)}function vf(o,e){if(e.isZero())throw Error("rhs is zero");let t=o.div(e);if(t.isZero())throw Error("quotient is zero");let n=Gr(o,e);return n.gt(xi)&&(t=t.add(new Io(1)),e=o.div(t),n=Gr(o,t),n.gt(xi)&&(e=e.add(new Io(1)))),[t,e]}var xi=new Io(0),Xr=class{static swapWithoutFees(e,t,n){let i=t.mul(n),r=t.add(e),[s]=vf(i,r),a=n.sub(s);if(a.isZero())throw Error("destinationAmountSwapped is zero");return{destinationAmountSwapped:a}}static lpTokensToTradingTokens(e,t,n,i,r){let s=e.mul(n).div(t),a=e.mul(i).div(t);if(r===0)return{tokenAmount0:s,tokenAmount1:a};if(r===1)return Gr(e.mul(n),t).gt(xi)&&s.gt(xi)&&(s=s.add(new Io(1))),Gr(e.mul(i),t).gt(xi)&&a.gt(xi)&&(a=a.add(new Io(1))),{tokenAmount0:s,tokenAmount1:a};throw Error("roundDirection value error")}};var Qr=class{static tradingFee(e,t){return or(e,t,Ht)}static protocolFee(e,t){return Ns(e,t,Ht)}static fundFee(e,t){return Ns(e,t,Ht)}};var gl=(t=>(t[t.Floor=0]="Floor",t[t.Ceiling=1]="Ceiling",t))(gl||{}),jr=class{static validate_supply(e,t){if(e.isZero())throw Error("tokenAmount0 is zero");if(t.isZero())throw Error("tokenAmount1 is zero")}static swap(e,t,n,i){let r=Qr.tradingFee(e,i),s=e.sub(r),{destinationAmountSwapped:a}=Xr.swapWithoutFees(s,t,n);return{newSwapDestinationAmount:n.sub(a),sourceAmountSwapped:e,destinationAmountSwapped:a,tradeFee:r}}static swapBaseOut({poolMintA:e,poolMintB:t,tradeFeeRate:n,baseReserve:i,quoteReserve:r,outputMint:s,outputAmount:a}){let[c,u,l,m,d]=t.address===s.toString()?[i,r,e.decimals,t.decimals,e.address]:[r,i,t.decimals,e.decimals,t.address],p=new zr(u.toString()).div(10**m).div(new zr(c.toString()).div(10**l)),b=a.gte(u)?u.sub(new Fa(1)):a,f=u.sub(b),y=Nn(c.mul(b),f),g=Nn(y.mul(new Fa(1e6)),new Fa(1e6).sub(n)),P=g.sub(y),k=new zr(b.toString()).div(10**m).div(new zr(g.toString()).div(10**l)),T=p.isZero()?0:k.sub(p).div(p).abs().toNumber();return{amountRealOut:b,amountIn:g,amountInWithoutFee:y,tradeFee:P,priceImpact:T}}};import Qe from"bn.js";import{PublicKey as xo,TransactionInstruction as ni,Keypair as Xf,SystemProgram as Qf}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as wl,TOKEN_2022_PROGRAM_ID as Wa,TOKEN_PROGRAM_ID as Wn}from"@solana/spl-token";var Ef=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),_f=Buffer.from("amm_config","utf8"),Vf=Buffer.from("pool","utf8"),Ff=Buffer.from("pool_lp_mint","utf8"),Df=Buffer.from("pool_vault","utf8"),Wf=Buffer.from("observation","utf8");function Si(o){return ie([Ef],o)}function dS(o,e){return ie([_f,Uf(e)],o)}function Da(o,e,t,n){return ie([Vf,e.toBuffer(),t.toBuffer(),n.toBuffer()],o)}function qf(o,e){return ie([Ff,e.toBuffer()],o)}function Al(o,e,t){return ie([Df,e.toBuffer(),t.toBuffer()],o)}function Bo(o,e){return ie([Wf,e.toBuffer()],o)}function Uf(o){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,o,!1),new Uint8Array(e)}function Pl({poolId:o,programId:e,configId:t,mintA:n,mintB:i}){let r=Si(e).publicKey,s=o||Da(e,t,n,i).publicKey,a=qf(e,s).publicKey,c=Al(e,s,n).publicKey,u=Al(e,s,i).publicKey,l=Bo(e,s).publicKey;return{poolId:s,configId:t,authority:r,lpMint:a,vaultA:c,vaultB:u,observationId:l}}var Gf=Buffer.from("locked_liquidity","utf8");function Hr(o,e){return ie([Gf,e.toBuffer()],o)}var zf=fe("Raydium_cpmm"),ii={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173],lockCpLiquidity:[216,157,29,78,38,51,31,26],collectCpFee:[8,30,51,199,209,184,247,133]};function kl(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P,k){let T=E([w("amountMaxA"),w("amountMaxB"),w("openTime")]),I=Da(o,t,r,s).publicKey,h=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!i.equals(I),isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:Wn,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:wl,isSigner:!1,isWritable:!1},{pubkey:tr,isSigner:!1,isWritable:!1},{pubkey:He,isSigner:!1,isWritable:!1}],S=Buffer.alloc(T.span);return T.encode({amountMaxA:g,amountMaxB:P,openTime:k},S),new ni({keys:h,programId:o,data:Buffer.from([...ii.initialize,...S])})}function hl(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b){let f=E([w("lpAmount"),w("amountMaxA"),w("amountMaxB")]),y=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Wn,isSigner:!1,isWritable:!1},{pubkey:Wa,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0}],g=Buffer.alloc(f.span);return zf.debug("cpmm deposit data",{lpAmount:d.toString(),amountMaxA:p.toString(),amountMaxB:b.toString()}),f.encode({lpAmount:d,amountMaxA:p,amountMaxB:b},g),new ni({keys:y,programId:o,data:Buffer.from([...ii.deposit,...g])})}function Tl(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b){let f=E([w("lpAmount"),w("amountMinA"),w("amountMinB")]),y=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Wn,isSigner:!1,isWritable:!1},{pubkey:Wa,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:an,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);return f.encode({lpAmount:d,amountMinA:p,amountMinB:b},g),new ni({keys:y,programId:o,data:Buffer.from([...ii.withdraw,...g])})}function Yr(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b,f){let y=E([w("amountIn"),w("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],P=Buffer.alloc(y.span);return y.encode({amountIn:b,amounOutMin:f},P),new ni({keys:g,programId:o,data:Buffer.from([...ii.swapBaseInput,...P])})}function Il(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b,f){let y=E([w("amountInMax"),w("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],P=Buffer.alloc(y.span);return y.encode({amountInMax:b,amountOut:f},P),new ni({keys:g,programId:o,data:Buffer.from([...ii.swapBaseOutput,...P])})}async function Bl(o){var y;let{ownerInfo:e,poolInfo:t,poolKeys:n,feeNftOwner:i,getEphemeralSigners:r}=o,s=[],[a,c]=[new xo(t.id),new xo(t.lpMint.address)],u;if(r)u=new xo((await r(1))[0]);else{let g=Xf.generate();s.push(g),u=g.publicKey}let{publicKey:l}=J(i,u,Wn),{publicKey:m}=kn(u),{publicKey:d}=Hr(o.lockProgram,u),{publicKey:p}=J(e.wallet,c,Wn),{publicKey:b}=J(o.lockAuthProgram,c,Wn),f=jf({programId:o.lockProgram,auth:o.lockAuthProgram,payer:e.feePayer,liquidityOwner:e.wallet,nftOwner:i,nftMint:u,nftAccount:l,poolId:a,lockPda:d,mintLp:c,userLpVault:p,lockLpVault:b,poolVaultA:new xo(n.vault.A),poolVaultB:new xo(n.vault.B),metadataAccount:m,lpAmount:o.lpAmount,withMetadata:(y=o.withMetadata)!=null?y:!0});return{address:{nftMint:u,nftAccount:l,metadataAccount:m,lockPda:d,userLpVault:p,lockLpVault:b},instructions:[f],signers:s,instructionTypes:[X.CpmmLockLp],lookupTableAddress:[]}}function jf({programId:o,auth:e,payer:t,liquidityOwner:n,nftOwner:i,nftMint:r,nftAccount:s,poolId:a,lockPda:c,mintLp:u,userLpVault:l,lockLpVault:m,poolVaultA:d,poolVaultB:p,metadataAccount:b,lpAmount:f,withMetadata:y}){let g=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:Qf.programId,isSigner:!1,isWritable:!1},{pubkey:Wn,isSigner:!1,isWritable:!1},{pubkey:wl,isSigner:!1,isWritable:!1},{pubkey:Xt,isSigner:!1,isWritable:!1}],P=E([w("lpAmount"),Fe("withMetadata")]),k=Buffer.alloc(P.span);P.encode({lpAmount:f,withMetadata:y},k);let T=Buffer.from([...ii.lockCpLiquidity,...k]);return new ni({keys:g,programId:o,data:T})}function xl({programId:o,nftOwner:e,auth:t,nftAccount:n,lockPda:i,poolId:r,mintLp:s,userVaultA:a,userVaultB:c,poolVaultA:u,poolVaultB:l,mintA:m,mintB:d,lockLpVault:p,lpFeeAmount:b,cpmmProgram:f,cpmmAuthProgram:y}){let g=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:f!=null?f:qi,isSigner:!1,isWritable:!1},{pubkey:y!=null?y:Vs,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:Wn,isSigner:!1,isWritable:!1},{pubkey:Wa,isSigner:!1,isWritable:!1},{pubkey:an,isSigner:!1,isWritable:!1}],P=E([w("lpFeeAmount")]),k=Buffer.alloc(P.span);P.encode({lpFeeAmount:b},k);let T=Buffer.from([...ii.collectCpFee,...k]);return new ni({keys:g,programId:o,data:T})}var Sl=E([Te(8),q("bump"),Fe("disableCreatePool"),Zt("index"),w("tradeFeeRate"),w("protocolFeeRate"),w("fundFeeRate"),w("createPoolFee"),N("protocolOwner"),N("fundOwner"),z(w(),16)]),Zr=E([Te(8),N("configId"),N("poolCreator"),N("vaultA"),N("vaultB"),N("mintLp"),N("mintA"),N("mintB"),N("mintProgramA"),N("mintProgramB"),N("observationId"),q("bump"),q("status"),q("lpDecimals"),q("mintDecimalA"),q("mintDecimalB"),w("lpAmount"),w("protocolFeesMintA"),w("protocolFeesMintB"),w("fundFeesMintA"),w("fundFeesMintB"),w("openTime"),z(w(),32)]);var So=class extends Me{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t){return(await this.getRpcPoolInfos([e],t))[e]}async getRpcPoolInfos(e,t){let n=await Ne(this.scope.connection,e.map(m=>({pubkey:new j(m)}))),i={},r=new Set,s=[];for(let m=0;m<e.length;m++){let d=n[m];if(d.accountInfo===null)throw Error("fetch pool info error: "+String(e[m]));let p=Zr.decode(d.accountInfo.data);i[String(e[m])]=U(v({},p),{programId:d.accountInfo.owner}),r.add(String(p.configId)),s.push(p.vaultA,p.vaultB)}let a={};if(t){let m=[...r],d=await Ne(this.scope.connection,m.map(p=>({pubkey:new j(p)})));for(let p=0;p<m.length;p++){let b=d[p].accountInfo;if(b===null)throw Error("fetch pool config error: "+m[p]);a[m[p]]=Sl.decode(b.data)}}let c={},u=await Ne(this.scope.connection,s.map(m=>({pubkey:new j(m)})));for(let m=0;m<s.length;m++){let d=u[m].accountInfo;if(d===null)throw Error("fetch vault info error: "+s[m]);c[String(s[m])]=new Qe(Hf.decode(d.data).amount.toString())}let l={};for(let[m,d]of Object.entries(i)){let p=c[d.vaultA.toString()].sub(d.protocolFeesMintA).sub(d.fundFeesMintA),b=c[d.vaultB.toString()].sub(d.protocolFeesMintB).sub(d.fundFeesMintB);l[m]=U(v({},d),{baseReserve:p,quoteReserve:b,vaultAAmount:c[d.vaultA.toString()],vaultBAmount:c[d.vaultB.toString()],configInfo:a[d.configId.toString()],poolPrice:new O(b.toString()).div(new O(10).pow(d.mintDecimalB)).div(new O(p.toString()).div(new O(10).pow(d.mintDecimalA)))})}return l}toComputePoolInfos({pools:e,mintInfos:t}){return Object.keys(e).reduce((n,i)=>{var c,u,l,m;let r=e[i],[s,a]=[r.mintA.toBase58(),r.mintB.toBase58()];return U(v({},n),{[i]:U(v({},r),{id:new j(i),configInfo:r.configInfo,version:7,authority:Si(r.programId).publicKey,mintA:bt({address:s,decimals:r.mintDecimalA,programId:r.mintProgramA.toBase58(),extensions:{feeConfig:(c=t[s])!=null&&c.feeConfig?Vn((u=t[s])==null?void 0:u.feeConfig):void 0}}),mintB:bt({address:a,decimals:r.mintDecimalB,programId:r.mintProgramB.toBase58(),extensions:{feeConfig:(l=t[a])!=null&&l.feeConfig?Vn((m=t[a])==null?void 0:m.feeConfig):void 0}})})})},{})}async getPoolInfoFromRpc(e){let t=await this.getRpcPoolInfo(e,!0),n=await ui({connection:this.scope.connection,mints:[t.mintA,t.mintB]}),i=bt({address:t.mintA.toBase58(),decimals:t.mintDecimalA,programId:t.mintProgramA.toBase58(),extensions:{feeConfig:n[t.mintA.toBase58()].feeConfig?Vn(n[t.mintA.toBase58()].feeConfig):void 0}}),r=bt({address:t.mintB.toBase58(),decimals:t.mintDecimalB,programId:t.mintProgramB.toBase58(),extensions:{feeConfig:n[t.mintB.toBase58()].feeConfig?Vn(n[t.mintB.toBase58()].feeConfig):void 0}}),s=bt({address:t.mintLp.toBase58(),decimals:t.lpDecimals,programId:tn.toBase58()}),a={id:t.configId.toBase58(),index:t.configInfo.index,protocolFeeRate:t.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:t.configInfo.tradeFeeRate.toNumber(),fundFeeRate:t.configInfo.fundFeeRate.toNumber(),createPoolFee:t.configInfo.createPoolFee.toString()},c={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};return{poolInfo:{programId:t.programId.toBase58(),id:e,type:"Standard",lpMint:s,lpPrice:0,lpAmount:t.lpAmount.toNumber(),config:a,mintA:i,mintB:r,rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:t.poolPrice.toNumber(),mintAmountA:new O(t.vaultAAmount.toString()).div(10**i.decimals).toNumber(),mintAmountB:new O(t.vaultBAmount.toString()).div(10**r.decimals).toNumber(),feeRate:t.configInfo.tradeFeeRate.toNumber(),openTime:t.openTime.toString(),tvl:0,burnPercent:0,day:c,week:c,month:c,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0},poolKeys:{programId:t.programId.toBase58(),id:e,mintA:i,mintB:r,openTime:t.openTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},authority:Si(t.programId).publicKey.toBase58(),mintLp:s,config:a,observationId:Bo(t.programId,new j(e)).publicKey.toBase58()},rpcData:t}}async createPool(b){var f=b,{poolId:e,programId:t,poolFeeAccount:n,startTime:i,ownerInfo:r,associatedOnly:s=!1,checkCreateATAOwner:a=!1,txVersion:c,feeConfig:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}=f,p=De(f,["poolId","programId","poolFeeAccount","startTime","ownerInfo","associatedOnly","checkCreateATAOwner","txVersion","feeConfig","computeBudgetConfig","txTipConfig","feePayer"]);var W,Y,se;let y=r.feePayer||((W=this.scope.owner)==null?void 0:W.publicKey),g=new Qe(new j(p.mintA.address).toBuffer()).lte(new Qe(new j(p.mintB.address).toBuffer())),[P,k]=g?[p.mintA,p.mintB]:[p.mintB,p.mintA],[T,I]=g?[p.mintAAmount,p.mintBAmount]:[p.mintBAmount,p.mintAAmount],h=r.useSOLBalance&&P.address===$r.toBase58(),S=r.useSOLBalance&&k.address===$r.toBase58(),[x,K]=[new j(P.address),new j(k.address)],B=this.createTxBuilder(d),{account:C,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({mint:x,tokenProgram:P.programId,owner:this.scope.ownerPubKey,createInfo:h?{payer:y,amount:T}:void 0,notUseTokenAccount:h,skipCloseAccount:!h,associatedOnly:h?!1:s,checkCreateATAOwner:a});B.addInstruction(L||{});let{account:R,instructionParams:D}=await this.scope.account.getOrCreateTokenAccount({mint:new j(k.address),tokenProgram:k.programId,owner:this.scope.ownerPubKey,createInfo:S?{payer:y,amount:I}:void 0,notUseTokenAccount:S,skipCloseAccount:!S,associatedOnly:S?!1:s,checkCreateATAOwner:a});if(B.addInstruction(D||{}),C===void 0||R===void 0)throw Error("you don't has some token account");let _=Pl({poolId:e,programId:t,configId:new j(u.id),mintA:x,mintB:K});return B.addInstruction({instructions:[kl(t,this.scope.ownerPubKey,new j(u.id),_.authority,_.poolId,x,K,_.lpMint,C,R,J(this.scope.ownerPubKey,_.lpMint).publicKey,_.vaultA,_.vaultB,n,new j((Y=P.programId)!=null?Y:tn),new j((se=k.programId)!=null?se:tn),_.observationId,T,I,i)],instructionTypes:[X.CpmmCreatePool]}),B.addCustomComputeBudget(l),B.addTipInstruction(m),B.versionBuild({txVersion:c,extInfo:{address:U(v({},_),{mintA:P,mintB:k,programId:t,poolFeeAccount:n,feeConfig:u})}})}async addLiquidity(e){let{poolInfo:t,poolKeys:n,inputAmount:i,baseIn:r,slippage:s,computeResult:a,computeBudgetConfig:c,txTipConfig:u,config:l,txVersion:m,feePayer:d}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),i.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:i.toString()});let{account:p}=this.scope,{bypassAssociatedCheck:b,checkCreateATAOwner:f}=v({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},l),y=a?void 0:await this.getRpcPoolInfo(t.id),{liquidity:g,inputAmountFee:P,anotherAmount:k}=a||this.computePairAmount({poolInfo:U(v({},t),{lpAmount:new O(y.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()}),baseReserve:y.baseReserve,quoteReserve:y.quoteReserve,slippage:new ot(0),baseIn:r,epochInfo:await this.scope.fetchEpochInfo(),amount:new O(i.toString()).div(10**(r?t.mintA.decimals:t.mintB.decimals))}),T=k.amount,I=t.mintA.address===$r.toString(),h=t.mintB.address===$r.toString(),S=this.createTxBuilder(d),[x,K]=[new j(t.mintA.address),new j(t.mintB.address)],{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new j(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:I||(r?i:T).isZero()?{payer:this.scope.ownerPubKey,amount:r?i:T}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:!1,checkCreateATAOwner:f});S.addInstruction(C||{});let{account:L,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new j(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||(r?T:i).isZero()?{payer:this.scope.ownerPubKey,amount:r?T:i}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!1,checkCreateATAOwner:f});S.addInstruction(R||{}),!B&&!L&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",p.tokenAccounts);let D=await p.getCreatedTokenAccount({mint:new j(t.lpMint.address)}),Pe=await p.handleTokenAccount({side:"out",amount:0,mint:new j(t.lpMint.address),tokenAccount:D,bypassAssociatedCheck:b,checkCreateATAOwner:f}),{tokenAccount:_}=Pe,W=De(Pe,["tokenAccount"]);S.addInstruction(W);let Y=n!=null?n:await this.getCpmmPoolKeys(t.id),se=new ot(new Qe(1)).sub(s);return S.addInstruction({instructions:[hl(new j(t.programId),this.scope.ownerPubKey,new j(Y.authority),new j(t.id),_,B,L,new j(Y.vault.A),new j(Y.vault.B),x,K,new j(t.lpMint.address),a?a==null?void 0:a.liquidity:se.mul(g).quotient,r?P.amount:T,r?T:P.amount)],instructionTypes:[X.CpmmAddLiquidity],lookupTableAddress:Y.lookupTableAccount?[Y.lookupTableAccount]:[]}),S.addCustomComputeBudget(c),S.addTipInstruction(u),S.versionBuild({txVersion:m})}async withdrawLiquidity(e){var W,Y;let{poolInfo:t,poolKeys:n,lpAmount:i,slippage:r,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u,closeWsol:l=!0}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let m=new ot(new Qe(1)).sub(r),d=await this.getRpcPoolInfo(t.id),[p,b]=[m.mul(i.mul(d.baseReserve).div(d.lpAmount)).quotient,m.mul(i.mul(d.quoteReserve).div(d.lpAmount)).quotient],f=await this.scope.fetchEpochInfo(),[y,g]=[he(p,t.mintA.extensions.feeConfig,f,!1),he(b,t.mintB.extensions.feeConfig,f,!1)],{account:P}=this.scope,k=this.createTxBuilder(u),[T,I]=[new j(t.mintA.address),new j(t.mintB.address)],h=T.equals($),S=I.equals($),x,K,{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new j(t.mintA.address),notUseTokenAccount:h,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(h&&l),associatedOnly:!h,checkCreateATAOwner:!1});x=B,C&&k.addInstruction(C);let{account:L,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new j(t.mintB.address),notUseTokenAccount:S,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(S&&l),associatedOnly:!S,checkCreateATAOwner:!1});K=L,R&&k.addInstruction(R),(!x||!K)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",P.tokenAccounts);let D=await P.getCreatedTokenAccount({mint:new j(t.lpMint.address)});D||this.logAndCreateError("cannot found lp token account","tokenAccounts",P.tokenAccounts);let _=n!=null?n:await this.getCpmmPoolKeys(t.id);return k.addInstruction({instructions:[Tl(new j(t.programId),this.scope.ownerPubKey,new j(_.authority),new j(t.id),D,x,K,new j(_.vault.A),new j(_.vault.B),T,I,new j(t.lpMint.address),i,p.sub((W=y.fee)!=null?W:new Qe(0)),b.sub((Y=g.fee)!=null?Y:new Qe(0)))],instructionTypes:[X.CpmmWithdrawLiquidity],lookupTableAddress:_.lookupTableAccount?[_.lookupTableAccount]:[]}),k.addCustomComputeBudget(s),k.addTipInstruction(a),k.versionBuild({txVersion:c})}async swap(e){var C,L,R,D,_,W;let{poolInfo:t,poolKeys:n,baseIn:i,fixedOut:r,inputAmount:s,swapResult:a,slippage:c=0,config:u,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,{bypassAssociatedCheck:b,checkCreateATAOwner:f,associatedOnly:y}=v({bypassAssociatedCheck:!1,checkCreateATAOwner:!1,associatedOnly:!0},u),g=this.createTxBuilder(p),[P,k]=[new j(t.mintA.address),new j(t.mintB.address)];r?a.sourceAmountSwapped=a.sourceAmountSwapped.mul(new Qe((1+c)*1e4)).div(new Qe(1e4)):a.destinationAmountSwapped=a.destinationAmountSwapped.mul(new Qe((1-c)*1e4)).div(new Qe(1e4));let T=t.mintA.address===$.toBase58(),I=t.mintB.address===$.toBase58(),{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:P,tokenProgram:new j((C=t.mintA.programId)!=null?C:tn),owner:this.scope.ownerPubKey,createInfo:T||!i?{payer:this.scope.ownerPubKey,amount:i?a.sourceAmountSwapped:0}:void 0,notUseTokenAccount:T,skipCloseAccount:!T,associatedOnly:T?!1:y,checkCreateATAOwner:f});S&&g.addInstruction(S);let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:k,tokenProgram:new j((L=t.mintB.programId)!=null?L:tn),owner:this.scope.ownerPubKey,createInfo:I||i?{payer:this.scope.ownerPubKey,amount:i?0:a.sourceAmountSwapped}:void 0,notUseTokenAccount:I,skipCloseAccount:!I,associatedOnly:I?!1:y,checkCreateATAOwner:f});K&&g.addInstruction(K),(!h||!x)&&this.logAndCreateError("user do not have token account",{mintA:t.mintA.symbol||t.mintA.address,mintB:t.mintB.symbol||t.mintB.address,mintATokenAcc:h,mintBTokenAcc:x,mintAUseSOLBalance:T,mintBUseSOLBalance:I,associatedOnly:y});let B=n!=null?n:await this.getCpmmPoolKeys(t.id);return g.addInstruction({instructions:[r?Il(new j(t.programId),this.scope.ownerPubKey,new j(B.authority),new j(B.config.id),new j(t.id),i?h:x,i?x:h,new j(B.vault[i?"A":"B"]),new j(B.vault[i?"B":"A"]),new j((_=t[i?"mintA":"mintB"].programId)!=null?_:tn),new j((W=t[i?"mintB":"mintA"].programId)!=null?W:tn),i?P:k,i?k:P,Bo(new j(t.programId),new j(t.id)).publicKey,a.sourceAmountSwapped,a.destinationAmountSwapped):Yr(new j(t.programId),this.scope.ownerPubKey,new j(B.authority),new j(B.config.id),new j(t.id),i?h:x,i?x:h,new j(B.vault[i?"A":"B"]),new j(B.vault[i?"B":"A"]),new j((R=t[i?"mintA":"mintB"].programId)!=null?R:tn),new j((D=t[i?"mintB":"mintA"].programId)!=null?D:tn),i?P:k,i?k:P,Bo(new j(t.programId),new j(t.id)).publicKey,s,a.destinationAmountSwapped)],instructionTypes:[r?X.CpmmSwapBaseOut:X.ClmmSwapBaseIn]}),g.addCustomComputeBudget(l),g.addTipInstruction(m),g.versionBuild({txVersion:d})}async lockLp(e){var d,p,b,f,y;let{poolInfo:t,lpAmount:n,computeBudgetConfig:i,txTipConfig:r,txVersion:s,feePayer:a,feeNftOwner:c}=e;n.isZero()&&this.logAndCreateError("lpAmount must greater than zero",{lpAmount:n.toString()});let u=this.createTxBuilder(a),l=(d=e.poolKeys)!=null?d:await this.getCpmmPoolKeys(t.id),m=await Bl({poolInfo:t,poolKeys:l,ownerInfo:{wallet:this.scope.ownerPubKey,feePayer:(p=e.feePayer)!=null?p:this.scope.ownerPubKey},feeNftOwner:c!=null?c:this.scope.ownerPubKey,lockProgram:(b=e.programId)!=null?b:Ui,lockAuthProgram:(f=e.authProgram)!=null?f:Gi,lpAmount:n,withMetadata:(y=e.withMetadata)!=null?y:!0,getEphemeralSigners:e.getEphemeralSigners});return u.addInstruction(m),u.addCustomComputeBudget(i),u.addTipInstruction(r),u.versionBuild({txVersion:s,extInfo:m.address})}async harvestLockLp(e){var L;let{poolInfo:t,lpFeeAmount:n,nftMint:i,programId:r=Ui,authProgram:s=Gi,cpmmProgram:a,computeBudgetConfig:c,txTipConfig:u,txVersion:l,closeWsol:m=!0}=e;n.isZero()&&this.logAndCreateError("lpFeeAmount must greater than zero",{lpAmount:n.toString()});let d=e.feePayer||this.scope.ownerPubKey,p=this.createTxBuilder(d),[b,f]=[new j(t.mintA.address),new j(t.mintB.address)],y=b.equals($),g=f.equals($),P,k,{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new j(t.mintA.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(y&&m),associatedOnly:!y,checkCreateATAOwner:!1});P=T,I&&p.addInstruction(I);let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new j(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(g&&m),associatedOnly:!g,checkCreateATAOwner:!1});k=h,S&&p.addInstruction(S),(!P||!k)&&this.logAndCreateError("cannot found target token accounts",{tokenAccountA:P,tokenAccountB:k});let x=(L=e.poolKeys)!=null?L:await this.getCpmmPoolKeys(t.id),{publicKey:K}=J(d,i,tn),{publicKey:B}=Hr(r,i),{publicKey:C}=J(s,new j(t.lpMint.address),tn);return p.addInstruction({instructions:[xl({programId:r!=null?r:Ui,nftOwner:this.scope.ownerPubKey,auth:s!=null?s:Gi,nftMint:i,nftAccount:K,lockPda:B,poolId:new j(t.id),mintLp:new j(x.mintLp.address),userVaultA:P,userVaultB:k,poolVaultA:new j(x.vault.A),poolVaultB:new j(x.vault.B),mintA:b,mintB:f,lockLpVault:C,lpFeeAmount:n,cpmmProgram:a==null?void 0:a.programId,cpmmAuthProgram:a==null?void 0:a.authProgram})],instructionTypes:[X.CpmmCollectLockFee]}),p.addCustomComputeBudget(c),p.addTipInstruction(u),p.versionBuild({txVersion:l})}computeSwapAmount({pool:e,amountIn:t,outputMint:n,slippage:i}){let r=n.toString()===e.mintB.address,s=jr.swap(t,r?e.baseReserve:e.quoteReserve,r?e.quoteReserve:e.baseReserve,e.configInfo.tradeFeeRate),a=new O(s.destinationAmountSwapped.toString()).div(s.sourceAmountSwapped.toString()),c=s.destinationAmountSwapped.mul(new Qe((1-i)*1e4)).div(new Qe(1e4));return{allTrade:s.sourceAmountSwapped.eq(t),amountIn:t,amountOut:s.destinationAmountSwapped,minAmountOut:c,executionPrice:a,fee:s.tradeFee,priceImpact:e.poolPrice.sub(a).div(e.poolPrice)}}computePairAmount({poolInfo:e,baseReserve:t,quoteReserve:n,amount:i,slippage:r,epochInfo:s,baseIn:a}){var T,I,h,S,x,K,B,C,L;let c=1-Number(r.toSignificant())/100,u=new Qe(new O(i).mul(10**e[a?"mintA":"mintB"].decimals).mul(c).toFixed(0)),l=he(u,e[a?"mintA":"mintB"].extensions.feeConfig,s,!1),m=u.sub((T=l.fee)!=null?T:new Qe(0)),d=new Qe(new O(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,O.ROUND_DOWN));this.logDebug("baseReserve:",t.toString(),"quoteReserve:",n.toString()),this.logDebug("tokenIn:",a?e.mintA.symbol:e.mintB.symbol,"amountIn:",u.toString(),"amountInFee:",(h=(I=l.fee)==null?void 0:I.toString())!=null?h:0,"anotherToken:",a?e.mintB.symbol:e.mintA.symbol,"slippage:",`${r.toSignificant()}%`);let p=a?"base":"quote";this.logDebug("input side:",p);let b=m.mul(d).div(p==="base"?t:n),f={amount:Bt,fee:void 0,expirationTime:void 0};if(!m.isZero()){let R=Yf(b,t,n,d);this.logDebug("lpAmountData:",{amountA:R.amountA.toString(),amountB:R.amountB.toString()}),f=he(R[a?"amountB":"amountA"],e[a?"mintB":"mintA"].extensions.feeConfig,s,!0)}let y=new ot(new Qe(1)).add(r),g=new ot(new Qe(1)).sub(r),P=he(y.mul(f.amount.sub((S=f.fee)!=null?S:new Qe(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0),k=he(g.mul(f.amount.sub((x=f.fee)!=null?x:new Qe(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0);return this.logDebug("anotherAmount:",f.amount.toString(),"anotherAmountFee:",(B=(K=f.fee)==null?void 0:K.toString())!=null?B:0,"maxAnotherAmount:",P.amount.toString(),"maxAnotherAmountFee:",(L=(C=P.fee)==null?void 0:C.toString())!=null?L:0),{inputAmountFee:l,anotherAmount:f,maxAnotherAmount:P,minAnotherAmount:k,liquidity:b}}};function Yf(o,e,t,n){let i=o.mul(e).div(n);!i.isZero()&&!o.mul(e).mod(n).isZero()&&(i=i.add(new Qe(1)));let r=o.mul(t).div(n);return!r.isZero()&&!o.mul(t).mod(n).isZero()&&(r=r.add(new Qe(1))),{amountA:i,amountB:r}}import{PublicKey as oi}from"@solana/web3.js";import{createTransferInstruction as Ol,TOKEN_PROGRAM_ID as ze,TOKEN_2022_PROGRAM_ID as ts}from"@solana/spl-token";import ns from"bn.js";var Kl={[cr.toBase58()]:3},Cl={3:cr};var qa=E([Te(5),Te(8),N("ownAddress"),w("vaultSignerNonce"),N("baseMint"),N("quoteMint"),N("baseVault"),w("baseDepositsTotal"),w("baseFeesAccrued"),N("quoteVault"),w("quoteDepositsTotal"),w("quoteFeesAccrued"),w("quoteDustThreshold"),N("requestQueue"),N("eventQueue"),N("bids"),N("asks"),w("baseLotSize"),w("quoteLotSize"),w("feeRateBps"),w("referrerRebatesAccrued"),Te(7)]),Ll={3:qa};import{PublicKey as Rl}from"@solana/web3.js";var Jr=fe("Serum"),es=class{static getProgramId(e){let t=Cl[e];return t||Jr.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=Kl[t];return n||Jr.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=Ll[e];return t||Jr.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],i=0,r;for(;i<100;){try{let s=n.concat(Buffer.from([i]),Buffer.alloc(7));r=Rl.createProgramAddressSync(s,e)}catch(s){if(s instanceof TypeError)throw s;i++;continue}return{publicKey:r,nonce:i}}return Jr.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:Rl.default,nonce:i}}};import{PublicKey as M,SystemProgram as Ko,TransactionInstruction as Co}from"@solana/web3.js";import ln from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Ua,TOKEN_2022_PROGRAM_ID as Ga,TOKEN_PROGRAM_ID as qn}from"@solana/spl-token";function OK(o,e,t,n,i,r,s,a,c,u,l,m){let d=E([q("instruction"),w("amountIn"),w("amountOut")]),p=[{pubkey:Ko.programId,isSigner:!1,isWritable:!1},{pubkey:qn,isSigner:!1,isWritable:!1},{pubkey:new M(t.programId),isSigner:!1,isWritable:!1},{pubkey:new M(t.id),isSigner:!1,isWritable:!0},{pubkey:new M(n.id),isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let f=Oe(t);p.push({pubkey:f.config.id,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(c)?f.vault.A:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(c)?f.vault.B:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},...m.map(y=>({pubkey:y,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let f=Oe(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:new M("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0})}else{let f=Oe(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},...f.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:f.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:f.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0}])}let b=Buffer.alloc(d.span);return d.encode({instruction:4,amountIn:u,amountOut:l},b),new Co({keys:p,programId:o,data:b})}function MK(o,e,t,n,i,r,s,a,c,u){let l=E([q("instruction")]),m=[{pubkey:Ko.programId,isSigner:!1,isWritable:!1},{pubkey:qn,isSigner:!1,isWritable:!1},{pubkey:new M(String(n.programId)),isSigner:!1,isWritable:!1},{pubkey:new M(String(n.id)),isSigner:!1,isWritable:!0},{pubkey:new M(String(t.id)),isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let p=Oe(n);m.push({pubkey:p.config.id,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(c)?p.vault.A:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(c)?p.vault.B:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},...u.map(b=>({pubkey:b,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let p=Oe(n);m.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:new M("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0})}else{let p=Oe(n);m.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},...p.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:p.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:p.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0}])}let d=Buffer.alloc(l.span);return l.encode({instruction:5},d),new Co({keys:m,programId:o,data:d})}function Zf(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b){var h;let f=[],y=[A({pubkey:qn,isWritable:!1}),A({pubkey:Ga,isWritable:!1}),A({pubkey:Ua,isWritable:!1}),A({pubkey:Ko.programId,isWritable:!1}),A({pubkey:e,isSigner:!0})];y.push(A({pubkey:t})),y.push(A({pubkey:i}));let g=[c,u],P=[l,m],k=[r,s,a];for(let S=0;S<g.length;S++){let x=g[S],K=k[S]===x.mintA.address;if(y.push(A({pubkey:new M(x.programId),isWritable:!1})),S===g.length-1?y.push(A({pubkey:i})):y.push(A({pubkey:n})),y.push(A({pubkey:new M(k[S])})),y.push(A({pubkey:new M(k[S+1])})),x.version===6){let B=P[S];y.push(A({pubkey:new M(B.config.id)})),y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(K?B.vault.A:B.vault.B)})),y.push(A({pubkey:new M(K?B.vault.B:B.vault.A)})),y.push(A({pubkey:new M(x.observationId)})),y.push(A({pubkey:an})),y.push(A({pubkey:Xe(new M(x.programId),new M(x.id)).publicKey})),f.push(Xa(x.sqrtPriceX64.toString(),K));for(let C of(h=b[S])!=null?h:[])y.push(A({pubkey:new M(C)}))}else if(x.version===5){let B=P[S];y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(B.authority),isWritable:!1})),y.push(A({pubkey:new M(B.marketProgramId)})),y.push(A({pubkey:new M(B.marketAuthority)})),y.push(A({pubkey:lr,isWritable:!1})),y.push(A({pubkey:new M(B.openOrders)})),y.push(A({pubkey:new M(B.vault.A)})),y.push(A({pubkey:new M(B.vault.B)})),y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(B.marketId)})),y.push(A({pubkey:new M(B.marketBids)})),y.push(A({pubkey:new M(B.marketAsks)})),y.push(A({pubkey:new M(B.marketEventQueue)})),y.push(A({pubkey:new M(B.marketBaseVault)})),y.push(A({pubkey:new M(B.marketQuoteVault)}))}else if(x.version===4){let B=P[S],C=x.status!==1;y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(B.authority),isWritable:!1})),y.push(A({pubkey:new M(C?B.id:B.marketProgramId)})),y.push(A({pubkey:new M(C?B.id:B.marketAuthority)})),y.push(A({pubkey:new M(C?B.id:B.openOrders)})),y.push(A({pubkey:new M(B.vault.A)})),y.push(A({pubkey:new M(B.vault.B)})),y.push(A({pubkey:new M(C?B.id:B.marketId)})),y.push(A({pubkey:new M(C?B.id:B.marketBids)})),y.push(A({pubkey:new M(C?B.id:B.marketAsks)})),y.push(A({pubkey:new M(C?B.id:B.marketEventQueue)})),y.push(A({pubkey:new M(C?B.id:B.marketBaseVault)})),y.push(A({pubkey:new M(C?B.id:B.marketQuoteVault)}))}else if(x.version===7){let B=P[S];y.push(A({pubkey:new M(B.authority)})),y.push(A({pubkey:new M(B.config.id)})),y.push(A({pubkey:new M(B.id)})),y.push(A({pubkey:new M(K?B.vault.A:B.vault.B)})),y.push(A({pubkey:new M(K?B.vault.B:B.vault.A)})),y.push(A({pubkey:new M(x.observationId)}))}else throw Error("pool type error")}let T=E([q("insId"),w("amountIn"),w("amountOut"),z(te(),f.length,"clmmPriceLimit")]),I=Buffer.alloc(T.span);return T.encode({insId:0,amountIn:d,amountOut:p,clmmPriceLimit:f},I),new Co({keys:y,programId:o,data:I})}function Xa(o,e){if(o)if(e){let t=new ln(o).div(new ln(25));return t.gt(Rr)?t:Rr}else{let t=new ln(o).mul(new ln(25));return t.lt(Nr)?t:Nr}else return e?Rr:Nr}function Nl({routeProgram:o,ownerInfo:e,inputMint:t,swapInfo:n}){var i,r,s,a,c,u,l;if(n.routeType==="amm")if(n.poolInfo[0].version===6){let m=n.poolKey[0],d=Oe(m),p=t.equals(d.mintA.address)?_t.add(Nt):Vt.sub(Nt);return Se.makeSwapBaseInInstructions({poolInfo:m,poolKeys:m,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:d.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:d.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub((r=(i=n.minAmountOut.fee)==null?void 0:i.raw)!=null?r:new ln(0)),sqrtPriceLimitX64:p,remainingAccounts:(s=n.remainingAccounts[0])!=null?s:[]})}else if(n.poolInfo[0].version===7){let m=n.poolInfo[0],d=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[Yr(m.programId,e.wallet,m.authority,m.configId,m.id,e.sourceToken,e.destinationToken,d?m.vaultA:m.vaultB,d?m.vaultB:m.vaultA,d?m.mintProgramA:m.mintProgramB,d?m.mintProgramB:m.mintProgramA,new M(m[d?"mintA":"mintB"].address),new M(m[d?"mintB":"mintA"].address),m.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[d?X.CpmmSwapBaseIn:X.CpmmSwapBaseOut],address:{}}}else{let m=n.poolKey[0];return{signers:[],instructions:[Fr({poolKeys:m,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub((c=(a=n.minAmountOut.fee)==null?void 0:a.raw)!=null?c:new ln(0)),fixedSide:"in"})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?X.AmmV5SwapBaseIn:X.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let m=n.poolInfo[0],d=n.poolInfo[1],p=n.poolKey[0],b=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[Zf(o,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),m,d,p,b,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub((l=(u=n.minAmountOut.fee)==null?void 0:u.raw)!=null?l:new ln(0)),n.remainingAccounts)],instructionTypes:[X.RouteSwap],lookupTableAddress:[p.lookupTableAccount,b.lookupTableAccount].filter(f=>f!==void 0),address:{}}}else throw Error("route type error")}function vK({programId:o,wallet:e,amount:t,inputAccount:n,outputAccount:i,routeInfo:r,poolKeys:s}){var d;if(r.success===!1)throw Error("route info error");let a=[],c=[A({pubkey:qn,isWritable:!1}),A({pubkey:Ga,isWritable:!1}),A({pubkey:Ua,isWritable:!1}),A({pubkey:Ko.programId,isWritable:!1}),A({pubkey:e,isSigner:!0})],u={[r.data.inputMint]:n,[r.data.outputMint]:i};c.push(A({pubkey:u[r.data.inputMint]})),c.push(A({pubkey:u[r.data.outputMint]}));for(let p=0;p<s.length;p++){let b=r.data.routePlan[p],f=s[p],y=b.inputMint===f.mintA.address;if(c.push(A({pubkey:new M(f.programId),isWritable:!1})),p===s.length-1)c.push(A({pubkey:u[b.outputMint]}));else{let g=b.outputMint;if(u[g]===void 0){let P=J(e,new M(g),f.programId===At.CLMM_PROGRAM_ID.toBase58()||f.programId===At.CREATE_CPMM_POOL_PROGRAM.toBase58()?new M(y?f.mintB.programId:f.mintA.programId):qn).publicKey;u[g]=P}c.push(A({pubkey:u[g]}))}if(c.push(A({pubkey:new M(b.inputMint)})),c.push(A({pubkey:new M(b.outputMint)})),f.programId===At.CLMM_PROGRAM_ID.toBase58()){let g=f;c.push(A({pubkey:new M(g.config.id)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(y?g.vault.A:g.vault.B)})),c.push(A({pubkey:new M(y?g.vault.B:g.vault.A)})),c.push(A({pubkey:new M(g.observationId)})),c.push(A({pubkey:an,isWritable:!1})),c.push(A({pubkey:new M(g.exBitmapAccount)})),a.push(Xa(b.lastPoolPriceX64,y));for(let P of(d=b.remainingAccounts)!=null?d:[])c.push(A({pubkey:new M(P)}))}else if(f.programId===At.AMM_STABLE.toBase58()){let g=f;c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.authority),isWritable:!1})),c.push(A({pubkey:new M(g.marketProgramId),isWritable:!1})),c.push(A({pubkey:new M(g.marketAuthority),isWritable:!1})),c.push(A({pubkey:lr,isWritable:!1})),c.push(A({pubkey:new M(g.openOrders)})),c.push(A({pubkey:new M(g.vault.A)})),c.push(A({pubkey:new M(g.vault.B)})),c.push(A({pubkey:new M(g.marketId)})),c.push(A({pubkey:new M(g.marketBids)})),c.push(A({pubkey:new M(g.marketAsks)})),c.push(A({pubkey:new M(g.marketEventQueue)})),c.push(A({pubkey:new M(g.marketBaseVault)})),c.push(A({pubkey:new M(g.marketQuoteVault)}))}else if(f.programId===At.AMM_V4.toBase58()){let g=f;c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.authority),isWritable:!1})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.vault.A)})),c.push(A({pubkey:new M(g.vault.B)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(g.id)}))}else if(f.programId===At.CREATE_CPMM_POOL_PROGRAM.toBase58()){let g=f;c.push(A({pubkey:new M(g.authority)})),c.push(A({pubkey:new M(g.config.id)})),c.push(A({pubkey:new M(g.id)})),c.push(A({pubkey:new M(y?g.vault.A:g.vault.B)})),c.push(A({pubkey:new M(y?g.vault.B:g.vault.A)})),c.push(A({pubkey:new M(g.observationId)}))}else throw Error("pool type error")}let l=E([q("insId"),w("amountIn"),w("amountOut"),z(te(),a.length,"clmmPriceLimit")]),m=Buffer.alloc(l.span);return l.encode({insId:0,amountIn:t,amountOut:new ln(r.data.otherAmountThreshold),clmmPriceLimit:a},m),new Co({keys:c,programId:o,data:m})}function EK({programId:o,wallet:e,inputAccount:t,outputAccount:n,routeInfo:i,poolKeys:r}){var m;if(i.success===!1)throw Error("route info error");let s=[],a=[A({pubkey:qn,isWritable:!1}),A({pubkey:Ga,isWritable:!1}),A({pubkey:Ua,isWritable:!1}),A({pubkey:Ko.programId,isWritable:!1}),A({pubkey:e,isSigner:!0})],c={[i.data.inputMint]:t,[i.data.outputMint]:n};for(let d=r.length-1;d>=0;d--){let p=i.data.routePlan[d],b=r[d],f=p.inputMint===b.mintA.address;if(a.push(A({pubkey:new M(b.programId)})),d===0)a.push(A({pubkey:c[p.inputMint]}));else{let y=p.inputMint;if(c[y]===void 0){let g=J(e,new M(y),b.programId===At.CLMM_PROGRAM_ID.toBase58()||b.programId===At.CREATE_CPMM_POOL_PROGRAM.toBase58()?new M(f?b.mintA.programId:b.mintB.programId):qn).publicKey;c[y]=g}a.push(A({pubkey:c[y]}))}if(d===r.length-1)a.push(A({pubkey:c[p.outputMint]}));else{let y=p.outputMint;if(c[y]===void 0){let g=J(e,new M(y),b.programId===At.CLMM_PROGRAM_ID.toBase58()||b.programId===At.CREATE_CPMM_POOL_PROGRAM.toBase58()?new M(f?b.mintB.programId:b.mintA.programId):qn).publicKey;c[y]=g}a.push(A({pubkey:c[y]}))}if(a.push(A({pubkey:new M(p.inputMint)})),a.push(A({pubkey:new M(p.outputMint)})),b.programId===At.CLMM_PROGRAM_ID.toBase58()){let y=b;a.push(A({pubkey:new M(y.config.id)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(f?y.vault.A:y.vault.B)})),a.push(A({pubkey:new M(f?y.vault.B:y.vault.A)})),a.push(A({pubkey:new M(y.observationId)})),a.push(A({pubkey:an,isWritable:!1})),a.push(A({pubkey:new M(y.exBitmapAccount)})),s.push(Xa(p.lastPoolPriceX64,f));for(let g of(m=p.remainingAccounts)!=null?m:[])a.push(A({pubkey:new M(g)}))}else if(b.programId===At.AMM_STABLE.toBase58()){let y=b;a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.authority),isWritable:!1})),a.push(A({pubkey:new M(y.marketProgramId),isWritable:!1})),a.push(A({pubkey:new M(y.marketAuthority),isWritable:!1})),a.push(A({pubkey:lr,isWritable:!1})),a.push(A({pubkey:new M(y.openOrders)})),a.push(A({pubkey:new M(y.vault.A)})),a.push(A({pubkey:new M(y.vault.B)})),a.push(A({pubkey:new M(y.marketId)})),a.push(A({pubkey:new M(y.marketBids)})),a.push(A({pubkey:new M(y.marketAsks)})),a.push(A({pubkey:new M(y.marketEventQueue)})),a.push(A({pubkey:new M(y.marketBaseVault)})),a.push(A({pubkey:new M(y.marketQuoteVault)}))}else if(b.programId===At.AMM_V4.toBase58()){let y=b;a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.authority),isWritable:!1})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.vault.A)})),a.push(A({pubkey:new M(y.vault.B)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(y.id)}))}else if(b.programId===At.CREATE_CPMM_POOL_PROGRAM.toBase58()){let y=b;a.push(A({pubkey:new M(y.authority)})),a.push(A({pubkey:new M(y.config.id)})),a.push(A({pubkey:new M(y.id)})),a.push(A({pubkey:new M(f?y.vault.A:y.vault.B)})),a.push(A({pubkey:new M(f?y.vault.B:y.vault.A)})),a.push(A({pubkey:new M(y.observationId)}))}else throw Error("pool type error")}let u=E([q("insId"),w("amountIn"),w("amountOut"),z(te(),s.length,"clmmPriceLimit")]),l=Buffer.alloc(u.span);return u.encode({insId:1,amountIn:new ln(i.data.otherAmountThreshold),amountOut:new ln(i.data.outputAmount),clmmPriceLimit:s},l),new Co({keys:a,programId:o,data:l})}var Bn=new ns(0),Lo=class extends Me{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals($));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:i=1,feePayer:r}=e,s=await this.getWSolAccounts(),a=this.createTxBuilder(r);a.addCustomComputeBudget(e.computeBudgetConfig);let c=ee(t);for(let u=0;u<s.length;u++)c.gte(s[u].amount)?(a.addInstruction({instructions:[Pn({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),c.sub(s[u].amount)):a.addInstruction({instructions:[Pn({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]});return a.versionBuild({txVersion:i})}async wrapWSol(e,t,n,i){let r=this.createTxBuilder(i),s=await vn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return r.addInstruction(s),r.versionBuild({txVersion:n!=null?n:1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:i,routeProgram:r,txVersion:s,feePayer:a}){let c=this.createTxBuilder(a),u=e.amountIn,l=e.amountOut,m=u.amount.token.mint.equals($),d=l.amount.token.mint.equals($),p=u.amount.token.mint,b=l.amount.token.mint,{account:f,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.amount.token.isToken2022?ts:ze,mint:p,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!m,createInfo:m?{payer:this.scope.ownerPubKey,amount:u.amount.raw}:void 0,associatedOnly:m?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(y&&c.addInstruction(y),f===void 0)throw Error("input account check error");let g;if(e.routeType==="route"&&!d)g=this.scope.account.getAssociatedTokenAccount(b,l.amount.token.isToken2022?ts:ze);else{let{account:I,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:l.amount.token.isToken2022?ts:ze,mint:b,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});g=I,h&&c.addInstruction(h)}d&&c.addInstruction({endInstructions:[Pn({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:g,programId:ze})],endInstructionTypes:[X.CloseAccount]});let P;if(e.routeType==="route"){let I=e.middleToken;P=this.scope.account.getAssociatedTokenAccount(I.mint,I.isToken2022?ts:ze)}let k=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),T=Nl({routeProgram:r,inputMint:p,swapInfo:U(v({},e),{poolInfo:[...e.poolInfoList],poolKey:k,outputMint:b}),ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:f,routeToken:P,destinationToken:g}});if(e.feeConfig!==void 0){let I=this.createTxBuilder();I.addInstruction({instructions:[Ol(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[X.TransferAmount]}),I.addInstruction(T);let{transactions:h}=s===0?await I.sizeCheckBuildV0():await I.sizeCheckBuild();h.length<2&&c.addInstruction({instructions:[Ol(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[X.TransferAmount]})}return c.addInstruction(T),s===0?c.sizeCheckBuildV0({computeBudgetConfig:i,address:T.address}):c.sizeCheckBuild({computeBudgetConfig:i,address:T.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=Di,clmm:n=Rn,cpmm:i=qi}=e||{},r=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:Zn.offsetOf("baseMint"),length:64}}),s=E([N("baseMint"),N("quoteMint")]),a=r.map(p=>({id:p.pubkey,version:4,mintA:s.decode(p.account.data).baseMint,mintB:s.decode(p.account.data).quoteMint})),c=E([N("mintA"),N("mintB")]),l=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:Hn.span}],dataSlice:{offset:Hn.offsetOf("mintA"),length:64}})).map(p=>{let b=c.decode(p.account.data);return{id:p.pubkey,version:6,mintA:b.mintA,mintB:b.mintB}}),d=(await this.scope.connection.getProgramAccounts(i,{dataSlice:{offset:Zr.offsetOf("mintA"),length:64}})).map(p=>{let b=c.decode(p.account.data);return{id:p.pubkey,version:7,mintA:b.mintA,mintB:b.mintB}});return{clmmPools:l,ammPools:a,cpmmPools:d}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:i,cpmmPools:r}){e=e.toString()===oi.default.toString()?$:e,t=t.toString()===oi.default.toString()?$:t;let s={},a={},c={},u=[],l={};for(let d of n!=null?n:[]){if((d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),a[d.id.toString()]=d),d.mintA.equals(e)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintB.equals(e)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintA.equals(t)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[p].out.push(d)}if(d.mintB.equals(t)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[p].out.push(d)}}let m=[];for(let d of i)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),s[d.id.toBase58()]=d,m.push(d)),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of r)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),c[d.id.toBase58()]=d),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of Object.keys(l)){if(l[d].in.length===1&&l[d].out.length===1&&l[d].in[0].id.equals(l[d].out[0].id)){delete l[d];continue}if(l[d].in.length===0||l[d].out.length===0){delete l[d];continue}let p=l[d];for(let b of p.in)for(let f of p.out)b.version===6&&a[b.id.toString()]===void 0?a[b.id.toString()]=b:b.version===7&&c[b.id.toString()]===void 0?c[b.id.toString()]=b:(b.version===4||b.version===5)&&s[b.id.toString()]===void 0&&(s[b.id.toString()]=b),f.version===6&&a[f.id.toString()]===void 0?a[f.id.toString()]=f:f.version===7&&c[f.id.toString()]===void 0?c[f.id.toString()]=f:(f.version===4||f.version===5)&&s[f.id.toString()]===void 0&&(s[f.id.toString()]=f)}return{directPath:u,addLiquidityPools:m,routePathDict:l,needSimulate:Object.values(s),needTickArray:Object.values(a),cpmmPoolList:Object.values(c)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let i=new Set([...e.needTickArray.map(f=>[f.mintA.toBase58(),f.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let r=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(f=>f.id)),s=Wr(r),a={};Object.values(s).forEach(f=>{i.delete(f.mintA.address),a[f.mintA.address]={address:new oi(f.mintA.address),programId:ze,mintAuthority:null,supply:BigInt(0),decimals:f.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},i.delete(f.mintB.address),a[f.mintB.address]={address:new oi(f.mintB.address),programId:ze,mintAuthority:null,supply:BigInt(0),decimals:f.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let c=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(f=>f.id.toBase58()),!0);Object.values(c).forEach(f=>{let[y,g]=[f.mintA.toBase58(),f.mintB.toBase58()];f.mintProgramA.equals(ze)?(i.delete(y),a[y]={address:f.mintA,programId:f.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(y),f.mintProgramB.equals(ze)?(i.delete(g),a[g]={address:f.mintB,programId:f.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(g)}),console.log("fetching mints info, total: ",i.size);let u=await ui({connection:this.scope.connection,mints:Array.from(i).map(f=>new oi(f))});a=v(v({},a),u);let l=this.scope.cpmm.toComputePoolInfos({pools:c,mintInfos:a});console.log("fetching clmm pools info, total:",e.needTickArray.length);let m=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(f=>f.id)}),{computeClmmPoolInfo:d,computePoolTickData:p}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:m,mintInfos:a}),b=Object.keys(e.routePathDict).reduce((f,y)=>U(v({},f),{[y]:U(v({},e.routePathDict[y]),{mintProgram:a[y].programId,mDecimals:a[y].decimals,in:e.routePathDict[y].in.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()]),out:e.routePathDict[y].out.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()])})}),{});return{mintInfos:a,ammPoolsRpcInfo:r,ammSimulateCache:s,clmmPoolsRpcInfo:m,computeClmmPoolInfo:d,computePoolTickData:p,computeCpmmData:l,routePathDict:b}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:i,simulateCache:r,tickCache:s,slippage:a,chainTime:c,epochInfo:u,feeConfig:l}){var g,P,k,T,I,h,S,x,K;let m=l===void 0?new ns(0):e.raw.mul(new ns(l.feeBps.toNumber())).div(new ns(1e4)),d=e.raw.sub(m),p=new Ie(e.token,d),b=l===void 0?void 0:{feeAmount:m,feeAccount:l.feeAccount},f=U(v({},t),{address:mt(t.address).toString()}),y=[];for(let B of n)try{y.push(U(v({},this.computeAmountOut({itemPool:B,tickCache:s,simulateCache:r,chainTime:c,epochInfo:u,slippage:a,outputToken:f,amountIn:p})),{feeConfig:b}))}catch(C){this.logDebug("direct error",B.version,B.id.toString(),C.message)}this.logDebug("direct done");for(let[B,C]of Object.entries(i)){let L={chainId:101,address:B,programId:C.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:C.mDecimals,tags:[],extensions:{}},R=C.in.map(_=>{try{return{pool:_,data:this.computeAmountOut({itemPool:_,tickCache:s,simulateCache:r,chainTime:c,epochInfo:u,slippage:a,outputToken:L,amountIn:p})}}catch(W){this.logDebug("route in error",_.version,_.id.toString(),W.message);return}}).sort((_,W)=>{var Pe,ce,de,Ke;let Y=_===void 0?Bn:_.data.amountOut.amount.raw.sub((ce=(Pe=_.data.amountOut.fee)==null?void 0:Pe.raw)!=null?ce:Bn),se=W===void 0?Bn:W.data.amountOut.amount.raw.sub((Ke=(de=W.data.amountOut.fee)==null?void 0:de.raw)!=null?Ke:Bn);return Y.lt(se)?1:-1})[0];if(R===void 0)continue;let D=new Ie(_r(L),R.data.amountOut.amount.raw.sub((P=(g=R.data.amountOut.fee)==null?void 0:g.raw)!=null?P:Bn));for(let _ of C.out)try{let W=this.computeAmountOut({itemPool:_,tickCache:s,simulateCache:r,chainTime:c,epochInfo:u,slippage:a,outputToken:f,amountIn:D});y.push(U(v({},W),{allTrade:!!(R.data.allTrade&&W.allTrade),amountIn:R.data.amountIn,amountOut:W.amountOut,minAmountOut:W.minAmountOut,currentPrice:void 0,executionPrice:new O(new It({baseToken:R.data.amountIn.amount.token,denominator:R.data.amountIn.amount.raw,quoteToken:W.amountOut.amount.token,numerator:W.amountOut.amount.raw.sub((T=(k=W.amountOut.fee)==null?void 0:k.raw)!=null?T:Bn)}).toFixed()),priceImpact:new O(R.data.priceImpact.add(W.priceImpact).toFixed()),fee:[R.data.fee[0],W.fee[0]],routeType:"route",poolInfoList:[R.pool,_],remainingAccounts:[R.data.remainingAccounts[0],W.remainingAccounts[0]],minMiddleAmountFee:(I=W.amountOut.fee)!=null&&I.raw?new Ie(R.data.amountOut.amount.token,((S=(h=R.data.amountOut.fee)==null?void 0:h.raw)!=null?S:Bn).add((K=(x=W.amountOut.fee)==null?void 0:x.raw)!=null?K:Bn)):void 0,middleToken:R.data.amountOut.amount.token,poolReady:R.data.poolReady&&W.poolReady,poolType:[R.data.poolType,W.poolType],feeConfig:b,expirationTime:jt(R.data.expirationTime,W.expirationTime)}))}catch(W){this.logDebug("route out error",_.version,_.id.toString(),W.message)}}return y.filter(B=>(B.allTrade||this.logDebug(`pool ${B.poolInfoList.map(C=>C.id.toString()).join(",")} filter out since not all trade`),B.allTrade)).sort((B,C)=>B.amountOut.amount.raw.sub(C.amountOut.amount.raw).gt(Bn)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:i,epochInfo:r,slippage:s,outputToken:a,amountIn:c}){if(e.version===6){let{allTrade:u,realAmountIn:l,amountOut:m,minAmountOut:d,expirationTime:p,currentPrice:b,executionPrice:f,priceImpact:y,fee:g,remainingAccounts:P,executionPriceX64:k}=Re.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:c.raw,tokenOut:a,slippage:s,epochInfo:r,catchLiquidityInsufficient:!0});return{allTrade:u,amountIn:l,amountOut:m,minAmountOut:d,currentPrice:new O(b.toFixed()),executionPrice:new O(f.toFixed()),priceImpact:new O(y.toFixed()),fee:[g],remainingAccounts:[P],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<i,poolType:"CLMM",slippage:s,clmmExPriceX64:[k],expirationTime:jt(l.expirationTime,p)}}else if(e.version===7){let{allTrade:u,executionPrice:l,amountOut:m,minAmountOut:d,priceImpact:p,fee:b}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:a.address,amountIn:c.raw,slippage:s});return{allTrade:u,amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:yo(U(v({},a),{amount:m})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:yo(U(v({},a),{amount:d})),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:l,priceImpact:p,fee:[new Ie(c.token,b)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<i,poolType:"CPMM",slippage:s,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:u,minAmountOut:l,currentPrice:m,executionPrice:d,priceImpact:p,fee:b}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:c.raw,mintIn:c.token.mint,mintOut:a.address,slippage:s});return{amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:yo(U(v({},a),{amount:u})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:yo(U(v({},a),{amount:l})),fee:void 0,expirationTime:void 0},currentPrice:m,executionPrice:d,priceImpact:p,fee:[new Ie(c.token,b)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<i,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:s,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let i=new Set(e.filter(u=>u.version===6&&!t[u.id.toString()]).map(u=>u.id.toString()));if(i.size>0){let u=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(i)});Object.keys(u).forEach(l=>{t[l]=u[l]})}let r=new Set(e.filter(u=>u.version===4&&!n[u.id.toString()]).map(u=>u.id.toString()));if(r.size>0){let u=await this.scope.liquidity.getRpcPoolInfos(Array.from(r));Object.keys(u).forEach(l=>{n[l]=u[l]})}let s=new Set(e.filter(u=>u.version===4).map(u=>u.marketId)),a={};s.size>0&&(await Ne(this.scope.connection,Array.from(s).map(l=>({pubkey:new oi(l)})))).forEach(l=>{if(!l.accountInfo)return;let m=qa.decode(l.accountInfo.data);a[l.pubkey.toBase58()]={marketId:l.pubkey.toString(),marketProgramId:l.accountInfo.owner.toString(),marketAuthority:es.getAssociatedAuthority({programId:l.accountInfo.owner,marketId:l.pubkey}).publicKey.toString(),marketBaseVault:m.baseVault.toString(),marketQuoteVault:m.quoteVault.toString(),marketBids:m.bids.toString(),marketAsks:m.asks.toString(),marketEventQueue:m.eventQueue.toString()}});let c=[];return e.forEach(u=>{if(u.version===6){let l=t[u.id.toString()],m={programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.startTime),vault:{A:l.vaultA.toBase58(),B:l.vaultB.toBase58()},config:U(v({},u.ammConfig),{id:u.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}),rewardInfos:[],observationId:u.observationId.toBase58(),exBitmapAccount:u.exBitmapAccount.toBase58()};c.push(m)}else if(u.version===4){let l=n[u.id.toString()],m=v({programId:u.programId,id:u.id,mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),vault:{A:l.baseVault.toBase58(),B:l.quoteVault.toBase58()},authority:Ea({programId:new oi(u.programId)}).publicKey.toString(),openOrders:l.openOrders.toBase58(),targetOrders:l.targetOrders.toBase58(),mintLp:u.lpMint},a[u.marketId]);c.push(m)}else u.version===7&&c.push({observationId:u.observationId.toBase58(),programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),authority:Si(u.programId).publicKey.toBase58(),vault:{A:u.vaultA.toBase58(),B:u.vaultB.toBase58()},mintLp:bt({address:u.mintLp.toBase58(),programId:ze.toBase58(),decimals:u.lpDecimals}),config:U(v({id:u.configId.toBase58()},u.configInfo),{protocolFeeRate:u.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:u.configInfo.tradeFeeRate.toNumber(),fundFeeRate:u.configInfo.fundFeeRate.toNumber(),createPoolFee:u.configInfo.createPoolFee.toString()})})}),c}};import{PublicKey as $f,Transaction as Qa,TransactionInstruction as Jf}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as eb}from"@solana/spl-token";import Ml from"bn.js";var yt=class extends Me{static getPdaPoolId(e,t){return ie([yt.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,i){return ie([yt.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new Ml(i).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:i,chainTime:r}){if(n.length===0)return[];let s=n.map(l=>yt.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<yt.VERSION_PROJECT.length;l++)a.push(...s.map(m=>yt.getPdaOwnerId(t,m,i,l).publicKey));let c=await qt(e,[...s,...a]),u=[];for(let l=0;l<c.length;l++){let m=Math.floor(l/n.length),d=l%n.length,p=s[d],b=a[l],f=c[d],y=c[n.length+l];if(!(f&&y)||f.data.length!==yt.POOL_LAYOUT.span||y.data.length!==yt.OWNER_LAYOUT.span)continue;let g=yt.POOL_LAYOUT.decode(f.data),P=yt.OWNER_LAYOUT.decode(y.data),k=g.openTime.toNumber(),T=g.endTime.toNumber(),I=P.tokenInfo.map(x=>x.debtAmount.gt(new Ml(0))).filter(x=>!x).length!==3,h=r>k&&r<T&&g.status===1,S=I&&h;u.push({programId:t,poolId:p,ammId:g.ammId,ownerAccountId:b,snapshotLpAmount:P.lpAmount,project:yt.VERSION_PROJECT[m],openTime:k,endTime:T,canClaim:S,canClaimErrorType:I?h?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((x,K)=>({mintAddress:x.mintAddress,mintVault:x.mintVault,mintDecimals:x.mintDecimals,perLpLoss:x.perLpLoss,debtAmount:P.tokenInfo[K].debtAmount.add(P.tokenInfo[K].claimedAmount)}))})}return u}async makeClaimTransaction({poolInfo:e,ownerInfo:t,feePayer:n}){t.wallet||this.scope.checkOwner();let i=this.createTxBuilder(n),r=t.wallet||this.scope.ownerPubKey,s=[];for(let u of e.tokenInfo){let{account:l,instructionParams:m}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(Ve.WSOL.mint),createInfo:{payer:r,amount:0},skipCloseAccount:!u.mintAddress.equals(Ve.WSOL.mint),associatedOnly:u.mintAddress.equals(Ve.WSOL.mint)?!1:t.associatedOnly});m&&i.addInstruction(m),s.push(l)}i.addInstruction({instructions:[yt.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:r,ownerPda:e.ownerAccountId,claimAddress:s}})]});let{transaction:a,signers:c}=i.build();return[{transaction:a,signer:c}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t,feePayer:n}){let i=this.createTxBuilder(n),r=t.wallet||this.scope.ownerPubKey,s={};for(let l of e){let m=[];for(let d of l.tokenInfo){let{account:p,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({mint:d.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:d.mintAddress.equals(Ve.WSOL.mint),createInfo:{payer:r,amount:0},skipCloseAccount:!d.mintAddress.equals(Ve.WSOL.mint),associatedOnly:d.mintAddress.equals(Ve.WSOL.mint)?!1:t.associatedOnly});b&&i.addInstruction(b),p&&(s[d.mintAddress.toString()]=p,m.push(p))}i.addInstruction({instructions:[yt.makeClaimInstruction({programId:l.programId,poolInfo:l,ownerInfo:{wallet:r,ownerPda:l.ownerAccountId,claimAddress:m}})]})}let{transaction:a,signers:c}=i.build(),u=i.allInstructions;return ar(u,[r,...c.map(l=>l.publicKey)])?[{transaction:a,signer:c}]:[{transaction:new Qa().add(...u.slice(0,i.AllTxData.instructions.length-1)),signer:c},{transaction:new Qa().add(...u.slice(i.AllTxData.instructions.length-1)),signer:[]},{transaction:new Qa().add(...i.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let i=E([]),r=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(c=>({pubkey:c,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:c})=>({pubkey:c,isSigner:!1,isWritable:!0})),{pubkey:eb,isSigner:!1,isWritable:!1}],s=Buffer.alloc(i.span);i.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new Jf({keys:r,programId:e,data:a})}},Ft=yt;Ft.CLAIMED_NUM=3,Ft.POOL_LAYOUT=E([Te(8),q("bump"),q("status"),w("openTime"),w("endTime"),N("ammId"),z(E([q("mintDecimals"),N("mintAddress"),N("mintVault"),w("perLpLoss"),w("totalClaimedAmount")]),yt.CLAIMED_NUM,"tokenInfo"),z(w(),10,"padding")]),Ft.OWNER_LAYOUT=E([Te(8),q("bump"),q("version"),N("poolId"),N("owner"),w("lpAmount"),z(E([N("mintAddress"),w("debtAmount"),w("claimedAmount")]),yt.CLAIMED_NUM,"tokenInfo"),z(w(),4,"padding")]),Ft.DEFAULT_POOL_ID=["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new $f(e)),Ft.SEED_CONFIG={pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}},Ft.VERSION_PROJECT=[void 0,"Francium","Tulip","Larix"];import{PublicKey as No}from"@solana/web3.js";import vl from"bn.js";import{SYSVAR_CLOCK_PUBKEY as tb,TransactionInstruction as ja}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ha}from"@solana/spl-token";var za=E([q("instruction"),tc("amount")]),Ro=E([q("instruction")]);function CC({programId:o,amount:e,instructionKeys:t}){let n=[{pubkey:tr,isSigner:!1,isWritable:!1},{pubkey:Ha,isSigner:!1,isWritable:!1},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:Ss,isSigner:!1,isWritable:!1},...Object.entries(t).map(([r,s])=>({pubkey:s,isSigner:r==="userOwner",isWritable:!["authority","userOwner","userIdoCheck","userStakeInfo"].includes(r)}))],i=Buffer.alloc(za.span);return za.encode({instruction:1,amount:Number(e)},i),new ja({keys:n,programId:o,data:i})}function is({programId:o},e){let t=[{pubkey:Ha,isSigner:!1,isWritable:!1},{pubkey:Ss,isSigner:!1,isWritable:!1},...Object.entries(e).map(([i,r])=>({pubkey:r,isSigner:i==="userOwner",isWritable:!["authority","userOwner"].includes(i)}))],n=Buffer.alloc(Ro.span);return Ro.encode({instruction:2},n),new ja({keys:t,programId:o,data:n})}function Ya(o){let{poolConfig:e,userKeys:t,side:n}=o,i=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,r=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(Ro.span);Ro.encode({instruction:2},s);let a=[{pubkey:Ha,isWritable:!1,isSigner:!1},{pubkey:tb,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:r,isWritable:!0,isSigner:!1},{pubkey:i,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new ja({programId:e.programId,keys:a,data:s})}var nb={[Xi.IDO_PROGRAM_ID_V1.toString()]:1,[Xi.IDO_PROGRAM_ID_V2.toString()]:2,[Xi.IDO_PROGRAM_ID_V3.toString()]:3,[Xi.IDO_PROGRAM_ID_V4.toString()]:4},Ki=class extends Me{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:i=!1,txVersion:r,feePayer:s}){let a=this.createTxBuilder(s),c=nb[t.programId];c||this.logAndCreateError("invalid version",c);let u=Oe(t),[l,m]=[!new vl(e.coin).isZero(),!new vl(e.pc).isZero()],d=u.projectInfo.mint.address.equals($),{account:p,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!d,notUseTokenAccount:d,associatedOnly:d?!1:n,checkCreateATAOwner:i});!p&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&b&&a.addInstruction(b);let f=u.buyInfo.mint.address.equals($),{account:y,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!f,notUseTokenAccount:f,associatedOnly:f?!1:n,checkCreateATAOwner:i});if(!p&&m&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),m&&g&&a.addInstruction(g),(!p||!y)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),c===3)return a.addInstruction({instructions:[...l?[is({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:p,userIdoInfo:new No(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...m?[is({programId:new No(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:y,userIdoInfo:new No(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:r});if(c<3)return!l&&!m&&this.logAndCreateError("no claimable rewards"),a.addInstruction({instructions:[is({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:y,userBaseTokenAccount:p,userIdoInfo:new No(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:r});let P={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:p,quoteTokenAccount:y,ledgerAccount:new No(e.userIdoInfo),owner:this.scope.ownerPubKey}};return a.addInstruction({instructions:[...l?[Ya(U(v({},P),{side:"base"}))]:[],...m?[Ya(U(v({},P),{side:"quote"}))]:[]]}).versionBuild({txVersion:r})}};var ib=Buffer.from("vault_auth_seed","utf8"),ob=Buffer.from("global_config","utf8"),rb=Buffer.from("pool","utf8"),sb=Buffer.from("pool_vault","utf8"),ab=Buffer.from("pool_vesting","utf8"),ub=Buffer.from("platform_config","utf8");function ri(o){return ie([ib],o)}function jC(o,e,t,n){return ie([ob,e.toBuffer(),cb(t),Mr(n)],o)}function os(o,e,t){return ie([rb,e.toBuffer(),t.toBuffer()],o)}function Za(o,e,t){return ie([sb,e.toBuffer(),t.toBuffer()],o)}function cb(o){let e=new ArrayBuffer(1);return new DataView(e).setUint8(0,o),new Uint8Array(e)}function Ci(o){return ie([Buffer.from("__event_authority","utf8")],o)}function $a(o,e){return ie([ub,e.toBuffer()],o)}function Ja(o,e,t){return ie([ab,e.toBuffer(),t.toBuffer()],o)}import{SystemProgram as Oo,TransactionInstruction as mn}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as El}from"@solana/spl-token";import rs from"bn.js";var dn={initialize:Buffer.from([175,175,109,31,13,152,155,237]),buyExactIn:Buffer.from([250,234,13,123,213,156,19,236]),buyExactOut:Buffer.from([24,211,116,40,105,3,153,56]),sellExactIn:Buffer.from([149,39,222,155,211,124,152,26]),sellExactOut:Buffer.from([95,200,71,34,8,9,11,166]),createVestingAccount:Buffer.from([129,178,2,13,217,172,230,218]),claimVestedToken:Buffer.from([49,33,104,30,189,157,79,35]),createPlatformConfig:Buffer.from([176,90,196,175,253,113,220,20]),claimPlatformFee:Buffer.from([156,39,208,135,76,237,61,72]),updatePlaformConfig:Buffer.from([195,60,76,129,146,45,67,143])};function _l(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g,P,k,T,I){let h=E([q("decimals"),$t("name"),$t("symbol"),$t("uri")]),S=E([w("totalLockedAmount"),w("cliffPeriod"),w("unlockPeriod")]),x=E([q("index"),w("supply"),w("totalFundRaisingB"),q("migrateType")]),K=E([q("index"),w("supply"),w("totalSellA"),w("totalFundRaisingB"),q("migrateType")]),B=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Xt,isSigner:!1,isWritable:!1},{pubkey:Oo.programId,isSigner:!1,isWritable:!1},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:Ci(o).publicKey,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1}],C=Buffer.alloc(Buffer.from(f,"utf-8").length+Buffer.from(y,"utf-8").length+Buffer.from(g,"utf-8").length+4*3+1),L=Buffer.alloc(S.span),R=Buffer.alloc(P.type==="ConstantCurve"?K.span:x.span);return h.encode({decimals:b,name:f,symbol:y,uri:g},C),P.type==="ConstantCurve"?K.encode(U(v({index:0},P),{migrateType:P.migrateType==="amm"?0:1}),R):P.type==="FixedCurve"?x.encode(U(v({index:1},P),{migrateType:P.migrateType==="amm"?0:1}),R):P.type==="LinearCurve"&&x.encode(U(v({index:2},P),{migrateType:P.migrateType==="amm"?0:1}),R),S.encode({totalLockedAmount:k,cliffPeriod:T,unlockPeriod:I},L),new mn({keys:B,programId:o,data:Buffer.from([...dn.initialize,...C,...R,...L])})}function Vl(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g){let P=E([w("amountB"),w("minAmountA"),w("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Ci(o).publicKey,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0}),console.log({amountB:b.toString(),minAmountA:f.toString()});let T=Buffer.alloc(P.span);return P.encode({amountB:b,minAmountA:f,shareFeeRate:y!=null?y:new rs(0)},T),new mn({keys:k,programId:o,data:Buffer.from([...dn.buyExactIn,...T])})}function o0(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g){let P=E([w("amountA"),w("maxAmountB"),w("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Ci(o).publicKey,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let T=Buffer.alloc(P.span);return P.encode({amountA:b,maxAmountB:f,shareFeeRate:y!=null?y:new rs(0)},T),new mn({keys:k,programId:o,data:Buffer.from([...dn.buyExactOut,...T])})}function Fl(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g){let P=E([w("amountA"),w("minAmountB"),w("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Ci(o).publicKey,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let T=Buffer.alloc(P.span);return P.encode({amountA:b,minAmountB:f,shareFeeRate:y!=null?y:new rs(0)},T),new mn({keys:k,programId:o,data:Buffer.from([...dn.sellExactIn,...T])})}function r0(o,e,t,n,i,r,s,a,c,u,l,m,d,p,b,f,y,g){let P=E([w("amountB"),w("maxAmountA"),w("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Ci(o).publicKey,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let T=Buffer.alloc(P.span);return P.encode({amountB:b,maxAmountA:f,shareFeeRate:y!=null?y:new rs(0)},T),new mn({keys:k,programId:o,data:Buffer.from([...dn.sellExactOut,...T])})}function Dl(o,e,t,n,i,r,s,a,c){let u=E([]),l=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:Oo.programId,isSigner:!1,isWritable:!1},{pubkey:El,isSigner:!1,isWritable:!1}],m=Buffer.alloc(u.span);return u.encode({},m),new mn({keys:l,programId:o,data:Buffer.from([...dn.claimVestedToken,...m])})}function Wl(o,e,t,n,i,r){let s=E([w("shareAmount")]),a=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:Oo.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({shareAmount:r},c),new mn({keys:a,programId:o,data:Buffer.from([...dn.createVestingAccount,...c])})}function eu(o,e,t,n,i,r,s,a,c){let u=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Oo.programId,isSigner:!1,isWritable:!0},{pubkey:El,isSigner:!1,isWritable:!0}];return new mn({keys:u,programId:o,data:dn.claimPlatformFee})}function ql(o,e,t,n,i,r,s,a,c,u,l){let m=E([w("platformScale"),w("creatorScale"),w("burnScale"),w("feeRate"),$t("name"),$t("web"),$t("img")]),d=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:Oo.programId,isSigner:!1,isWritable:!1}],p=Buffer.alloc(8*4+Buffer.from(c,"utf-8").length+Buffer.from(u,"utf-8").length+Buffer.from(l,"utf-8").length+4*3);return m.encode({platformScale:s.platformScale,creatorScale:s.creatorScale,burnScale:s.burnScale,feeRate:a,name:c,web:u,img:l},p),new mn({keys:d,programId:o,data:Buffer.from([...dn.createPlatformConfig,...p])})}function Ul(o,e,t,n){let i=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0}],r;if(n.type==="updateClaimFeeWallet"){let s=E([q("index"),N("value")]);r=Buffer.alloc(s.span),s.encode({index:0,value:n.value},r)}else if(n.type==="updateLockNftWallet"){let s=E([q("index"),N("value")]);r=Buffer.alloc(s.span),s.encode({index:1,value:n.value},r)}else if(n.type==="migrateCpLockNftScale"){let s=E([q("index"),w("platformScale"),w("creatorScale"),w("burnScale")]);r=Buffer.alloc(s.span),s.encode(v({index:2},n.value),r)}else if(n.type==="updateFeeRate"){let s=E([q("index"),w("value")]);r=Buffer.alloc(s.span),s.encode({index:3,value:n.value},r)}else if(n.type==="updateImg"||n.type==="updateName"||n.type==="updateWeb"){let s=E([q("index"),$t("value")]);r=Buffer.alloc(Buffer.from(n.value,"utf-8").length+4+1*1),n.type==="updateName"?s.encode({index:4,value:n.value},r):n.type==="updateWeb"?s.encode({index:5,value:n.value},r):n.type==="updateImg"&&s.encode({index:6,value:n.value},r)}else if(n.type==="updateCpConfigId"){i.push({pubkey:n.value,isSigner:!1,isWritable:!1});let s=E([q("index")]);r=Buffer.alloc(s.span),s.encode({index:7},r)}else if(n.type==="updateAll"){console.log("Please note that this update will overwrite all data in the platform account with the new data."),i.push({pubkey:n.value.cpConfigId,isSigner:!1,isWritable:!1});let s=E([q("index"),N("platformClaimFeeWallet"),N("platformLockNftWallet"),w("platformScale"),w("creatorScale"),w("burnScale"),w("feeRate"),$t("name"),$t("web"),$t("img")]);r=Buffer.alloc(1+32+32+8*4+4*3+Buffer.from(n.value.name,"utf-8").length+Buffer.from(n.value.web,"utf-8").length+Buffer.from(n.value.img,"utf-8").length),s.encode({index:8,platformClaimFeeWallet:n.value.platformClaimFeeWallet,platformLockNftWallet:n.value.platformLockNftWallet,platformScale:n.value.migrateCpLockNftScale.platformScale,creatorScale:n.value.migrateCpLockNftScale.creatorScale,burnScale:n.value.migrateCpLockNftScale.burnScale,feeRate:n.value.feeRate,name:n.value.name,web:n.value.web,img:n.value.img},r)}else throw Error("updateInfo params type error");return new mn({keys:i,programId:o,data:Buffer.from([...dn.updatePlaformConfig,...r])})}import{NATIVE_MINT as ls,TOKEN_PROGRAM_ID as Lt,createAssociatedTokenAccountIdempotentInstruction as Eo}from"@solana/spl-token";import be from"bn.js";import{PublicKey as Xl}from"@solana/web3.js";var Li=E([w(),w("epoch"),q("curveType"),Zt("index"),w("migrateFee"),w("tradeFeeRate"),w("maxShareFeeRate"),w("minSupplyA"),w("maxLockRate"),w("minSellRateA"),w("minMigrateRateA"),w("minFundRaisingB"),N("mintB"),N("protocolFeeOwner"),N("migrateFeeOwner"),N("migrateToAmmWallet"),N("migrateToCpmmWallet"),z(w(),16)]),lb=E([w("totalLockedAmount"),w("cliffPeriod"),w("unlockPeriod"),w("startTime"),w("totalAllocatedShare")]),xn=E([w(),w("epoch"),q("bump"),q("status"),q("mintDecimalsA"),q("mintDecimalsB"),q("migrateType"),w("supply"),w("totalSellA"),w("virtualA"),w("virtualB"),w("realA"),w("realB"),w("totalFundRaisingB"),w("protocolFee"),w("platformFee"),w("migrateFee"),lb.replicate("vestingSchedule"),N("configId"),N("platformId"),N("mintA"),N("mintB"),N("vaultA"),N("vaultB"),N("creator"),z(w(),8)]),u0=E([w(),w("epoch"),N("poolId"),N("beneficiary"),w("claimedAmount"),w("tokenShareAmount"),z(w(),8)]),ss=E([w(),w("epoch"),N("platformClaimFeeWallet"),N("platformLockNftWallet"),w("platformScale"),w("creatorScale"),w("burnScale"),w("feeRate"),z(q(),64,"name"),z(q(),256,"web"),z(q(),256,"img"),N("cpConfigId"),z(q(),224)]);import pn from"bn.js";import Mo from"bn.js";var Un=class{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i}){throw Error()}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:i,migrateFee:r,decimalA:s,decimalB:a}){throw Error()}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,migrateFee:r}){throw Error()}static buyExactIn({poolInfo:e,amount:t}){throw Error()}static buyExactOut({poolInfo:e,amount:t}){throw Error()}static sellExactIn({poolInfo:e,amount:t}){throw Error()}static sellExactOut({poolInfo:e,amount:t}){throw Error()}};var as=class extends Un{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i}){return new O(t.toString()).div(e.toString()).mul(10**(n-i))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualB.add(e.realB).toString()).div(e.virtualA.sub(e.realA).toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:i,migrateFee:r,decimalA:s,decimalB:a}){return new O(i.sub(r).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let i=e.totalSellA.sub(e.realA),r=e.totalFundRaisingB.sub(e.realB);return new O(e.virtualB.add(e.realB.add(r)).toString()).div(e.virtualA.sub(e.realA.add(i)).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,migrateFee:r}){if(e.lte(n))throw Error("supply need gt total sell");let s=e.sub(n).sub(i);if(s.lte(new Mo(0)))throw Error("supplyMinusSellLocked <= 0");let a=t.sub(r);if(a.lte(new Mo(0)))throw Error("tfMinusMf <= 0");let c=a.mul(n).mul(n).div(s),u=a.mul(n).div(s).sub(t);if(u.lt(new Mo(0)))throw Error("supply/totalSell/totalLockedAmount diff too high");let l=c.div(u),m=t.mul(t).div(u);if(l.lt(new Mo(0))||m.lt(new Mo(0)))throw Error("invalid input 0");return{a:l,b:m,c:n}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static getAmountOut({amountIn:e,inputReserve:t,outputReserve:n}){let i=e.mul(n),r=t.add(e);return i.div(r)}static getAmountIn({amountOut:e,inputReserve:t,outputReserve:n}){let i=t.mul(e),r=n.sub(e);return mr(i,r)}};import Gl from"bn.js";var us=class extends Un{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i}){return new O(t.toString()).div(e.toString()).mul(10**(n-i))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:i,migrateFee:r,decimalA:s,decimalB:a}){return new O(i.sub(r).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let i=e.totalSellA.sub(e.realA),r=e.totalFundRaisingB.sub(e.realB);return new O(e.virtualB.add(e.realB).add(r).toString()).div(e.virtualA.sub(e.realA).add(i).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,migrateFee:r}){let s=e.sub(i);if(s.lte(new Gl(0)))throw Error("invalid input 1");let a=new Gl(2).mul(t).sub(r),u=t.mul(s).div(a);return{a:u,b:t,c:u}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualB,initOutput:e.virtualA})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualB,initOutput:e.virtualA})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualA,initOutput:e.virtualB})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualA,initOutput:e.virtualB})}static getAmountOut({amountIn:e,initInput:t,initOutput:n}){return n.mul(e).div(t)}static getAmountIn({amountOut:e,initInput:t,initOutput:n}){let i=t.mul(e);return mr(i,n)}};import Ct from"bn.js";import Ri from"bn.js";var vo=class{static _multipler(e){return new O(10).pow(e)}static getPrice({priceX64:e,decimalA:t,decimalB:n}){return new O(e.toString()).div(this._Q64).mul(this._multipler(t)).div(this._multipler(n))}static getPriceX64({price:e,decimalA:t,decimalB:n}){let i=e.mul(this._multipler(n)).div(this._multipler(t));return new Ri(i.mul(this._Q64).toFixed(0))}};vo._Q64=new O(new Ri(1).shln(64).toString());function x0({supply:o,totalFundRaisingB:e,totalLockedAmount:t,totalSellA:n,migrateType:i,decimalsA:r}){let s=o.sub(n).sub(t),a=new Ri(new O(s.mul(e).toString()).sqrt().toFixed(0));if(i==="amm"){if(a.gt(new Ri(10).pow(new Ri(r))))return!0}else if(i==="cpmm"){if(a.gt(new Ri(100)))return!0}else throw Error("migrate type error");return!1}var cs=class extends Un{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new O(0)}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i}){return new O(0)}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualA.mul(e.realA).toString()).div(vo._Q64).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:i,migrateFee:r,decimalA:s,decimalB:a}){return new O(i.sub(r).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let i=e.totalSellA.sub(e.realA),r=e.totalFundRaisingB.sub(e.realB);return new O(e.virtualB.add(e.realB).add(r).toString()).div(e.virtualA.sub(e.realA).add(i).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,migrateFee:r}){let s=e.sub(i);if(s.lte(new Ct(0)))throw Error("supplyMinusLocked need gt 0");let a=t.mul(new Ct(3)).sub(r),u=t.mul(new Ct(2)).mul(s).div(a),l=u.mul(u),m=t.mul(new Ct(2)).mul(Ye).div(l);if(!m.gt(new Ct(0)))throw Error("a need gt 0");if(!ro.gt(m))throw Error("a need lt u64 max");return{a:m,b:new Ct(0),c:u}}static buyExactIn({poolInfo:e,amount:t}){let n=e.realB.add(t),i=new Ct(2).mul(n).mul(Ye).div(e.virtualA);return new Ct(new O(i.toString()).sqrt().toFixed(0)).sub(e.realA)}static buyExactOut({poolInfo:e,amount:t}){let n=e.realA.add(t),i=n.mul(n),{div:r,mod:s}=e.virtualA.mul(i).divmod(new Ct(2).mul(Ye));return(s.isZero()?r:r.add(new Ct(1))).sub(e.realB)}static sellExactIn({poolInfo:e,amount:t}){let n=e.realA.sub(t),i=n.mul(n),{div:r,mod:s}=e.virtualA.mul(i).divmod(new Ct(2).mul(Ye)),a=s.isZero()?r:r.add(new Ct(1));return e.realB.sub(a)}static sellExactOut({poolInfo:e,amount:t}){let n=e.realB.sub(t),i=new Ct(2).mul(n).mul(Ye).div(e.virtualA),r=new Ct(new O(i.toString()).sqrt().toFixed(0));return e.realA.sub(r)}};var fn=class{static getPoolCurvePointByPoolInfo({curveType:e,pointCount:t,poolInfo:n}){return this.getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n.supply,totalFundRaising:n.totalFundRaisingB,totalSell:n.totalSellA,totalLockedAmount:n.vestingSchedule.totalLockedAmount,migrateFee:n.migrateFee,decimalA:n.mintDecimalsA,decimalB:n.mintDecimalsB})}static getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n,totalFundRaising:i,totalSell:r,totalLockedAmount:s,migrateFee:a,decimalA:c,decimalB:u}){if(t<3)throw Error("point count < 3");let l=this.getCurve(e),m=l.getInitParam({supply:n,totalFundRaising:i,totalSell:r,totalLockedAmount:s,migrateFee:a}),d=l.getPoolInitPriceByInit(U(v({},m),{decimalA:c,decimalB:u})),p=i.div(new pn(t-1)),b=new pn(0),f=[{price:d,totalSellSupply:0}],{a:y,b:g}=m,P=b,k=b;for(let T=1;T<t;T++){let I=T!==t-1?p:i.sub(k),h=this.buyExactIn({poolInfo:{virtualA:y,virtualB:g,realA:P,realB:k,totalFundRaisingB:i,totalSellA:r},amountB:I,protocolFeeRate:b,platformFeeRate:b,curveType:e,shareFeeRate:b});P=P.add(h.amountA),k=k.add(h.amountB);let S=this.getPrice({poolInfo:{virtualA:y,virtualB:g,realA:P,realB:k},decimalA:c,decimalB:u,curveType:e});f.push({price:S,totalSellSupply:new O(P.toString()).div(10**c).toNumber()})}return f}static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n,curveType:i}){return this.getCurve(i).getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n})}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i,curveType:r}){return this.getCurve(r).getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i})}static getPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:i}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:i})}static getEndPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:i}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:i})}static getPoolEndPriceReal({poolInfo:e,curveType:t,decimalA:n,decimalB:i}){return this.getCurve(t).getPoolEndPriceReal({poolInfo:e,decimalA:n,decimalB:i})}static checkParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,decimals:r,config:s,migrateType:a}){if(Number(r)!==6)throw Error("decimals = 6");if(e.mul(s.maxLockRate).div(Ht).lt(i))throw Error("total lock amount gte max lock amount");if(e.lt(s.minSupplyA.mul(new pn(10**r))))throw Error("supply lt min supply");let u=e.mul(s.minSellRateA).div(Ht);if(n.lt(u))throw Error("invalid input");if(t.lt(s.minFundRaisingB))throw Error("total fund raising lt min fund raising");let l=e.sub(n).sub(i),m=e.mul(s.minMigrateRateA).div(Ht);if(l.lt(m))throw Error("migrate lt min migrate amount");let d=e.sub(n).sub(i),p=new pn(new O(d.mul(t).toString()).sqrt().toFixed(0));if(a==="amm"){let b=new pn(10).pow(new pn(r));if(p.lte(b))throw Error("check migrate lp error")}else if(a==="cpmm"){let b=new pn(100);if(p.lte(b))throw Error("check migrate lp error")}else throw Error("migrate type error")}static buyExactIn({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:i,curveType:r,shareFeeRate:s}){let a=n.add(s).add(i),c=this.calculateFee({amount:t,feeRate:a}),u=t.sub(c),l=this.getCurve(r),m=l.buyExactIn({poolInfo:e,amount:u}),d=e.totalSellA.sub(e.realA),p,b,f;if(m.gt(d)){p=d;let g=l.buyExactOut({poolInfo:e,amount:p});b=this.calculatePreFee({postFeeAmount:g,feeRate:a}),f=b.sub(g)}else p=m,b=t,f=c;let y=this.splitFee({totalFee:f,protocolFeeRate:n,platformFeeRate:i,shareFeeRate:s});return{amountA:p,amountB:b,splitFee:y}}static buyExactOut({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:i,curveType:r,shareFeeRate:s}){let a=e.totalSellA.sub(e.realA),c=t;t.gt(a)&&(c=a);let l=this.getCurve(r).buyExactOut({poolInfo:e,amount:t}),m=n.add(s).add(i),d=this.calculatePreFee({postFeeAmount:l,feeRate:m}),p=d.sub(l),b=this.splitFee({totalFee:p,protocolFeeRate:n,platformFeeRate:i,shareFeeRate:s});return{amountA:c,amountB:d,splitFee:b}}static sellExactIn({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:i,curveType:r,shareFeeRate:s}){let c=this.getCurve(r).sellExactIn({poolInfo:e,amount:t}),u=this.calculateFee({amount:c,feeRate:n.add(s).add(i)}),l=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:i,shareFeeRate:s});return{amountA:t,amountB:c.sub(u),splitFee:l}}static sellExactOut({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:i,curveType:r,shareFeeRate:s}){let a=n.add(s).add(i),c=this.calculatePreFee({postFeeAmount:t,feeRate:a});if(e.realB.lt(c))throw Error("Insufficient liquidity");let u=c.sub(t),m=fn.getCurve(r).sellExactOut({poolInfo:e,amount:c});if(m.gt(e.realA))throw Error();let d=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:i,shareFeeRate:s});return{amountA:m,amountB:t,splitFee:d}}static splitFee({totalFee:e,protocolFeeRate:t,platformFeeRate:n,shareFeeRate:i}){let r=t.add(n).add(i),s=r.isZero()?new pn(0):e.mul(n).div(r),a=r.isZero()?new pn(0):e.mul(i).div(r),c=e.sub(s).sub(a);return{platformFee:s,shareFee:a,protocolFee:c}}static calculateFee({amount:e,feeRate:t}){return or(e,t,Ht)}static calculatePreFee({postFeeAmount:e,feeRate:t}){if(t.isZero())return e;let n=e.mul(Ht),i=Ht.sub(t);return n.add(i).sub(new pn(1)).div(i)}static getCurve(e){switch(e){case 0:return as;case 1:return us;case 2:return cs}throw Error("find curve error")}};var si={initPriceX64:new be("515752397214619"),supply:new be(1e15),totalSellA:new be(7931e11),totalFundRaisingB:new be(85e9),totalLockedAmount:new be("0"),cliffPeriod:new be("0"),unlockPeriod:new be("0"),decimals:6,virtualA:new be("1073471847374405"),virtualB:new be("30050573465"),realA:new be(0),realB:new be(0),protocolFee:new be(0),platformId:new Xl("4Bu96XjU84XjPDSpveTVf6LYGCkfW5FK7SNkREWcEfV4"),vestingSchedule:{totalLockedAmount:new be(0),cliffPeriod:new be(0),unlockPeriod:new be(0),startTime:new be(0),totalAllocatedShare:new be(0)}},ms=new be(1e4),_o=class extends Me{constructor(e){super(e)}async createLaunchpad(K){var B=K,{programId:e=zt,authProgramId:t,platformId:n=si.platformId,mintA:i,decimals:r=6,mintBDecimals:s=9,name:a,symbol:c,uri:u,migrateType:l,configId:m,configInfo:d,platformFeeRate:p,txVersion:b,computeBudgetConfig:f,txTipConfig:y,feePayer:g,buyAmount:P,minMintAAmount:k,slippage:T,associatedOnly:I=!0,checkCreateATAOwner:h=!1,extraSigners:S}=B,x=De(B,["programId","authProgramId","platformId","mintA","decimals","mintBDecimals","name","symbol","uri","migrateType","configId","configInfo","platformFeeRate","txVersion","computeBudgetConfig","txTipConfig","feePayer","buyAmount","minMintAAmount","slippage","associatedOnly","checkCreateATAOwner","extraSigners"]);var $e,ai,Fo,Do,Ni,Oi;let C=this.createTxBuilder(g);t=t!=null?t:ri(e).publicKey;let L=d;if(!L&&m){let Rt=await this.scope.connection.getAccountInfo(m);Rt&&(L=Li.decode(Rt.data))}L||this.logAndCreateError("config not found");let R=L.mintB,D=L.curveType,{publicKey:_}=os(e,i,R),{publicKey:W}=Za(e,_,i),{publicKey:Y}=Za(e,_,R),{publicKey:se}=kn(i);console.log(`create token: ${i.toBase58()}, mintB: ${R.toBase58()}, decimals A:${r}/B:${s}, config:${m.toBase58()}`),c.length>10&&this.logAndCreateError("Symbol length should shorter than 11"),u||this.logAndCreateError("uri should not empty"),P.lte(new be(0))&&this.logAndCreateError("buy amount should gt 0:",P.toString());let Pe=($e=x==null?void 0:x.supply)!=null?$e:si.supply,ce=(ai=x==null?void 0:x.totalSellA)!=null?ai:si.totalSellA,de=(Fo=x==null?void 0:x.totalFundRaisingB)!=null?Fo:si.totalFundRaisingB,Ke=(Do=x==null?void 0:x.totalLockedAmount)!=null?Do:new be(0),Ze=p;if(!p){let Rt=await this.scope.connection.getAccountInfo(n);Rt||this.logAndCreateError("platform id not found:",n.toString()),Ze=ss.decode(Rt.data).feeRate}let gt=fn.getCurve(L.curveType).getInitParam({supply:Pe,totalFundRaising:de,totalSell:ce,totalLockedAmount:Ke,migrateFee:L.migrateFee}),Ue={epoch:new be(896),bump:254,status:0,mintDecimalsA:r,mintDecimalsB:s,supply:Pe,totalSellA:ce,mintA:new Xl(i),mintB:R,virtualA:gt.a,virtualB:gt.b,realA:si.realA,realB:si.realB,migrateFee:L.migrateFee,migrateType:l==="amm"?0:1,protocolFee:si.protocolFee,platformFee:Ze,platformId:n,configId:m,vaultA:W,vaultB:Y,creator:this.scope.ownerPubKey,totalFundRaisingB:de,vestingSchedule:{totalLockedAmount:Ke,cliffPeriod:new be(0),unlockPeriod:new be(0),startTime:new be(0),totalAllocatedShare:new be(0)}},lt=fn.getCurve(L.curveType),{c:nn}=lt.getInitParam({supply:Ue.supply,totalFundRaising:Ue.totalFundRaisingB,totalLockedAmount:Ke,totalSell:L.curveType===0?Ue.totalSellA:new be(0),migrateFee:L.migrateFee});try{fn.checkParam({supply:Ue.supply,totalFundRaising:Ue.totalFundRaisingB,totalSell:nn,totalLockedAmount:Ke,decimals:Ue.mintDecimalsA,config:L,migrateType:l}),console.log("check init params success")}catch(Rt){this.logAndCreateError(`check create mint params failed, ${Rt.message}`)}C.addInstruction({instructions:[_l(e,g!=null?g:this.scope.ownerPubKey,this.scope.ownerPubKey,m,n,t,_,i,R,W,Y,se,Lt,Lt,r,a,c,u||"https://",{type:D===0?"ConstantCurve":D===1?"FixedCurve":D===2?"LinearCurve":"ConstantCurve",totalSellA:ce,migrateType:l,supply:Pe,totalFundRaisingB:de},Ke,(Ni=x==null?void 0:x.cliffPeriod)!=null?Ni:new be(0),(Oi=x==null?void 0:x.unlockPeriod)!=null?Oi:new be(0))]});let bn=new be(0),Wt;if(S!=null&&S.length&&C.addInstruction({signers:S}),!x.createOnly){let{builder:Rt,extInfo:Wo}=await this.buyToken({programId:e,authProgramId:t,mintA:i,mintB:R,poolInfo:Ue,buyAmount:P,minMintAAmount:k,shareFeeRate:x.shareFeeRate,shareFeeReceiver:x.shareFeeReceiver,configInfo:L,platformFeeRate:Ze,slippage:T,associatedOnly:I,checkCreateATAOwner:h});C.addInstruction(v({},Rt.AllTxData)),bn=Wo.outAmount,Wt=(this.scope.cluster==="devnet"||b===1)&&x.shareFeeReceiver?[Rt.allInstructions[0]]:void 0}return C.addTipInstruction(y),b===0?C.sizeCheckBuildV0({computeBudgetConfig:f,outAmount:bn,splitIns:Wt,address:U(v({},Ue),{poolId:_})}):C.sizeCheckBuild({computeBudgetConfig:f,outAmount:bn,splitIns:Wt,address:U(v({},Ue),{poolId:_})})}async buyToken({programId:e=zt,authProgramId:t,mintA:n,mintB:i=ls,poolInfo:r,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:m,buyAmount:d,minMintAAmount:p,slippage:b,shareFeeRate:f=new be(0),shareFeeReceiver:y,associatedOnly:g=!0,checkCreateATAOwner:P=!1}){d.lte(new be(0))&&this.logAndCreateError("buy amount should gt 0:",d.toString());let k=this.createTxBuilder(m),{publicKey:T}=os(e,n,i);t=t!=null?t:ri(e).publicKey;let I=null,h=null,S=i.equals(ls),{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:P});x&&(I=x),k.addInstruction(K||{}),I===void 0&&this.logAndCreateError(`cannot found mintA(${n.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({mint:i,owner:this.scope.ownerPubKey,createInfo:S?{payer:this.scope.ownerPubKey,amount:d}:void 0,skipCloseAccount:!S,notUseTokenAccount:S,associatedOnly:S?!1:g,checkCreateATAOwner:P});B&&(h=B),k.addInstruction(C||{}),h===void 0&&this.logAndCreateError(`cannot found mintB(${i.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let L=r;if(!L){let ce=await this.scope.connection.getAccountInfo(T,{commitment:"processed"});ce||this.logAndCreateError("cannot found pool:",T.toBase58()),L=xn.decode(ce.data)}let R=s,D=await Ne(this.scope.connection,[R?void 0:L.configId,a?void 0:L.platformId].filter(Boolean).map(ce=>({pubkey:ce})));if(!R){let ce=D.find(de=>de.pubkey.equals(L.configId));(!ce||!ce.accountInfo)&&this.logAndCreateError("config not found: ",L.configId.toBase58()),R=Li.decode(ce.accountInfo.data)}if(!a){let ce=D.find(de=>de.pubkey.equals(L.platformId));(!ce||!ce.accountInfo)&&this.logAndCreateError("platform info not found: ",L.configId.toBase58()),a=ss.decode(ce.accountInfo.data).feeRate}let _=fn.buyExactIn({poolInfo:L,amountB:d,protocolFeeRate:R.tradeFeeRate,platformFeeRate:a,curveType:R.curveType,shareFeeRate:f}),W=new O(_.amountA.toString()),Y=b?new O(ms.sub(b).toNumber()/ms.toNumber()).clampedTo(0,1):new O(1),se=p!=null?p:b?new be(W.mul(Y).toFixed(0)):_.amountA;_.amountB.lt(d)&&console.log(`maximum ${n.toBase58()} amount can buy is ${_.amountA.toString()}, input ${i.toBase58()} amount: ${_.amountB.toString()}`);let Pe=y?J(y,i,Lt).publicKey:void 0;return Pe&&k.addInstruction({instructions:[Eo(this.scope.ownerPubKey,Pe,y,i)]}),k.addInstruction({instructions:[Vl(e,this.scope.ownerPubKey,t,L.configId,L.platformId,T,I,h,L.vaultA,L.vaultB,n,i,Lt,Lt,_.amountB.lt(d)?_.amountB:d,se,f,Pe)]}),k.addCustomComputeBudget(u),k.addTipInstruction(l),k.versionBuild({txVersion:c,extInfo:{outAmount:se}})}async sellToken({programId:e=zt,authProgramId:t,mintA:n,mintB:i=ls,poolInfo:r,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:m,sellAmount:d,minAmountB:p,slippage:b,shareFeeRate:f=new be(0),shareFeeReceiver:y,associatedOnly:g=!0,checkCreateATAOwner:P=!1}){t=t!=null?t:ri(e).publicKey;let k=this.createTxBuilder(m);d.lte(new be(0))&&this.logAndCreateError("sell amount should be gt 0");let{publicKey:T}=os(e,n,i),I=null,h=null,S=i.equals(ls),{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:void 0,skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:P});x&&(I=x),k.addInstruction(K||{}),I===void 0&&this.logAndCreateError("cannot found mintA token accounts","tokenAccounts",this.scope.account.tokenAccounts);let{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({mint:i,owner:this.scope.ownerPubKey,createInfo:S?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!S,notUseTokenAccount:S,associatedOnly:S?!1:g,checkCreateATAOwner:P});B&&(h=B),k.addInstruction(C||{}),h===void 0&&this.logAndCreateError("cannot found mintB token accounts","tokenAccounts",this.scope.account.tokenAccounts);let L=r;if(!L){let ce=await this.scope.connection.getAccountInfo(T,{commitment:"processed"});ce||this.logAndCreateError("cannot found pool",T.toBase58()),L=xn.decode(ce.data)}let R=s,D=await Ne(this.scope.connection,[R?void 0:L.configId,a?void 0:L.platformId].filter(Boolean).map(ce=>({pubkey:ce})));if(!R){let ce=D.find(de=>de.pubkey.equals(L.configId));(!ce||!ce.accountInfo)&&this.logAndCreateError("config not found: ",L.configId.toBase58()),R=Li.decode(ce.accountInfo.data)}if(!a){let ce=D.find(de=>de.pubkey.equals(L.platformId));(!ce||!ce.accountInfo)&&this.logAndCreateError("platform info not found: ",L.configId.toBase58()),a=ss.decode(ce.accountInfo.data).feeRate}let _=fn.sellExactIn({poolInfo:L,amountA:d,protocolFeeRate:R.tradeFeeRate,platformFeeRate:a,curveType:R.curveType,shareFeeRate:f}),W=new O(_.amountB.toString()),Y=b?new O(ms.sub(b).toNumber()/ms.toNumber()).clampedTo(0,1):new O(1),se=p!=null?p:b?new be(W.mul(Y).toFixed(0)):_.amountB;se.lte(new be(0))&&this.logAndCreateError(`out ${i.toBase58()} amount should be gt 0`);let Pe=y?J(y,i,Lt).publicKey:void 0;return Pe&&k.addInstruction({instructions:[Eo(this.scope.ownerPubKey,Pe,y,i)]}),k.addInstruction({instructions:[Fl(e,this.scope.ownerPubKey,t,L.configId,L.platformId,T,I,h,L.vaultA,L.vaultB,n,i,Lt,Lt,_.amountA.lt(d)?_.amountA:d,se,f,Pe)]}),k.addCustomComputeBudget(u),k.addTipInstruction(l),k.versionBuild({txVersion:c,extInfo:{outAmount:se}})}async createPlatformConfig({programId:e=zt,platformAdmin:t,platformClaimFeeWallet:n,platformLockNftWallet:i,cpConfigId:r,migrateCpLockNftScale:s,feeRate:a,name:c,web:u,img:l,txVersion:m,computeBudgetConfig:d,txTipConfig:p,feePayer:b}){let f=this.createTxBuilder(b),{publicKey:y}=$a(e,t);return f.addInstruction({instructions:[ql(e,t,n,i,y,r,s,a,c,u,l)]}),f.addCustomComputeBudget(d),f.addTipInstruction(p),f.versionBuild({txVersion:m,extInfo:{platformId:y}})}async updatePlatformConfig({programId:e=zt,platformAdmin:t,platformId:n,updateInfo:i,txVersion:r,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=n!=null?n:$a(e,t).publicKey;return u.addInstruction({instructions:[Ul(e,t,l,i)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:r})}async claimPlatformFee({programId:e=zt,authProgramId:t,platformId:n,poolId:i,platformClaimFeeWallet:r,mintB:s,vaultB:a,mintBProgram:c=Lt,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}){var g;let p=this.createTxBuilder(d);t=t!=null?t:ri(e).publicKey;let b=s,f=a;if(!b){let P=await this.scope.connection.getAccountInfo(i,{commitment:"processed"});P||this.logAndCreateError("cannot found pool:",i.toBase58());let k=xn.decode(P.data),T=await this.scope.connection.getAccountInfo(k.configId,{commitment:"processed"});T||this.logAndCreateError("cannot found config:",k.configId.toBase58()),b=Li.decode(T.data).mintB,f=f!=null?f:k.vaultB}(!b||!f)&&this.logAndCreateError("cannot found mint info, mintB: ",b.toBase58(),", vaultB: ",(g=f==null?void 0:f.toBase58())!=null?g:"");let y=J(this.scope.ownerPubKey,b,Lt).publicKey;return p.addInstruction({instructions:[Eo(this.scope.ownerPubKey,y,this.scope.ownerPubKey,b)]}),p.addInstruction({instructions:[eu(e,r,t,i,n,f,y,b,c)]}),p.addCustomComputeBudget(l),p.addTipInstruction(m),p.versionBuild({txVersion:u})}async claimAllPlatformFee({programId:e=zt,authProgramId:t,platformId:n,platformClaimFeeWallet:i,txVersion:r,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c);return t=t!=null?t:ri(e).publicKey,(await this.scope.connection.getProgramAccounts(e,{filters:[{dataSize:xn.span},{memcmp:{offset:xn.offsetOf("platformId"),bytes:n.toString()}}]})).forEach(m=>{let d=xn.decode(m.account.data),p=J(this.scope.ownerPubKey,d.mintB,Lt).publicKey;u.addInstruction({instructions:[Eo(this.scope.ownerPubKey,p,this.scope.ownerPubKey,d.mintB)]}),u.addInstruction({instructions:[eu(e,i,t,m.pubkey,n,d.vaultB,p,d.mintB,Lt)]})}),u.addTipInstruction(a),r===0?u.sizeCheckBuildV0({computeBudgetConfig:s}):u.sizeCheckBuild({computeBudgetConfig:s})}async createVesting({programId:e=zt,poolId:t,beneficiary:n,shareAmount:i,txVersion:r,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=Ja(e,t,n).publicKey;return u.addInstruction({instructions:[Wl(e,this.scope.ownerPubKey,n,t,l,i)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:r})}async claimVesting({programId:e=zt,poolId:t,poolInfo:n,txVersion:i,computeBudgetConfig:r,txTipConfig:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1}){let l=this.createTxBuilder(a),m=ri(e).publicKey,d=Ja(e,t,this.scope.ownerPubKey).publicKey,p=n;if(!p){let f=await this.scope.connection.getAccountInfo(t);f||this.logAndCreateError("pool not found"),p=xn.decode(f.data)}let b=J(this.scope.ownerPubKey,p.mintA,Lt).publicKey;return l.addInstruction({instructions:[Eo(this.scope.ownerPubKey,b,this.scope.ownerPubKey,p.mintA)]}),l.addInstruction({instructions:[Dl(e,this.scope.ownerPubKey,m,t,d,b,p.vaultA,p.mintA,Lt)]}),l.addCustomComputeBudget(r),l.addTipInstruction(s),l.versionBuild({txVersion:i})}async getRpcPoolInfo({poolId:e}){return(await this.getRpcPoolsInfo({poolIdList:[e]})).poolInfoMap[e.toBase58()]}async getRpcPoolsInfo({poolIdList:e,config:t}){let n=await Ne(this.scope.connection,e.map(c=>({pubkey:c})),t),i={},r=[];for(let c=0;c<e.length;c++){let u=n[c];if(u===null||!u.accountInfo)throw Error("fetch pool info error: "+e[c].toBase58());let l=xn.decode(u.accountInfo.data);i[e[c].toBase58()]=U(v({},l),{poolId:u.accountInfo.owner}),r.push(l.configId)}let s=await Ne(this.scope.connection,r.map(c=>({pubkey:c})),t),a={};for(let c=0;c<r.length;c++){let u=s[c];if(u===null||!u.accountInfo)throw Error("fetch config info error: "+r[c].toBase58());let l=Li.decode(u.accountInfo.data);a[r[c].toBase58()]=U(v({},l),{configId:u.accountInfo.owner})}return{poolInfoMap:Object.keys(i).reduce((c,u)=>U(v({},c),{[u]:U(v({},i[u]),{configInfo:a[i[u].configId.toBase58()]})}),{})}}};import{PublicKey as mb}from"@solana/web3.js";import{MintLayout as db,TOKEN_2022_PROGRAM_ID as tu,TOKEN_PROGRAM_ID as nu}from"@solana/spl-token";var Vo=class extends Me{constructor(t){super(t);this._tokenList=[];this._tokenMap=new Map;this._blackTokenMap=new Set;this._mintGroup={official:new Set,jup:new Set,extra:new Set};this._whiteMap=new Set;this._extraTokenList=[]}async load(t){this.checkDisabled();let{forceUpdate:n=!1,type:i="strict"}=t||{},{mintList:r,blacklist:s,whiteList:a}=await this.scope.fetchV3TokenList(n),c=await this.scope.fetchJupTokenList(n);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Set(s),this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(a),this._tokenMap.set(sn.address,sn),this._mintGroup.official.add(sn.address),r.forEach(u=>{var l;this._blackTokenMap.has(u.address)||(this._tokenMap.set(u.address,U(v({},u),{type:"raydium",priority:2,programId:(l=u.programId)!=null?l:u.tags.includes("token-2022")?tu.toBase58():nu.toBase58()})),this._mintGroup.official.add(u.address))}),c.forEach(u=>{var l;this._blackTokenMap.has(u.address)||this._tokenMap.has(u.address)||(this._tokenMap.set(u.address,U(v({},u),{type:"jupiter",priority:1,programId:(l=u.programId)!=null?l:u.tags.includes("token-2022")?tu.toBase58():nu.toBase58(),tags:u.freezeAuthority?[...u.tags||[],"hasFreeze"]:u.tags})),this._mintGroup.jup.add(u.address))}),this._extraTokenList.forEach(u=>{this._blackTokenMap.has(u.address)||this._tokenMap.has(u.address)||(this._tokenMap.set(u.address,U(v({},u),{type:"extra",priority:1,programId:u.programId||u.tags.includes("token-2022")?tu.toBase58():nu.toBase58()})),this._mintGroup.extra.add(u.address))}),this._tokenList=Array.from(this._tokenMap).map(u=>u[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(t){if(!t)throw new Error("please input mint");let n=t.toString(),i=this._tokenMap.get(n);if(i)return i;if(n.toLocaleUpperCase()==="SOL")return sn;let r=(await this.scope.api.getTokenInfo([n]))[0];if(r)return this._mintGroup.extra.add(n),this._tokenMap.set(n,U(v({},r),{priority:2})),r;let s=await this.scope.connection.getAccountInfo(new mb(n));if(!s)throw new Error(`mint address not found: ${n}`);let a=db.decode(s.data),c=n.toString().substring(0,6),u={chainId:101,address:n,programId:s.owner.toBase58(),logoURI:"",symbol:c,name:c,decimals:a.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(n),this._tokenMap.set(n,u),u}};var ds=class{constructor(e){this.rawBalances=new Map;let{connection:t,cluster:n,owner:i,api:r,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:c,blockhashCommitment:u="confirmed",loopMultiTxStatus:l}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=i?new Qt(i):void 0,this._signAllTransactions=e.signAllTransactions,this.blockhashCommitment=u,this.loopMultiTxStatus=l,this.api=r,this._apiCacheTime=c||5*60*1e3,this.logger=fe("Raydium"),this.farm=new oo({scope:this,moduleName:"Raydium_Farm"}),this.account=new ji({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new ko({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new Vo({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new Lo({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new To({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new So({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new Ft({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new Bi({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new Ki({scope:this,moduleName:"Raydium_ido"}),this.launchpad=new _o({scope:this,moduleName:"Raydium_lauchpad"}),this.availability={};let m=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:m,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){var l;let t=pb({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:n,apiRequestTimeout:i,logCount:r,logRequests:s,urlConfigs:a}=t,c=new wr({cluster:n,timeout:i,urlConfigs:a,logCount:r,logRequests:s}),u=new ds(U(v({},t),{api:c}));return await u.fetchAvailabilityStatus((l=e.disableFeatureCheck)!=null?l:!0),e.disableLoadToken||await u.token.load({type:e.jupTokenType}),u}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(kr);return this._owner.publicKey}setOwner(e){return this._owner=e?new Qt(e):void 0,this.account.resetTokenAccounts(),this}get connection(){if(!this._connection)throw new Error(zu);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw console.error(kr),new Error(kr)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;try{let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}catch(t){return console.error(t),{mintList:[],blacklist:[],whiteList:[]}}}async fetchJupTokenList(e){let t=this.apiData.jupTokenList;if(t&&!this.isCacheInvalidate(t.fetched)&&!e)return t.data;try{let n=await this.api.getJupTokenList();return this.apiData.jupTokenList={fetched:Date.now(),data:n.map(i=>U(v({},i),{mintAuthority:i.mint_authority||void 0,freezeAuthority:i.freeze_authority||void 0}))},this.apiData.jupTokenList.data}catch(n){return console.error(n),[]}}get chainTimeData(){var e;return(e=this._chainTime)==null?void 0:e.value}async chainTimeOffset(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.offset)||0)}async currentBlockChainTime(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.chainTime)||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};var q1=o=>o;export{Up as AMM_CONFIG_SEED,Rc as BIT_PRECISION,To as Clmm,Qc as ClmmConfigLayout,Se as ClmmInstrument,Xr as ConstantProductCurve,Sl as CpmmConfigInfoLayout,Qr as CpmmFee,Zr as CpmmPoolInfoLayout,fn as Curve,Un as CurveBase,jr as CurveCalculator,mf as DataElement,ka as EXTENSION_TICKARRAY_BITMAP_SIZE,Ac as FARM_LOCK_MINT,Pc as FARM_LOCK_VAULT,vt as FARM_PROGRAM_TO_VERSION,kc as FARM_VERSION_TO_LEDGER_LAYOUT,wc as FARM_VERSION_TO_STATE_LAYOUT,Or as FEE_RATE_DENOMINATOR,$p as FETCH_TICKARRAY_COUNT,qp as Fee,us as FixedPriceCurve,ib as LAUNCHPAD_AUTH_SEED,ob as LAUNCHPAD_CONFIG_SEED,ub as LAUNCHPAD_POOL_PLATFORM_SEED,rb as LAUNCHPAD_POOL_SEED,sb as LAUNCHPAD_POOL_VAULT_SEED,ab as LAUNCHPAD_POOL_VESTING_SEED,Vr as LIQUIDITY_FEES_DENOMINATOR,Ba as LIQUIDITY_FEES_NUMERATOR,uf as LIQUIDITY_VERSION_TO_SERUM_VERSION,xI as LIQUIDITY_VERSION_TO_STATE_LAYOUT,Gf as LOCK_LIQUIDITY_SEED,Nc as LOG_B_2_X32,Oc as LOG_B_P_ERR_MARGIN_LOWER_X64,Mc as LOG_B_P_ERR_MARGIN_UPPER_X64,as as LaunchPadConstantProductCurve,Li as LaunchpadConfig,xn as LaunchpadPool,si as LaunchpadPoolInitParam,u0 as LaunchpadVesting,lb as LaunchpadVestingSchedule,cs as LinearPriceCurve,Ae as LiquidityMath,VT as LockClPositionLayoutV2,_T as LockPositionLayout,Va as MARKET_STATE_LAYOUT_V2,qa as MARKET_STATE_LAYOUT_V3,Ll as MARKET_VERSION_TO_STATE_LAYOUT,Vt as MAX_SQRT_PRICE_X64,Nr as MAX_SQRT_PRICE_X64_SUB_ONE,kt as MAX_TICK,_t as MIN_SQRT_PRICE_X64,Rr as MIN_SQRT_PRICE_X64_ADD_ONE,ft as MIN_TICK,Ti as MODEL_DATA_PUBKEY,es as Market,vo as MathLaunch,ue as MathUtil,ro as MaxU64,Lc as MaxUint128,wn as NEGATIVE_ONE,Yp as OBSERVATION_SEED,Nt as ONE,jp as OPERATION_SEED,zc as ObservationInfoLayout,tf as ObservationLayout,jc as OperationLayout,qc as POOL_LOCK_ID_SEED,Qp as POOL_REWARD_VAULT_SEED,Gp as POOL_SEED,Hp as POOL_TICK_ARRAY_BITMAP_SEED,Xp as POOL_VAULT_SEED,Vc as POSITION_SEED,ss as PlatformConfig,Hn as PoolInfoLayout,Re as PoolUtils,fo as PositionInfoLayout,of as PositionRewardInfoLayout,lo as PositionUtils,ET as ProtocolPositionLayout,Lr as Q128,Ye as Q64,ds as Raydium,nf as RewardInfo,gl as RoundDirection,Kl as SERUM_PROGRAMID_TO_VERSION,Cl as SERUM_VERSION_TO_PROGRAMID,sn as SOL_INFO,$c as SPL_MINT_LAYOUT,Zp as SUPPORT_MINT_SEED,oe as SqrtPriceMath,hi as StableLayout,jn as SwapMath,zn as TICK_ARRAY_BITMAP_SIZE,zp as TICK_ARRAY_SEED,tt as TICK_ARRAY_SIZE,Ah as TICK_SPACINGS,nt as TOKEN_WSOL,hn as TickArrayBitmap,Xc as TickArrayBitmapExtensionLayout,po as TickArrayBitmapExtensionUtils,mo as TickArrayLayout,rf as TickLayout,Yn as TickMath,we as TickQuery,Z as TickUtils,so as U64Resolution,wh as U64_IGNORE_RANGE,yc as Voter,Sp as VoterDepositEntry,xp as VoterLockup,bc as VoterRegistrar,Bp as VoterVotingMintConfig,ye as ZERO,Ca as addLiquidityLayout,dn as anchorDataBuf,Js as associatedLedgerAccountLayout,Vl as buyExactInInstruction,o0 as buyExactOutInstruction,da as calFarmRewardAmount,x0 as checkPoolToAmm,Ro as claimLayout,eu as claimPlatformFee,Dl as claimVestedToken,Gc as clmmComputeInfoToApiInfo,Pn as closeAccountInstruction,xl as collectCpFeeInstruction,jf as cpmmLockPositionInstruction,eo as createAssociatedLedgerAccountInstruction,ql as createPlatformConfig,tl as createPoolFeeLayout,Oa as createPoolV4InstructionV2,BI as createPoolV4Layout,Wl as createVestingAccount,vn as createWSolAccountInstructions,wt as dwLayout,ia as farmAddRewardLayout,Yw as farmLedgerLayoutV3_1,Yi as farmLedgerLayoutV3_2,Zw as farmLedgerLayoutV5_1,pc as farmLedgerLayoutV5_2,fc as farmLedgerLayoutV6_1,Tc as farmRewardInfoToConfig,ta as farmRewardLayout,na as farmRewardRestartLayout,Ip as farmRewardTimeInfoLayout,mc as farmStateV3Layout,dc as farmStateV5Layout,Hi as farmStateV6Layout,hk as fetchMultipleFarmInfoAndUpdate,pB as fetchMultipleInfo,xa as fixedSwapInLayout,Sa as fixedSwapOutLayout,kf as formatLayout,Ge as generatePubKey,hc as getAssociatedAuthority,Dr as getAssociatedConfigId,pt as getAssociatedLedgerAccount,$i as getAssociatedLedgerPoolAccount,Cf as getAssociatedOpenOrders,_a as getAssociatedPoolKeys,Hr as getCpLockPda,dS as getCpmmPdaAmmConfigId,Da as getCpmmPdaPoolId,Pl as getCreatePoolKeys,pa as getDepositEntryIndex,rl as getDxByDyBaseIn,ol as getDyByDxBaseIn,wi as getFarmLedgerLayout,Kp as getFarmStateLayout,Ea as getLiquidityAssociatedAuthority,ei as getLiquidityAssociatedId,dT as getLiquidityFromAmounts,Sh as getPdaAmmConfigId,Ci as getPdaCpiEvent,Xe as getPdaExBitmapAccount,ri as getPdaLaunchpadAuth,jC as getPdaLaunchpadConfigId,os as getPdaLaunchpadPoolId,Za as getPdaLaunchpadVaultId,co as getPdaLockClPositionIdV2,Pa as getPdaLockPositionId,qf as getPdaLpMint,kn as getPdaMetadataKey,wa as getPdaMintExAccount,Wc as getPdaObservationAccount,Bo as getPdaObservationId,uo as getPdaOperationAccount,ht as getPdaPersonalPositionAddress,$a as getPdaPlatformId,Si as getPdaPoolAuthority,Fc as getPdaPoolId,Dc as getPdaPoolRewardVaulId,Aa as getPdaPoolVaultId,en as getPdaProtocolPositionAddress,ge as getPdaTickArrayAddress,Al as getPdaVault,Ja as getPdaVestId,sa as getRegistrarAddress,sl as getStablePrice,ma as getTokenOwnerRecordAddress,ca as getVoterAddress,la as getVoterWeightRecordAddress,ua as getVotingMintAuthority,aa as getVotingTokenMint,_p as governanceCreateTokenOwnerRecord,hh as i16ToBytes,vr as i32ToBytes,Ka as initPoolLayout,Zs as initTokenAccountInstruction,_l as initialize,Of as initializeMarket,oa as isValidFarmVersion,ao as isZero,Tk as judgeFarmType,ya as leadingZeros,_c as leastSignificantBit,Zn as liquidityStateV4Layout,cf as liquidityStateV5Layout,Fr as makeAMMSwapInstruction,cl as makeAddLiquidityInstruction,ba as makeAddNewRewardInstruction,is as makeClaimInstruction,Ya as makeClaimInstructionV4,Bl as makeCpmmLockInstruction,kl as makeCreateCpmmPoolInInstruction,Ic as makeCreateFarmInstruction,qr as makeCreateMarketInstruction,Bc as makeCreatorWithdrawFarmRewardInstruction,hl as makeDepositCpmmInInstruction,Sc as makeDepositInstructionV3,Kc as makeDepositInstructionV5,Cc as makeDepositInstructionV6,Fk as makeDepositTokenInstruction,Wk as makeDepositWithdrawInstruction,UI as makeInitPoolInstructionV4,CC as makePurchaseInstruction,fa as makeRestartRewardInstruction,ll as makeSimulatePoolInfoInstruction,Yr as makeSwapCpmmBaseInInstruction,Il as makeSwapCpmmBaseOutInstruction,If as makeSwapFixedInInstruction,Bf as makeSwapFixedOutInstruction,Nl as makeSwapInstruction,lc as makeTransferInstruction,Tl as makeWithdrawCpmmInInstruction,io as makeWithdrawInstructionV3,xc as makeWithdrawInstructionV4,no as makeWithdrawInstructionV5,to as makeWithdrawInstructionV6,Dk as makeWithdrawTokenInstruction,Ph as mockCreatePoolInfo,vc as mockV3CreatePoolInfo,df as modelDataInfoLayout,Ec as mostSignificantBit,cc as parseTokenAccountResp,mI as parseTokenInfo,_n as poolTypeV6,za as purchaseLayout,kp as realFarmStateV3Layout,hp as realFarmStateV5Layout,Tp as realFarmV6Layout,Na as removeLiquidityInstruction,La as removeLiquidityLayout,OK as route1Instruction,MK as route2Instruction,Zf as routeInstruction,Fl as sellExactInInstruction,r0 as sellExactOut,qI as simulatePoolInfoInstruction,pI as solToWSolToken,Jt as splAccountLayout,vK as swapBaseInAutoAccount,EK as swapBaseOutAutoAccount,Wr as toAmmComputePoolInfo,bt as toApiV3Token,Vn as toFeeConfig,_r as toToken,yo as toTokenAmount,dI as toTokenInfo,ga as trailingZeros,Mr as u16ToBytes,Th as u32ToBytes,cb as u8ToBytes,q1 as unionArr,Cp as updateFarmPoolInfo,Ul as updatePlatformConfig,ra as validateFarmRewards,Fp as voterStakeRegistryCreateDepositEntry,Vp as voterStakeRegistryCreateVoter,Mp as voterStakeRegistryDeposit,vp as voterStakeRegistryUpdateVoterWeightRecord,Ep as voterStakeRegistryWithdraw,fI as wSolToSolToken,ea as withdrawRewardLayout};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=index.mjs.map