{"version":3,"sources":["../../src/api/utils.ts"],"sourcesContent":["export const SESSION_KEY = \"ray_tab_hash\";\r\nexport const STORAGE_KEY = \"ray_req_hash\";\r\n\r\nexport const getSessionKey = (): string => {\r\n  if (typeof window === undefined) return \"\";\r\n  let key = sessionStorage.getItem(SESSION_KEY);\r\n\r\n  // new a session key\r\n  if (!key) {\r\n    key = `ray-${Date.now()}`;\r\n    sessionStorage.setItem(SESSION_KEY, key);\r\n  }\r\n  return key;\r\n};\r\n\r\nexport interface ResHistory {\r\n  status: number;\r\n  url: string;\r\n  params?: any;\r\n  data: any;\r\n  logCount?: number;\r\n  time: number;\r\n  session: string;\r\n  removeLastLog?: boolean;\r\n}\r\n\r\nexport const updateReqHistory = async ({\r\n  logCount = 1000,\r\n  removeLastLog,\r\n  ...resData\r\n}: Omit<ResHistory, \"time\" | \"session\">): Promise<void> => {\r\n  if (typeof window === undefined) return new Promise((resolve) => resolve());\r\n  const data: ResHistory[] = JSON.parse(localStorage.getItem(STORAGE_KEY) || \"[]\").slice(0, logCount - 1);\r\n\r\n  // means retry last save error\r\n  if (removeLastLog) data.pop();\r\n\r\n  // if data > 1kb\r\n  if (new Blob([JSON.stringify(resData.data)]).size > 1024)\r\n    resData.data = JSON.stringify(resData.data).substring(0, 200) + \"...\";\r\n  data.unshift({ ...resData, time: Date.now(), session: getSessionKey() });\r\n\r\n  try {\r\n    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));\r\n  } catch {\r\n    // if retry failed, empty request data\r\n    if (removeLastLog) {\r\n      let success = false;\r\n      const resStr = JSON.stringify(resData.data).substring(0, 100);\r\n      data[0].data = resStr + (resStr.length > 100 ? \"...\" : \"\");\r\n      while (!success) {\r\n        data.pop();\r\n        const resStr = JSON.stringify(resData.data).substring(0, 100);\r\n        data[0].data = resStr + (resStr.length > 100 ? \"...\" : \"\");\r\n        try {\r\n          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));\r\n          success = true;\r\n        } catch {\r\n          success = false;\r\n        }\r\n      }\r\n      return new Promise((resolve) => resolve());\r\n    }\r\n    return updateReqHistory({\r\n      ...resData,\r\n      logCount,\r\n      removeLastLog: true,\r\n    });\r\n  }\r\n};\r\n"],"mappings":"+kBAAO,GAAM,GAAc,eACd,EAAc,eAEd,EAAgB,IAAc,CACzC,GAAI,MAAO,UAAW,OAAW,MAAO,GACxC,GAAI,GAAM,eAAe,QAAQ,CAAW,EAG5C,MAAK,IACH,GAAM,OAAO,KAAK,IAAI,IACtB,eAAe,QAAQ,EAAa,CAAG,GAElC,CACT,EAaa,EAAmB,KAAO,IAIoB,CAJpB,QACrC,YAAW,IACX,iBAFqC,EAGlC,IAHkC,EAGlC,CAFH,WACA,kBAGA,GAAI,MAAO,UAAW,OAAW,MAAO,IAAI,SAAQ,AAAC,GAAY,EAAQ,CAAC,EAC1E,GAAM,GAAqB,KAAK,MAAM,aAAa,QAAQ,CAAW,GAAK,IAAI,EAAE,MAAM,EAAG,EAAW,CAAC,EAGtG,AAAI,GAAe,EAAK,IAAI,EAGxB,GAAI,MAAK,CAAC,KAAK,UAAU,EAAQ,IAAI,CAAC,CAAC,EAAE,KAAO,MAClD,GAAQ,KAAO,KAAK,UAAU,EAAQ,IAAI,EAAE,UAAU,EAAG,GAAG,EAAI,OAClE,EAAK,QAAQ,OAAK,GAAL,CAAc,KAAM,KAAK,IAAI,EAAG,QAAS,EAAc,CAAE,EAAC,EAEvE,GAAI,CACF,aAAa,QAAQ,EAAa,KAAK,UAAU,CAAI,CAAC,CACxD,MAAE,CAEA,GAAI,EAAe,CACjB,GAAI,GAAU,GACR,EAAS,KAAK,UAAU,EAAQ,IAAI,EAAE,UAAU,EAAG,GAAG,EAE5D,IADA,EAAK,GAAG,KAAO,EAAU,GAAO,OAAS,IAAM,MAAQ,IAChD,CAAC,GAAS,CACf,EAAK,IAAI,EACT,GAAM,GAAS,KAAK,UAAU,EAAQ,IAAI,EAAE,UAAU,EAAG,GAAG,EAC5D,EAAK,GAAG,KAAO,EAAU,GAAO,OAAS,IAAM,MAAQ,IACvD,GAAI,CACF,aAAa,QAAQ,EAAa,KAAK,UAAU,CAAI,CAAC,EACtD,EAAU,EACZ,MAAE,CACA,EAAU,EACZ,CACF,CACA,MAAO,IAAI,SAAQ,AAAC,GAAY,EAAQ,CAAC,CAC3C,CACA,MAAO,GAAiB,OACnB,GADmB,CAEtB,WACA,cAAe,EACjB,EAAC,CACH,CACF","names":[]}